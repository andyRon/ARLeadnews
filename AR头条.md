ARå¤´æ¡
-----
æµ‹è¯•

https://www.bilibili.com/video/BV1Qs4y1v7x4

## ä»‹ç»

### æŠ€æœ¯æ ˆ

å¾®æœåŠ¡é¡¹ç›®

![](images/image-20231002072412096.png)

æŠ€æœ¯è§£å†³æ–¹æ¡ˆï¼š

- é™æ€åŒ–æ¨¡æ¿æ–¹æ¡ˆ
- å»¶è¿Ÿå‘å¸ƒæ–¹æ¡ˆ
- å†…å®¹å®¡æ ¸å‘å¸ƒæ•´å¥—æµç¨‹å®ç°æ–¹æ¡ˆ
- çƒ­ç‚¹æ•°æ®ç­›é€‰ä¸å¤„ç†æ–¹æ¡ˆ
- åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦è§£å†³æ–¹æ¡ˆ
- å¾®æœåŠ¡æŒç»­é›†æˆè§£å†³æ–¹æ¡ˆ

![](images/image-20231002072456555.png)

### é¡¹ç›®å‰ç½®çŸ¥è¯†

- Springbootçµæ´»ä½¿ç”¨çš„ç¨‹åº¦

- Spring cloud å…¥é—¨ç¨‹åº¦

- NacosåŸºæœ¬ä½¿ç”¨ç¨‹åº¦



### æ€æ ·å­¦ä¹ é¡¹ç›®

ä¸šåŠ¡ç»†èŠ‚

å­¦ä¹ çš„é‡ç‚¹ï¼š

- ä¸šåŠ¡ï¼ˆBï¼‰ã€‚ç†è§£éœ€æ±‚ã€å‡†å¤‡é¢è¯•
- æŠ€æœ¯ï¼ˆTï¼‰ã€‚è€æŠ€æœ¯èä¼šè´¯é€šã€æ–°æŠ€æœ¯å¿«é€ŸæŒæ¡
- ä»£ç ï¼ˆCï¼‰ã€‚ç ”ç©¶ä»£ç é€»è¾‘ï¼Œé‡å˜å½±å“è´¨å˜
- å®æˆ˜ï¼ˆPï¼‰ã€‚çœŸéœ€æ±‚ï¼ŒéªŒè¯æ°´å¹³

![](images/image-20231002073123807.png)

é‡åˆ°é—®é¢˜æ€ä¹ˆåŠï¼Ÿ

åœ¨è°ƒè¯•ä¸­æˆé•¿ï¼ˆå­¦ä¼šdebugï¼‰

## 1 é¡¹ç›®ä»‹ç»

æ€ä¹ˆä»‹ç»ä¸€ä¸ªé¡¹ç›®ï¼š

é¡¹ç›®èƒŒæ™¯ã€ä¸šåŠ¡èƒ½åŠ›ã€æŠ€æœ¯æ ˆè¯´æ˜ã€è§£å†³æ–¹æ¡ˆ

### é¡¹ç›®æ¦‚è¿°

ç±»ä¼¼äºä»Šæ—¥å¤´æ¡ï¼Œæ˜¯ä¸€ä¸ªæ–°é—»èµ„è®¯ç±»é¡¹ç›®

#### è¯¾ç¨‹æ¦‚è¿°

![](images/image-20231002075450779.png)



è¯¾ç¨‹å¤§çº²ï¼š

| ç« èŠ‚                           | å¤©æ•° | å†…å®¹                                                         |
| ------------------------------ | ---- | ------------------------------------------------------------ |
| ç¬¬ä¸€ç«  ç¯å¢ƒæ­å»º                | 1    | springbootã€springcloudã€nacosã€swagger                      |
| ç¬¬äºŒç«  æ–‡ç« åˆ—è¡¨æŸ¥çœ‹            | 2    | freemarkerã€OSSã€CDNã€ElasticSearchã€Redis                   |
| ç¬¬ä¸‰ç«  çƒ­ç‚¹æ–‡ç« è®¡ç®—            | 3    | kafkaã€kafkaStreamã€xxl-jobã€Redis                           |
| ç¬¬å››ç«  CMSè‡ªåª’ä½“ç«¯æ–‡ç« å‘å¸ƒå®¡æ ¸ | 3    | ç¬¬ä¸‰æ–¹æ¥å£ã€å»¶è¿Ÿé˜Ÿåˆ—ã€                                       |
| ç¬¬äº”ç«  é¡¹ç›®éƒ¨ç½² æ•°æ®è¿ç§»       | 2    | Hbaseã€Jenkinsã€Gitã€Docker                                  |
| é¡¹ç›®å®æˆ˜                       | 4    | appç«¯-æ–‡ç« è¡Œä¸ºã€<br />appç«¯-è¯„è®ºç³»ç»Ÿã€<br />è‡ªåª’ä½“ç«¯-è¯„è®ºç®¡ç†ã€<br />è‡ªåª’ä½“ç«¯-æŠ¥è¡¨ |



#### ç¯å¢ƒæ­å»º

ä½¿ç”¨ç™»å½•åŠç½‘å…³è®¤è¯æ ¡éªŒåŠŸèƒ½æ¥æµ‹è¯•ç¯å¢ƒæ­å»ºæˆåŠŸä¸å¦ã€‚

ç›®æ ‡ï¼šæ¥å£æµ‹è¯•å·¥å…·åŠå‰åç«¯è”è°ƒ

![](images/image-20231002074108700.png)



#### ä¸šåŠ¡è¯´æ˜

åŠŸèƒ½æ¶æ„å›¾

![](images/image-20231002074638167.png)

- ç”¨æˆ·ç§»åŠ¨App

![](images/image-20231002085931731.png)

- è‡ªåª’ä½“å¹³å°æ˜¯æ–°é—»å†™æ–‡ç« ã€å‘å¸ƒæ–‡ç« ã€ç®¡ç†çš„å¹³å°

![](images/image-20231002090133533.png)

![](images/image-20231002090201877.png)

![](images/image-20231002090220080.png)

![](images/image-20231002090243457.png)

![](images/image-20231002090304625.png)



- ç®¡ç†å¹³å°ç›¸å½“äºARå¤´æ¡çš„å®˜æ–¹å¹³å°ï¼Œæƒé™æ¯”è¾ƒå¤§

![](images/image-20231207114854942.png)

![](images/image-20231002090408535.png)

é¡¹ç›®æ¼”ç¤ºåœ°å€ï¼š
å¹³å°ç®¡ç†ï¼šhttp://heima-admin-java.research.itcast.cn 
è‡ªåª’ä½“ï¼šhttp://heime-media-java.research.itcast.cn 
appç«¯ï¼šhttp://heima-app-java.research.itcast.cn 

#### é¡¹ç›®æœ¯è¯­

- ç”¨æˆ·ï¼šé»‘é©¬å¤´æ¡APPç”¨æˆ·ç«¯ç”¨æˆ·
- è‡ªåª’ä½“äººï¼šé€šè¿‡é»‘é©¬è‡ªåª’ä½“ç³»ç»Ÿå‘é€æ–‡ç« çš„ç”¨æˆ·
- ç®¡ç†å‘˜ï¼šä½¿ç”¨é»‘é©¬å¤´æ¡ç®¡ç†ç³»ç»Ÿçš„ç”¨æˆ·
- Appï¼šé»‘é©¬å¤´æ¡App
- We Mediaï¼šé»‘é©¬å¤´æ¡è‡ªåª’ä½“ç³»ç»Ÿ
- Adminï¼šé»‘é©¬å¤´æ¡ç®¡ç†ç³»ç»Ÿ

#### æŠ€æœ¯æ ˆ

![](images/f3accd2ba01c41b0a9ac98370241eba3.png)





åŸºç¡€å±‚

![](images/image-20231002075147758.png)

æœåŠ¡å±‚

![](images/image-20231002075217399.png)



### nacosç¯å¢ƒæ­å»º

Centos è™šæ‹Ÿæœº

#### dockerå®‰è£…Nacoså®‰è£…

1. ä½¿ç”¨vmè™šæ‹Ÿæœºæ‰“å¼€èµ„æ–™ä¸­çš„contos7é•œåƒ

2. dockeræ‹‰å–é•œåƒ

   ```shell
   docker pull nacos/nacos-server:1.2.0
   ```

3. åˆ›å»ºå®¹å™¨

   ```shell
   docker run --env MODE=standalone --name nacos --restart=always  -d -p 8848:8848 nacos/nacos-server:1.2.0
   ```

> MODE=standalone  å•æœºç‰ˆ
> --restart=always  å¼€æœºå¯åŠ¨
> -p 8848:8848   æ˜ å°„ç«¯å£
> -d åˆ›å»ºä¸€ä¸ªå®ˆæŠ¤å¼å®¹å™¨åœ¨åå°è¿è¡Œ

æŠ¥é”™ï¼š
```
WARNING: The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested

```
å› ä¸ºmacos m1 ï¼Œæ·»åŠ  `--platform linux/arm64`

```shell
docker run --platform linux/arm64 --env MODE=standalone --name nacos --restart=always -d -p 8848:8848 nacos/nacos-server:1.2.0
```



ğŸ”–é—®é¢˜ï¼š

```
Unable to find image 'nacos/nacos-server:1.2.0' locally
1.2.0: Pulling from nacos/nacos-server
Digest: sha256:2db29d58eb4d3235ff55e44d5708c5690a399195c9e0504d79933a12b0a4f9f5
Status: Image is up to date for nacos/nacos-server:1.2.0
docker: image with reference docker.io/nacos/nacos-server:1.2.0 was found but does not match the specified platform: wanted linux/arm64, actual: linux/amd64.
See 'docker run --help'.
```







4. è®¿é—®åœ°å€ï¼šhttp://10.211.55.5:8848/nacos 



ä½¿ç”¨æœ¬åœ°macosä¸Šï¼Œæºç å®‰è£…å¯åŠ¨nacos  `./startup.sh -m standalone` (å•æœºæ¨¡å¼è¿è¡Œ)

http://localhost:8848/nacos

è´¦å·å¯†ç éƒ½æ˜¯nacos




### åˆå§‹å·¥ç¨‹æ­å»º



#### å·¥ç¨‹ä¸»é¢˜ç»“æ„

```
arleadnews								çˆ¶å·¥ç¨‹ï¼Œç»Ÿä¸€ç®¡ç†é¡¹ç›®ä¾èµ–ï¼ˆå®šä¹‰é€šç”¨åŒ…çš„ç‰ˆæœ¬ï¼‰ï¼Œspringboot
		leadnews-common				é€šç”¨é…ç½®
		leadnews-feign-api		feignå¯¹å¤–çš„æ¥å£
		leadnews-model				pojoã€dto
		leadnews-utils				é€šç”¨å·¥å…·
		leadnews-gateway			ç®¡ç†ä¸€ç³»åˆ—ç½‘å…³
		leadnews-service			ç®¡ç†ä¸€ç³»åˆ—å¾®æœåŠ¡
		leadnews-test					æµ‹è¯•æ¡ˆä¾‹
```



#### å…¨å±€å¼‚å¸¸

![](images/image-20231207231920204.png)



### ç™»å½•

#### éœ€æ±‚åˆ†æ

![](images/image-20231207232050429.png)

- ç”¨æˆ·ç‚¹å‡»**å¼€å§‹ä½¿ç”¨**

  ç™»å½•åçš„ç”¨æˆ·æƒé™è¾ƒå¤§ï¼Œå¯ä»¥æŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥æ“ä½œï¼ˆç‚¹èµï¼Œå…³æ³¨ï¼Œè¯„è®ºï¼‰

- ç”¨æˆ·ç‚¹å‡»**ä¸ç™»å½•ï¼Œå…ˆçœ‹çœ‹**

â€‹       æ¸¸å®¢åªæœ‰æŸ¥çœ‹çš„æƒé™

#### è¡¨ç»“æ„åˆ†æ

å…³äºappç«¯ç”¨æˆ·ç›¸å…³çš„å†…å®¹è¾ƒå¤šï¼Œå¯ä»¥å•ç‹¬è®¾ç½®ä¸€ä¸ªåº“leadnews_user

| **è¡¨åç§°**       | **è¯´æ˜**          |
| ---------------- | ----------------- |
| ap_user          | APPç”¨æˆ·ä¿¡æ¯è¡¨     |
| ap_user_fan      | APPç”¨æˆ·ç²‰ä¸ä¿¡æ¯è¡¨ |
| ap_user_follow   | APPç”¨æˆ·å…³æ³¨ä¿¡æ¯è¡¨ |
| ap_user_realname | APPå®åè®¤è¯ä¿¡æ¯è¡¨ |

```mysql
CREATE TABLE `ap_user` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `salt` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'å¯†ç ã€é€šä¿¡ç­‰åŠ å¯†ç›',
  `name` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'ç”¨æˆ·å',
  `password` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'å¯†ç ,md5åŠ å¯†',
  `phone` varchar(11) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'æ‰‹æœºå·',
  `image` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'å¤´åƒ',
  `sex` tinyint unsigned DEFAULT NULL COMMENT '0 ç”·\r\n            1 å¥³\r\n            2 æœªçŸ¥',
  `is_certification` tinyint unsigned DEFAULT NULL COMMENT '0 æœª\r\n            1 æ˜¯',
  `is_identity_authentication` tinyint(1) DEFAULT NULL COMMENT 'æ˜¯å¦èº«ä»½è®¤è¯',
  `status` tinyint unsigned DEFAULT NULL COMMENT '0æ­£å¸¸\r\n            1é”å®š',
  `flag` tinyint unsigned DEFAULT NULL COMMENT '0 æ™®é€šç”¨æˆ·\r\n            1 è‡ªåª’ä½“äºº\r\n            2 å¤§V',
  `created_time` datetime DEFAULT NULL COMMENT 'æ³¨å†Œæ—¶é—´',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC COMMENT='APPç”¨æˆ·ä¿¡æ¯è¡¨';
```

> `tinyint`ç±»å‹ï¼šå 1ä¸ªå­—èŠ‚ï¼Œä¸æŒ‡å®šunsignedï¼ˆéè´Ÿæ•°ï¼‰ï¼Œå€¼èŒƒå›´ï¼ˆ-128,127ï¼‰ï¼ŒæŒ‡å®šäº†unsignedï¼Œå€¼èŒƒå›´ï¼ˆ0,255ï¼‰
>
> tinyinté€šå¸¸è¡¨ç¤ºå°èŒƒå›´çš„æ•°å€¼ï¼Œæˆ–è€…è¡¨ç¤ºtrueæˆ–falseï¼Œé€šå¸¸å€¼ä¸º0è¡¨ç¤ºfalseï¼Œå€¼ä¸º1è¡¨ç¤ºtrue

é¡¹ç›®ä¸­çš„æŒä¹…å±‚ä½¿ç”¨çš„mybatis-plusï¼Œä¸€èˆ¬éƒ½ä½¿ç”¨mybais-plusé€†å‘ç”Ÿæˆå¯¹åº”çš„å®ä½“ç±»

#### æ‰‹åŠ¨åŠ å¯†ï¼ˆmd5+éšæœºå­—ç¬¦ä¸²ï¼‰

md5æ˜¯ä¸å¯é€†åŠ å¯†ï¼Œmd5ç›¸åŒçš„å¯†ç æ¯æ¬¡åŠ å¯†éƒ½ä¸€æ ·ï¼Œä¸å¤ªå®‰å…¨ã€‚åœ¨md5çš„åŸºç¡€ä¸Šæ‰‹åŠ¨åŠ ç›ï¼ˆsaltï¼‰å¤„ç†

æ³¨å†Œ->ç”Ÿæˆç›ï¼ˆå­—æ®µsaltï¼‰ï¼š

![](images/image-20231207233816713.png)

ç™»å½•->ä½¿ç”¨ç›æ¥é…åˆéªŒè¯ï¼š

![](images/image-20231207233934748.png)



#### ç”¨æˆ·ç«¯ï¼ˆè¿è¥ç«¯ï¼‰å¾®æœåŠ¡æ­å»º

åœ¨leadnews-serviceä¸‹åˆ›å»ºå·¥ç¨‹leadnews-user

![](images/image-20231208000352009.png)

```yaml
spring:
  datasource:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/leadnews_user?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&useSSL=false&allowPublicKeyRetrieval=true
      username: root
      password: 33824
# è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: top.andyron.model.user.pojos
```



#### ç™»å½•åŠŸèƒ½å®ç°

##### æ¥å£å®šä¹‰

![](images/image-20231208000615566.png)





å¿«æ·é”®ctrl + a  ï¼ˆctrl + iï¼‰

![](images/image-20231208002436863.png)

##### æ€è·¯åˆ†æ

æµç¨‹ï¼š

![](images/image-20231208002610020.png)

1. ç”¨æˆ·è¾“å…¥äº†ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œç™»å½•ï¼Œæ ¡éªŒæˆåŠŸåè¿”å›jwtï¼ˆåŸºäºå½“å‰ç”¨æˆ·çš„idç”Ÿæˆï¼‰
2. ç”¨æˆ·æ¸¸å®¢ç™»å½•ï¼Œç”Ÿæˆjwtè¿”å›ï¼ˆåŸºäºé»˜è®¤å€¼0ç”Ÿæˆï¼‰



### æ¥å£å·¥å…·postmanã€swaggerã€knife4j



#### swagger

Springå·²ç»å°†Swaggerçº³å…¥è‡ªèº«çš„æ ‡å‡†ï¼Œå»ºç«‹äº†Spring-swaggeré¡¹ç›®ï¼Œç°åœ¨å«Springfoxã€‚é€šè¿‡åœ¨é¡¹ç›®ä¸­å¼•å…¥Springfox ï¼Œå³å¯éå¸¸ç®€å•å¿«æ·çš„ä½¿ç”¨Swaggerã€‚

```xml
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-swagger2</artifactId>
</dependency>
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-swagger-ui</artifactId>
</dependency>
```

åœ¨leadnews-commonä¸­è¿›è¡Œé…ç½®å³å¯ï¼Œå› ä¸ºå…¶ä»–å¾®æœåŠ¡å·¥ç¨‹éƒ½ç›´æ¥æˆ–é—´æ¥ä¾èµ–å³å¯ã€‚



##### swaggerå¸¸ç”¨æ³¨è§£

@Apiï¼šä¿®é¥°æ•´ä¸ªç±»ï¼Œæè¿°Controllerçš„ä½œç”¨  

@ApiOperationï¼šæè¿°ä¸€ä¸ªç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œæˆ–è€…è¯´ä¸€ä¸ªæ¥å£  

@ApiParamï¼šå•ä¸ªå‚æ•°çš„æè¿°ä¿¡æ¯  

@ApiModelï¼šç”¨å¯¹è±¡æ¥æ¥æ”¶å‚æ•°  

@ApiModelPropertyï¼šç”¨å¯¹è±¡æ¥æ”¶å‚æ•°æ—¶ï¼Œæè¿°å¯¹è±¡çš„ä¸€ä¸ªå­—æ®µ  

@ApiResponseï¼šHTTPå“åº”å…¶ä¸­1ä¸ªæè¿°  

@ApiResponsesï¼šHTTPå“åº”æ•´ä½“æè¿°  

@ApiIgnoreï¼šä½¿ç”¨è¯¥æ³¨è§£å¿½ç•¥è¿™ä¸ªAPI  

@ApiError ï¼šå‘ç”Ÿé”™è¯¯è¿”å›çš„ä¿¡æ¯  

@ApiImplicitParamï¼šä¸€ä¸ªè¯·æ±‚å‚æ•°  

@ApiImplicitParamsï¼šå¤šä¸ªè¯·æ±‚å‚æ•°çš„æè¿°ä¿¡æ¯



 @ApiImplicitParamå±æ€§ï¼š

| å±æ€§         | å–å€¼   | ä½œç”¨                                          |
| ------------ | ------ | --------------------------------------------- |
| paramType    |        | æŸ¥è¯¢å‚æ•°ç±»å‹                                  |
|              | path   | ä»¥åœ°å€çš„å½¢å¼æäº¤æ•°æ®                          |
|              | query  | ç›´æ¥è·Ÿå‚æ•°å®Œæˆè‡ªåŠ¨æ˜ å°„èµ‹å€¼                    |
|              | body   | ä»¥æµçš„å½¢å¼æäº¤ ä»…æ”¯æŒPOST                     |
|              | header | å‚æ•°åœ¨request headers é‡Œè¾¹æäº¤                |
|              | form   | ä»¥formè¡¨å•çš„å½¢å¼æäº¤ ä»…æ”¯æŒPOST               |
| dataType     |        | å‚æ•°çš„æ•°æ®ç±»å‹ åªä½œä¸ºæ ‡å¿—è¯´æ˜ï¼Œå¹¶æ²¡æœ‰å®é™…éªŒè¯ |
|              | Long   |                                               |
|              | String |                                               |
| name         |        | æ¥æ”¶å‚æ•°å                                    |
| value        |        | æ¥æ”¶å‚æ•°çš„æ„ä¹‰æè¿°                            |
| required     |        | å‚æ•°æ˜¯å¦å¿…å¡«                                  |
|              | true   | å¿…å¡«                                          |
|              | false  | éå¿…å¡«                                        |
| defaultValue |        | é»˜è®¤å€¼                                        |



å¯åŠ¨å¾®æœåŠ¡ï¼Œè®¿é—® http://localhost:51801/swagger-ui.html

```json
{
  "password": "admin",
  "phone": "13511223456"
}
```



#### knife4j

knife4jæ˜¯ä¸ºJava MVCæ¡†æ¶é›†æˆSwaggerç”ŸæˆApiæ–‡æ¡£çš„å¢å¼ºè§£å†³æ–¹æ¡ˆ,å‰èº«æ˜¯swagger-bootstrap-ui,å–åkni4jæ˜¯å¸Œæœ›å®ƒèƒ½åƒä¸€æŠŠåŒ•é¦–ä¸€æ ·å°å·§,è½»é‡,å¹¶ä¸”åŠŸèƒ½å¼ºæ‚!

giteeåœ°å€ï¼šhttps://gitee.com/xiaoym/knife4j

å®˜æ–¹æ–‡æ¡£ï¼šhttps://doc.xiaominfo.com/

æ•ˆæœæ¼”ç¤ºï¼šhttp://knife4j.xiaominfo.com/doc.html

è¯¥UIå¢å¼ºåŒ…ä¸»è¦åŒ…æ‹¬ä¸¤å¤§æ ¸å¿ƒåŠŸèƒ½ï¼šæ–‡æ¡£è¯´æ˜ å’Œ åœ¨çº¿è°ƒè¯•

- æ–‡æ¡£è¯´æ˜ï¼šæ ¹æ®Swaggerçš„è§„èŒƒè¯´æ˜ï¼Œè¯¦ç»†åˆ—å‡ºæ¥å£æ–‡æ¡£çš„è¯´æ˜ï¼ŒåŒ…æ‹¬æ¥å£åœ°å€ã€ç±»å‹ã€è¯·æ±‚ç¤ºä¾‹ã€è¯·æ±‚å‚æ•°ã€å“åº”ç¤ºä¾‹ã€å“åº”å‚æ•°ã€å“åº”ç ç­‰ä¿¡æ¯ï¼Œä½¿ç”¨swagger-bootstrap-uièƒ½æ ¹æ®è¯¥æ–‡æ¡£è¯´æ˜ï¼Œå¯¹è¯¥æ¥å£çš„ä½¿ç”¨æƒ…å†µä¸€ç›®äº†ç„¶ã€‚
- åœ¨çº¿è°ƒè¯•ï¼šæä¾›åœ¨çº¿æ¥å£è”è°ƒçš„å¼ºå¤§åŠŸèƒ½ï¼Œè‡ªåŠ¨è§£æå½“å‰æ¥å£å‚æ•°,åŒæ—¶åŒ…å«è¡¨å•éªŒè¯ï¼Œè°ƒç”¨å‚æ•°å¯è¿”å›æ¥å£å“åº”å†…å®¹ã€headersã€Curlè¯·æ±‚å‘½ä»¤å®ä¾‹ã€å“åº”æ—¶é—´ã€å“åº”çŠ¶æ€ç ç­‰ä¿¡æ¯ï¼Œå¸®åŠ©å¼€å‘è€…åœ¨çº¿è°ƒè¯•ï¼Œè€Œä¸å¿…é€šè¿‡å…¶ä»–æµ‹è¯•å·¥å…·æµ‹è¯•æ¥å£æ˜¯å¦æ­£ç¡®,ç®€ä»‹ã€å¼ºå¤§ã€‚
- ==ä¸ªæ€§åŒ–é…ç½®==ï¼šé€šè¿‡ä¸ªæ€§åŒ–uié…ç½®é¡¹ï¼Œå¯è‡ªå®šä¹‰UIçš„ç›¸å…³æ˜¾ç¤ºä¿¡æ¯
- ==ç¦»çº¿æ–‡æ¡£==ï¼šæ ¹æ®æ ‡å‡†è§„èŒƒï¼Œç”Ÿæˆçš„åœ¨çº¿markdownç¦»çº¿æ–‡æ¡£ï¼Œå¼€å‘è€…å¯ä»¥è¿›è¡Œæ‹·è´ç”Ÿæˆmarkdownæ¥å£æ–‡æ¡£ï¼Œé€šè¿‡å…¶ä»–ç¬¬ä¸‰æ–¹markdownè½¬æ¢å·¥å…·è½¬æ¢æˆhtmlæˆ–pdfï¼Œè¿™æ ·ä¹Ÿå¯ä»¥æ”¾å¼ƒswagger2markdownç»„ä»¶
- ==æ¥å£æ’åº==ï¼šè‡ª1.8.5åï¼Œuiæ”¯æŒäº†æ¥å£æ’åºåŠŸèƒ½ï¼Œä¾‹å¦‚ä¸€ä¸ªæ³¨å†ŒåŠŸèƒ½ä¸»è¦åŒ…å«äº†å¤šä¸ªæ­¥éª¤,å¯ä»¥æ ¹æ®swagger-bootstrap-uiæä¾›çš„æ¥å£æ’åºè§„åˆ™å®ç°æ¥å£çš„æ’åºï¼ŒstepåŒ–æ¥å£æ“ä½œï¼Œæ–¹ä¾¿å…¶ä»–å¼€å‘è€…è¿›è¡Œæ¥å£å¯¹æ¥

ä½¿ç”¨ï¼š

```xml
<dependency>
     <groupId>com.github.xiaoymin</groupId>
     <artifactId>knife4j-spring-boot-starter</artifactId>
</dependency>
```



```java
@Configuration
@EnableSwagger2
@EnableKnife4j
@Import(BeanValidatorPluginsConfiguration.class)
public class SwaggerConfiguration2 {
```

| æ³¨è§£              | è¯´æ˜                                                         |
| ----------------- | ------------------------------------------------------------ |
| `@EnableSwagger2` | è¯¥æ³¨è§£æ˜¯Springfox-swaggeræ¡†æ¶æä¾›çš„ä½¿ç”¨Swaggeræ³¨è§£ï¼Œè¯¥æ³¨è§£å¿…é¡»åŠ  |
| `@EnableKnife4j`  | è¯¥æ³¨è§£æ˜¯`knife4j`æä¾›çš„å¢å¼ºæ³¨è§£,Uiæä¾›äº†ä¾‹å¦‚åŠ¨æ€å‚æ•°ã€å‚æ•°è¿‡æ»¤ã€æ¥å£æ’åºç­‰å¢å¼ºåŠŸèƒ½,å¦‚æœä½ æƒ³ä½¿ç”¨è¿™äº›å¢å¼ºåŠŸèƒ½å°±å¿…é¡»åŠ è¯¥æ³¨è§£ï¼Œå¦åˆ™å¯ä»¥ä¸ç”¨åŠ  |

```
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  top.andyron.common.exception.ExceptionCatch,\
  top.andyron.common.swagger.SwaggerConfiguration2
```



http://localhost:51801/doc.html

ğŸ”–  ä¸ºä»€ä¹ˆä¼šå’Œswaggerå†²çª



### appç«¯ç½‘å…³

#### ç½‘å…³æ¦‚è¿°

![](images/image-20231208124634676.png)

#### é¡¹ç›®ä¸­ç½‘å…³

```
leadnews-gateway									ç®¡ç†ç½‘å…³
		leadnews-admin-gateway    		ç®¡ç†å¹³å°ç½‘å…³
		leadnews-wemedia-gateway			è‡ªåª’ä½“ç½‘å…³
		leadnews-app-gateway					appç½‘å…³
```



#### å®ç°

- åœ¨leadnews-gateway

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-gateway</artifactId>
    </dependency>
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
     <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
        </dependency>
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt</artifactId>
    </dependency>
</dependencies>
```

- åœ¨leadnews-gatewayä¸‹åˆ›å»ºleadnews-app-gatewayå¾®æœåŠ¡

bootstrap.yml

```yaml
server:
  port: 51601
spring:
  application:
    name: leadnews-app-gateway
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.0.102:8848
      config:
        server-addr: 192.168.0.102:8848
        file-extension: yml
```

åœ¨nacosçš„é…ç½®ä¸­å¿ƒåˆ›å»ºdataidä¸ºleadnews-app-gatewayçš„ymlé…ç½®





```yaml
spring:
  cloud:
    gateway:
      globalcors:
        add-to-simple-url-handler-mapping: true
        corsConfigurations:
          '[/**]':
            allowedHeaders: "*"
            allowedOrigins: "*"
            allowedMethods:
              - GET
              - POST
              - DELETE
              - PUT
              - OPTION
      routes:
        # å¹³å°ç®¡ç†
        - id: user
          uri: lb://leadnews-user
          predicates:
            - Path=/user/**
          filters:
            - StripPrefix= 1
```



ç¯å¢ƒæ­å»ºå®Œæˆä»¥åï¼Œå¯åŠ¨é¡¹ç›®ç½‘å…³å’Œç”¨æˆ·ä¸¤ä¸ªæœåŠ¡ï¼Œä½¿ç”¨postmanè¿›è¡Œæµ‹è¯•

è¯·æ±‚åœ°å€ï¼šhttp://localhost:51601/user/api/v1/login/login_auth   



#### è®¤è¯è¿‡æ»¤å™¨

è®¤è¯è¿‡æ»¤å™¨ç”¨æ¥æ ¡éªŒtokenã€‚

å…¨å±€è¿‡æ»¤å™¨å®ç°jwtæ ¡éªŒ

![](images/image-20231208131031979.png)

åœ¨leandews-app-gatewayä¸­åˆ›å»º`AuthorizeFilter`





### Appå‰ç«¯é›†æˆ

nginxæ–¹å¼é›†æˆå‰ç«¯é¡¹ç›®

![](images/image-20231208133108999.png)





- å‰ç«¯é¡¹ç›®app-web



- é…ç½®nginx

> æ¯ä¸ªé¡¹ç›®å•ç‹¬åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå› ä¸ºä¹‹åè¿˜æœ‰å¾ˆå¤šé¡¹ç›®ã€‚

åœ¨nginxå®‰è£…çš„confç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹`leadnews.conf`,åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸­æ–°å»º`leadnews-app.conf`æ–‡ä»¶:

```nginx
upstream  leadnews-app-gateway {
    server localhost:51601;    # åå‘ä»£ç†åˆ°appç½‘å…³
}

server {
	listen 8801;
	location / {
		root /Users/andyron/myfield/git/ARLeadnews/app-web/;
		index index.html;
	}
	
	location ~/app/(.*) {
		proxy_pass http://leadnews-app-gateway/$1;
		proxy_set_header HOST $host;  # ä¸æ”¹å˜æºè¯·æ±‚å¤´çš„å€¼
		proxy_pass_request_body on;  #å¼€å¯è·å–è¯·æ±‚ä½“
		proxy_pass_request_headers on;  #å¼€å¯è·å–è¯·æ±‚å¤´
		proxy_set_header X-Real-IP $remote_addr;   # è®°å½•çœŸå®å‘å‡ºè¯·æ±‚çš„å®¢æˆ·ç«¯IP
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  #è®°å½•ä»£ç†ä¿¡æ¯
	}
}
```

åœ¨nginx.confä¸­å¼•å…¥`leadnews-app.conf`æ–‡ä»¶ï¼š

```nginx
http {
  # ...
  include leadnews.conf/*.conf;
}
```



- é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶

`nginx -s reload`



- æµ‹è¯•

 http://localhost:8801



> ä»ä¸šåŠ¡è§’åº¦åˆ†æå¦‚ä½•åˆ†è¡¨
>
> æ»šå±åˆ†é¡µçš„é€»è¾‘
>
> æ–‡ç« è¯¦æƒ…-å¤§æ–‡æœ¬é™æ€åŒ–æ–¹æ¡ˆï¼ˆfreemarkerï¼Œminioï¼‰

## 2 appç«¯æ–‡ç« æŸ¥çœ‹ï¼Œé™æ€åŒ–freemarker,åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸminIO

### Appæ–‡ç« åˆ—è¡¨

#### éœ€æ±‚åˆ†æ

æ–‡ç« çš„å¸ƒå±€å±•ç¤º

![](images/image-20231208154204744.png)

æ•°æ®åº“leadnews_article

![](images/image-20231208154431646.png)

```mysql
CREATE TABLE `ap_article` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `title` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'æ ‡é¢˜',
  `author_id` int unsigned DEFAULT NULL COMMENT 'æ–‡ç« ä½œè€…çš„ID',
  `author_name` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'ä½œè€…æ˜µç§°',
  `channel_id` int unsigned DEFAULT NULL COMMENT 'æ–‡ç« æ‰€å±é¢‘é“ID',
  `channel_name` varchar(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'é¢‘é“åç§°',
  `layout` tinyint unsigned DEFAULT NULL COMMENT 'æ–‡ç« å¸ƒå±€\r\n            0 æ— å›¾æ–‡ç« \r\n            1 å•å›¾æ–‡ç« \r\n            2 å¤šå›¾æ–‡ç« ',
  `flag` tinyint unsigned DEFAULT NULL COMMENT 'æ–‡ç« æ ‡è®°\r\n            0 æ™®é€šæ–‡ç« \r\n            1 çƒ­ç‚¹æ–‡ç« \r\n            2 ç½®é¡¶æ–‡ç« \r\n            3 ç²¾å“æ–‡ç« \r\n            4 å¤§V æ–‡ç« ',
  `images` varchar(1000) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'æ–‡ç« å›¾ç‰‡\r\n            å¤šå¼ é€—å·åˆ†éš”',
  `labels` varchar(500) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'æ–‡ç« æ ‡ç­¾æœ€å¤š3ä¸ª é€—å·åˆ†éš”',
  `likes` int unsigned DEFAULT NULL COMMENT 'ç‚¹èµæ•°é‡',
  `collection` int unsigned DEFAULT NULL COMMENT 'æ”¶è—æ•°é‡',
  `comment` int unsigned DEFAULT NULL COMMENT 'è¯„è®ºæ•°é‡',
  `views` int unsigned DEFAULT NULL COMMENT 'é˜…è¯»æ•°é‡',
  `province_id` int unsigned DEFAULT NULL COMMENT 'çœå¸‚',
  `city_id` int unsigned DEFAULT NULL COMMENT 'å¸‚åŒº',
  `county_id` int unsigned DEFAULT NULL COMMENT 'åŒºå¿',
  `created_time` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `publish_time` datetime DEFAULT NULL COMMENT 'å‘å¸ƒæ—¶é—´',
  `sync_status` tinyint(1) DEFAULT '0' COMMENT 'åŒæ­¥çŠ¶æ€',
  `origin` tinyint unsigned DEFAULT '0' COMMENT 'æ¥æº',
  `static_url` varchar(150) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=1383828014629179394 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC COMMENT='æ–‡ç« ä¿¡æ¯è¡¨ï¼Œå­˜å‚¨å·²å‘å¸ƒçš„æ–‡ç« ';
```

![](images/image-20231208155017745.png)

> ä¸ºä»€ä¹ˆæ–‡ç« ä¿¡æ¯è¦æ‹†åˆ†æˆå¤šä¸ªè¡¨ï¼Ÿ

è¡¨çš„æ‹†åˆ†-**å‚ç›´åˆ†è¡¨**

å‚ç›´åˆ†è¡¨ï¼šå°†ä¸€ä¸ªè¡¨çš„å­—æ®µåˆ†æ•£åˆ°å¤šä¸ªè¡¨ä¸­ï¼Œæ¯ä¸ªè¡¨å­˜å‚¨å…¶ä¸­ä¸€éƒ¨åˆ†å­—æ®µã€‚

ä¼˜åŠ¿ï¼š

1. ï»¿ï»¿å‡å°‘IOäº‰æŠ¢ï¼Œå‡å°‘é”è¡¨çš„å‡ ç‡ï¼ŒæŸ¥çœ‹æ–‡ç« æ¦‚è¿°ä¸æ–‡ç« è¯¦æƒ…äº’ä¸å½±å“
2. ï»¿ï»¿ï»¿å……åˆ†å‘æŒ¥é«˜é¢‘æ•°æ®çš„æ“ä½œæ•ˆç‡ï¼Œå¯¹æ–‡ç« æ¦‚è¿°æ•°æ®æ“ä½œçš„é«˜æ•ˆç‡ä¸ä¼šè¢«æ“ä½œæ–‡ç« è¯¦æƒ…æ•°æ®çš„ä½æ•ˆç‡æ‰€æ‹–ç´¯ã€‚

æ‹†åˆ†è§„åˆ™ï¼š

1. ï»¿ï»¿ï»¿æŠŠ**ä¸å¸¸ç”¨çš„å­—æ®µ**å•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨
2. ï»¿ï»¿ï»¿æŠŠtextï¼Œblobç­‰**å¤§å­—æ®µ**æ‹†åˆ†å‡ºæ¥å•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨
3. ï»¿ï»¿ï»¿**ç»å¸¸ç»„åˆæŸ¥è¯¢çš„å­—æ®µ**å•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨ä¸­



#### å®ç°æ€è·¯

![](images/image-20231208155627228.png)

1. åœ¨é»˜è®¤é¢‘é“å±•ç¤º10æ¡æ–‡ç« ä¿¡æ¯

2. å¯ä»¥åˆ‡æ¢é¢‘é“æŸ¥çœ‹ä¸åŒç§ç±»æ–‡ç« 

3. å½“ç”¨æˆ·==ä¸‹æ‹‰==å¯ä»¥åŠ è½½æœ€æ–°çš„æ–‡ç« ï¼ˆåˆ†é¡µï¼‰æœ¬é¡µæ–‡ç« åˆ—è¡¨ä¸­å‘å¸ƒæ—¶é—´ä¸ºæœ€å¤§çš„æ—¶é—´ä¸ºä¾æ®
4. å½“ç”¨æˆ·==ä¸Šæ‹‰==å¯ä»¥åŠ è½½æ›´å¤šçš„æ–‡ç« ä¿¡æ¯ï¼ˆæŒ‰ç…§å‘å¸ƒæ—¶é—´ï¼‰æœ¬é¡µæ–‡ç« åˆ—è¡¨ä¸­å‘å¸ƒæ—¶é—´æœ€å°çš„æ—¶é—´ä¸ºä¾æ®

5. å¦‚æœæ˜¯å½“å‰é¢‘é“çš„é¦–é¡µï¼Œå‰ç«¯ä¼ é€’é»˜è®¤å‚æ•°ï¼š

   `maxBehotTime`:0ï¼ˆæ¯«ç§’ï¼‰

   `minBehotTime`: 20000000000000ï¼ˆæ¯«ç§’ï¼‰2063å¹´

é¦–é¡µé»˜è®¤åŠ è½½å°äº2063å¹´çš„æ•°æ®



#### æ¥å£å®šä¹‰

![](images/image-20231208160713084.png)

#### å®ç°

- åœ¨leadnews-serviceä¸­æ·»åŠ ä¸€ä¸ªæ¨¡å—leadnews-article

```yaml
server:
  port: 51802
spring:
  application:
    name: leadnews-article
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.0.102:8848
      config:
        server-addr: 192.168.0.102:8848
        file-extension: yml
```



- éœ€è¦åœ¨nacosä¸­æ·»åŠ å¯¹åº”çš„é…ç½®

```yaml
spring:
  datasource:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/leadnews_article?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&useSSL=false&allowPublicKeyRetrieval=true
      username: root
      password: 33824
# è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: top.andyron.model.article.pojos
```

![](images/image-20231208162601041.png)

- å®šä¹‰æ¥å£



- ç¼–å†™mapperæ–‡ä»¶

æ–‡ç« è¡¨ä¸æ–‡ç« é…ç½®è¡¨å¤šè¡¨æŸ¥è¯¢



- ç¼–å†™ä¸šåŠ¡å±‚ä»£ç 



- ç¼–å†™æ§åˆ¶å™¨ä»£ç 



- swaggeræµ‹è¯•æˆ–å‰åç«¯è”è°ƒæµ‹è¯•

é¦–é¡µè¦åœ¨appç½‘å…³çš„nacosé…ç½®ä¸­å¿ƒæ·»åŠ æ–‡ç« å¾®æœåŠ¡çš„è·¯ç”±ï¼š

```yaml

				# æ–‡ç« å¾®æœåŠ¡
        - id: article
          uri: lb://leadnews-article
          predicates:
            - Path=/article/**
          filters:
            - StripPrefix= 1
```

å¯åŠ¨ç½‘å…³ã€userã€articleå¾®æœåŠ¡



### æ–‡ç« è¯¦æƒ…-å®ç°æ–¹æ¡ˆåˆ†æ

#### æ–¹æ¡ˆ1

æ ¹æ®æ–‡ç« çš„idå»æŸ¥è¯¢æ–‡ç« å†…å®¹è¡¨ï¼Œè¿”å›æ¸²æŸ“é¡µé¢

![](images/image-20231208175801032.png)

#### æ–¹æ¡ˆ2-é™æ€æ¨¡æ¿å±•ç¤º 

![](images/image-20231208175735636.png)



### freemarker

#### æ¨¡æ¿å¼•æ“

![](images/image-20231208181155299.png)

[FreeMarker](https://github.com/apache/freemarker) æ˜¯ä¸€æ¬¾ æ¨¡æ¿å¼•æ“ï¼š å³ä¸€ç§åŸºäºæ¨¡æ¿å’Œè¦æ”¹å˜çš„æ•°æ®ï¼Œ å¹¶ç”¨æ¥ç”Ÿæˆè¾“å‡ºæ–‡æœ¬(==HTMLç½‘é¡µï¼Œç”µå­é‚®ä»¶ï¼Œé…ç½®æ–‡ä»¶ï¼Œæºä»£ç ==ç­‰)çš„é€šç”¨å·¥å…·ã€‚ å®ƒ**==ä¸æ˜¯é¢å‘æœ€ç»ˆç”¨æˆ·çš„==**ï¼Œè€Œæ˜¯ä¸€ä¸ªJavaç±»åº“ï¼Œæ˜¯ä¸€æ¬¾ç¨‹åºå‘˜å¯ä»¥åµŒå…¥ä»–ä»¬æ‰€å¼€å‘äº§å“çš„ç»„ä»¶ã€‚

æ¨¡æ¿ç¼–å†™ä¸ºFreeMarker Template Language (FTL)ã€‚å®ƒæ˜¯ç®€å•çš„ï¼Œä¸“ç”¨çš„è¯­è¨€ï¼Œ *ä¸æ˜¯* åƒPHPé‚£æ ·æˆç†Ÿçš„ç¼–ç¨‹è¯­è¨€ã€‚ é‚£å°±æ„å‘³ç€è¦å‡†å¤‡æ•°æ®åœ¨çœŸå®ç¼–ç¨‹è¯­è¨€ä¸­æ¥æ˜¾ç¤ºï¼Œæ¯”å¦‚æ•°æ®åº“æŸ¥è¯¢å’Œä¸šåŠ¡è¿ç®—ï¼Œ ä¹‹åæ¨¡æ¿æ˜¾ç¤ºå·²ç»å‡†å¤‡å¥½çš„æ•°æ®ã€‚åœ¨æ¨¡æ¿ä¸­ï¼Œä½ å¯ä»¥ä¸“æ³¨äºå¦‚ä½•å±•ç°æ•°æ®ï¼Œ è€Œåœ¨æ¨¡æ¿ä¹‹å¤–å¯ä»¥ä¸“æ³¨äºè¦å±•ç¤ºä»€ä¹ˆæ•°æ®ã€‚ 

#### æŠ€æœ¯é€‰å‹å¯¹æ¯”

å¸¸ç”¨çš„javaæ¨¡æ¿å¼•æ“è¿˜æœ‰å“ªäº›ï¼Ÿ

Jspã€Freemarkerã€Thymeleaf ã€Velocity ç­‰ã€‚

1. Jsp ä¸º Servlet ä¸“ç”¨ï¼Œä¸èƒ½å•ç‹¬è¿›è¡Œä½¿ç”¨ã€‚

2. Thymeleaf ä¸ºæ–°æŠ€æœ¯ï¼ŒåŠŸèƒ½è¾ƒä¸ºå¼ºå¤§ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ•ˆç‡æ¯”è¾ƒä½ã€‚

3. Velocityä»2010å¹´æ›´æ–°å®Œ 2.0 ç‰ˆæœ¬åï¼Œä¾¿æ²¡æœ‰åœ¨æ›´æ–°ã€‚Spring Boot å®˜æ–¹åœ¨ 1.4 ç‰ˆæœ¬åå¯¹æ­¤ä¹Ÿä¸åœ¨æ”¯æŒï¼Œè™½ç„¶ Velocity åœ¨ 2017 å¹´ç‰ˆæœ¬å¾—åˆ°è¿­ä»£ï¼Œä½†ä¸ºæ—¶å·²æ™šã€‚ 

#### ç¯å¢ƒæ­å»º-å¿«é€Ÿå…¥é—¨

freemarkerä½œä¸ºspringmvcä¸€ç§è§†å›¾æ ¼å¼ï¼Œé»˜è®¤æƒ…å†µä¸‹SpringMVCæ”¯æŒfreemarkerè§†å›¾æ ¼å¼ã€‚

- åˆ›å»ºä¸€ä¸ªfreemarker-demo çš„æµ‹è¯•å·¥ç¨‹ä¸“é—¨ç”¨äºfreemarkerçš„åŠŸèƒ½æµ‹è¯•ä¸æ¨¡æ¿çš„æµ‹è¯•ã€‚

```xml
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-freemarker</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
        </dependency>
        <!-- lombok -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>

        <!-- apache å¯¹ java io çš„å°è£…å·¥å…·åº“ -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-io</artifactId>
            <version>1.3.2</version>
        </dependency>
    </dependencies>
```

- é…ç½®æ–‡ä»¶application.yml

```yaml
server:
  port: 8881 #æœåŠ¡ç«¯å£
spring:
  application:
    name: freemarker-demo #æŒ‡å®šæœåŠ¡å
  freemarker:
    cache: false  #å…³é—­æ¨¡æ¿ç¼“å­˜ï¼Œæ–¹ä¾¿æµ‹è¯•
    settings:
      template_update_delay: 0 #æ£€æŸ¥æ¨¡æ¿æ›´æ–°å»¶è¿Ÿæ—¶é—´ï¼Œè®¾ç½®ä¸º0è¡¨ç¤ºç«‹å³æ£€æŸ¥ï¼Œå¦‚æœæ—¶é—´å¤§äº0ä¼šæœ‰ç¼“å­˜ä¸æ–¹ä¾¿è¿›è¡Œæ¨¡æ¿æµ‹è¯•
    suffix: .ftl               #æŒ‡å®šFreemarkeræ¨¡æ¿æ–‡ä»¶çš„åç¼€å
```

- åˆ›å»ºæ¨¡å‹ç±»
- åˆ›å»ºæ¨¡æ¿

åœ¨resourcesä¸‹åˆ›å»º`templates`ï¼Œæ­¤ç›®å½•ä¸ºfreemarkerçš„é»˜è®¤æ¨¡æ¿å­˜æ”¾ç›®å½•ã€‚

åœ¨templatesä¸‹åˆ›å»ºæ¨¡æ¿æ–‡ä»¶ 01-basic.ftlï¼Œæ¨¡æ¿ä¸­çš„==æ’å€¼è¡¨è¾¾å¼==æœ€ç»ˆä¼šè¢«freemarkeræ›¿æ¢æˆå…·ä½“çš„æ•°æ®ã€‚

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World!</title>
</head>
<body>
<b>æ™®é€šæ–‡æœ¬ String å±•ç¤ºï¼š</b><br><br>
Hello ${name} <br>
<hr>
<b>å¯¹è±¡Studentä¸­çš„æ•°æ®å±•ç¤ºï¼š</b><br/>
å§“åï¼š${stu.name}<br/>
å¹´é¾„ï¼š${stu.age}
<hr>
</body>
</html>
```

- åˆ›å»ºcontroller

- åˆ›å»ºå¯åŠ¨ç±»

- æµ‹è¯•

http://localhost:8881/basic

![](images/image-20231208182656467.png)



freemarkeræ¨¡æ¿æ–‡ä»¶é€šå¸¸éƒ½æ˜¯ä»¥ftlä½œä¸ºæ‰©å±•åï¼Œä¹Ÿå¯ä»¥ä¸ºhtmlã€xmlã€jspç­‰

`FreeMarkerAutoConfiguration`

`FreeMarkerProperties`



#### FreemarkeræŒ‡ä»¤è¯­æ³•

##### åŸºç¡€è¯­æ³•ç§ç±»

- æ³¨é‡Š

```velocity
<#-- æˆ‘æ˜¯ä¸€ä¸ªfreemarkeræ³¨é‡Š -->
```

- æ’å€¼ï¼ˆInterpolationï¼‰ï¼šå³ **`${..}`** éƒ¨åˆ†,freemarkerä¼šç”¨çœŸå®çš„å€¼ä»£æ›¿**`${..}`**

```velocity
Hello ${name}
```

- ==FTLæŒ‡ä»¤==ï¼šå’ŒHTMLæ ‡è®°ç±»ä¼¼ï¼Œåå­—å‰åŠ #äºˆä»¥åŒºåˆ†ï¼ŒFreemarkerä¼šè§£ææ ‡ç­¾ä¸­çš„è¡¨è¾¾å¼æˆ–é€»è¾‘ã€‚

```html
<# >FTLæŒ‡ä»¤</#> 
```

æœ‰å¾ˆå¤šFTLæŒ‡ä»¤

- æ–‡æœ¬ï¼Œä»…æ–‡æœ¬ä¿¡æ¯ï¼Œè¿™äº›ä¸æ˜¯freemarkerçš„æ³¨é‡Šã€æ’å€¼ã€FTLæŒ‡ä»¤çš„å†…å®¹ä¼šè¢«freemarkerå¿½ç•¥è§£æï¼Œç›´æ¥è¾“å‡ºå†…å®¹ã€‚

```velocity
<#--freemarkerä¸­çš„æ™®é€šæ–‡æœ¬-->
æˆ‘æ˜¯ä¸€ä¸ªæ™®é€šçš„æ–‡æœ¬
```



##### é›†åˆæŒ‡ä»¤ï¼ˆListå’ŒMapï¼‰

```html
<#list></#list>
```

List:

```html
    <#list stus as stu >
      <tr>
        <td>${stu_index}</td>
        <td>${stu.name}</td>
        <td>${stu.age}</td>
        <td>${stu.money}</td>
      </tr>
    </#list>
```

`${k_index}`å¾—åˆ°å¾ªç¯çš„ä¸‹è¡¨ï¼Œä»0å¼€å§‹ï¼Œæ˜¯stuåŠ ä¸Š`_index`ã€‚

è·å–mapä¸­çš„å€¼ï¼š

```
map["keyname"].property
map.keyname.property
```

éå†mapï¼š

```html
		<#list stuMap?keys as key >
        <tr>
            <td>${key_index}</td>
            <td>${stuMap[key].name}</td>
            <td>${stuMap[key].age}</td>
            <td>${stuMap[key].money}</td>
        </tr>
    </#list>
```



##### ifæŒ‡ä»¤

```html
<#if expression>
<#else>
</#if>
```



```html
<table>
    <tr>
        <td>å§“å</td>
        <td>å¹´é¾„</td>
        <td>é’±åŒ…</td>
    </tr>
    <#list stus as stu >
        <#if stu.name='å°çº¢'>
            <tr style="color: red">
                <td>${stu_index}</td>
                <td>${stu.name}</td>
                <td>${stu.age}</td>
                <td>${stu.money}</td>
            </tr>
            <#else >
            <tr>
                <td>${stu_index}</td>
                <td>${stu.name}</td>
                <td>${stu.age}</td>
                <td>${stu.money}</td>
            </tr>
        </#if>
    </#list>
</table>
```



##### è¿ç®—ç¬¦

- ç®—æ•°è¿ç®—ç¬¦

é™¤äº† + è¿ç®—ä»¥å¤–ï¼Œå…¶ä»–çš„è¿ç®—åªèƒ½å’Œ number æ•°å­—ç±»å‹çš„è®¡ç®—ã€‚

```html
<b>ç®—æ•°è¿ç®—ç¬¦</b>
<br/><br/>
    100+5 è¿ç®—ï¼š  ${100 + 5 }<br/>
    100 - 5 * 5è¿ç®—ï¼š${100 - 5 * 5}<br/>
    5 / 2è¿ç®—ï¼š${5 / 2}<br/>
    12 % 10è¿ç®—ï¼š${12 % 10}<br/>
<hr>
```

- æ¯”è¾ƒè¿ç®—ç¬¦

![](images/image-20231208190601994.png)

![](images/image-20231208190638809.png)



- é€»è¾‘è¿ç®—ç¬¦

```html
<b>é€»è¾‘è¿ç®—ç¬¦</b>
    <br/>
    <br/>
    <#if (10 lt 12 )&&( 10  gt  5 )  >
        (10 lt 12 )&&( 10  gt  5 )  æ˜¾ç¤ºä¸º true
    </#if>
    <br/>
    <br/>
    <#if !false>
        false å–åä¸ºtrue
    </#if>
<hr>
```



##### ç©ºå€¼å¤„ç†

- åˆ¤æ–­æŸå˜é‡æ˜¯å¦å­˜åœ¨ä½¿ç”¨ â€œ`??`â€

```html
    <#if stus??>
    </#if>
```

- ç¼ºå¤±å˜é‡é»˜è®¤å€¼ä½¿ç”¨ â€œ`!`â€

ä½¿ç”¨!è¦ä»¥æŒ‡å®šä¸€ä¸ªé»˜è®¤å€¼ï¼Œå½“å˜é‡ä¸ºç©ºæ—¶æ˜¾ç¤ºé»˜è®¤å€¼ï¼Œ `${name!''}`è¡¨ç¤ºå¦‚æœnameä¸ºç©ºæ˜¾ç¤ºç©ºå­—ç¬¦ä¸²ã€‚

å¦‚æœæ˜¯åµŒå¥—å¯¹è±¡åˆ™å»ºè®®ä½¿ç”¨ï¼ˆï¼‰æ‹¬èµ·æ¥ï¼Œä¾‹ï¼š `${(stu.bestFriend.name)!''}`è¡¨ç¤ºï¼Œå¦‚æœstuæˆ–bestFriendæˆ–nameä¸ºç©ºé»˜è®¤æ˜¾ç¤ºç©ºå­—ç¬¦ä¸²ã€‚



##### å†…å»ºå‡½æ•°

å†…å»ºå‡½æ•°è¯­æ³•æ ¼å¼ï¼š `å˜é‡+?+å‡½æ•°åç§°` 

- é›†åˆçš„å¤§å°

  `${é›†åˆå?size}`

- æ—¥æœŸæ ¼å¼åŒ–

  æ˜¾ç¤ºå¹´æœˆæ—¥: `${today?date}`
  æ˜¾ç¤ºæ—¶åˆ†ç§’ï¼š`${today?time}`
  æ˜¾ç¤ºæ—¥æœŸ+æ—¶é—´ï¼š`${today?datetime}`
  è‡ªå®šä¹‰æ ¼å¼åŒ–ï¼š  `${today?string("yyyyå¹´MMæœˆ")}`

- å†…å»ºå‡½æ•°`c`

  ```java
  model.addAttribute("point", 102920122);
  ```

  pointæ˜¯æ•°å­—å‹ï¼Œä½¿ç”¨${point}ä¼šæ˜¾ç¤ºè¿™ä¸ªæ•°å­—çš„å€¼ï¼Œæ¯ä¸‰ä½ä½¿ç”¨é€—å·åˆ†éš”ã€‚

  å¦‚æœä¸æƒ³æ˜¾ç¤ºä¸ºæ¯ä¸‰ä½åˆ†éš”çš„æ•°å­—ï¼Œå¯ä»¥ä½¿ç”¨cå‡½æ•°å°†æ•°å­—å‹è½¬æˆå­—ç¬¦ä¸²è¾“å‡º

  `${point?c}`

- å°†jsonå­—ç¬¦ä¸²è½¬æˆå¯¹è±¡

 assignæ ‡ç­¾ï¼Œassignçš„ä½œç”¨æ˜¯å®šä¹‰ä¸€ä¸ªå˜é‡

```html
<#assign text="{'bank':'å·¥å•†é“¶è¡Œ','account':'10101920201920212'}" />
<#assign data=text?eval />
å¼€æˆ·è¡Œï¼š${data.bank}  è´¦å·ï¼š${data.account}
```

#### è¾“å‡ºé™æ€åŒ–æ–‡ä»¶

ä½¿ç”¨freemarkderåŸå§‹apiè®²é¡µé¢ç”Ÿæˆhtmlæ–‡ä»¶

![](images/image-20231208191831939.png)

```java
Template template = configuration.getTemplate("02-list.ftl");

// åˆæˆæ–¹æ³•
// ç¬¬ä¸€ä¸ªå‚æ•°ï¼šæ¨¡å‹æ•°æ®
// ç¬¬äºŒä¸ªå‚æ•°ï¼šè¾“å‡ºæµ
template.process(getData(), new FileWriter("/Users/andyron/Downloads/list.html"));

```



### å¯¹è±¡å­˜å‚¨æœåŠ¡MinIO 

åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ

#### å¯¹è±¡å­˜å‚¨çš„æ–¹å¼å¯¹æ¯”

![](images/image-20231208193311299.png)

#### åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ

![](images/image-20231208193622650.png)

#### MinIOç®€ä»‹

[MinIO](https://github.com/minio/minio)åŸºäºApache License v2.0å¼€æºåè®®çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œå¯ä»¥åšä¸ºäº‘å­˜å‚¨çš„è§£å†³æ–¹æ¡ˆç”¨æ¥ä¿å­˜æµ·é‡çš„å›¾ç‰‡ï¼Œè§†é¢‘ï¼Œæ–‡æ¡£ã€‚

- Golangå®ç°ï¼Œé…ç½®ç®€å•ï¼Œå•è¡Œå‘½ä»¤å¯ä»¥è¿è¡Œèµ·æ¥ã€‚

- MinIOå…¼å®¹äºšé©¬é€ŠS3äº‘å­˜å‚¨æœåŠ¡æ¥å£ï¼ˆä¹‹åä¸æƒ³è‡ªå·±ç»´æŠ¤äº†ï¼Œå¯ä»¥ç›´æ¥å°†å…¶éƒ¨ç½²åˆ°äº‘ä¸Šï¼‰ï¼Œéå¸¸é€‚åˆäºå­˜å‚¨å¤§å®¹é‡éç»“æ„åŒ–çš„æ•°æ®ï¼Œä¾‹å¦‚å›¾ç‰‡ã€è§†é¢‘ã€æ—¥å¿—æ–‡ä»¶ã€å¤‡ä»½æ•°æ®å’Œå®¹å™¨/è™šæ‹Ÿæœºé•œåƒç­‰ï¼Œè€Œä¸€ä¸ªå¯¹è±¡æ–‡ä»¶å¯ä»¥æ˜¯ä»»æ„å¤§å°ï¼Œä»å‡ kbåˆ°æœ€å¤§5Tä¸ç­‰ã€‚

**S3 ï¼ˆ Simple Storage Serviceç®€å•å­˜å‚¨æœåŠ¡ï¼‰**  ä¸€ç§äº‘æ ‡å‡†

MinIOåŸºæœ¬æ¦‚å¿µ

- bucket â€“ ç±»æ¯”äºæ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•
- Object â€“ ç±»æ¯”æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶
- Keys â€“ ç±»æ¯”æ–‡ä»¶å

å®˜ç½‘æ–‡æ¡£ï¼šhttp://docs.minio.org.cn/docs/

MinIOç‰¹ç‚¹ï¼š 

- æ•°æ®ä¿æŠ¤

  Minioä½¿ç”¨Minio Erasure Codeï¼ˆçº åˆ ç ï¼‰æ¥é˜²æ­¢ç¡¬ä»¶æ•…éšœã€‚å³ä¾¿æŸåä¸€åŠä»¥ä¸Šçš„driverï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä»ä¸­æ¢å¤ã€‚

- é«˜æ€§èƒ½

  ä½œä¸ºé«˜æ€§èƒ½å¯¹è±¡å­˜å‚¨ï¼Œåœ¨æ ‡å‡†ç¡¬ä»¶æ¡ä»¶ä¸‹å®ƒèƒ½è¾¾åˆ°55GB/sçš„è¯»ã€35GB/sçš„å†™é€Ÿç‡

- å¯æ‰©å®¹

  ä¸åŒMinIOé›†ç¾¤å¯ä»¥ç»„æˆè”é‚¦ï¼Œå¹¶å½¢æˆä¸€ä¸ªå…¨å±€çš„å‘½åç©ºé—´ï¼Œå¹¶è·¨è¶Šå¤šä¸ªæ•°æ®ä¸­å¿ƒ

- SDKæ”¯æŒ

  åŸºäºMinioè½»é‡çš„ç‰¹ç‚¹ï¼Œå®ƒå¾—åˆ°ç±»ä¼¼Javaã€Pythonæˆ–Goç­‰è¯­è¨€çš„sdkæ”¯æŒ

- æœ‰æ“ä½œé¡µé¢

  é¢å‘ç”¨æˆ·å‹å¥½çš„ç®€å•æ“ä½œç•Œé¢ï¼Œéå¸¸æ–¹ä¾¿çš„ç®¡ç†BucketåŠé‡Œé¢çš„æ–‡ä»¶èµ„æº

- åŠŸèƒ½ç®€å•

  è¿™ä¸€è®¾è®¡åŸåˆ™è®©MinIOä¸å®¹æ˜“å‡ºé”™ã€æ›´å¿«å¯åŠ¨

- ä¸°å¯Œçš„API

  æ”¯æŒæ–‡ä»¶èµ„æºçš„åˆ†äº«è¿æ¥åŠåˆ†äº«é“¾æ¥çš„è¿‡æœŸç­–ç•¥ã€å­˜å‚¨æ¡¶æ“ä½œã€æ–‡ä»¶åˆ—è¡¨è®¿é—®åŠæ–‡ä»¶ä¸Šä¼ ä¸‹è½½çš„åŸºæœ¬åŠŸèƒ½ç­‰ã€‚

- æ–‡ä»¶å˜åŒ–ä¸»åŠ¨é€šçŸ¥

  å­˜å‚¨æ¡¶ï¼ˆBucketï¼‰å¦‚æœå‘ç”Ÿæ”¹å˜,æ¯”å¦‚ä¸Šä¼ å¯¹è±¡å’Œåˆ é™¤å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨å­˜å‚¨æ¡¶äº‹ä»¶é€šçŸ¥æœºåˆ¶è¿›è¡Œç›‘æ§ï¼Œå¹¶é€šè¿‡ä»¥ä¸‹æ–¹å¼å‘å¸ƒå‡ºå»:AMQPã€MQTTã€Elasticsearchã€Redisã€NATSã€MySQLã€Kafkaã€Webhooksç­‰ã€‚



#### MinIOå®‰è£…

dockerå®‰è£…MinIOn

- `docker pull minio/minio`
- åˆ›å»ºå®¹å™¨

```shell
docker run -p 9000:9000 --name minio -d --restart=always -e "MINIO_ACCESS_KEY=minio" -e "MINIO_SECRET_KEY=minio123" -v /home/data:/data -v /home/config:/root/.minio minio/minio server /data
```

- è®¿é—®minio

```shell
docker run -p 9000:9000 --name minio -d --restart=always -e "MINIO_ROOT_USER=minio" -e "MINIO_ROOT_PASSWORD=minio123" -v /home/data:/data -v /home/config:/root/.minio minio/minio server /data
```

è®¿é—®æŠ¥é”™

```
Warning: The standard parity is set to 0. This can lead to data loss.
```

> åœ¨macosæœ¬åœ°éƒ¨ç½²minios
>
> ```shell
> curl -O https://dl.minio.org.cn/server/minio/release/darwin-arm64/minio
> chmod +x ./minio
> ```
>
> ä¸‹è½½ï¼Œåªæ˜¯å•ä¸€æ‰§è¡Œæ–‡ä»¶ã€‚
>
> è¿è¡Œï¼Œé…ç½®ä¸€äº›å‚æ•°
>
> ```shell
> ./minio server --config-dir=/Users/andyron/myfield/env/minio/config --address=:9000 /Users/andyron/myfield/env/minio/data
> ```
>
> minioadmin
>
> minioadmin
>
> è®¿é—®æœ¬åœ°9000ç«¯å£å³å¯ http://192.168.0.102:9000





#### minioå¿«é€Ÿå…¥é—¨

åˆ›å»ºæ¨¡å—minio-demo

```java

        try {
            FileInputStream fileInputStream = new FileInputStream("/Users/andyron/myfield/tmp/list.html"); 

            // 1 åˆ›å»ºminioé“¾æ¥å®¢æˆ·ç«¯
            MinioClient minioClient = MinioClient.builder().credentials("minioadmin", "minioadmin")
                    .endpoint("http://192.168.0.102:9000").build();
            // 2 ä¸Šä¼ 
            PutObjectArgs objectArgs = PutObjectArgs.builder()
                    .object("list.html")        // æ–‡ä»¶å
                    .contentType("text/html")         // æ–‡ä»¶ç±»å‹
                    .bucket("leadnews")         // æ¡¶åç§°ï¼Œä¸åœ¨minioç®¡ç†ç•Œé¢åˆ›å»ºçš„æ¡¶ä¸€è‡´
                    // -1 è¡¨ç¤ºä¸Šä¼ æ‰€æœ‰
                    .stream(fileInputStream, fileInputStream.available(), -1)
                    .build();
            minioClient.putObject(objectArgs);

            // è®¿é—®è·¯å¾„
            System.out.println("http://192.168.0.102:9000/leadnews/list.html");
        } catch (Exception e) {
            e.printStackTrace();
        }
```

éœ€è¦è®¾ç½®ä¸‹é€šé“è®¿é—®æƒé™ï¼Œç„¶åä¸Šä¼ é¢æ–‡ä»¶å°±èƒ½åœ¨æµè§ˆå™¨ç›´æ¥è®¿é—®äº†

![](images/iShot_2023-12-08_22.41.39.png)

http://192.168.0.102:9000/leadnews/list.html



#### å°è£…MinIOä¸ºstarter

ä¸ºä»€ä¹ˆéœ€è¦å°è£…MinIOä¸ºstarterï¼Ÿ

![](images/image-20231208224521367.png)

> [p39 2:30](https://www.bilibili.com/video/BV1Qs4y1v7x4?p=39&vd_source=634715056d593def3fe15c44fd54e180)  å½“éœ€è¦æ‹·è´ç›®å½•åˆ°é¡¹ç›®ä¸­å˜æˆæ¨¡å—ï¼Œæ€ä¹ˆæ“ä½œ â¤ï¸



- å»ºç«‹ä¸¤ä¸ªæ¨¡å—

```
leadnews-basic
		file-starter
```



```xml
				<dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-autoconfigure</artifactId>
        </dependency>
        <dependency>
            <groupId>io.minio</groupId>
            <artifactId>minio</artifactId>
            <version>7.1.0</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-configuration-processor</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
```



```
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  top.andyron.file.service.impl.MinIOFileStorageService
```



##### æµ‹è¯•å°è£…çš„starter

- åœ¨minio-demoä¸­å¼•å…¥è‡ªå®šä¹‰çš„starter

```xml
				<dependency>
            <groupId>top.andyron</groupId>
            <artifactId>file-starter</artifactId>
            <version>0.0.1-SNAPSHOT</version>
        </dependency>
```

- åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œé…ç½®å±æ€§ä¸è‡ªå®šä¹‰çš„`MinIOConfigProperties`ä¸€è‡´

```yaml
minio:
  accessKey: minioadmin
  secretKey: minioadmin
  bucket: leadnews
  endpoint: http://192.168.0.102:9000
  readPath: http://192.168.0.102:9000
```



- æµ‹è¯•ï¼Œæ³¨å…¥`FileStorageService`ä½¿ç”¨ï¼š

```java
@SpringBootTest(classes = MinIOApplication.class)
@RunWith(SpringRunner.class)
public class MinIOTest {

    @Autowired
    private FileStorageService fileStorageService;
    // æµ‹è¯•è‡ªå®šä¹‰starter
    @Test
    public void test() throws FileNotFoundException {
        FileInputStream fileInputStream = new FileInputStream("/Users/andyron/myfield/tmp/list.html");
        String path = fileStorageService.uploadHtmlFile("", "list.html", fileInputStream);
        System.out.println(path);
    }
}
```

ä¸Šä¼ æ–‡ä»¶åˆ°MinIOï¼Œå¹¶è¿”å›äº†è®¿é—®åœ°å€ http://192.168.0.102:9000/leadnews/2023/12/08/list.html 





### æ–‡ç« è¯¦æƒ…

#### å®ç°æ­¥éª¤

1. åœ¨artileå¾®æœåŠ¡ä¸­æ·»åŠ MinIOå’Œfreemarkerçš„æ”¯æŒï¼Œå‚è€ƒæµ‹è¯•é¡¹ç›®

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-freemarker</artifactId>
</dependency>
<dependency>
  <groupId>top.andyron</groupId>
  <artifactId>file-starter</artifactId>
  <version>0.0.1-SNAPSHOT</version>
</dependency>
```

åœ¨nacosä¸­çš„æ–‡ç« å¾®æœåŠ¡æ·»åŠ å¤‡æ³¨ï¼š

```yaml
minio:
  accessKey: minioadmin
  secretKey: minioadmin
  bucket: leadnews
  endpoint: http://192.168.0.102:9000
  readPath: http://192.168.0.102:9000
```





2. åˆ›å»ºæ¨¡æ¿æ–‡ä»¶ï¼ˆarticle.ftlï¼‰



3. åˆ›å»ºindex.jså’Œindex.cssæ–‡ä»¶ï¼Œæ‰‹åŠ¨ä¸Šä¼ åˆ°MinIOèŒå·¥



4. åœ¨artileå¾®æœåŠ¡ä¸­æ–°å¢æµ‹è¯•ç±»ï¼ˆåæœŸæ–°å¢æ–‡ç« çš„æ—¶å€™åˆ›å»ºè¯¦æƒ…é™æ€é¡µï¼Œç›®å‰æš‚æ—¶æ‰‹åŠ¨ç”Ÿæˆï¼‰

```java
				// 1 è·å–æ–‡ç« å†…å®¹
        ApArticleContent apArticleContent = apArticleContentMapper
                .selectOne(Wrappers.<ApArticleContent>lambdaQuery()
                .eq(ApArticleContent::getArticleId, "1383828014629179393"));
        if (apArticleContent != null && StringUtils.isNotBlank(apArticleContent.getContent())) {
            //2 æ–‡ç« å†…å®¹é€šè¿‡freemarkerç”Ÿæˆhtmlæ–‡ä»¶
            Template template = configuration.getTemplate("article.ftl");
            // æ•°æ®æ¨¡å‹
            Map<String, Object> content = new HashMap<>();
            content.put("content", JSONArray.parseArray(apArticleContent.getContent()));
            StringWriter out = new StringWriter();
            template.process(content, out);

            //3 æŠŠhtmlæ–‡ä»¶ä¸Šä¼ åˆ°minioä¸­
            InputStream in = new ByteArrayInputStream(out.toString().getBytes());
            String path = fileStorageService.uploadHtmlFile("", apArticleContent.getArticleId() + ".html", in);

            //4 ä¿®æ”¹ap_articleè¡¨ï¼Œä¿å­˜static_urlå­—æ®µ
            apArticleService.update(Wrappers.<ApArticle>lambdaUpdate()
                    .eq(ApArticle::getId, apArticleContent.getArticleId())
                    .set(ApArticle::getStaticUrl, path));

        }
```





ğŸ”– ç”Ÿæˆhtmlä¸­ä¸€äº›å‚æ•°æ²¡æœ‰ 

> è‡ªåª’ä½“ç¯å¢ƒ
>
> â€‹	åå°ç¯å¢ƒ
>
> â€‹	å‰å°ç¯å¢ƒ
>
> ç´ æç®¡ç†
>
> â€‹	minIOçš„å›¾ç‰‡ä¸Šä¼ 
>
> â€‹	å¾®æœåŠ¡ä¸­è·å–ç”¨æˆ·çš„æ–¹å¼
>
> â€‹	æ‹¦æˆªå™¨çš„ä½¿ç”¨
>
> æ–‡ç« ç®¡ç†
>
> â€‹	å¤šæ¡ä»¶æŸ¥è¯¢
>
> â€‹	å¤æ‚ä¸šåŠ¡çš„å¤„ç†ï¼ˆæ–‡ç« å‘å¸ƒï¼‰
>
> â€‹	jdk8ä¸­çš„æ–°ç‰¹æ€§

## 3 è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ

### è‡ªåª’ä½“å‰åç«¯æ­å»º

#### åå°æ­å»º

```
arleandnews-service
		leandnews-service
				leandnews-wemedia
		leandnews-gateway
				leandnews-wemedia-gateway
```

æ­å»ºæ­¥éª¤

1. åŸºç¡€ç¯å¢ƒå’Œæ•°æ®å‡†å¤‡

æ•°æ®åº“leadnews_wemedia

åœ¨leandnews-modelæ¨¡å—ä¸­æ·»åŠ å¯¹åº”ç›¸åº”é…ç½®

2. leandnews-wemediaæ¨¡å—

æ·»åŠ ç›¸åº”nacosé…ç½®

```yaml
spring:
  datasource:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/leadnews_wemedia?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&useSSL=false&allowPublicKeyRetrieval=true
      username: root
      password: 33824
# è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: top.andyron.model.wemedia.pojos

```





3. leandnews-wemedia-gatewayæ¨¡å—

æ·»åŠ å¯¹åº”nacosé…ç½®

```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]': # åŒ¹é…æ‰€æœ‰è¯·æ±‚
            allowedOrigins: "*" #è·¨åŸŸå¤„ç† å…è®¸æ‰€æœ‰çš„åŸŸ
            allowedMethods: # æ”¯æŒçš„æ–¹æ³•
              - GET
              - POST
              - PUT
              - DELETE
      routes:
        # å¹³å°ç®¡ç†
        - id: wemedia
          uri: lb://leadnews-wemedia
          predicates:
            - Path=/wemedia/**
          filters:
            - StripPrefix= 1
```



#### å‰å°æ­å»º

é€šè¿‡nginxçš„è™šæ‹Ÿä¸»æœºåŠŸèƒ½ï¼Œä½¿ç”¨åŒä¸€ä¸ªnginxè®¿é—®å¤šä¸ªé¡¹ç›®

![](images/image-20231209211900862.png)



- è‡ªåª’ä½“å‰ç«¯ï¼šwemedia-web
- åœ¨nginxä¸­é…ç½®leadnews.confç›®å½•ä¸­æ–°å¢leadnews-wemedia.confæ–‡ä»¶

```nginx
upstream  leadnews-wemedia-gateway {
    server localhost:51602;    
}

server {
    listen 8802;
    location / {
        root /Users/andyron/myfield/git/ARLeadnews/wemedia-web/;
        index index.html;
    }
    
    location ~/wemedia/MEDIA/(.*) {
        proxy_pass http://leadnews-wemedia-gateway/$1;
        proxy_set_header HOST $host;  # ä¸æ”¹å˜æºè¯·æ±‚å¤´çš„å€¼
        proxy_pass_request_body on;  #å¼€å¯è·å–è¯·æ±‚ä½“
        proxy_pass_request_headers on;  #å¼€å¯è·å–è¯·æ±‚å¤´
        proxy_set_header X-Real-IP $remote_addr;   # è®°å½•çœŸå®å‘å‡ºè¯·æ±‚çš„å®¢æˆ·ç«¯IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  #è®°å½•ä»£ç†ä¿¡æ¯
    }
}
```

`nginx -s reload`

- å¯åŠ¨nginxï¼Œå¯åŠ¨è‡ªåª’ä½“å¾®æœåŠ¡å’Œå¯¹åº”ç½‘å…³

- è”è°ƒæµ‹è¯•ç™»å½•åŠŸèƒ½

http://localhost:8802/



### è‡ªåª’ä½“ç´ æç®¡ç†

è‡ªåª’ä½“æ ¸å¿ƒï¼šä¸Šä¼ æ–‡ç« 

#### ç´ æä¸Šä¼ 

```sql
CREATE TABLE `wm_news_material` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `material_id` int unsigned DEFAULT NULL COMMENT 'ç´ æID',
  `news_id` int unsigned DEFAULT NULL COMMENT 'å›¾æ–‡ID',
  `type` tinyint unsigned DEFAULT NULL COMMENT 'å¼•ç”¨ç±»å‹\r\n            0 å†…å®¹å¼•ç”¨\r\n            1 ä¸»å›¾å¼•ç”¨',
  `ord` tinyint unsigned DEFAULT NULL COMMENT 'å¼•ç”¨æ’åº',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=281 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC COMMENT='è‡ªåª’ä½“å›¾æ–‡å¼•ç”¨ç´ æä¿¡æ¯è¡¨';
```

åœ¨ç´ æè¡¨ä¸­çš„ç”¨æˆ·ä¿¡æ¯å¦‚ä½•å¾—åˆ°ï¼Ÿ
ç´ æçš„ä¿¡æ¯ä¿å­˜åˆ°ä»€ä¹ˆä½ç½®ï¼Ÿ

##### å®ç°æ€è·¯

![](images/image-20231210175934144.png)

1. tokenä¸­è§£æç”¨æˆ·idï¼Œå­˜å…¥headerã€‚

åœ¨è‡ªåª’ä½“ç½‘å…³ä¸­çš„`AuthorizeFilter`æ·»åŠ ï¼š

```java
            // è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä¹‹å‰tokenä¸­å­˜å‚¨çš„å°±æ˜¯id
            Object userId = claimsBody.get("id");
            // å­˜å‚¨headerä¸­
            ServerHttpRequest serverHttpRequest = request.mutate().headers(httpHeaders -> {
                httpHeaders.add("userId", userId + "");
            }).build();
            // é‡ç½®è¯·æ±‚
            exchange.mutate().request(serverHttpRequest);
```

2. è‡ªå®šä¹‰æ‹¦æˆªTokençš„æ‹¦æˆªå™¨WmTokenInterceptorï¼Œå¹¶é…ç½®æ·»åŠ 

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // æ·»åŠ è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨ï¼Œæ‹¦æˆªæ‰€æœ‰è¯·æ±‚
        registry.addInterceptor(new WmTokenInterceptor()).addPathPatterns("/**");
    }
}
```



##### æ¥å£å®šä¹‰

|          | **è¯´æ˜**                        |
| -------- | ------------------------------- |
| æ¥å£è·¯å¾„ | /api/v1/material/upload_picture |
| è¯·æ±‚æ–¹å¼ | POST                            |
| å‚æ•°     | MultipartFile                   |
| å“åº”ç»“æœ | ResponseResult                  |

`MultipartFile`  ï¼šSpringmvcæŒ‡å®šçš„æ–‡ä»¶æ¥æ”¶ç±»å‹

ResponseResult  ï¼š

æˆåŠŸéœ€è¦å›æ˜¾å›¾ç‰‡ï¼Œè¿”å›ç´ æå¯¹è±¡





- å¯¼å…¥è‡ªå®šä¹‰çš„file-starterï¼Œå¼•å…¥minio

- åœ¨nacosä¸­çš„è‡ªåª’ä½“å¾®æœåŠ¡æ·»åŠ å¤‡æ³¨ï¼š

```yaml
minio:
  accessKey: minioadmin
  secretKey: minioadmin
  bucket: leadnews
  endpoint: http://192.168.0.102:9000
  readPath: http://192.168.0.102:9000
```



> ==æ³¨æ„==ï¼šnacosä¸­æœåŠ¡åä¸è¦æé”™ï¼ˆ`_`,`-`ï¼‰



#### ç´ æåˆ—è¡¨æŸ¥è¯¢

##### æ¥å£å®šä¹‰

|          | **è¯´æ˜**              |
| -------- | --------------------- |
| æ¥å£è·¯å¾„ | /api/v1/material/list |
| è¯·æ±‚æ–¹å¼ | POST                  |
| å‚æ•°     | WmMaterialDto         |
| å“åº”ç»“æœ | ResponseResult        |

ResponseResult  :

```json
{
  "host":null,
  "code":200,
  "errorMessage":"æ“ä½œæˆåŠŸ",
  "data":[
    {
    "id":52,
      "userId":1102,
      "url":"http://192.168.200.130:9000/leadnews/2021/04/26/ec893175f18c4261af14df14b83cb25f.jpg",
      "type":0,
      "isCollection":0,
      "createdTime":"2021-01-20T16:49:48.000+0000"
    },
    ....
  ],
  "currentPage":1,
  "size":20,
  "total":0
}
```

##### å®ç°



åœ¨è‡ªåª’ä½“å¯åŠ¨ç±»ä¸­æ·»åŠ mybatis-plusçš„åˆ†é¡µæ‹¦æˆªå™¨

```java
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
```



> ğŸ“¢æ³¨æ„ï¼šå…ˆè¦ç™»å½•ï¼Œè¦ä¸ç„¶ä¼šå‡ºç°NullPointerExceptionï¼Œå› ä¸ºWmThreadLocalUtilä¸­æ²¡æœ‰å­˜å‚¨ç”¨æˆ·ä¿¡æ¯



### è‡ªåª’ä½“æ–‡ç« ç®¡ç†

#### æŸ¥è¯¢æ‰€æœ‰é¢‘é“



#### æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« 

```mysql
CREATE TABLE `wm_news` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `user_id` int unsigned DEFAULT NULL COMMENT 'è‡ªåª’ä½“ç”¨æˆ·ID',
  `title` varchar(36) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'æ ‡é¢˜',
  `content` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci COMMENT 'å›¾æ–‡å†…å®¹',
  `type` tinyint unsigned DEFAULT NULL COMMENT 'æ–‡ç« å¸ƒå±€\r\n            0 æ— å›¾æ–‡ç« \r\n            1 å•å›¾æ–‡ç« \r\n            3 å¤šå›¾æ–‡ç« ',
  `channel_id` int unsigned DEFAULT NULL COMMENT 'å›¾æ–‡é¢‘é“ID',
  `labels` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `created_time` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `submited_time` datetime DEFAULT NULL COMMENT 'æäº¤æ—¶é—´',
  `status` tinyint unsigned DEFAULT NULL COMMENT 'å½“å‰çŠ¶æ€\r\n            0 è‰ç¨¿\r\n            1 æäº¤ï¼ˆå¾…å®¡æ ¸ï¼‰\r\n            2 å®¡æ ¸å¤±è´¥\r\n            3 äººå·¥å®¡æ ¸\r\n            4 äººå·¥å®¡æ ¸é€šè¿‡\r\n            8 å®¡æ ¸é€šè¿‡ï¼ˆå¾…å‘å¸ƒï¼‰\r\n            9 å·²å‘å¸ƒ',
  `publish_time` datetime DEFAULT NULL COMMENT 'å®šæ—¶å‘å¸ƒæ—¶é—´ï¼Œä¸å®šæ—¶åˆ™ä¸ºç©º',
  `reason` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'æ‹’ç»ç†ç”±',
  `article_id` bigint unsigned DEFAULT NULL COMMENT 'å‘å¸ƒåº“æ–‡ç« ID',
  `images` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci COMMENT '//å›¾ç‰‡ç”¨é€—å·åˆ†éš”',
  `enable` tinyint unsigned DEFAULT '1',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=6232 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC COMMENT='è‡ªåª’ä½“å›¾æ–‡å†…å®¹ä¿¡æ¯è¡¨';
```



#### æ–‡ç« å‘å¸ƒ

##### éœ€æ±‚åˆ†æ

![](images/image-20231211095937950.png)



![](images/image-20231211100127259.png)

![](images/image-20231211100328767.png)

##### å®ç°æ€è·¯åŠæµç¨‹

è¯¥åŠŸèƒ½ä¸ºä¿å­˜ã€ä¿®æ”¹ï¼ˆæ˜¯å¦æœ‰idï¼‰ã€ä¿å­˜è‰ç¨¿çš„å…±æœ‰æ–¹æ³•

![](images/image-20231211100559243.png)

1.å‰ç«¯æäº¤å‘å¸ƒæˆ–ä¿å­˜ä¸ºè‰ç¨¿

2.åå°åˆ¤æ–­è¯·æ±‚ä¸­æ˜¯å¦åŒ…å«äº†æ–‡ç« id

3.å¦‚æœä¸åŒ…å«id,åˆ™ä¸ºæ–°å¢

â€‹	3.1 æ‰§è¡Œæ–°å¢æ–‡ç« çš„æ“ä½œ

â€‹	3.2 å…³è”æ–‡ç« å†…å®¹å›¾ç‰‡ä¸ç´ æçš„å…³ç³»

â€‹	3.3 å…³è”æ–‡ç« å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»

4.å¦‚æœåŒ…å«äº†idï¼Œåˆ™ä¸ºä¿®æ”¹è¯·æ±‚

â€‹	4.1 åˆ é™¤è¯¥æ–‡ç« ä¸ç´ æçš„æ‰€æœ‰å…³ç³»

â€‹	4.2 æ‰§è¡Œä¿®æ”¹æ“ä½œ

â€‹	4.3 å…³è”æ–‡ç« å†…å®¹å›¾ç‰‡ä¸ç´ æçš„å…³ç³»

â€‹	4.4 å…³è”æ–‡ç« å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»

##### æ¥å£å®šä¹‰

|          | **è¯´æ˜**               |
| -------- | ---------------------- |
| æ¥å£è·¯å¾„ | /api/v1/channel/submit |
| è¯·æ±‚æ–¹å¼ | POST                   |
| å‚æ•°     | WmNewsDto              |
| å“åº”ç»“æœ | ResponseResult         |

![](images/image-20231211101052424.png)

##### å®ç°





ğŸ”–  å‘å¸ƒæ–‡ç«  å†…å®¹æ ‡ç­¾ä¸èƒ½ä¸ºæˆ–è¶…è¿‡20å­—ç¬¦



## 4 è‡ªåª’ä½“æ–‡ç« -è‡ªåŠ¨å®¡æ ¸

æ–‡ç« æ•°æ®æµï¼š

![æ–‡ç« æ•°æ®æµ](images/image-20231211110741292.png)



å®¡æ ¸æ¶‰åŠçš„å†…å®¹ï¼š

- ç¬¬ä¸‰æ–¹å†…å®¹å®‰å…¨å®¡æ ¸æ¥å£
- åˆ†å¸ƒå¼ä¸»é”®
- å¼‚æ­¥è°ƒç”¨
- feignè¿œç¨‹æ¥å£
- ç†”æ–­é™çº§



### 4.1 è‡ªåª’ä½“æ–‡ç« è‡ªåŠ¨å®¡æ ¸æµç¨‹

å®¡æ ¸æ–¹å¼ï¼š

- è‡ªåŠ¨å®¡æ ¸
  æ–‡ç« å‘å¸ƒä¹‹åï¼Œç³»ç»Ÿè‡ªåŠ¨å®¡æ ¸ï¼Œä¸»è¦æ˜¯é€šè¿‡ç¬¬ä¸‰æ–¹æ¥å£å¯¹æ–‡ç« å†…å®¹è¿›è¡Œå®¡æ ¸ï¼ˆæˆåŠŸã€å¤±è´¥ã€ä¸ç¡®å®šï¼‰ã€‚

- äººå·¥å®¡æ ¸
  å¾…è‡ªåŠ¨å®¡æ ¸è¿”å›==ä¸ç¡®å®š==ä¿¡æ¯æ—¶ï¼Œè½¬åˆ°äººå·¥å®¡æ ¸ï¼Œç”±å¹³å°ç®¡ç†å‘˜è¿›è¡Œå®¡æ ¸ã€‚



å®¡æ ¸æµç¨‹-å¤šç«¯è°ƒç”¨ï¼š

![](images/image-20231212131456329.png)



### 4.2 å†…å®¹å®‰å…¨ç¬¬ä¸‰æ–¹æ¥å£

#### å†…å®¹å®‰å…¨æ¥å£é€‰å‹

å†…å®¹å®‰å…¨æ˜¯è¯†åˆ«æœåŠ¡ï¼Œæ”¯æŒå¯¹å›¾ç‰‡ã€è§†é¢‘ã€æ–‡æœ¬ã€è¯­éŸ³ç­‰å¯¹è±¡è¿›è¡Œå¤šæ ·åŒ–åœºæ™¯æ£€æµ‹ï¼Œæœ‰æ•ˆé™ä½å†…å®¹è¿è§„é£é™©ã€‚

ç›®å‰å¾ˆå¤šå¹³å°éƒ½æ”¯æŒå†…å®¹æ£€æµ‹ï¼Œå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€ç™¾åº¦AIã€ç½‘æ˜“äº‘ç­‰å›½å†…å¤§å‹äº’è”ç½‘å…¬å¸éƒ½å¯¹å¤–æä¾›äº†APIã€‚
æŒ‰ç…§æ€§èƒ½å’Œæ”¶è´¹æ¥çœ‹ï¼Œé»‘é©¬å¤´æ¡é¡¹ç›®ä½¿ç”¨çš„å°±æ˜¯é˜¿é‡Œäº‘çš„å†…å®¹å®‰å…¨æ¥å£ï¼Œä½¿ç”¨åˆ°äº†å›¾ç‰‡å’Œæ–‡æœ¬çš„å®¡æ ¸ã€‚
é˜¿é‡Œäº‘æ”¶è´¹æ ‡å‡†ï¼šhttps://www.aliyun.com/price/product/?spm=a2c4g.11186623.2.10.4146401eg5oeu8#/lvwang/detail 

#### å‡†å¤‡å·¥ä½œ

è·å–é˜¿é‡Œäº‘ã€å†…å®¹å®‰å…¨ã€‘çš„AccessKeyIDå’ŒAccessKeySecretã€‚

#### æ–‡æœ¬å†…å®¹å®¡æ ¸æ¥å£

æ–‡æœ¬åƒåœ¾å†…å®¹æ£€æµ‹ï¼šhttps://help.aliyun.com/document_detail/70439.html?spm=a2c4g.11186623.6.659.35ac3db3l0wV5k 

æ–‡æœ¬åƒåœ¾å†…å®¹Java SDK: https://help.aliyun.com/document_detail/53427.html?spm=a2c4g.11186623.6.717.466d7544QbU8Lr 

#### å›¾ç‰‡å®¡æ ¸æ¥å£

å›¾ç‰‡åƒåœ¾å†…å®¹æ£€æµ‹ï¼šhttps://help.aliyun.com/document_detail/70292.html?spm=a2c4g.11186623.6.616.5d7d1e7f9vDRz4 

å›¾ç‰‡åƒåœ¾å†…å®¹Java SDK: https://help.aliyun.com/document_detail/53424.html?spm=a2c4g.11186623.6.715.c8f69b12ey35j4 

#### é¡¹ç›®é›†æˆ

1. åœ¨leandnews-commonæ¨¡å—ä¸‹ï¼Œæ·»åŠ é˜¿é‡Œäº‘ã€å†…å®¹å®‰å…¨ã€‘ç›¸å…³å·¥å…·ç±»

![](images/image-20231213083507097.png)

å¹¶åœ¨spring.factoriesæ–‡ä»¶ä¸­æ·»åŠ è‡ªåŠ¨é…ç½®

```
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  top.andyron.common.exception.ExceptionCatch,\
  top.andyron.common.swagger.SwaggerConfiguration,\
  top.andyron.common.aliyun.GreenImageScan,\
  top.andyron.common.aliyun.GreenTextScan
```



2. åœ¨leadnews-wemediaçš„nacosé…ç½®ä¸­å¿ƒé˜¿é‡Œäº‘ã€å†…å®¹å®‰å…¨ã€‘æ·»åŠ é…ç½®ï¼š

```yaml
aliyun:
 accessKeyId: 
 secret: 
#aliyun.scenes=porn,terrorism,ad,qrcode,live,logo
 scenes: terrorism
```

3. åœ¨è‡ªåª’ä½“å¾®æœåŠ¡ä¸­æµ‹è¯•ç±»ä¸­æ³¨å…¥å®¡æ ¸æ–‡æœ¬å’Œå›¾ç‰‡çš„beanè¿›è¡Œæµ‹è¯•



### 4.3 appç«¯æ–‡ç« ä¿å­˜æ¥å£

æ–‡ç« çš„ä¿å­˜æ˜¯åœ¨ä¹‹å‰çš„ã€4.å®¡æ ¸é€šè¿‡ã€‘ä¿å­˜åˆ°æ–‡ç« å¾®æœåŠ¡ä¸­ï¼Œä¿å­˜åˆ°articleåº“ï¼š

![](images/image-20231213111614286.png)

è€Œæ–‡ç« idæ ¼å¼æ˜¯bigintï¼Œä¸æ˜¯è‡ªå¢

#### åˆ†å¸ƒå¼id

éšç€ä¸šåŠ¡çš„å¢é•¿ï¼Œæ–‡ç« è¡¨å¯èƒ½è¦å ç”¨å¾ˆå¤§çš„ç‰©ç†å­˜å‚¨ç©ºé—´ï¼Œä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼ŒåæœŸä½¿ç”¨æ•°æ®åº“åˆ†ç‰‡æŠ€æœ¯ã€‚å°†ä¸€ä¸ªæ•°æ®åº“è¿›è¡Œæ‹†åˆ†ï¼Œé€šè¿‡æ•°æ®åº“ä¸­é—´ä»¶è¿æ¥ã€‚å¦‚æœæ•°æ®åº“ä¸­è¯¥è¡¨é€‰ç”¨IDè‡ªå¢ç­–ç•¥ï¼Œåˆ™å¯èƒ½äº§ç”Ÿé‡å¤çš„IDï¼Œæ­¤æ—¶åº”è¯¥ä½¿ç”¨åˆ†å¸ƒå¼IDç”Ÿæˆç­–ç•¥æ¥ç”ŸæˆIDã€‚

![](images/image-20231213111807488.png)

##### åˆ†å¸ƒå¼id-æŠ€æœ¯é€‰å‹

| **æ–¹æ¡ˆ**      | **ä¼˜åŠ¿**                                    | **åŠ£åŠ¿**                                                     |
| ------------- | ------------------------------------------- | ------------------------------------------------------------ |
| redis         | ï¼ˆINCRï¼‰ç”Ÿæˆä¸€ä¸ªå…¨å±€è¿ç»­é€’å¢ çš„æ•°å­—ç±»å‹ä¸»é”® | å¢åŠ äº†ä¸€ä¸ªå¤–éƒ¨ç»„ä»¶çš„ä¾èµ–ï¼ŒRedisä¸å¯ç”¨ï¼Œåˆ™æ•´ä¸ªæ•°æ®åº“å°†æ— æ³•åœ¨æ’å…¥ |
| UUID          | å…¨å±€å”¯ä¸€ï¼ŒMysqlä¹Ÿæœ‰UUIDå®ç°                 | 36ä¸ªå­—ç¬¦ç»„æˆï¼Œå ç”¨ç©ºé—´å¤§                                     |
| snowflakeç®—æ³• | å…¨å±€å”¯ä¸€ ï¼Œæ•°å­—ç±»å‹ï¼Œå­˜å‚¨æˆæœ¬ä½             | æœºå™¨è§„æ¨¡å¤§äº1024å°æ— æ³•æ”¯æŒ                                   |

é›ªèŠ±ç®—æ³•ï¼ˆsnowflakeï¼‰æ˜¯Twitterå¼€æºçš„åˆ†å¸ƒå¼IDç”Ÿæˆç®—æ³•ï¼Œç»“æœæ˜¯ä¸€ä¸ªlongå‹çš„IDã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šä½¿ç”¨41bitä½œä¸ºæ¯«ç§’æ•°ï¼Œ10bitä½œä¸ºæœºå™¨çš„IDï¼ˆ5ä¸ªbitæ˜¯æ•°æ®ä¸­å¿ƒï¼Œ5ä¸ªbitçš„æœºå™¨IDï¼›å¯ä»¥ç†è§£ä¸º32ä¸ªæœºæˆ¿ï¼Œæ¯ä¸ªæœºæˆ¿æœ€å¤š32å°æœºå™¨ï¼‰ï¼Œ12bitä½œä¸ºæ¯«ç§’å†…çš„æµæ°´å·ï¼ˆæ„å‘³ç€æ¯ä¸ªèŠ‚ç‚¹åœ¨æ¯æ¯«ç§’å¯ä»¥äº§ç”Ÿ 4096 ä¸ª IDï¼‰ï¼Œæœ€åè¿˜æœ‰ä¸€ä¸ªç¬¦å·ä½ï¼ˆç¬¬ä¸€ä¸ªï¼‰ï¼Œæ°¸è¿œæ˜¯0ã€‚

![](images/image-20231213112110656.png)

æ–‡ç« ç«¯ç›¸å…³çš„è¡¨éƒ½ä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆid,åŒ…æ‹¬ap_articleã€ ap_article_configã€ ap_article_contentã€‚

mybatis-pluså·²ç»é›†æˆäº†é›ªèŠ±ç®—æ³•ï¼Œå®Œæˆä»¥ä¸‹ä¸¤æ­¥å³å¯åœ¨é¡¹ç›®ä¸­é›†æˆé›ªèŠ±ç®—æ³•

ç¬¬ä¸€ï¼šåœ¨å®ä½“ç±»ä¸­çš„idä¸ŠåŠ å…¥å¦‚ä¸‹é…ç½®ï¼ŒæŒ‡å®šç±»å‹ä¸ºid_worker

```java
@TableId(value = "id",type = IdType.ID_WORKER)
private Long id;
```

ç¬¬äºŒï¼šåœ¨application.ymlæ–‡ä»¶ä¸­é…ç½®æ•°æ®ä¸­å¿ƒidå’Œæœºå™¨id ã€åœ¨leadnews-articleçš„nacosä¸­é…ç½®ã€‘

```yaml
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: top.andyron.model.article.pojos
  global-config:
    datacenter-id: 1
    workerId: 1
```

datacenter-id:æ•°æ®ä¸­å¿ƒid(å–å€¼èŒƒå›´ï¼š0-31)

workerId:æœºå™¨id(å–å€¼èŒƒå›´ï¼š0-31)

#### ä¿å­˜appç«¯æ–‡ç« -æ€è·¯åˆ†æ

åœ¨æ–‡ç« å®¡æ ¸æˆåŠŸä»¥åéœ€è¦åœ¨appçš„articleåº“ä¸­æ–°å¢æ–‡ç« æ•°æ®ã€‚

> wm_newsçš„article_idå¯¹åº”ap_articleçš„idï¼Œwm_newsçš„article_idä¸ºç©ºè¡¨ç¤ºæ–°å¢æ–‡ç« ï¼Œä¸ä¸ºç©ºè¡¨ç¤ºä¿®æ”¹
>
> å½“è‡ªåª’ä½“ä¸­æ·»åŠ æ–‡ç« åï¼Œä½†æ²¡æœ‰å®¡æ ¸æˆåŠŸæ—¶article_idä¸ºç©ºï¼›
>
> å½“å®¡æ ¸æˆåŠŸåæ–‡ç« æ·»åŠ åˆ°appç«¯æ–‡ç« æ¨¡å—å¹¶äº§ç”Ÿæ–‡ç« idï¼Œå†æ·»åŠ åˆ°wm_newsçš„article_idã€‚

1.ä¿å­˜æ–‡ç« ä¿¡æ¯  ap_article
2.ä¿å­˜æ–‡ç« é…ç½®ä¿¡æ¯  ap_article_config
3.ä¿å­˜æ–‡ç« å†…å®¹ ap_article_content

![](images/image-20231213113733226.png)





#### ä¿å­˜appç«¯æ–‡ç« -feignæ¥å£

è‡ªåª’ä½“æ¨¡å—é€šè¿‡ è¿œç¨‹è°ƒç”¨å®ç° æ•°æ®ä¿å­˜åˆ°æ–‡ç« æ¨¡å—

![](images/image-20231213114649483.png)

`ApArticle`æ²¡æœ‰æ–‡ç« å†…å®¹å­—æ®µï¼Œéœ€è¦åœ¨ä¼ è¾“å¯¹è±¡ä¸­æ·»åŠ ã€‚

`ResponseResult`ç»“æœå¯èƒ½ä¸ºï¼š

![](images/image-20231213114727906.png)

#### å®ç°

1. åœ¨leadnews-feign-apiä¸­æ–°å¢æ¥å£

å¯¼å…¥feignçš„ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

å®šä¹‰æ–‡ç« ç«¯çš„è¿œç¨‹æ¥å£:

```java
package top.andyron.apis.article;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import top.andyron.model.article.dto.ArticleDto;
import top.andyron.model.common.dtos.ResponseResult;

/**
 * @author andyron
 **/
@FeignClient(value = "leadnews-article")
public interface IArticleClient {

    @PostMapping("/api/v1/article/save")
    public ResponseResult saveArticle(@RequestBody ArticleDto dto);
}
```



2. åœ¨leadnews-articleä¸­å®ç°feignæ¥å£

```java
@RestController
public class ArticleClient implements IArticleClient {
    @Autowired
    private ApArticleService apArticleService;
    @Override
    @PostMapping("/api/v1/article/save")
    public ResponseResult saveArticle(ArticleDto dto) {
        return apArticleService.saveArticle(dto);
    }
}
```

3. åœ¨æ–‡ç« å¾®æœåŠ¡ä¸­æ·»åŠ `ApArticleConfigMapper`ã€‚

åœ¨`ApArticleConfig`ä¸­æ·»åŠ æ„é€ å‡½æ•°ï¼Œè®¾ç½®ä¸€äº›APPå·²å‘å¸ƒæ–‡ç« é»˜è®¤é…ç½®ï¼š

```java
@Data
@NoArgsConstructor
@TableName("ap_article_config")
public class ApArticleConfig implements Serializable {

    public ApArticleConfig(Long articleId){
        this.articleId = articleId;
        this.isComment = true;
        this.isForward = true;
        this.isDelete = false;
        this.isDown = false;
    }
}
```

4. åœ¨ApArticleServiceä¸­æ–°å¢æ–¹æ³•saveArticleï¼Œå¹¶å®ç°



5. æµ‹è¯•

POST http://localhost:51802/user/api/v1/article/save

```json
{
    "title":"ARå¤´æ¡é¡¹ç›®èƒŒæ™¯",
    "authoId":1102,
    "layout":1,
    "labels":"ARå¤´æ¡é¡¹ç›®èƒŒæ™¯",
    "publishTime":"2028-03-14T11:35:49.000Z",
    "images": "http://192.168.0.102:9000/leadnews/2023/12/11/585e27f794e9403681ca5080fe710d0e.jpg",
    "content":"ARå¤´æ¡é¡¹ç›®èƒŒæ™¯,ARå¤´æ¡é¡¹ç›®èƒŒæ™¯,ARå¤´æ¡é¡¹ç›®èƒŒæ™¯,ARå¤´æ¡é¡¹ç›®èƒŒæ™¯"
}
```

ä¼šåœ¨ `ap_article`ã€`ap_article_config`ã€`ap_article_content`ä¿å­˜å„ä¸€æ¡æ•°æ®ã€‚

å¯ä»¥æ·»åŠ idå­—æ®µï¼Œä¿®æ”¹ã€‚

### 4.4 è‡ªåª’ä½“æ–‡ç« è‡ªåŠ¨å®¡æ ¸åŠŸèƒ½å®ç°

wm_news è‡ªåª’ä½“æ–‡ç« è¡¨

statuså­—æ®µï¼š0 è‰ç¨¿  1 å¾…å®¡æ ¸  2 å®¡æ ¸å¤±è´¥  3 äººå·¥å®¡æ ¸  4 äººå·¥å®¡æ ¸é€šè¿‡  8 å®¡æ ¸é€šè¿‡ï¼ˆå¾…å‘å¸ƒï¼‰ 9 å·²å‘å¸ƒ

#### å®ç°

åœ¨leadnews-wemediaä¸­çš„serviceæ–°å¢æ¥å£`WmNewsAutoScanService`ï¼ŒåŠå…¶å®ç°







#### feignè¿œç¨‹æ¥å£è°ƒç”¨æ–¹å¼

![](images/image-20231213175037041.png)

leadnews-wemediaæœåŠ¡éœ€è¦ä¾èµ–äº†leadnews-feign-apiså·¥ç¨‹ï¼Œå¹¶ä¸”åœ¨è‡ªåª’ä½“çš„å¯åŠ¨ç±»WemediaApplicationä¸Šå¼€å¯feignçš„è¿œç¨‹è°ƒç”¨å³å¯`@EnableFeignClients(basePackages = "top.andyron.apis")`ï¼š

```java
@EnableFeignClients(basePackages = "top.andyron.apis")
@SpringBootApplication
@EnableDiscoveryClient
@MapperScan("top.andyron.wemedia.mapper")
public class WemediaApplication {
    public static void main(String[] args) {
        SpringApplication.run(WemediaApplication.class, args);
    }
}

```



#### å•å…ƒæµ‹è¯•

åˆ›å»ºå•å…ƒæµ‹è¯•ç±»å’Œæ–¹æ³•ï¼Œæ‰“æ–­ç‚¹æµ‹è¯•



#### æœåŠ¡é™çº§å¤„ç†

![](images/image-20231213184825153.png)

- æœåŠ¡é™çº§æ˜¯æœåŠ¡è‡ªæˆ‘ä¿æŠ¤çš„ä¸€ç§æ–¹å¼ï¼Œæˆ–è€…ä¿æŠ¤ä¸‹æ¸¸æœåŠ¡çš„ä¸€ç§æ–¹å¼ï¼Œç”¨äºç¡®ä¿æœåŠ¡ä¸ä¼šå—è¯·æ±‚çªå¢å½±å“å˜å¾—ä¸å¯ç”¨ï¼Œç¡®ä¿æœåŠ¡ä¸ä¼šå´©æºƒ
- æœåŠ¡é™çº§è™½ç„¶ä¼šå¯¼è‡´è¯·æ±‚å¤±è´¥ï¼Œä½†æ˜¯ä¸ä¼šå¯¼è‡´é˜»å¡ã€‚

ä¿æŠ¤æ–‡ç« å¾®æœåŠ¡



å®ç°æ­¥éª¤ï¼š

1. åœ¨leadnews-feign-apiç¼–å†™é™çº§é€»è¾‘

```java
package top.andyron.apis.article.fallback;

import org.springframework.stereotype.Component;
import top.andyron.apis.article.IArticleClient;
import top.andyron.model.article.dto.ArticleDto;
import top.andyron.model.common.dtos.ResponseResult;
import top.andyron.model.common.enums.AppHttpCodeEnum;

/**
 * @author andyron
 **/
@Component
public class IArticleClientFallback implements IArticleClient {
    @Override
    public ResponseResult saveArticle(ArticleDto dto) {
        return ResponseResult.errorResult(AppHttpCodeEnum.SERVER_ERROR, "è·å–æ•°æ®å¤±è´¥");
    }
}
```

åœ¨è‡ªåª’ä½“å¾®æœåŠ¡ä¸­æ·»åŠ ç±»ï¼Œæ‰«æé™çº§ä»£ç ç±»çš„åŒ…

```java
package top.andyron.wemedia.config;

import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;

/**
 * @author andyron
 **/
@Configuration
@ComponentScan("top.andyron.apis.article.fallback")
public class InitConfig {
}
```



2. è¿œç¨‹æ¥å£ä¸­æŒ‡å‘é™çº§ä»£ç 

![](images/image-20231213185722271.png)



3. åœ¨è‡ªåª’ä½“æ¨¡å—leadnews-wemediaçš„å¼€å¯é™çº§

åœ¨leadnews-wemediaçš„nacosé…ç½®ä¸­å¿ƒé‡Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œå¼€å¯æœåŠ¡é™çº§ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šæœåŠ¡å“åº”çš„è¶…æ—¶çš„æ—¶é—´

```yaml
feign:
  # å¼€å¯feignå¯¹hystrixç†”æ–­é™çº§çš„æ”¯æŒ
  hystrix:
    enabled: true
  # ä¿®æ”¹è°ƒç”¨è¶…æ—¶æ—¶é—´
  client:
    config:
      default:
        connectTimeout: 2000
        readTimeout: 2000
```



4. æµ‹è¯•

åœ¨æ–‡ç« å¾®æœåŠ¡leadnews-articleä¸­ç±»ApArticleServiceImplçš„saveArticleä¸­æ·»åŠ ï¼šã€æ³¨æ„é‡å¯ã€‘

```java
        // ä¸ºäº†æµ‹è¯•æœåŠ¡é™çº§
        try {
            Thread.sleep(3000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
```

åœ¨è‡ªåª’ä½“ç«¯è¿›è¡Œå®¡æ ¸æµ‹è¯•ï¼Œä¼šå‡ºç°æœåŠ¡é™çº§çš„ç°è±¡ã€ä¼šè°ƒç”¨IArticleClientFallbackçš„saveArticleæ–¹æ³•ã€‘

### 4.5 å‘å¸ƒæ–‡ç« æäº¤å®¡æ ¸é›†æˆ

#### åŒæ­¥è°ƒç”¨ä¸å¼‚æ­¥è°ƒç”¨

åŒæ­¥ï¼šå°±æ˜¯åœ¨å‘å‡ºä¸€ä¸ªè°ƒç”¨æ—¶ï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œ è¯¥è°ƒç”¨å°±ä¸è¿”å›ï¼ˆå®æ—¶å¤„ç†ï¼‰

å¼‚æ­¥ï¼šè°ƒç”¨åœ¨å‘å‡ºä¹‹åï¼Œè¿™ä¸ªè°ƒç”¨å°±ç›´æ¥è¿”å›äº†ï¼Œæ²¡æœ‰è¿”å›ç»“æœï¼ˆåˆ†æ—¶å¤„ç†ï¼‰

![](images/image-20231213191322672.png)

#### Springbooté›†æˆå¼‚æ­¥çº¿ç¨‹è°ƒç”¨

1. åœ¨è‡ªåŠ¨å®¡æ ¸çš„æ–¹æ³•ä¸ŠåŠ ä¸Š@Asyncæ³¨è§£ï¼ˆæ ‡æ˜è¦å¼‚æ­¥è°ƒç”¨ï¼‰

```java
    @Override
    @Async  // æ ‡æ˜å½“å‰æ–¹æ³•æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•
    public void autoScanWmNews(Integer id) {
```

2. åœ¨æ–‡ç« å‘å¸ƒæˆåŠŸåè°ƒç”¨å®¡æ ¸çš„æ–¹æ³•

```java
   	@Autowired
    private WmNewsAutoScanService wmNewsAutoScanService;

    @Override
    public ResponseResult submitNews(WmNewsDto dto) {
        ...

        // 4 ä¸æ˜¯è‰ç¨¿ï¼Œä¿å­˜æ–‡ç« å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»ï¼Œå¦‚æœå½“å‰å¸ƒå±€æ˜¯è‡ªåŠ¨ï¼Œéœ€è¦åŒ¹é…å°é¢å›¾ç‰‡
        saveRelativeInfoForCover(dto, wmNews, materials);
        
        // å®¡æ ¸æ–‡ç« 
        wmNewsAutoScanService.autoScanWmNews(wmNews.getId());
        
        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }
```





3. åœ¨è‡ªåª’ä½“å¯åŠ¨ç±»ä¸Šæ·»åŠ @EnableAsyncæ³¨è§£å¼€å¯å¼‚æ­¥è°ƒç”¨

```java
@EnableAsync // å¼€å¯å¼‚æ­¥è°ƒç”¨
public class WemediaApplication {
```







### 4.6 æ–‡ç« å®¡æ ¸åŠŸèƒ½-ç»¼åˆæµ‹è¯•

#### æœåŠ¡å¯åŠ¨åˆ—è¡¨

1ï¼ŒnacosæœåŠ¡ç«¯

2ï¼Œarticleå¾®æœåŠ¡

3ï¼Œwemediaå¾®æœåŠ¡

4ï¼Œå¯åŠ¨wemediaç½‘å…³å¾®æœåŠ¡

5ï¼Œå¯åŠ¨wemediaå‰ç«¯ç³»ç»Ÿ



#### æµ‹è¯•æƒ…å†µåˆ—è¡¨

1ï¼Œè‡ªåª’ä½“å‰ç«¯å‘å¸ƒä¸€ç¯‡æ­£å¸¸çš„æ–‡ç« 

   å®¡æ ¸æˆåŠŸåï¼Œappç«¯çš„articleç›¸å…³æ•°æ®æ˜¯å¦å¯ä»¥æ­£å¸¸ä¿å­˜ï¼Œè‡ªåª’ä½“æ–‡ç« çŠ¶æ€å’Œappç«¯æ–‡ç« idæ˜¯å¦å›æ˜¾

2ï¼Œè‡ªåª’ä½“å‰ç«¯å‘å¸ƒä¸€ç¯‡åŒ…å«æ•æ„Ÿè¯çš„æ–‡ç«   ğŸ”–

   æ­£å¸¸æ˜¯å®¡æ ¸å¤±è´¥ï¼Œ wm_newsè¡¨ä¸­çš„çŠ¶æ€æ˜¯å¦æ”¹å˜ï¼ŒæˆåŠŸå’Œå¤±è´¥åŸå› æ­£å¸¸ä¿å­˜

3ï¼Œè‡ªåª’ä½“å‰ç«¯å‘å¸ƒä¸€ç¯‡åŒ…å«æ•æ„Ÿå›¾ç‰‡çš„æ–‡ç«  ğŸ”–

   æ­£å¸¸æ˜¯å®¡æ ¸å¤±è´¥ï¼Œ wm_newsè¡¨ä¸­çš„çŠ¶æ€æ˜¯å¦æ”¹å˜ï¼ŒæˆåŠŸå’Œå¤±è´¥åŸå› æ­£å¸¸ä¿å­˜





### 4.7 æ–°éœ€æ±‚-è‡ªç®¡ç†æ•æ„Ÿè¯

#### éœ€æ±‚åˆ†æ

æ–‡ç« å®¡æ ¸åŠŸèƒ½å·²ç»äº¤ä»˜äº†ï¼Œæ–‡ç« ä¹Ÿèƒ½æ­£å¸¸å‘å¸ƒå®¡æ ¸ã€‚çªç„¶ï¼Œäº§å“ç»ç†è¿‡æ¥è¯´è¦å¼€ä¼šã€‚

ä¼šè®®çš„å†…å®¹æ ¸å¿ƒæœ‰ä»¥ä¸‹å†…å®¹ï¼š

- æ–‡ç« å®¡æ ¸ä¸èƒ½è¿‡æ»¤ä¸€äº›æ•æ„Ÿè¯ï¼š

  ç§äººä¾¦æ¢ã€é’ˆå­”æ‘„è±¡ã€ä¿¡ç”¨å¡æç°ã€å¹¿å‘Šä»£ç†ã€ä»£å¼€å‘ç¥¨ã€åˆ»ç« åŠã€å‡ºå”®ç­”æ¡ˆã€å°é¢è´·æ¬¾â€¦



éœ€è¦å®Œæˆçš„åŠŸèƒ½ï¼š

éœ€è¦è‡ªå·±ç»´æŠ¤ä¸€å¥—æ•æ„Ÿè¯ï¼Œåœ¨æ–‡ç« å®¡æ ¸çš„æ—¶å€™ï¼Œéœ€è¦éªŒè¯æ–‡ç« æ˜¯å¦åŒ…å«è¿™äº›æ•æ„Ÿè¯



#### æ•æ„Ÿè¯-è¿‡æ»¤

æŠ€æœ¯é€‰å‹

| **æ–¹æ¡ˆ**               | **è¯´æ˜**                         |
| ---------------------- | -------------------------------- |
| æ•°æ®åº“æ¨¡ç³ŠæŸ¥è¯¢         | æ•ˆç‡å¤ªä½                         |
| String.indexOf("")æŸ¥æ‰¾ | æ•°æ®åº“é‡å¤§çš„è¯ä¹Ÿæ˜¯æ¯”è¾ƒæ…¢         |
| å…¨æ–‡æ£€ç´¢               | åˆ†è¯å†åŒ¹é…                       |
| DFAç®—æ³•                | ç¡®å®šæœ‰ç©·è‡ªåŠ¨æœº(ä¸€ç§==æ•°æ®ç»“æ„==) |



#### DFAå®ç°åŸç†

DFAå…¨ç§°ä¸ºï¼šDeterministic Finite Automaton,å³ç¡®å®šæœ‰ç©·è‡ªåŠ¨æœºã€‚

å­˜å‚¨ï¼šä¸€æ¬¡æ€§çš„æŠŠæ‰€æœ‰çš„æ•æ„Ÿè¯å­˜å‚¨åˆ°äº†å¤šä¸ªmapä¸­ï¼Œå°±æ˜¯ä¸‹å›¾è¡¨ç¤ºè¿™ç§ç»“æ„

æ•æ„Ÿè¯ï¼šå†°æ¯’ã€å¤§éº»ã€å¤§åè›‹

![](images/image-20231213210014870.png)

æ£€ç´¢çš„è¿‡ç¨‹:

![](images/image-20231213210149385.png)





#### è‡ªç®¡ç†æ•æ„Ÿè¯é›†æˆåˆ°æ–‡ç« å®¡æ ¸ä¸­

æ•æ„Ÿè¯ä¸€èˆ¬å­˜åˆ°ä¸€å¼ è¡¨ä¸­ã€‚

1. åˆ›å»ºæ•æ„Ÿè¯è¡¨wm_sensitiveåˆ°leadnews_wemediaåº“ä¸­

```mysql
CREATE TABLE `wm_sensitive` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `sensitives` varchar(10) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'æ•æ„Ÿè¯',
  `created_time` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=3201 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC COMMENT='æ•æ„Ÿè¯ä¿¡æ¯è¡¨';
```



2. æ·»åŠ WmSensitiveMapper



3. åœ¨æ–‡ç« å®¡æ ¸çš„ä»£ç ä¸­æ·»åŠ è‡ªç®¡ç†æ•æ„Ÿè¯å®¡æ ¸

```java
    private boolean handleSensitiveScan(String content, WmNews wmNews) {
        boolean flag = true;
        // è·å–æ‰€æœ‰æ•æ„Ÿè¯
        List<WmSensitive> wmSensitives = wmSensitiveMapper.selectList(Wrappers.<WmSensitive>lambdaQuery().select(WmSensitive::getSensitives));
        List<String> sensitiveList = wmSensitives.stream().map(WmSensitive::getSensitives).collect(Collectors.toList());

        SensitiveWordUtil.initMap(sensitiveList);
        Map<String, Integer> map = SensitiveWordUtil.matchWords(content);
        if (map.size() > 0) {
            updateWmNews(wmNews, (short) 2, "å½“å‰æ–‡ç« ä¸­å­˜å‚¨è¿è§„å†…å®¹ " + map);
            flag = false;
        }
        return flag;
    }
```







### 4.8 æ–°éœ€æ±‚-å›¾ç‰‡è¯†åˆ«æ–‡å­—å®¡æ ¸æ•æ„Ÿè¯

#### éœ€æ±‚åˆ†æ

äº§å“ç»ç†å¬é›†å¼€ä¼šï¼Œæ–‡ç« å®¡æ ¸åŠŸèƒ½å·²ç»äº¤ä»˜äº†ï¼Œæ–‡ç« ä¹Ÿèƒ½æ­£å¸¸å‘å¸ƒå®¡æ ¸ã€‚å¯¹äºä¸Šæ¬¡æå‡ºçš„è‡ªç®¡ç†æ•æ„Ÿè¯ä¹Ÿå¾ˆæ»¡æ„ï¼Œè¿™æ¬¡ä¼šè®®æ ¸å¿ƒçš„å†…å®¹å¦‚ä¸‹ï¼š

- æ–‡ç« ä¸­åŒ…å«çš„å›¾ç‰‡è¦è¯†åˆ«æ–‡å­—ï¼Œè¿‡æ»¤æ‰å›¾ç‰‡æ–‡å­—çš„æ•æ„Ÿè¯



#### å›¾ç‰‡æ–‡å­—è¯†åˆ«

ä»€ä¹ˆæ˜¯OCR?

OCR ï¼ˆOptical Character Recognitionï¼Œå…‰å­¦å­—ç¬¦è¯†åˆ«ï¼‰æ˜¯æŒ‡ç”µå­è®¾å¤‡ï¼ˆä¾‹å¦‚æ‰«æä»ªæˆ–æ•°ç ç›¸æœºï¼‰æ£€æŸ¥çº¸ä¸Šæ‰“å°çš„å­—ç¬¦ï¼Œé€šè¿‡æ£€æµ‹æš—ã€äº®çš„æ¨¡å¼ç¡®å®šå…¶å½¢çŠ¶ï¼Œç„¶åç”¨å­—ç¬¦è¯†åˆ«æ–¹æ³•å°†å½¢çŠ¶ç¿»è¯‘æˆè®¡ç®—æœºæ–‡å­—çš„è¿‡ç¨‹

| **æ–¹æ¡ˆ**      | **è¯´æ˜**                                            |
| ------------- | --------------------------------------------------- |
| ç™¾åº¦OCR       | æ”¶è´¹                                                |
| Tesseract-OCR | Googleç»´æŠ¤çš„å¼€æºOCRå¼•æ“ï¼Œæ”¯æŒJavaï¼ŒPythonç­‰è¯­è¨€è°ƒç”¨ |
| Tess4J        | å°è£…äº†Tesseract-OCR  ï¼Œæ”¯æŒJavaè°ƒç”¨                 |

Tesseract-OCR ç‰¹ç‚¹ï¼š

- Tesseractæ”¯æŒUTF-8ç¼–ç æ ¼å¼ï¼Œå¹¶ä¸”å¯ä»¥â€œå¼€ç®±å³ç”¨â€åœ°è¯†åˆ«100å¤šç§è¯­è¨€ã€‚
- Tesseractæ”¯æŒå¤šç§è¾“å‡ºæ ¼å¼ï¼šçº¯æ–‡æœ¬ï¼ŒhOCRï¼ˆHTMLï¼‰ï¼ŒPDFç­‰
- å®˜æ–¹å»ºè®®ï¼Œä¸ºäº†è·å¾—æ›´å¥½çš„OCRç»“æœï¼Œæœ€å¥½æä¾›ç»™é«˜è´¨é‡çš„å›¾åƒã€‚
- Tesseractè¿›è¡Œè¯†åˆ«å…¶ä»–è¯­è¨€çš„è®­ç»ƒ
  å…·ä½“çš„è®­ç»ƒæ–¹å¼ï¼Œè¯·å‚è€ƒå®˜æ–¹æä¾›çš„æ–‡æ¡£ï¼šhttps://tesseract-ocr.github.io/tessdoc/

#### Tess4jæ¡ˆä¾‹ ğŸ”–

1. åˆ›å»ºé¡¹ç›®å¯¼å…¥tess4jå¯¹åº”çš„ä¾èµ–

```xml
<dependency>
    <groupId>net.sourceforge.tess4j</groupId>
    <artifactId>tess4j</artifactId>
    <version>4.1.1</version>
</dependency>
```



2. å¯¼å…¥ä¸­æ–‡å­—ä½“åº“ï¼Œ æŠŠèµ„æ–™ä¸­çš„tessdataæ–‡ä»¶å¤¹æ‹·è´åˆ°è‡ªå·±çš„å·¥ä½œç©ºé—´ä¸‹ã€‚ç®€ä½“ä¸­æ–‡ `chi_sim.traineddata`



3. ç¼–å†™æµ‹è¯•ç±»è¿›è¡Œæµ‹è¯•



#### å›¾ç‰‡æ–‡å­—è¯†åˆ«é›†æˆåˆ°æ–‡ç« å®¡æ ¸ ğŸ”–

1. åœ¨leadnews-commonä¸­åˆ›å»ºå·¥å…·ç±»ï¼Œç®€å•å°è£…ä¸€ä¸‹tess4j

å…ˆå¯¼å…¥ä¾èµ–

åœ¨spring.factoriesé…ç½®ä¸­æ·»åŠ è¯¥ç±»



2. åœ¨leadnews-wemediaä¸­çš„é…ç½®ä¸­æ·»åŠ ä¸¤ä¸ªå±æ€§

```yaml
tess4j:
  data-path: D:\workspace\tessdata
  language: chi_sim
```



3. åœ¨WmNewsAutoScanServiceImplä¸­çš„handleImageScanæ–¹æ³•ä¸Šæ·»åŠ å¦‚ä¸‹ä»£ç 







### 4.9 æ–‡ç« è¯¦æƒ…-é™æ€æ–‡ä»¶ç”Ÿæˆ

#### æ€è·¯åˆ†æ

æ–‡ç« ç«¯åˆ›å»ºappç›¸å…³æ–‡ç« æ—¶ï¼Œç”Ÿæˆæ–‡ç« è¯¦æƒ…é™æ€é¡µä¸Šä¼ åˆ°MinIOä¸­

![](images/image-20210709110852966.png)

#### å®ç°æ­¥éª¤





### æ€è€ƒ

åˆ†å¸ƒå¼äº‹åŠ¡

![](images/image-20231213223344281.png)

ç›®å‰ï¼Œè‡ªåª’ä½“å¾®æœåŠ¡å’Œæ–‡ç« å¾®æœåŠ¡ï¼Œå¦‚æœå„è‡ªæŠ¥é”™ï¼Œå®ƒä»¬ç›¸äº’æ˜¯ä¸çŸ¥é“

> ä½œä¸šï¼šä½¿ç”¨seataæ¥è§£å†³å®¡æ ¸è¿‡ç¨‹ä¸­çš„åˆ†å¸ƒå¼äº‹ç‰©çš„é—®é¢˜

> æ–‡ç« å‘å¸ƒæ—¶é—´æ˜¯ä¸€ä¸ªæœªæ¥æ—¶é—´ï¼Œè¯¥å¦‚ä½•æŒ‰ç…§ç²¾ç¡®æ—¶é—´å‘å¸ƒï¼Ÿ
> ä¾‹å¦‚ï¼šå¦‚æœä»Šå¤©æ˜¯1æœˆ1æ—¥å†™äº†ä¸€ç¯‡æ–‡ç« ï¼Œè®¾å®šå‘å¸ƒæ—¶é—´æ˜¯1æœˆ5æ—¥ï¼Œé‚£è¿™ä¸ªæ–‡ç« ä»€ä¹ˆæ—¶å€™å®¡æ ¸

## 5 å»¶è¿Ÿä»»åŠ¡ç²¾å‡†å‘å¸ƒæ–‡ç« 

### æ–‡ç« å®šæ—¶å‘å¸ƒ



### å»¶è¿Ÿä»»åŠ¡æ¦‚è¿°



### rediså®ç°å»¶è¿Ÿä»»åŠ¡



### å»¶è¿Ÿä»»åŠ¡æœåŠ¡å®ç°



### å»¶è¿Ÿé˜Ÿåˆ—è§£å†³ç²¾å‡†æ—¶é—´å‘å¸ƒæ–‡ç« 







## 6 kafkaåŠå¼‚æ­¥é€šçŸ¥æ–‡ç« ä¸Šä¸‹æ¶

### è‡ªåª’ä½“æ–‡ç« ä¸Šä¸‹æ¶





### kafka









### springbooté›†æˆkafka











## 07-appç«¯æ–‡ç« æœç´¢



## 08-å¹³å°ç®¡ç†



## 09-ç”¨æˆ·è¡Œä¸º



## 10-xxl-Jobåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦

å®šæ—¶è®¡ç®—çƒ­ç‚¹æ–‡ç« 



## 11-çƒ­ç‚¹æ–‡ç« -å®æ—¶è®¡ç®—
