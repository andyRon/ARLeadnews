ARå¤´æ¡
------

æµ‹è¯•

https://www.bilibili.com/video/BV1Qs4y1v7x4

## ä»‹ç»

### æŠ€æœ¯æ ˆ

å¾®æœåŠ¡é¡¹ç›®

![](images/image-20231002072412096.png)

æŠ€æœ¯è§£å†³æ–¹æ¡ˆï¼š

- é™æ€åŒ–æ¨¡æ¿æ–¹æ¡ˆ
- å»¶è¿Ÿå‘å¸ƒæ–¹æ¡ˆ
- å†…å®¹å®¡æ ¸å‘å¸ƒæ•´å¥—æµç¨‹å®ç°æ–¹æ¡ˆ
- çƒ­ç‚¹æ•°æ®ç­›é€‰ä¸å¤„ç†æ–¹æ¡ˆ
- åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦è§£å†³æ–¹æ¡ˆ
- å¾®æœåŠ¡æŒç»­é›†æˆè§£å†³æ–¹æ¡ˆ

![](images/image-20231002072456555.png)

### é¡¹ç›®å‰ç½®çŸ¥è¯†

- Springbootçµæ´»ä½¿ç”¨çš„ç¨‹åº¦
- Spring cloud å…¥é—¨ç¨‹åº¦
- NacosåŸºæœ¬ä½¿ç”¨ç¨‹åº¦

### æ€æ ·å­¦ä¹ é¡¹ç›®

ä¸šåŠ¡ç»†èŠ‚

å­¦ä¹ çš„é‡ç‚¹ï¼š

- ä¸šåŠ¡ï¼ˆBï¼‰ã€‚ç†è§£éœ€æ±‚ã€å‡†å¤‡é¢è¯•
- æŠ€æœ¯ï¼ˆTï¼‰ã€‚è€æŠ€æœ¯èä¼šè´¯é€šã€æ–°æŠ€æœ¯å¿«é€ŸæŒæ¡
- ä»£ç ï¼ˆCï¼‰ã€‚ç ”ç©¶ä»£ç é€»è¾‘ï¼Œé‡å˜å½±å“è´¨å˜
- å®æˆ˜ï¼ˆPï¼‰ã€‚çœŸéœ€æ±‚ï¼ŒéªŒè¯æ°´å¹³

![](images/image-20231002073123807.png)

é‡åˆ°é—®é¢˜æ€ä¹ˆåŠï¼Ÿ

åœ¨è°ƒè¯•ä¸­æˆé•¿ï¼ˆå­¦ä¼šdebugï¼‰

## 1 é¡¹ç›®ä»‹ç»

æ€ä¹ˆä»‹ç»ä¸€ä¸ªé¡¹ç›®ï¼š

é¡¹ç›®èƒŒæ™¯ã€ä¸šåŠ¡èƒ½åŠ›ã€æŠ€æœ¯æ ˆè¯´æ˜ã€è§£å†³æ–¹æ¡ˆ

### é¡¹ç›®æ¦‚è¿°

ç±»ä¼¼äºä»Šæ—¥å¤´æ¡ï¼Œæ˜¯ä¸€ä¸ªæ–°é—»èµ„è®¯ç±»é¡¹ç›®

#### è¯¾ç¨‹æ¦‚è¿°

![](images/image-20231002075450779.png)

è¯¾ç¨‹å¤§çº²ï¼š

| ç« èŠ‚                           | å¤©æ•° | å†…å®¹                                                                               |
| ------------------------------ | ---- | ---------------------------------------------------------------------------------- |
| ç¬¬ä¸€ç«  ç¯å¢ƒæ­å»º                | 1    | springbootã€springcloudã€nacosã€swagger                                            |
| ç¬¬äºŒç«  æ–‡ç« åˆ—è¡¨æŸ¥çœ‹            | 2    | freemarkerã€OSSã€CDNã€ElasticSearchã€Redis                                         |
| ç¬¬ä¸‰ç«  çƒ­ç‚¹æ–‡ç« è®¡ç®—            | 3    | kafkaã€kafkaStreamã€XXL-JOBã€Redis                                                 |
| ç¬¬å››ç«  CMSè‡ªåª’ä½“ç«¯æ–‡ç« å‘å¸ƒå®¡æ ¸ | 3    | ç¬¬ä¸‰æ–¹æ¥å£ã€å»¶è¿Ÿé˜Ÿåˆ—ã€                                                             |
| ç¬¬äº”ç«  é¡¹ç›®éƒ¨ç½² æ•°æ®è¿ç§»       | 2    | Hbaseã€Jenkinsã€Gitã€Docker                                                        |
| é¡¹ç›®å®æˆ˜                       | 4    | appç«¯-æ–‡ç« è¡Œä¸ºã€<br />appç«¯-è¯„è®ºç³»ç»Ÿã€<br />è‡ªåª’ä½“ç«¯-è¯„è®ºç®¡ç†ã€<br />è‡ªåª’ä½“ç«¯-æŠ¥è¡¨ |

#### ç¯å¢ƒæ­å»º

ä½¿ç”¨ç™»å½•åŠç½‘å…³è®¤è¯æ ¡éªŒåŠŸèƒ½æ¥æµ‹è¯•ç¯å¢ƒæ­å»ºæˆåŠŸä¸å¦ã€‚

ç›®æ ‡ï¼šæ¥å£æµ‹è¯•å·¥å…·åŠå‰åç«¯è”è°ƒ

![](images/image-20231002074108700.png)

#### ä¸šåŠ¡è¯´æ˜

åŠŸèƒ½æ¶æ„å›¾

![](images/image-20231002074638167.png)

- ç”¨æˆ·ç§»åŠ¨App

![](images/image-20231002085931731.png)

- è‡ªåª’ä½“å¹³å°æ˜¯æ–°é—»å†™æ–‡ç« ã€å‘å¸ƒæ–‡ç« ã€ç®¡ç†çš„å¹³å°

![](images/image-20231002090133533.png)

![](images/image-20231002090201877.png)

![](images/image-20231002090220080.png)

![](images/image-20231002090243457.png)

![](images/image-20231002090304625.png)

- ç®¡ç†å¹³å°ç›¸å½“äºARå¤´æ¡çš„å®˜æ–¹å¹³å°ï¼Œæƒé™æ¯”è¾ƒå¤§

![](images/image-20231207114854942.png)

![](images/image-20231002090408535.png)

é¡¹ç›®æ¼”ç¤ºåœ°å€ï¼š
å¹³å°ç®¡ç†ï¼šhttp://heima-admin-java.research.itcast.cn
è‡ªåª’ä½“ï¼šhttp://heime-media-java.research.itcast.cn
appç«¯ï¼šhttp://heima-app-java.research.itcast.cn

#### é¡¹ç›®æœ¯è¯­

- ç”¨æˆ·ï¼šé»‘é©¬å¤´æ¡APPç”¨æˆ·ç«¯ç”¨æˆ·
- è‡ªåª’ä½“äººï¼šé€šè¿‡é»‘é©¬è‡ªåª’ä½“ç³»ç»Ÿå‘é€æ–‡ç« çš„ç”¨æˆ·
- ç®¡ç†å‘˜ï¼šä½¿ç”¨é»‘é©¬å¤´æ¡ç®¡ç†ç³»ç»Ÿçš„ç”¨æˆ·
- Appï¼šé»‘é©¬å¤´æ¡App
- We Mediaï¼šé»‘é©¬å¤´æ¡è‡ªåª’ä½“ç³»ç»Ÿ
- Adminï¼šé»‘é©¬å¤´æ¡ç®¡ç†ç³»ç»Ÿ

#### æŠ€æœ¯æ ˆ

![](images/f3accd2ba01c41b0a9ac98370241eba3.png)

åŸºç¡€å±‚

![](images/image-20231002075147758.png)

æœåŠ¡å±‚

![](images/image-20231002075217399.png)

### nacosç¯å¢ƒæ­å»º

Centos è™šæ‹Ÿæœº

#### dockerå®‰è£…Nacoså®‰è£…

1. ä½¿ç”¨vmè™šæ‹Ÿæœºæ‰“å¼€èµ„æ–™ä¸­çš„contos7é•œåƒ
2. dockeræ‹‰å–é•œåƒ

   ```shell
   docker pull nacos/nacos-server:1.2.0
   ```
3. åˆ›å»ºå®¹å™¨

   ```shell
   docker run --env MODE=standalone --name nacos --restart=always  -d -p 8848:8848 nacos/nacos-server:1.2.0
   ```

> MODE=standalone  å•æœºç‰ˆ
> --restart=always  å¼€æœºå¯åŠ¨
> -p 8848:8848   æ˜ å°„ç«¯å£
> -d åˆ›å»ºä¸€ä¸ªå®ˆæŠ¤å¼å®¹å™¨åœ¨åå°è¿è¡Œ

æŠ¥é”™ï¼š

```
WARNING: The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested

```

å› ä¸ºmacos m1 ï¼Œæ·»åŠ  `--platform linux/arm64`

```shell
docker run --platform linux/arm64 --env MODE=standalone --name nacos --restart=always -d -p 8848:8848 nacos/nacos-server:1.2.0
```

ğŸ”–é—®é¢˜ï¼š

```
Unable to find image 'nacos/nacos-server:1.2.0' locally
1.2.0: Pulling from nacos/nacos-server
Digest: sha256:2db29d58eb4d3235ff55e44d5708c5690a399195c9e0504d79933a12b0a4f9f5
Status: Image is up to date for nacos/nacos-server:1.2.0
docker: image with reference docker.io/nacos/nacos-server:1.2.0 was found but does not match the specified platform: wanted linux/arm64, actual: linux/amd64.
See 'docker run --help'.
```

4. è®¿é—®åœ°å€ï¼šhttp://10.211.55.5:8848/nacos

ä½¿ç”¨æœ¬åœ°macosä¸Šï¼Œæºç å®‰è£…å¯åŠ¨nacos  `./startup.sh -m standalone` (å•æœºæ¨¡å¼è¿è¡Œ)

http://localhost:8848/nacos

è´¦å·å¯†ç éƒ½æ˜¯nacos

### åˆå§‹å·¥ç¨‹æ­å»º

#### å·¥ç¨‹ä¸»é¢˜ç»“æ„

```
arleadnews								çˆ¶å·¥ç¨‹ï¼Œç»Ÿä¸€ç®¡ç†é¡¹ç›®ä¾èµ–ï¼ˆå®šä¹‰é€šç”¨åŒ…çš„ç‰ˆæœ¬ï¼‰ï¼Œspringboot
		leadnews-common				é€šç”¨é…ç½®
		leadnews-feign-api		feignå¯¹å¤–çš„æ¥å£
		leadnews-model				pojoã€dto
		leadnews-utils				é€šç”¨å·¥å…·
		leadnews-gateway			ç®¡ç†ä¸€ç³»åˆ—ç½‘å…³
		leadnews-service			ç®¡ç†ä¸€ç³»åˆ—å¾®æœåŠ¡
		leadnews-test					æµ‹è¯•æ¡ˆä¾‹
```

#### å…¨å±€å¼‚å¸¸

![](images/image-20231207231920204.png)

### ç™»å½•

#### éœ€æ±‚åˆ†æ

![](images/image-20231207232050429.png)

- ç”¨æˆ·ç‚¹å‡»**å¼€å§‹ä½¿ç”¨**

  ç™»å½•åçš„ç”¨æˆ·æƒé™è¾ƒå¤§ï¼Œå¯ä»¥æŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥æ“ä½œï¼ˆç‚¹èµï¼Œå…³æ³¨ï¼Œè¯„è®ºï¼‰
- ç”¨æˆ·ç‚¹å‡»**ä¸ç™»å½•ï¼Œå…ˆçœ‹çœ‹**

    æ¸¸å®¢åªæœ‰æŸ¥çœ‹çš„æƒé™

#### è¡¨ç»“æ„åˆ†æ

å…³äºappç«¯ç”¨æˆ·ç›¸å…³çš„å†…å®¹è¾ƒå¤šï¼Œå¯ä»¥å•ç‹¬è®¾ç½®ä¸€ä¸ªåº“leadnews_user

| **è¡¨åç§°** | **è¯´æ˜**    |
| ---------------- | ----------------- |
| ap_user          | APPç”¨æˆ·ä¿¡æ¯è¡¨     |
| ap_user_fan      | APPç”¨æˆ·ç²‰ä¸ä¿¡æ¯è¡¨ |
| ap_user_follow   | APPç”¨æˆ·å…³æ³¨ä¿¡æ¯è¡¨ |
| ap_user_realname | APPå®åè®¤è¯ä¿¡æ¯è¡¨ |

```mysql
CREATE TABLE `ap_user` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `salt` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'å¯†ç ã€é€šä¿¡ç­‰åŠ å¯†ç›',
  `name` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'ç”¨æˆ·å',
  `password` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'å¯†ç ,md5åŠ å¯†',
  `phone` varchar(11) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'æ‰‹æœºå·',
  `image` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'å¤´åƒ',
  `sex` tinyint unsigned DEFAULT NULL COMMENT '0 ç”·\r\n            1 å¥³\r\n            2 æœªçŸ¥',
  `is_certification` tinyint unsigned DEFAULT NULL COMMENT '0 æœª\r\n            1 æ˜¯',
  `is_identity_authentication` tinyint(1) DEFAULT NULL COMMENT 'æ˜¯å¦èº«ä»½è®¤è¯',
  `status` tinyint unsigned DEFAULT NULL COMMENT '0æ­£å¸¸\r\n            1é”å®š',
  `flag` tinyint unsigned DEFAULT NULL COMMENT '0 æ™®é€šç”¨æˆ·\r\n            1 è‡ªåª’ä½“äºº\r\n            2 å¤§V',
  `created_time` datetime DEFAULT NULL COMMENT 'æ³¨å†Œæ—¶é—´',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC COMMENT='APPç”¨æˆ·ä¿¡æ¯è¡¨';
```

> `tinyint`ç±»å‹ï¼šå 1ä¸ªå­—èŠ‚ï¼Œä¸æŒ‡å®šunsignedï¼ˆéè´Ÿæ•°ï¼‰ï¼Œå€¼èŒƒå›´ï¼ˆ-128,127ï¼‰ï¼ŒæŒ‡å®šäº†unsignedï¼Œå€¼èŒƒå›´ï¼ˆ0,255ï¼‰
>
> tinyinté€šå¸¸è¡¨ç¤ºå°èŒƒå›´çš„æ•°å€¼ï¼Œæˆ–è€…è¡¨ç¤ºtrueæˆ–falseï¼Œé€šå¸¸å€¼ä¸º0è¡¨ç¤ºfalseï¼Œå€¼ä¸º1è¡¨ç¤ºtrue

é¡¹ç›®ä¸­çš„æŒä¹…å±‚ä½¿ç”¨çš„mybatis-plusï¼Œä¸€èˆ¬éƒ½ä½¿ç”¨mybais-plusé€†å‘ç”Ÿæˆå¯¹åº”çš„å®ä½“ç±»

#### æ‰‹åŠ¨åŠ å¯†ï¼ˆmd5+éšæœºå­—ç¬¦ä¸²ï¼‰

md5æ˜¯ä¸å¯é€†åŠ å¯†ï¼Œmd5ç›¸åŒçš„å¯†ç æ¯æ¬¡åŠ å¯†éƒ½ä¸€æ ·ï¼Œä¸å¤ªå®‰å…¨ã€‚åœ¨md5çš„åŸºç¡€ä¸Šæ‰‹åŠ¨åŠ ç›ï¼ˆsaltï¼‰å¤„ç†

æ³¨å†Œ->ç”Ÿæˆç›ï¼ˆå­—æ®µsaltï¼‰ï¼š

![](images/image-20231207233816713.png)

ç™»å½•->ä½¿ç”¨ç›æ¥é…åˆéªŒè¯ï¼š

![](images/image-20231207233934748.png)

#### ç”¨æˆ·ç«¯ï¼ˆè¿è¥ç«¯ï¼‰å¾®æœåŠ¡æ­å»º

åœ¨leadnews-serviceä¸‹åˆ›å»ºå·¥ç¨‹leadnews-user

![](images/image-20231208000352009.png)

```yaml
spring:
  datasource:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/leadnews_user?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&useSSL=false&allowPublicKeyRetrieval=true
      username: root
      password: 33824
# è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: top.andyron.model.user.pojos
```

#### ç™»å½•åŠŸèƒ½å®ç°

##### æ¥å£å®šä¹‰

![](images/image-20231208000615566.png)

å¿«æ·é”®ctrl + a  ï¼ˆctrl + iï¼‰

![](images/image-20231208002436863.png)

##### æ€è·¯åˆ†æ

æµç¨‹ï¼š

![](images/image-20231208002610020.png)

1. ç”¨æˆ·è¾“å…¥äº†ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œç™»å½•ï¼Œæ ¡éªŒæˆåŠŸåè¿”å›jwtï¼ˆåŸºäºå½“å‰ç”¨æˆ·çš„idç”Ÿæˆï¼‰
2. ç”¨æˆ·æ¸¸å®¢ç™»å½•ï¼Œç”Ÿæˆjwtè¿”å›ï¼ˆåŸºäºé»˜è®¤å€¼0ç”Ÿæˆï¼‰

### æ¥å£å·¥å…·postmanã€swaggerã€knife4j

#### swagger

Springå·²ç»å°†Swaggerçº³å…¥è‡ªèº«çš„æ ‡å‡†ï¼Œå»ºç«‹äº†Spring-swaggeré¡¹ç›®ï¼Œç°åœ¨å«Springfoxã€‚é€šè¿‡åœ¨é¡¹ç›®ä¸­å¼•å…¥Springfox ï¼Œå³å¯éå¸¸ç®€å•å¿«æ·çš„ä½¿ç”¨Swaggerã€‚

```xml
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-swagger2</artifactId>
</dependency>
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-swagger-ui</artifactId>
</dependency>
```

åœ¨leadnews-commonä¸­è¿›è¡Œé…ç½®å³å¯ï¼Œå› ä¸ºå…¶ä»–å¾®æœåŠ¡å·¥ç¨‹éƒ½ç›´æ¥æˆ–é—´æ¥ä¾èµ–å³å¯ã€‚

##### swaggerå¸¸ç”¨æ³¨è§£

@Apiï¼šä¿®é¥°æ•´ä¸ªç±»ï¼Œæè¿°Controllerçš„ä½œç”¨

@ApiOperationï¼šæè¿°ä¸€ä¸ªç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œæˆ–è€…è¯´ä¸€ä¸ªæ¥å£

@ApiParamï¼šå•ä¸ªå‚æ•°çš„æè¿°ä¿¡æ¯

@ApiModelï¼šç”¨å¯¹è±¡æ¥æ¥æ”¶å‚æ•°

@ApiModelPropertyï¼šç”¨å¯¹è±¡æ¥æ”¶å‚æ•°æ—¶ï¼Œæè¿°å¯¹è±¡çš„ä¸€ä¸ªå­—æ®µ

@ApiResponseï¼šHTTPå“åº”å…¶ä¸­1ä¸ªæè¿°

@ApiResponsesï¼šHTTPå“åº”æ•´ä½“æè¿°

@ApiIgnoreï¼šä½¿ç”¨è¯¥æ³¨è§£å¿½ç•¥è¿™ä¸ªAPI

@ApiError ï¼šå‘ç”Ÿé”™è¯¯è¿”å›çš„ä¿¡æ¯

@ApiImplicitParamï¼šä¸€ä¸ªè¯·æ±‚å‚æ•°

@ApiImplicitParamsï¼šå¤šä¸ªè¯·æ±‚å‚æ•°çš„æè¿°ä¿¡æ¯

@ApiImplicitParamå±æ€§ï¼š

| å±æ€§         | å–å€¼   | ä½œç”¨                                          |
| ------------ | ------ | --------------------------------------------- |
| paramType    |        | æŸ¥è¯¢å‚æ•°ç±»å‹                                  |
|              | path   | ä»¥åœ°å€çš„å½¢å¼æäº¤æ•°æ®                          |
|              | query  | ç›´æ¥è·Ÿå‚æ•°å®Œæˆè‡ªåŠ¨æ˜ å°„èµ‹å€¼                    |
|              | body   | ä»¥æµçš„å½¢å¼æäº¤ ä»…æ”¯æŒPOST                     |
|              | header | å‚æ•°åœ¨request headers é‡Œè¾¹æäº¤                |
|              | form   | ä»¥formè¡¨å•çš„å½¢å¼æäº¤ ä»…æ”¯æŒPOST               |
| dataType     |        | å‚æ•°çš„æ•°æ®ç±»å‹ åªä½œä¸ºæ ‡å¿—è¯´æ˜ï¼Œå¹¶æ²¡æœ‰å®é™…éªŒè¯ |
|              | Long   |                                               |
|              | String |                                               |
| name         |        | æ¥æ”¶å‚æ•°å                                    |
| value        |        | æ¥æ”¶å‚æ•°çš„æ„ä¹‰æè¿°                            |
| required     |        | å‚æ•°æ˜¯å¦å¿…å¡«                                  |
|              | true   | å¿…å¡«                                          |
|              | false  | éå¿…å¡«                                        |
| defaultValue |        | é»˜è®¤å€¼                                        |

å¯åŠ¨å¾®æœåŠ¡ï¼Œè®¿é—® http://localhost:51801/swagger-ui.html

```json
{
  "password": "admin",
  "phone": "13511223456"
}
```

#### knife4j

knife4jæ˜¯ä¸ºJava MVCæ¡†æ¶é›†æˆSwaggerç”ŸæˆApiæ–‡æ¡£çš„å¢å¼ºè§£å†³æ–¹æ¡ˆ,å‰èº«æ˜¯swagger-bootstrap-ui,å–åkni4jæ˜¯å¸Œæœ›å®ƒèƒ½åƒä¸€æŠŠåŒ•é¦–ä¸€æ ·å°å·§,è½»é‡,å¹¶ä¸”åŠŸèƒ½å¼ºæ‚!

giteeåœ°å€ï¼šhttps://gitee.com/xiaoym/knife4j

å®˜æ–¹æ–‡æ¡£ï¼šhttps://doc.xiaominfo.com/

æ•ˆæœæ¼”ç¤ºï¼šhttp://knife4j.xiaominfo.com/doc.html

è¯¥UIå¢å¼ºåŒ…ä¸»è¦åŒ…æ‹¬ä¸¤å¤§æ ¸å¿ƒåŠŸèƒ½ï¼šæ–‡æ¡£è¯´æ˜ å’Œ åœ¨çº¿è°ƒè¯•

- æ–‡æ¡£è¯´æ˜ï¼šæ ¹æ®Swaggerçš„è§„èŒƒè¯´æ˜ï¼Œè¯¦ç»†åˆ—å‡ºæ¥å£æ–‡æ¡£çš„è¯´æ˜ï¼ŒåŒ…æ‹¬æ¥å£åœ°å€ã€ç±»å‹ã€è¯·æ±‚ç¤ºä¾‹ã€è¯·æ±‚å‚æ•°ã€å“åº”ç¤ºä¾‹ã€å“åº”å‚æ•°ã€å“åº”ç ç­‰ä¿¡æ¯ï¼Œä½¿ç”¨swagger-bootstrap-uièƒ½æ ¹æ®è¯¥æ–‡æ¡£è¯´æ˜ï¼Œå¯¹è¯¥æ¥å£çš„ä½¿ç”¨æƒ…å†µä¸€ç›®äº†ç„¶ã€‚
- åœ¨çº¿è°ƒè¯•ï¼šæä¾›åœ¨çº¿æ¥å£è”è°ƒçš„å¼ºå¤§åŠŸèƒ½ï¼Œè‡ªåŠ¨è§£æå½“å‰æ¥å£å‚æ•°,åŒæ—¶åŒ…å«è¡¨å•éªŒè¯ï¼Œè°ƒç”¨å‚æ•°å¯è¿”å›æ¥å£å“åº”å†…å®¹ã€headersã€Curlè¯·æ±‚å‘½ä»¤å®ä¾‹ã€å“åº”æ—¶é—´ã€å“åº”çŠ¶æ€ç ç­‰ä¿¡æ¯ï¼Œå¸®åŠ©å¼€å‘è€…åœ¨çº¿è°ƒè¯•ï¼Œè€Œä¸å¿…é€šè¿‡å…¶ä»–æµ‹è¯•å·¥å…·æµ‹è¯•æ¥å£æ˜¯å¦æ­£ç¡®,ç®€ä»‹ã€å¼ºå¤§ã€‚
- ==ä¸ªæ€§åŒ–é…ç½®==ï¼šé€šè¿‡ä¸ªæ€§åŒ–uié…ç½®é¡¹ï¼Œå¯è‡ªå®šä¹‰UIçš„ç›¸å…³æ˜¾ç¤ºä¿¡æ¯
- ==ç¦»çº¿æ–‡æ¡£==ï¼šæ ¹æ®æ ‡å‡†è§„èŒƒï¼Œç”Ÿæˆçš„åœ¨çº¿markdownç¦»çº¿æ–‡æ¡£ï¼Œå¼€å‘è€…å¯ä»¥è¿›è¡Œæ‹·è´ç”Ÿæˆmarkdownæ¥å£æ–‡æ¡£ï¼Œé€šè¿‡å…¶ä»–ç¬¬ä¸‰æ–¹markdownè½¬æ¢å·¥å…·è½¬æ¢æˆhtmlæˆ–pdfï¼Œè¿™æ ·ä¹Ÿå¯ä»¥æ”¾å¼ƒswagger2markdownç»„ä»¶
- ==æ¥å£æ’åº==ï¼šè‡ª1.8.5åï¼Œuiæ”¯æŒäº†æ¥å£æ’åºåŠŸèƒ½ï¼Œä¾‹å¦‚ä¸€ä¸ªæ³¨å†ŒåŠŸèƒ½ä¸»è¦åŒ…å«äº†å¤šä¸ªæ­¥éª¤,å¯ä»¥æ ¹æ®swagger-bootstrap-uiæä¾›çš„æ¥å£æ’åºè§„åˆ™å®ç°æ¥å£çš„æ’åºï¼ŒstepåŒ–æ¥å£æ“ä½œï¼Œæ–¹ä¾¿å…¶ä»–å¼€å‘è€…è¿›è¡Œæ¥å£å¯¹æ¥

ä½¿ç”¨ï¼š

```xml
<dependency>
     <groupId>com.github.xiaoymin</groupId>
     <artifactId>knife4j-spring-boot-starter</artifactId>
</dependency>
```

```java
@Configuration
@EnableSwagger2
@EnableKnife4j
@Import(BeanValidatorPluginsConfiguration.class)
public class SwaggerConfiguration2 {
```

| æ³¨è§£                | è¯´æ˜                                                                                                                                         |
| ------------------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| `@EnableSwagger2` | è¯¥æ³¨è§£æ˜¯Springfox-swaggeræ¡†æ¶æä¾›çš„ä½¿ç”¨Swaggeræ³¨è§£ï¼Œè¯¥æ³¨è§£å¿…é¡»åŠ                                                                              |
| `@EnableKnife4j`  | è¯¥æ³¨è§£æ˜¯ `knife4j`æä¾›çš„å¢å¼ºæ³¨è§£,Uiæä¾›äº†ä¾‹å¦‚åŠ¨æ€å‚æ•°ã€å‚æ•°è¿‡æ»¤ã€æ¥å£æ’åºç­‰å¢å¼ºåŠŸèƒ½,å¦‚æœä½ æƒ³ä½¿ç”¨è¿™äº›å¢å¼ºåŠŸèƒ½å°±å¿…é¡»åŠ è¯¥æ³¨è§£ï¼Œå¦åˆ™å¯ä»¥ä¸ç”¨åŠ  |

```
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  top.andyron.common.exception.ExceptionCatch,\
  top.andyron.common.swagger.SwaggerConfiguration2
```

http://localhost:51801/doc.html

ğŸ”–  ä¸ºä»€ä¹ˆä¼šå’Œswaggerå†²çª

### appç«¯ç½‘å…³

#### ç½‘å…³æ¦‚è¿°

![](images/image-20231208124634676.png)

#### é¡¹ç›®ä¸­ç½‘å…³

```
leadnews-gateway									ç®¡ç†ç½‘å…³
		leadnews-admin-gateway    		ç®¡ç†å¹³å°ç½‘å…³
		leadnews-wemedia-gateway			è‡ªåª’ä½“ç½‘å…³
		leadnews-app-gateway					appç½‘å…³
```

#### å®ç°

- åœ¨leadnews-gateway

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-gateway</artifactId>
    </dependency>
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
     <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
        </dependency>
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt</artifactId>
    </dependency>
</dependencies>
```

- åœ¨leadnews-gatewayä¸‹åˆ›å»ºleadnews-app-gatewayå¾®æœåŠ¡

bootstrap.yml

```yaml
server:
  port: 51601
spring:
  application:
    name: leadnews-app-gateway
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.0.102:8848
      config:
        server-addr: 192.168.0.102:8848
        file-extension: yml
```

åœ¨nacosçš„é…ç½®ä¸­å¿ƒåˆ›å»ºdataidä¸ºleadnews-app-gatewayçš„ymlé…ç½®

```yaml
spring:
  cloud:
    gateway:
      globalcors:
        add-to-simple-url-handler-mapping: true
        corsConfigurations:
          '[/**]':
            allowedHeaders: "*"
            allowedOrigins: "*"
            allowedMethods:
              - GET
              - POST
              - DELETE
              - PUT
              - OPTION
      routes:
        # å¹³å°ç®¡ç†
        - id: user
          uri: lb://leadnews-user
          predicates:
            - Path=/user/**
          filters:
            - StripPrefix= 1
```

ç¯å¢ƒæ­å»ºå®Œæˆä»¥åï¼Œå¯åŠ¨é¡¹ç›®ç½‘å…³å’Œç”¨æˆ·ä¸¤ä¸ªæœåŠ¡ï¼Œä½¿ç”¨postmanè¿›è¡Œæµ‹è¯•

è¯·æ±‚åœ°å€ï¼šhttp://localhost:51601/user/api/v1/login/login_auth

#### è®¤è¯è¿‡æ»¤å™¨

è®¤è¯è¿‡æ»¤å™¨ç”¨æ¥æ ¡éªŒtokenã€‚

å…¨å±€è¿‡æ»¤å™¨å®ç°jwtæ ¡éªŒ

![](images/image-20231208131031979.png)

åœ¨leandews-app-gatewayä¸­åˆ›å»º `AuthorizeFilter`

### Appå‰ç«¯é›†æˆ

nginxæ–¹å¼é›†æˆå‰ç«¯é¡¹ç›®

![](images/image-20231208133108999.png)

- å‰ç«¯é¡¹ç›®app-web
- é…ç½®nginx

> æ¯ä¸ªé¡¹ç›®å•ç‹¬åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå› ä¸ºä¹‹åè¿˜æœ‰å¾ˆå¤šé¡¹ç›®ã€‚

åœ¨nginxå®‰è£…çš„confç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ `leadnews.conf`,åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸­æ–°å»º `leadnews-app.conf`æ–‡ä»¶:

```nginx
upstream  leadnews-app-gateway {
    server localhost:51601;    # åå‘ä»£ç†åˆ°appç½‘å…³
}

server {
	listen 8801;
	location / {
		root /Users/andyron/myfield/git/ARLeadnews/app-web/;
		index index.html;
	}

	location ~/app/(.*) {
		proxy_pass http://leadnews-app-gateway/$1;
		proxy_set_header HOST $host;  # ä¸æ”¹å˜æºè¯·æ±‚å¤´çš„å€¼
		proxy_pass_request_body on;  #å¼€å¯è·å–è¯·æ±‚ä½“
		proxy_pass_request_headers on;  #å¼€å¯è·å–è¯·æ±‚å¤´
		proxy_set_header X-Real-IP $remote_addr;   # è®°å½•çœŸå®å‘å‡ºè¯·æ±‚çš„å®¢æˆ·ç«¯IP
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  #è®°å½•ä»£ç†ä¿¡æ¯
	}
}
```

åœ¨nginx.confä¸­å¼•å…¥ `leadnews-app.conf`æ–‡ä»¶ï¼š

```nginx
http {
  # ...
  include leadnews.conf/*.conf;
}
```

- é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶

`nginx -s reload`

- æµ‹è¯•

 http://localhost:8801

> ä»ä¸šåŠ¡è§’åº¦åˆ†æå¦‚ä½•åˆ†è¡¨
>
> æ»šå±åˆ†é¡µçš„é€»è¾‘
>
> æ–‡ç« è¯¦æƒ…-å¤§æ–‡æœ¬é™æ€åŒ–æ–¹æ¡ˆï¼ˆfreemarkerï¼Œminioï¼‰

## 2 appç«¯æ–‡ç« æŸ¥çœ‹ï¼Œé™æ€åŒ–freemarker,åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸminIO

### Appæ–‡ç« åˆ—è¡¨

#### éœ€æ±‚åˆ†æ

æ–‡ç« çš„å¸ƒå±€å±•ç¤º

![](images/image-20231208154204744.png)

æ•°æ®åº“leadnews_article

![](images/image-20231208154431646.png)

```mysql
CREATE TABLE `ap_article` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `title` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'æ ‡é¢˜',
  `author_id` int unsigned DEFAULT NULL COMMENT 'æ–‡ç« ä½œè€…çš„ID',
  `author_name` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'ä½œè€…æ˜µç§°',
  `channel_id` int unsigned DEFAULT NULL COMMENT 'æ–‡ç« æ‰€å±é¢‘é“ID',
  `channel_name` varchar(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'é¢‘é“åç§°',
  `layout` tinyint unsigned DEFAULT NULL COMMENT 'æ–‡ç« å¸ƒå±€\r\n            0 æ— å›¾æ–‡ç« \r\n            1 å•å›¾æ–‡ç« \r\n            2 å¤šå›¾æ–‡ç« ',
  `flag` tinyint unsigned DEFAULT NULL COMMENT 'æ–‡ç« æ ‡è®°\r\n            0 æ™®é€šæ–‡ç« \r\n            1 çƒ­ç‚¹æ–‡ç« \r\n            2 ç½®é¡¶æ–‡ç« \r\n            3 ç²¾å“æ–‡ç« \r\n            4 å¤§V æ–‡ç« ',
  `images` varchar(1000) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'æ–‡ç« å›¾ç‰‡\r\n            å¤šå¼ é€—å·åˆ†éš”',
  `labels` varchar(500) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'æ–‡ç« æ ‡ç­¾æœ€å¤š3ä¸ª é€—å·åˆ†éš”',
  `likes` int unsigned DEFAULT NULL COMMENT 'ç‚¹èµæ•°é‡',
  `collection` int unsigned DEFAULT NULL COMMENT 'æ”¶è—æ•°é‡',
  `comment` int unsigned DEFAULT NULL COMMENT 'è¯„è®ºæ•°é‡',
  `views` int unsigned DEFAULT NULL COMMENT 'é˜…è¯»æ•°é‡',
  `province_id` int unsigned DEFAULT NULL COMMENT 'çœå¸‚',
  `city_id` int unsigned DEFAULT NULL COMMENT 'å¸‚åŒº',
  `county_id` int unsigned DEFAULT NULL COMMENT 'åŒºå¿',
  `created_time` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `publish_time` datetime DEFAULT NULL COMMENT 'å‘å¸ƒæ—¶é—´',
  `sync_status` tinyint(1) DEFAULT '0' COMMENT 'åŒæ­¥çŠ¶æ€',
  `origin` tinyint unsigned DEFAULT '0' COMMENT 'æ¥æº',
  `static_url` varchar(150) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=1383828014629179394 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC COMMENT='æ–‡ç« ä¿¡æ¯è¡¨ï¼Œå­˜å‚¨å·²å‘å¸ƒçš„æ–‡ç« ';
```

![](images/image-20231208155017745.png)

> ä¸ºä»€ä¹ˆæ–‡ç« ä¿¡æ¯è¦æ‹†åˆ†æˆå¤šä¸ªè¡¨ï¼Ÿ

è¡¨çš„æ‹†åˆ†-**å‚ç›´åˆ†è¡¨**

å‚ç›´åˆ†è¡¨ï¼šå°†ä¸€ä¸ªè¡¨çš„å­—æ®µåˆ†æ•£åˆ°å¤šä¸ªè¡¨ä¸­ï¼Œæ¯ä¸ªè¡¨å­˜å‚¨å…¶ä¸­ä¸€éƒ¨åˆ†å­—æ®µã€‚

ä¼˜åŠ¿ï¼š

1. ï»¿ï»¿å‡å°‘IOäº‰æŠ¢ï¼Œå‡å°‘é”è¡¨çš„å‡ ç‡ï¼ŒæŸ¥çœ‹æ–‡ç« æ¦‚è¿°ä¸æ–‡ç« è¯¦æƒ…äº’ä¸å½±å“
2. ï»¿ï»¿ï»¿å……åˆ†å‘æŒ¥é«˜é¢‘æ•°æ®çš„æ“ä½œæ•ˆç‡ï¼Œå¯¹æ–‡ç« æ¦‚è¿°æ•°æ®æ“ä½œçš„é«˜æ•ˆç‡ä¸ä¼šè¢«æ“ä½œæ–‡ç« è¯¦æƒ…æ•°æ®çš„ä½æ•ˆç‡æ‰€æ‹–ç´¯ã€‚

æ‹†åˆ†è§„åˆ™ï¼š

1. ï»¿ï»¿ï»¿æŠŠ**ä¸å¸¸ç”¨çš„å­—æ®µ**å•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨
2. ï»¿ï»¿ï»¿æŠŠtextï¼Œblobç­‰**å¤§å­—æ®µ**æ‹†åˆ†å‡ºæ¥å•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨
3. ï»¿ï»¿ï»¿**ç»å¸¸ç»„åˆæŸ¥è¯¢çš„å­—æ®µ**å•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨ä¸­

#### å®ç°æ€è·¯

![](images/image-20231208155627228.png)

1. åœ¨é»˜è®¤é¢‘é“å±•ç¤º10æ¡æ–‡ç« ä¿¡æ¯
2. å¯ä»¥åˆ‡æ¢é¢‘é“æŸ¥çœ‹ä¸åŒç§ç±»æ–‡ç« 
3. å½“ç”¨æˆ·==ä¸‹æ‹‰==å¯ä»¥åŠ è½½æœ€æ–°çš„æ–‡ç« ï¼ˆåˆ†é¡µï¼‰æœ¬é¡µæ–‡ç« åˆ—è¡¨ä¸­å‘å¸ƒæ—¶é—´ä¸ºæœ€å¤§çš„æ—¶é—´ä¸ºä¾æ®
4. å½“ç”¨æˆ·==ä¸Šæ‹‰==å¯ä»¥åŠ è½½æ›´å¤šçš„æ–‡ç« ä¿¡æ¯ï¼ˆæŒ‰ç…§å‘å¸ƒæ—¶é—´ï¼‰æœ¬é¡µæ–‡ç« åˆ—è¡¨ä¸­å‘å¸ƒæ—¶é—´æœ€å°çš„æ—¶é—´ä¸ºä¾æ®
5. å¦‚æœæ˜¯å½“å‰é¢‘é“çš„é¦–é¡µï¼Œå‰ç«¯ä¼ é€’é»˜è®¤å‚æ•°ï¼š

   `maxBehotTime`:0ï¼ˆæ¯«ç§’ï¼‰

   `minBehotTime`: 20000000000000ï¼ˆæ¯«ç§’ï¼‰2063å¹´

é¦–é¡µé»˜è®¤åŠ è½½å°äº2063å¹´çš„æ•°æ®

#### æ¥å£å®šä¹‰

![](images/image-20231208160713084.png)

#### å®ç°

- åœ¨leadnews-serviceä¸­æ·»åŠ ä¸€ä¸ªæ¨¡å—leadnews-article

```yaml
server:
  port: 51802
spring:
  application:
    name: leadnews-article
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.0.102:8848
      config:
        server-addr: 192.168.0.102:8848
        file-extension: yml
```

- éœ€è¦åœ¨nacosä¸­æ·»åŠ å¯¹åº”çš„é…ç½®

```yaml
spring:
  datasource:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/leadnews_article?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&useSSL=false&allowPublicKeyRetrieval=true
      username: root
      password: 33824
# è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: top.andyron.model.article.pojos
```

![](images/image-20231208162601041.png)

- å®šä¹‰æ¥å£
- ç¼–å†™mapperæ–‡ä»¶

æ–‡ç« è¡¨ä¸æ–‡ç« é…ç½®è¡¨å¤šè¡¨æŸ¥è¯¢

- ç¼–å†™ä¸šåŠ¡å±‚ä»£ç 
- ç¼–å†™æ§åˆ¶å™¨ä»£ç 
- swaggeræµ‹è¯•æˆ–å‰åç«¯è”è°ƒæµ‹è¯•

é¦–é¡µè¦åœ¨appç½‘å…³çš„nacosé…ç½®ä¸­å¿ƒæ·»åŠ æ–‡ç« å¾®æœåŠ¡çš„è·¯ç”±ï¼š

```yaml

				# æ–‡ç« å¾®æœåŠ¡
        - id: article
          uri: lb://leadnews-article
          predicates:
            - Path=/article/**
          filters:
            - StripPrefix= 1
```

å¯åŠ¨ç½‘å…³ã€userã€articleå¾®æœåŠ¡

### æ–‡ç« è¯¦æƒ…-å®ç°æ–¹æ¡ˆåˆ†æ

#### æ–¹æ¡ˆ1

æ ¹æ®æ–‡ç« çš„idå»æŸ¥è¯¢æ–‡ç« å†…å®¹è¡¨ï¼Œè¿”å›æ¸²æŸ“é¡µé¢

![](images/image-20231208175801032.png)

#### æ–¹æ¡ˆ2-é™æ€æ¨¡æ¿å±•ç¤º

![](images/image-20231208175735636.png)

### freemarker

#### æ¨¡æ¿å¼•æ“

![](images/image-20231208181155299.png)

[FreeMarker](https://github.com/apache/freemarker) æ˜¯ä¸€æ¬¾ æ¨¡æ¿å¼•æ“ï¼š å³ä¸€ç§åŸºäºæ¨¡æ¿å’Œè¦æ”¹å˜çš„æ•°æ®ï¼Œ å¹¶ç”¨æ¥ç”Ÿæˆè¾“å‡ºæ–‡æœ¬(==HTMLç½‘é¡µï¼Œç”µå­é‚®ä»¶ï¼Œé…ç½®æ–‡ä»¶ï¼Œæºä»£ç ==ç­‰)çš„é€šç”¨å·¥å…·ã€‚ å®ƒ**==ä¸æ˜¯é¢å‘æœ€ç»ˆç”¨æˆ·çš„==**ï¼Œè€Œæ˜¯ä¸€ä¸ªJavaç±»åº“ï¼Œæ˜¯ä¸€æ¬¾ç¨‹åºå‘˜å¯ä»¥åµŒå…¥ä»–ä»¬æ‰€å¼€å‘äº§å“çš„ç»„ä»¶ã€‚

æ¨¡æ¿ç¼–å†™ä¸ºFreeMarker Template Language (FTL)ã€‚å®ƒæ˜¯ç®€å•çš„ï¼Œä¸“ç”¨çš„è¯­è¨€ï¼Œ *ä¸æ˜¯* åƒPHPé‚£æ ·æˆç†Ÿçš„ç¼–ç¨‹è¯­è¨€ã€‚ é‚£å°±æ„å‘³ç€è¦å‡†å¤‡æ•°æ®åœ¨çœŸå®ç¼–ç¨‹è¯­è¨€ä¸­æ¥æ˜¾ç¤ºï¼Œæ¯”å¦‚æ•°æ®åº“æŸ¥è¯¢å’Œä¸šåŠ¡è¿ç®—ï¼Œ ä¹‹åæ¨¡æ¿æ˜¾ç¤ºå·²ç»å‡†å¤‡å¥½çš„æ•°æ®ã€‚åœ¨æ¨¡æ¿ä¸­ï¼Œä½ å¯ä»¥ä¸“æ³¨äºå¦‚ä½•å±•ç°æ•°æ®ï¼Œ è€Œåœ¨æ¨¡æ¿ä¹‹å¤–å¯ä»¥ä¸“æ³¨äºè¦å±•ç¤ºä»€ä¹ˆæ•°æ®ã€‚

#### æŠ€æœ¯é€‰å‹å¯¹æ¯”

å¸¸ç”¨çš„javaæ¨¡æ¿å¼•æ“è¿˜æœ‰å“ªäº›ï¼Ÿ

Jspã€Freemarkerã€Thymeleaf ã€Velocity ç­‰ã€‚

1. Jsp ä¸º Servlet ä¸“ç”¨ï¼Œä¸èƒ½å•ç‹¬è¿›è¡Œä½¿ç”¨ã€‚
2. Thymeleaf ä¸ºæ–°æŠ€æœ¯ï¼ŒåŠŸèƒ½è¾ƒä¸ºå¼ºå¤§ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ•ˆç‡æ¯”è¾ƒä½ã€‚
3. Velocityä»2010å¹´æ›´æ–°å®Œ 2.0 ç‰ˆæœ¬åï¼Œä¾¿æ²¡æœ‰åœ¨æ›´æ–°ã€‚Spring Boot å®˜æ–¹åœ¨ 1.4 ç‰ˆæœ¬åå¯¹æ­¤ä¹Ÿä¸åœ¨æ”¯æŒï¼Œè™½ç„¶ Velocity åœ¨ 2017 å¹´ç‰ˆæœ¬å¾—åˆ°è¿­ä»£ï¼Œä½†ä¸ºæ—¶å·²æ™šã€‚

#### ç¯å¢ƒæ­å»º-å¿«é€Ÿå…¥é—¨

freemarkerä½œä¸ºspringmvcä¸€ç§è§†å›¾æ ¼å¼ï¼Œé»˜è®¤æƒ…å†µä¸‹SpringMVCæ”¯æŒfreemarkerè§†å›¾æ ¼å¼ã€‚

- åˆ›å»ºä¸€ä¸ªfreemarker-demo çš„æµ‹è¯•å·¥ç¨‹ä¸“é—¨ç”¨äºfreemarkerçš„åŠŸèƒ½æµ‹è¯•ä¸æ¨¡æ¿çš„æµ‹è¯•ã€‚

```xml
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-freemarker</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
        </dependency>
        <!-- lombok -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>

        <!-- apache å¯¹ java io çš„å°è£…å·¥å…·åº“ -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-io</artifactId>
            <version>1.3.2</version>
        </dependency>
    </dependencies>
```

- é…ç½®æ–‡ä»¶application.yml

```yaml
server:
  port: 8881 #æœåŠ¡ç«¯å£
spring:
  application:
    name: freemarker-demo #æŒ‡å®šæœåŠ¡å
  freemarker:
    cache: false  #å…³é—­æ¨¡æ¿ç¼“å­˜ï¼Œæ–¹ä¾¿æµ‹è¯•
    settings:
      template_update_delay: 0 #æ£€æŸ¥æ¨¡æ¿æ›´æ–°å»¶è¿Ÿæ—¶é—´ï¼Œè®¾ç½®ä¸º0è¡¨ç¤ºç«‹å³æ£€æŸ¥ï¼Œå¦‚æœæ—¶é—´å¤§äº0ä¼šæœ‰ç¼“å­˜ä¸æ–¹ä¾¿è¿›è¡Œæ¨¡æ¿æµ‹è¯•
    suffix: .ftl               #æŒ‡å®šFreemarkeræ¨¡æ¿æ–‡ä»¶çš„åç¼€å
```

- åˆ›å»ºæ¨¡å‹ç±»
- åˆ›å»ºæ¨¡æ¿

åœ¨resourcesä¸‹åˆ›å»º `templates`ï¼Œæ­¤ç›®å½•ä¸ºfreemarkerçš„é»˜è®¤æ¨¡æ¿å­˜æ”¾ç›®å½•ã€‚

åœ¨templatesä¸‹åˆ›å»ºæ¨¡æ¿æ–‡ä»¶ 01-basic.ftlï¼Œæ¨¡æ¿ä¸­çš„==æ’å€¼è¡¨è¾¾å¼==æœ€ç»ˆä¼šè¢«freemarkeræ›¿æ¢æˆå…·ä½“çš„æ•°æ®ã€‚

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World!</title>
</head>
<body>
<b>æ™®é€šæ–‡æœ¬ String å±•ç¤ºï¼š</b><br><br>
Hello ${name} <br>
<hr>
<b>å¯¹è±¡Studentä¸­çš„æ•°æ®å±•ç¤ºï¼š</b><br/>
å§“åï¼š${stu.name}<br/>
å¹´é¾„ï¼š${stu.age}
<hr>
</body>
</html>
```

- åˆ›å»ºcontroller
- åˆ›å»ºå¯åŠ¨ç±»
- æµ‹è¯•

http://localhost:8881/basic

![](images/image-20231208182656467.png)

freemarkeræ¨¡æ¿æ–‡ä»¶é€šå¸¸éƒ½æ˜¯ä»¥ftlä½œä¸ºæ‰©å±•åï¼Œä¹Ÿå¯ä»¥ä¸ºhtmlã€xmlã€jspç­‰

`FreeMarkerAutoConfiguration`

`FreeMarkerProperties`

#### FreemarkeræŒ‡ä»¤è¯­æ³•

##### åŸºç¡€è¯­æ³•ç§ç±»

- æ³¨é‡Š

```velocity
<#-- æˆ‘æ˜¯ä¸€ä¸ªfreemarkeræ³¨é‡Š -->
```

- æ’å€¼ï¼ˆInterpolationï¼‰ï¼šå³ **`${..}`** éƒ¨åˆ†,freemarkerä¼šç”¨çœŸå®çš„å€¼ä»£æ›¿**`${..}`**

```velocity
Hello ${name}
```

- ==FTLæŒ‡ä»¤==ï¼šå’ŒHTMLæ ‡è®°ç±»ä¼¼ï¼Œåå­—å‰åŠ #äºˆä»¥åŒºåˆ†ï¼ŒFreemarkerä¼šè§£ææ ‡ç­¾ä¸­çš„è¡¨è¾¾å¼æˆ–é€»è¾‘ã€‚

```html
<# >FTLæŒ‡ä»¤</#> 
```

æœ‰å¾ˆå¤šFTLæŒ‡ä»¤

- æ–‡æœ¬ï¼Œä»…æ–‡æœ¬ä¿¡æ¯ï¼Œè¿™äº›ä¸æ˜¯freemarkerçš„æ³¨é‡Šã€æ’å€¼ã€FTLæŒ‡ä»¤çš„å†…å®¹ä¼šè¢«freemarkerå¿½ç•¥è§£æï¼Œç›´æ¥è¾“å‡ºå†…å®¹ã€‚

```velocity
<#--freemarkerä¸­çš„æ™®é€šæ–‡æœ¬-->
æˆ‘æ˜¯ä¸€ä¸ªæ™®é€šçš„æ–‡æœ¬
```

##### é›†åˆæŒ‡ä»¤ï¼ˆListå’ŒMapï¼‰

```html
<#list></#list>
```

List:

```html
    <#list stus as stu >
      <tr>
        <td>${stu_index}</td>
        <td>${stu.name}</td>
        <td>${stu.age}</td>
        <td>${stu.money}</td>
      </tr>
    </#list>
```

`${k_index}`å¾—åˆ°å¾ªç¯çš„ä¸‹è¡¨ï¼Œä»0å¼€å§‹ï¼Œæ˜¯stuåŠ ä¸Š `_index`ã€‚

è·å–mapä¸­çš„å€¼ï¼š

```
map["keyname"].property
map.keyname.property
```

éå†mapï¼š

```html
		<#list stuMap?keys as key >
        <tr>
            <td>${key_index}</td>
            <td>${stuMap[key].name}</td>
            <td>${stuMap[key].age}</td>
            <td>${stuMap[key].money}</td>
        </tr>
    </#list>
```

##### ifæŒ‡ä»¤

```html
<#if expression>
<#else>
</#if>
```

```html
<table>
    <tr>
        <td>å§“å</td>
        <td>å¹´é¾„</td>
        <td>é’±åŒ…</td>
    </tr>
    <#list stus as stu >
        <#if stu.name='å°çº¢'>
            <tr style="color: red">
                <td>${stu_index}</td>
                <td>${stu.name}</td>
                <td>${stu.age}</td>
                <td>${stu.money}</td>
            </tr>
            <#else >
            <tr>
                <td>${stu_index}</td>
                <td>${stu.name}</td>
                <td>${stu.age}</td>
                <td>${stu.money}</td>
            </tr>
        </#if>
    </#list>
</table>
```

##### è¿ç®—ç¬¦

- ç®—æ•°è¿ç®—ç¬¦

é™¤äº† + è¿ç®—ä»¥å¤–ï¼Œå…¶ä»–çš„è¿ç®—åªèƒ½å’Œ number æ•°å­—ç±»å‹çš„è®¡ç®—ã€‚

```html
<b>ç®—æ•°è¿ç®—ç¬¦</b>
<br/><br/>
    100+5 è¿ç®—ï¼š  ${100 + 5 }<br/>
    100 - 5 * 5è¿ç®—ï¼š${100 - 5 * 5}<br/>
    5 / 2è¿ç®—ï¼š${5 / 2}<br/>
    12 % 10è¿ç®—ï¼š${12 % 10}<br/>
<hr>
```

- æ¯”è¾ƒè¿ç®—ç¬¦

![](images/image-20231208190601994.png)

![](images/image-20231208190638809.png)

- é€»è¾‘è¿ç®—ç¬¦

```html
<b>é€»è¾‘è¿ç®—ç¬¦</b>
    <br/>
    <br/>
    <#if (10 lt 12 )&&( 10  gt  5 )  >
        (10 lt 12 )&&( 10  gt  5 )  æ˜¾ç¤ºä¸º true
    </#if>
    <br/>
    <br/>
    <#if !false>
        false å–åä¸ºtrue
    </#if>
<hr>
```

##### ç©ºå€¼å¤„ç†

- åˆ¤æ–­æŸå˜é‡æ˜¯å¦å­˜åœ¨ä½¿ç”¨ â€œ`??`â€

```html
    <#if stus??>
    </#if>
```

- ç¼ºå¤±å˜é‡é»˜è®¤å€¼ä½¿ç”¨ â€œ`!`â€

ä½¿ç”¨!è¦ä»¥æŒ‡å®šä¸€ä¸ªé»˜è®¤å€¼ï¼Œå½“å˜é‡ä¸ºç©ºæ—¶æ˜¾ç¤ºé»˜è®¤å€¼ï¼Œ `${name!''}`è¡¨ç¤ºå¦‚æœnameä¸ºç©ºæ˜¾ç¤ºç©ºå­—ç¬¦ä¸²ã€‚

å¦‚æœæ˜¯åµŒå¥—å¯¹è±¡åˆ™å»ºè®®ä½¿ç”¨ï¼ˆï¼‰æ‹¬èµ·æ¥ï¼Œä¾‹ï¼š `${(stu.bestFriend.name)!''}`è¡¨ç¤ºï¼Œå¦‚æœstuæˆ–bestFriendæˆ–nameä¸ºç©ºé»˜è®¤æ˜¾ç¤ºç©ºå­—ç¬¦ä¸²ã€‚

##### å†…å»ºå‡½æ•°

å†…å»ºå‡½æ•°è¯­æ³•æ ¼å¼ï¼š `å˜é‡+?+å‡½æ•°åç§°`

- é›†åˆçš„å¤§å°

  `${é›†åˆå?size}`
- æ—¥æœŸæ ¼å¼åŒ–

  æ˜¾ç¤ºå¹´æœˆæ—¥: `${today?date}`
  æ˜¾ç¤ºæ—¶åˆ†ç§’ï¼š`${today?time}`
  æ˜¾ç¤ºæ—¥æœŸ+æ—¶é—´ï¼š`${today?datetime}`
  è‡ªå®šä¹‰æ ¼å¼åŒ–ï¼š  `${today?string("yyyyå¹´MMæœˆ")}`
- å†…å»ºå‡½æ•° `c`

  ```java
  model.addAttribute("point", 102920122);
  ```

  pointæ˜¯æ•°å­—å‹ï¼Œä½¿ç”¨${point}ä¼šæ˜¾ç¤ºè¿™ä¸ªæ•°å­—çš„å€¼ï¼Œæ¯ä¸‰ä½ä½¿ç”¨é€—å·åˆ†éš”ã€‚

  å¦‚æœä¸æƒ³æ˜¾ç¤ºä¸ºæ¯ä¸‰ä½åˆ†éš”çš„æ•°å­—ï¼Œå¯ä»¥ä½¿ç”¨cå‡½æ•°å°†æ•°å­—å‹è½¬æˆå­—ç¬¦ä¸²è¾“å‡º

  `${point?c}`
- å°†jsonå­—ç¬¦ä¸²è½¬æˆå¯¹è±¡

 assignæ ‡ç­¾ï¼Œassignçš„ä½œç”¨æ˜¯å®šä¹‰ä¸€ä¸ªå˜é‡

```html
<#assign text="{'bank':'å·¥å•†é“¶è¡Œ','account':'10101920201920212'}" />
<#assign data=text?eval />
å¼€æˆ·è¡Œï¼š${data.bank}  è´¦å·ï¼š${data.account}
```

#### è¾“å‡ºé™æ€åŒ–æ–‡ä»¶

ä½¿ç”¨freemarkderåŸå§‹apiè®²é¡µé¢ç”Ÿæˆhtmlæ–‡ä»¶

![](images/image-20231208191831939.png)

```java
Template template = configuration.getTemplate("02-list.ftl");

// åˆæˆæ–¹æ³•
// ç¬¬ä¸€ä¸ªå‚æ•°ï¼šæ¨¡å‹æ•°æ®
// ç¬¬äºŒä¸ªå‚æ•°ï¼šè¾“å‡ºæµ
template.process(getData(), new FileWriter("/Users/andyron/Downloads/list.html"));

```

### å¯¹è±¡å­˜å‚¨æœåŠ¡MinIO

åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ

#### å¯¹è±¡å­˜å‚¨çš„æ–¹å¼å¯¹æ¯”

![](images/image-20231208193311299.png)

#### åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ

![](images/image-20231208193622650.png)

#### MinIOç®€ä»‹

[MinIO](https://github.com/minio/minio)åŸºäºApache License v2.0å¼€æºåè®®çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œå¯ä»¥åšä¸ºäº‘å­˜å‚¨çš„è§£å†³æ–¹æ¡ˆç”¨æ¥ä¿å­˜æµ·é‡çš„å›¾ç‰‡ï¼Œè§†é¢‘ï¼Œæ–‡æ¡£ã€‚

- Golangå®ç°ï¼Œé…ç½®ç®€å•ï¼Œå•è¡Œå‘½ä»¤å¯ä»¥è¿è¡Œèµ·æ¥ã€‚
- MinIOå…¼å®¹äºšé©¬é€ŠS3äº‘å­˜å‚¨æœåŠ¡æ¥å£ï¼ˆä¹‹åä¸æƒ³è‡ªå·±ç»´æŠ¤äº†ï¼Œå¯ä»¥ç›´æ¥å°†å…¶éƒ¨ç½²åˆ°äº‘ä¸Šï¼‰ï¼Œéå¸¸é€‚åˆäºå­˜å‚¨å¤§å®¹é‡éç»“æ„åŒ–çš„æ•°æ®ï¼Œä¾‹å¦‚å›¾ç‰‡ã€è§†é¢‘ã€æ—¥å¿—æ–‡ä»¶ã€å¤‡ä»½æ•°æ®å’Œå®¹å™¨/è™šæ‹Ÿæœºé•œåƒç­‰ï¼Œè€Œä¸€ä¸ªå¯¹è±¡æ–‡ä»¶å¯ä»¥æ˜¯ä»»æ„å¤§å°ï¼Œä»å‡ kbåˆ°æœ€å¤§5Tä¸ç­‰ã€‚

**S3 ï¼ˆ Simple Storage Serviceç®€å•å­˜å‚¨æœåŠ¡ï¼‰**  ä¸€ç§äº‘æ ‡å‡†

MinIOåŸºæœ¬æ¦‚å¿µ

- bucket â€“ ç±»æ¯”äºæ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•
- Object â€“ ç±»æ¯”æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶
- Keys â€“ ç±»æ¯”æ–‡ä»¶å

å®˜ç½‘æ–‡æ¡£ï¼šhttp://docs.minio.org.cn/docs/

MinIOç‰¹ç‚¹ï¼š

- æ•°æ®ä¿æŠ¤

  Minioä½¿ç”¨Minio Erasure Codeï¼ˆçº åˆ ç ï¼‰æ¥é˜²æ­¢ç¡¬ä»¶æ•…éšœã€‚å³ä¾¿æŸåä¸€åŠä»¥ä¸Šçš„driverï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä»ä¸­æ¢å¤ã€‚
- é«˜æ€§èƒ½

  ä½œä¸ºé«˜æ€§èƒ½å¯¹è±¡å­˜å‚¨ï¼Œåœ¨æ ‡å‡†ç¡¬ä»¶æ¡ä»¶ä¸‹å®ƒèƒ½è¾¾åˆ°55GB/sçš„è¯»ã€35GB/sçš„å†™é€Ÿç‡
- å¯æ‰©å®¹

  ä¸åŒMinIOé›†ç¾¤å¯ä»¥ç»„æˆè”é‚¦ï¼Œå¹¶å½¢æˆä¸€ä¸ªå…¨å±€çš„å‘½åç©ºé—´ï¼Œå¹¶è·¨è¶Šå¤šä¸ªæ•°æ®ä¸­å¿ƒ
- SDKæ”¯æŒ

  åŸºäºMinioè½»é‡çš„ç‰¹ç‚¹ï¼Œå®ƒå¾—åˆ°ç±»ä¼¼Javaã€Pythonæˆ–Goç­‰è¯­è¨€çš„sdkæ”¯æŒ
- æœ‰æ“ä½œé¡µé¢

  é¢å‘ç”¨æˆ·å‹å¥½çš„ç®€å•æ“ä½œç•Œé¢ï¼Œéå¸¸æ–¹ä¾¿çš„ç®¡ç†BucketåŠé‡Œé¢çš„æ–‡ä»¶èµ„æº
- åŠŸèƒ½ç®€å•

  è¿™ä¸€è®¾è®¡åŸåˆ™è®©MinIOä¸å®¹æ˜“å‡ºé”™ã€æ›´å¿«å¯åŠ¨
- ä¸°å¯Œçš„API

  æ”¯æŒæ–‡ä»¶èµ„æºçš„åˆ†äº«è¿æ¥åŠåˆ†äº«é“¾æ¥çš„è¿‡æœŸç­–ç•¥ã€å­˜å‚¨æ¡¶æ“ä½œã€æ–‡ä»¶åˆ—è¡¨è®¿é—®åŠæ–‡ä»¶ä¸Šä¼ ä¸‹è½½çš„åŸºæœ¬åŠŸèƒ½ç­‰ã€‚
- æ–‡ä»¶å˜åŒ–ä¸»åŠ¨é€šçŸ¥

  å­˜å‚¨æ¡¶ï¼ˆBucketï¼‰å¦‚æœå‘ç”Ÿæ”¹å˜,æ¯”å¦‚ä¸Šä¼ å¯¹è±¡å’Œåˆ é™¤å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨å­˜å‚¨æ¡¶äº‹ä»¶é€šçŸ¥æœºåˆ¶è¿›è¡Œç›‘æ§ï¼Œå¹¶é€šè¿‡ä»¥ä¸‹æ–¹å¼å‘å¸ƒå‡ºå»:AMQPã€MQTTã€Elasticsearchã€Redisã€NATSã€MySQLã€Kafkaã€Webhooksç­‰ã€‚

#### MinIOå®‰è£…

dockerå®‰è£…MinIOn

- `docker pull minio/minio`
- åˆ›å»ºå®¹å™¨

```shell
docker run -p 9000:9000 --name minio -d --restart=always -e "MINIO_ACCESS_KEY=minio" -e "MINIO_SECRET_KEY=minio123" -v /home/data:/data -v /home/config:/root/.minio minio/minio server /data
```

- è®¿é—®minio

```shell
docker run -p 9000:9000 --name minio -d --restart=always -e "MINIO_ROOT_USER=minio" -e "MINIO_ROOT_PASSWORD=minio123" -v /home/data:/data -v /home/config:/root/.minio minio/minio server /data
```

è®¿é—®æŠ¥é”™

```
Warning: The standard parity is set to 0. This can lead to data loss.
```

> åœ¨macosæœ¬åœ°éƒ¨ç½²minios
>
> ```shell
> curl -O https://dl.minio.org.cn/server/minio/release/darwin-arm64/minio
> chmod +x ./minio
> ```
>
> ä¸‹è½½ï¼Œåªæ˜¯å•ä¸€æ‰§è¡Œæ–‡ä»¶ã€‚
>
> è¿è¡Œï¼Œé…ç½®ä¸€äº›å‚æ•°
>
> ```shell
> ./minio server --config-dir=/Users/andyron/myfield/env/minio/config --address=:9000 /Users/andyron/myfield/env/minio/data
> ```
>
> minioadmin
>
> minioadmin
>
> è®¿é—®æœ¬åœ°9000ç«¯å£å³å¯ http://localhost:9000

#### minioå¿«é€Ÿå…¥é—¨

åˆ›å»ºæ¨¡å—minio-demo

```java

        try {
            FileInputStream fileInputStream = new FileInputStream("/Users/andyron/myfield/tmp/list.html"); 

            // 1 åˆ›å»ºminioé“¾æ¥å®¢æˆ·ç«¯
            MinioClient minioClient = MinioClient.builder().credentials("minioadmin", "minioadmin")
                    .endpoint("http://192.168.0.102:9000").build();
            // 2 ä¸Šä¼ 
            PutObjectArgs objectArgs = PutObjectArgs.builder()
                    .object("list.html")        // æ–‡ä»¶å
                    .contentType("text/html")         // æ–‡ä»¶ç±»å‹
                    .bucket("leadnews")         // æ¡¶åç§°ï¼Œä¸åœ¨minioç®¡ç†ç•Œé¢åˆ›å»ºçš„æ¡¶ä¸€è‡´
                    // -1 è¡¨ç¤ºä¸Šä¼ æ‰€æœ‰
                    .stream(fileInputStream, fileInputStream.available(), -1)
                    .build();
            minioClient.putObject(objectArgs);

            // è®¿é—®è·¯å¾„
            System.out.println("http://192.168.0.102:9000/leadnews/list.html");
        } catch (Exception e) {
            e.printStackTrace();
        }
```

éœ€è¦è®¾ç½®ä¸‹é€šé“è®¿é—®æƒé™ï¼Œç„¶åä¸Šä¼ é¢æ–‡ä»¶å°±èƒ½åœ¨æµè§ˆå™¨ç›´æ¥è®¿é—®äº†

![](images/iShot_2023-12-08_22.41.39.png)

http://192.168.0.102:9000/leadnews/list.html

#### å°è£…MinIOä¸ºstarter

ä¸ºä»€ä¹ˆéœ€è¦å°è£…MinIOä¸ºstarterï¼Ÿ

![](images/image-20231208224521367.png)

> [p39 2:30](https://www.bilibili.com/video/BV1Qs4y1v7x4?p=39&vd_source=634715056d593def3fe15c44fd54e180)  å½“éœ€è¦æ‹·è´ç›®å½•åˆ°é¡¹ç›®ä¸­å˜æˆæ¨¡å—ï¼Œæ€ä¹ˆæ“ä½œ â¤ï¸

- å»ºç«‹ä¸¤ä¸ªæ¨¡å—

```
leadnews-basic
		file-starter
```

```xml
				<dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-autoconfigure</artifactId>
        </dependency>
        <dependency>
            <groupId>io.minio</groupId>
            <artifactId>minio</artifactId>
            <version>7.1.0</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-configuration-processor</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
```

```
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  top.andyron.file.service.impl.MinIOFileStorageService
```

##### æµ‹è¯•å°è£…çš„starter

- åœ¨minio-demoä¸­å¼•å…¥è‡ªå®šä¹‰çš„starter

```xml
				<dependency>
            <groupId>top.andyron</groupId>
            <artifactId>file-starter</artifactId>
            <version>0.0.1-SNAPSHOT</version>
        </dependency>
```

- åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œé…ç½®å±æ€§ä¸è‡ªå®šä¹‰çš„ `MinIOConfigProperties`ä¸€è‡´

```yaml
minio:
  accessKey: minioadmin
  secretKey: minioadmin
  bucket: leadnews
  endpoint: http://192.168.0.102:9000
  readPath: http://192.168.0.102:9000
```

- æµ‹è¯•ï¼Œæ³¨å…¥`FileStorageService`ä½¿ç”¨ï¼š

```java
@SpringBootTest(classes = MinIOApplication.class)
@RunWith(SpringRunner.class)
public class MinIOTest {

    @Autowired
    private FileStorageService fileStorageService;
    // æµ‹è¯•è‡ªå®šä¹‰starter
    @Test
    public void test() throws FileNotFoundException {
        FileInputStream fileInputStream = new FileInputStream("/Users/andyron/myfield/tmp/list.html");
        String path = fileStorageService.uploadHtmlFile("", "list.html", fileInputStream);
        System.out.println(path);
    }
}
```

ä¸Šä¼ æ–‡ä»¶åˆ°MinIOï¼Œå¹¶è¿”å›äº†è®¿é—®åœ°å€ http://192.168.0.102:9000/leadnews/2023/12/08/list.html

### æ–‡ç« è¯¦æƒ…

#### å®ç°æ­¥éª¤

1. åœ¨artileå¾®æœåŠ¡ä¸­æ·»åŠ MinIOå’Œfreemarkerçš„æ”¯æŒï¼Œå‚è€ƒæµ‹è¯•é¡¹ç›®

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-freemarker</artifactId>
</dependency>
<dependency>
  <groupId>top.andyron</groupId>
  <artifactId>file-starter</artifactId>
  <version>0.0.1-SNAPSHOT</version>
</dependency>
```

åœ¨nacosä¸­çš„æ–‡ç« å¾®æœåŠ¡æ·»åŠ å¤‡æ³¨ï¼š

```yaml
minio:
  accessKey: minioadmin
  secretKey: minioadmin
  bucket: leadnews
  endpoint: http://192.168.0.102:9000
  readPath: http://192.168.0.102:9000
```

2. åˆ›å»ºæ¨¡æ¿æ–‡ä»¶ï¼ˆarticle.ftlï¼‰
3. åˆ›å»ºindex.jså’Œindex.cssæ–‡ä»¶ï¼Œæ‰‹åŠ¨ä¸Šä¼ åˆ°MinIOèŒå·¥
4. åœ¨artileå¾®æœåŠ¡ä¸­æ–°å¢æµ‹è¯•ç±»ï¼ˆåæœŸæ–°å¢æ–‡ç« çš„æ—¶å€™åˆ›å»ºè¯¦æƒ…é™æ€é¡µï¼Œç›®å‰æš‚æ—¶æ‰‹åŠ¨ç”Ÿæˆï¼‰

```java
				// 1 è·å–æ–‡ç« å†…å®¹
        ApArticleContent apArticleContent = apArticleContentMapper
                .selectOne(Wrappers.<ApArticleContent>lambdaQuery()
                .eq(ApArticleContent::getArticleId, "1383828014629179393"));
        if (apArticleContent != null && StringUtils.isNotBlank(apArticleContent.getContent())) {
            //2 æ–‡ç« å†…å®¹é€šè¿‡freemarkerç”Ÿæˆhtmlæ–‡ä»¶
            Template template = configuration.getTemplate("article.ftl");
            // æ•°æ®æ¨¡å‹
            Map<String, Object> content = new HashMap<>();
            content.put("content", JSONArray.parseArray(apArticleContent.getContent()));
            StringWriter out = new StringWriter();
            template.process(content, out);

            //3 æŠŠhtmlæ–‡ä»¶ä¸Šä¼ åˆ°minioä¸­
            InputStream in = new ByteArrayInputStream(out.toString().getBytes());
            String path = fileStorageService.uploadHtmlFile("", apArticleContent.getArticleId() + ".html", in);

            //4 ä¿®æ”¹ap_articleè¡¨ï¼Œä¿å­˜static_urlå­—æ®µ
            apArticleService.update(Wrappers.<ApArticle>lambdaUpdate()
                    .eq(ApArticle::getId, apArticleContent.getArticleId())
                    .set(ApArticle::getStaticUrl, path));

        }
```

ğŸ”– ç”Ÿæˆhtmlä¸­ä¸€äº›å‚æ•°æ²¡æœ‰

> è‡ªåª’ä½“ç¯å¢ƒ
>
>     åå°ç¯å¢ƒ
>
>     å‰å°ç¯å¢ƒ
>
> ç´ æç®¡ç†
>
>     minIOçš„å›¾ç‰‡ä¸Šä¼ 
>
>     å¾®æœåŠ¡ä¸­è·å–ç”¨æˆ·çš„æ–¹å¼
>
>     æ‹¦æˆªå™¨çš„ä½¿ç”¨
>
> æ–‡ç« ç®¡ç†
>
>     å¤šæ¡ä»¶æŸ¥è¯¢
>
>     å¤æ‚ä¸šåŠ¡çš„å¤„ç†ï¼ˆæ–‡ç« å‘å¸ƒï¼‰
>
>     jdk8ä¸­çš„æ–°ç‰¹æ€§

## 3 è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ

### è‡ªåª’ä½“å‰åç«¯æ­å»º

#### åå°æ­å»º

```
arleandnews-service
		leandnews-service
				leandnews-wemedia
		leandnews-gateway
				leandnews-wemedia-gateway
```

æ­å»ºæ­¥éª¤

1. åŸºç¡€ç¯å¢ƒå’Œæ•°æ®å‡†å¤‡

æ•°æ®åº“leadnews_wemedia

åœ¨leandnews-modelæ¨¡å—ä¸­æ·»åŠ å¯¹åº”ç›¸åº”é…ç½®

2. leandnews-wemediaæ¨¡å—

æ·»åŠ ç›¸åº”nacosé…ç½®

```yaml
spring:
  datasource:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/leadnews_wemedia?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&useSSL=false&allowPublicKeyRetrieval=true
      username: root
      password: 33824
# è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: top.andyron.model.wemedia.pojos

```

3. leandnews-wemedia-gatewayæ¨¡å—

æ·»åŠ å¯¹åº”nacosé…ç½®

```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]': # åŒ¹é…æ‰€æœ‰è¯·æ±‚
            allowedOrigins: "*" #è·¨åŸŸå¤„ç† å…è®¸æ‰€æœ‰çš„åŸŸ
            allowedMethods: # æ”¯æŒçš„æ–¹æ³•
              - GET
              - POST
              - PUT
              - DELETE
      routes:
        # å¹³å°ç®¡ç†
        - id: wemedia
          uri: lb://leadnews-wemedia
          predicates:
            - Path=/wemedia/**
          filters:
            - StripPrefix= 1
```

#### å‰å°æ­å»º

é€šè¿‡nginxçš„è™šæ‹Ÿä¸»æœºåŠŸèƒ½ï¼Œä½¿ç”¨åŒä¸€ä¸ªnginxè®¿é—®å¤šä¸ªé¡¹ç›®

![](images/image-20231209211900862.png)

- è‡ªåª’ä½“å‰ç«¯ï¼šwemedia-web
- åœ¨nginxä¸­é…ç½®leadnews.confç›®å½•ä¸­æ–°å¢leadnews-wemedia.confæ–‡ä»¶

```nginx
upstream  leadnews-wemedia-gateway {
    server localhost:51602;  
}

server {
    listen 8802;
    location / {
        root /Users/andyron/myfield/git/ARLeadnews/wemedia-web/;
        index index.html;
    }
  
    location ~/wemedia/MEDIA/(.*) {
        proxy_pass http://leadnews-wemedia-gateway/$1;
        proxy_set_header HOST $host;  # ä¸æ”¹å˜æºè¯·æ±‚å¤´çš„å€¼
        proxy_pass_request_body on;  #å¼€å¯è·å–è¯·æ±‚ä½“
        proxy_pass_request_headers on;  #å¼€å¯è·å–è¯·æ±‚å¤´
        proxy_set_header X-Real-IP $remote_addr;   # è®°å½•çœŸå®å‘å‡ºè¯·æ±‚çš„å®¢æˆ·ç«¯IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  #è®°å½•ä»£ç†ä¿¡æ¯
    }
}
```

`nginx -s reload`

- å¯åŠ¨nginxï¼Œå¯åŠ¨è‡ªåª’ä½“å¾®æœåŠ¡å’Œå¯¹åº”ç½‘å…³
- è”è°ƒæµ‹è¯•ç™»å½•åŠŸèƒ½

http://localhost:8802/

### è‡ªåª’ä½“ç´ æç®¡ç†

è‡ªåª’ä½“æ ¸å¿ƒï¼šä¸Šä¼ æ–‡ç« 

#### ç´ æä¸Šä¼ 

```sql
CREATE TABLE `wm_news_material` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `material_id` int unsigned DEFAULT NULL COMMENT 'ç´ æID',
  `news_id` int unsigned DEFAULT NULL COMMENT 'å›¾æ–‡ID',
  `type` tinyint unsigned DEFAULT NULL COMMENT 'å¼•ç”¨ç±»å‹\r\n            0 å†…å®¹å¼•ç”¨\r\n            1 ä¸»å›¾å¼•ç”¨',
  `ord` tinyint unsigned DEFAULT NULL COMMENT 'å¼•ç”¨æ’åº',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=281 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC COMMENT='è‡ªåª’ä½“å›¾æ–‡å¼•ç”¨ç´ æä¿¡æ¯è¡¨';
```

åœ¨ç´ æè¡¨ä¸­çš„ç”¨æˆ·ä¿¡æ¯å¦‚ä½•å¾—åˆ°ï¼Ÿ
ç´ æçš„ä¿¡æ¯ä¿å­˜åˆ°ä»€ä¹ˆä½ç½®ï¼Ÿ

##### å®ç°æ€è·¯

![](images/image-20231210175934144.png)

1. tokenä¸­è§£æç”¨æˆ·idï¼Œå­˜å…¥headerã€‚

åœ¨è‡ªåª’ä½“ç½‘å…³ä¸­çš„ `AuthorizeFilter`æ·»åŠ ï¼š

```java
            // è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä¹‹å‰tokenä¸­å­˜å‚¨çš„å°±æ˜¯id
            Object userId = claimsBody.get("id");
            // å­˜å‚¨headerä¸­
            ServerHttpRequest serverHttpRequest = request.mutate().headers(httpHeaders -> {
                httpHeaders.add("userId", userId + "");
            }).build();
            // é‡ç½®è¯·æ±‚
            exchange.mutate().request(serverHttpRequest);
```

2. è‡ªå®šä¹‰æ‹¦æˆªTokençš„æ‹¦æˆªå™¨WmTokenInterceptorï¼Œå¹¶é…ç½®æ·»åŠ 

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // æ·»åŠ è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨ï¼Œæ‹¦æˆªæ‰€æœ‰è¯·æ±‚
        registry.addInterceptor(new WmTokenInterceptor()).addPathPatterns("/**");
    }
}
```

##### æ¥å£å®šä¹‰

|          | **è¯´æ˜**                  |
| -------- | ------------------------------- |
| æ¥å£è·¯å¾„ | /api/v1/material/upload_picture |
| è¯·æ±‚æ–¹å¼ | POST                            |
| å‚æ•°     | MultipartFile                   |
| å“åº”ç»“æœ | ResponseResult                  |

`MultipartFile`  ï¼šSpringmvcæŒ‡å®šçš„æ–‡ä»¶æ¥æ”¶ç±»å‹

ResponseResult  ï¼š

æˆåŠŸéœ€è¦å›æ˜¾å›¾ç‰‡ï¼Œè¿”å›ç´ æå¯¹è±¡

- å¯¼å…¥è‡ªå®šä¹‰çš„file-starterï¼Œå¼•å…¥minio
- åœ¨nacosä¸­çš„è‡ªåª’ä½“å¾®æœåŠ¡æ·»åŠ å¤‡æ³¨ï¼š

```yaml
minio:
  accessKey: minioadmin
  secretKey: minioadmin
  bucket: leadnews
  endpoint: http://192.168.0.102:9000
  readPath: http://192.168.0.102:9000
```

> ==æ³¨æ„==ï¼šnacosä¸­æœåŠ¡åä¸è¦æé”™ï¼ˆ`_`,`-`ï¼‰

#### ç´ æåˆ—è¡¨æŸ¥è¯¢

##### æ¥å£å®šä¹‰

|          | **è¯´æ˜**        |
| -------- | --------------------- |
| æ¥å£è·¯å¾„ | /api/v1/material/list |
| è¯·æ±‚æ–¹å¼ | POST                  |
| å‚æ•°     | WmMaterialDto         |
| å“åº”ç»“æœ | ResponseResult        |

ResponseResult  :

```json
{
  "host":null,
  "code":200,
  "errorMessage":"æ“ä½œæˆåŠŸ",
  "data":[
    {
    "id":52,
      "userId":1102,
      "url":"http://192.168.200.130:9000/leadnews/2021/04/26/ec893175f18c4261af14df14b83cb25f.jpg",
      "type":0,
      "isCollection":0,
      "createdTime":"2021-01-20T16:49:48.000+0000"
    },
    ....
  ],
  "currentPage":1,
  "size":20,
  "total":0
}
```

##### å®ç°

åœ¨è‡ªåª’ä½“å¯åŠ¨ç±»ä¸­æ·»åŠ mybatis-plusçš„åˆ†é¡µæ‹¦æˆªå™¨

```java
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
```

> ğŸ“¢æ³¨æ„ï¼šå…ˆè¦ç™»å½•ï¼Œè¦ä¸ç„¶ä¼šå‡ºç°NullPointerExceptionï¼Œå› ä¸ºWmThreadLocalUtilä¸­æ²¡æœ‰å­˜å‚¨ç”¨æˆ·ä¿¡æ¯

### è‡ªåª’ä½“æ–‡ç« ç®¡ç†

#### æŸ¥è¯¢æ‰€æœ‰é¢‘é“

#### æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« 

```mysql
CREATE TABLE `wm_news` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `user_id` int unsigned DEFAULT NULL COMMENT 'è‡ªåª’ä½“ç”¨æˆ·ID',
  `title` varchar(36) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'æ ‡é¢˜',
  `content` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci COMMENT 'å›¾æ–‡å†…å®¹',
  `type` tinyint unsigned DEFAULT NULL COMMENT 'æ–‡ç« å¸ƒå±€\r\n            0 æ— å›¾æ–‡ç« \r\n            1 å•å›¾æ–‡ç« \r\n            3 å¤šå›¾æ–‡ç« ',
  `channel_id` int unsigned DEFAULT NULL COMMENT 'å›¾æ–‡é¢‘é“ID',
  `labels` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `created_time` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `submited_time` datetime DEFAULT NULL COMMENT 'æäº¤æ—¶é—´',
  `status` tinyint unsigned DEFAULT NULL COMMENT 'å½“å‰çŠ¶æ€\r\n            0 è‰ç¨¿\r\n            1 æäº¤ï¼ˆå¾…å®¡æ ¸ï¼‰\r\n            2 å®¡æ ¸å¤±è´¥\r\n            3 äººå·¥å®¡æ ¸\r\n            4 äººå·¥å®¡æ ¸é€šè¿‡\r\n            8 å®¡æ ¸é€šè¿‡ï¼ˆå¾…å‘å¸ƒï¼‰\r\n            9 å·²å‘å¸ƒ',
  `publish_time` datetime DEFAULT NULL COMMENT 'å®šæ—¶å‘å¸ƒæ—¶é—´ï¼Œä¸å®šæ—¶åˆ™ä¸ºç©º',
  `reason` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'æ‹’ç»ç†ç”±',
  `article_id` bigint unsigned DEFAULT NULL COMMENT 'å‘å¸ƒåº“æ–‡ç« ID',
  `images` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci COMMENT '//å›¾ç‰‡ç”¨é€—å·åˆ†éš”',
  `enable` tinyint unsigned DEFAULT '1',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=6232 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC COMMENT='è‡ªåª’ä½“å›¾æ–‡å†…å®¹ä¿¡æ¯è¡¨';
```

#### æ–‡ç« å‘å¸ƒ

##### éœ€æ±‚åˆ†æ

![](images/image-20231211095937950.png)

![](images/image-20231211100127259.png)

![](images/image-20231211100328767.png)

##### å®ç°æ€è·¯åŠæµç¨‹

è¯¥åŠŸèƒ½ä¸ºä¿å­˜ã€ä¿®æ”¹ï¼ˆæ˜¯å¦æœ‰idï¼‰ã€ä¿å­˜è‰ç¨¿çš„å…±æœ‰æ–¹æ³•

![](images/image-20231211100559243.png)

1.å‰ç«¯æäº¤å‘å¸ƒæˆ–ä¿å­˜ä¸ºè‰ç¨¿

2.åå°åˆ¤æ–­è¯·æ±‚ä¸­æ˜¯å¦åŒ…å«äº†æ–‡ç« id

3.å¦‚æœä¸åŒ…å«id,åˆ™ä¸ºæ–°å¢

    3.1 æ‰§è¡Œæ–°å¢æ–‡ç« çš„æ“ä½œ
    
    3.2 å…³è”æ–‡ç« å†…å®¹å›¾ç‰‡ä¸ç´ æçš„å…³ç³»
    
    3.3 å…³è”æ–‡ç« å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»

4.å¦‚æœåŒ…å«äº†idï¼Œåˆ™ä¸ºä¿®æ”¹è¯·æ±‚

    4.1 åˆ é™¤è¯¥æ–‡ç« ä¸ç´ æçš„æ‰€æœ‰å…³ç³»
    
    4.2 æ‰§è¡Œä¿®æ”¹æ“ä½œ
    
    4.3 å…³è”æ–‡ç« å†…å®¹å›¾ç‰‡ä¸ç´ æçš„å…³ç³»
    
    4.4 å…³è”æ–‡ç« å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»

##### æ¥å£å®šä¹‰

|          | **è¯´æ˜**         |
| -------- | ---------------------- |
| æ¥å£è·¯å¾„ | /api/v1/channel/submit |
| è¯·æ±‚æ–¹å¼ | POST                   |
| å‚æ•°     | WmNewsDto              |
| å“åº”ç»“æœ | ResponseResult         |

![](images/image-20231211101052424.png)

##### å®ç°

ğŸ”–  å‘å¸ƒæ–‡ç«  å†…å®¹æ ‡ç­¾ä¸èƒ½ä¸ºæˆ–è¶…è¿‡20å­—ç¬¦

## 4 è‡ªåª’ä½“æ–‡ç« -è‡ªåŠ¨å®¡æ ¸

æ–‡ç« æ•°æ®æµï¼š

![æ–‡ç« æ•°æ®æµ](images/image-20231211110741292.png)

å®¡æ ¸æ¶‰åŠçš„å†…å®¹ï¼š

- ç¬¬ä¸‰æ–¹å†…å®¹å®‰å…¨å®¡æ ¸æ¥å£
- åˆ†å¸ƒå¼ä¸»é”®
- å¼‚æ­¥è°ƒç”¨
- feignè¿œç¨‹æ¥å£
- ç†”æ–­é™çº§

### 4.1 è‡ªåª’ä½“æ–‡ç« è‡ªåŠ¨å®¡æ ¸æµç¨‹

å®¡æ ¸æ–¹å¼ï¼š

- è‡ªåŠ¨å®¡æ ¸
  æ–‡ç« å‘å¸ƒä¹‹åï¼Œç³»ç»Ÿè‡ªåŠ¨å®¡æ ¸ï¼Œä¸»è¦æ˜¯é€šè¿‡ç¬¬ä¸‰æ–¹æ¥å£å¯¹æ–‡ç« å†…å®¹è¿›è¡Œå®¡æ ¸ï¼ˆæˆåŠŸã€å¤±è´¥ã€ä¸ç¡®å®šï¼‰ã€‚
- äººå·¥å®¡æ ¸
  å¾…è‡ªåŠ¨å®¡æ ¸è¿”å›==ä¸ç¡®å®š==ä¿¡æ¯æ—¶ï¼Œè½¬åˆ°äººå·¥å®¡æ ¸ï¼Œç”±å¹³å°ç®¡ç†å‘˜è¿›è¡Œå®¡æ ¸ã€‚

å®¡æ ¸æµç¨‹-å¤šç«¯è°ƒç”¨ï¼š

![](images/image-20231212131456329.png)

### 4.2 å†…å®¹å®‰å…¨ç¬¬ä¸‰æ–¹æ¥å£

#### å†…å®¹å®‰å…¨æ¥å£é€‰å‹

å†…å®¹å®‰å…¨æ˜¯è¯†åˆ«æœåŠ¡ï¼Œæ”¯æŒå¯¹å›¾ç‰‡ã€è§†é¢‘ã€æ–‡æœ¬ã€è¯­éŸ³ç­‰å¯¹è±¡è¿›è¡Œå¤šæ ·åŒ–åœºæ™¯æ£€æµ‹ï¼Œæœ‰æ•ˆé™ä½å†…å®¹è¿è§„é£é™©ã€‚

ç›®å‰å¾ˆå¤šå¹³å°éƒ½æ”¯æŒå†…å®¹æ£€æµ‹ï¼Œå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€ç™¾åº¦AIã€ç½‘æ˜“äº‘ç­‰å›½å†…å¤§å‹äº’è”ç½‘å…¬å¸éƒ½å¯¹å¤–æä¾›äº†APIã€‚
æŒ‰ç…§æ€§èƒ½å’Œæ”¶è´¹æ¥çœ‹ï¼Œé»‘é©¬å¤´æ¡é¡¹ç›®ä½¿ç”¨çš„å°±æ˜¯é˜¿é‡Œäº‘çš„å†…å®¹å®‰å…¨æ¥å£ï¼Œä½¿ç”¨åˆ°äº†å›¾ç‰‡å’Œæ–‡æœ¬çš„å®¡æ ¸ã€‚
é˜¿é‡Œäº‘æ”¶è´¹æ ‡å‡†ï¼šhttps://www.aliyun.com/price/product/?spm=a2c4g.11186623.2.10.4146401eg5oeu8#/lvwang/detail

#### å‡†å¤‡å·¥ä½œ

è·å–é˜¿é‡Œäº‘ã€å†…å®¹å®‰å…¨ã€‘çš„AccessKeyIDå’ŒAccessKeySecretã€‚

#### æ–‡æœ¬å†…å®¹å®¡æ ¸æ¥å£

æ–‡æœ¬åƒåœ¾å†…å®¹æ£€æµ‹ï¼šhttps://help.aliyun.com/document_detail/70439.html?spm=a2c4g.11186623.6.659.35ac3db3l0wV5k

æ–‡æœ¬åƒåœ¾å†…å®¹Java SDK: https://help.aliyun.com/document_detail/53427.html?spm=a2c4g.11186623.6.717.466d7544QbU8Lr

#### å›¾ç‰‡å®¡æ ¸æ¥å£

å›¾ç‰‡åƒåœ¾å†…å®¹æ£€æµ‹ï¼šhttps://help.aliyun.com/document_detail/70292.html?spm=a2c4g.11186623.6.616.5d7d1e7f9vDRz4

å›¾ç‰‡åƒåœ¾å†…å®¹Java SDK: https://help.aliyun.com/document_detail/53424.html?spm=a2c4g.11186623.6.715.c8f69b12ey35j4

#### é¡¹ç›®é›†æˆ

1. åœ¨leandnews-commonæ¨¡å—ä¸‹ï¼Œæ·»åŠ é˜¿é‡Œäº‘ã€å†…å®¹å®‰å…¨ã€‘ç›¸å…³å·¥å…·ç±»

![](images/image-20231213083507097.png)

å¹¶åœ¨spring.factoriesæ–‡ä»¶ä¸­æ·»åŠ è‡ªåŠ¨é…ç½®

```
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  top.andyron.common.exception.ExceptionCatch,\
  top.andyron.common.swagger.SwaggerConfiguration,\
  top.andyron.common.aliyun.GreenImageScan,\
  top.andyron.common.aliyun.GreenTextScan
```

2. åœ¨leadnews-wemediaçš„nacosé…ç½®ä¸­å¿ƒé˜¿é‡Œäº‘ã€å†…å®¹å®‰å…¨ã€‘æ·»åŠ é…ç½®ï¼š

```yaml
aliyun:
 accessKeyId: 
 secret: 
#aliyun.scenes=porn,terrorism,ad,qrcode,live,logo
 scenes: terrorism
```

3. åœ¨è‡ªåª’ä½“å¾®æœåŠ¡ä¸­æµ‹è¯•ç±»ä¸­æ³¨å…¥å®¡æ ¸æ–‡æœ¬å’Œå›¾ç‰‡çš„beanè¿›è¡Œæµ‹è¯•

### 4.3 appç«¯æ–‡ç« ä¿å­˜æ¥å£

æ–‡ç« çš„ä¿å­˜æ˜¯åœ¨ä¹‹å‰çš„ã€4.å®¡æ ¸é€šè¿‡ã€‘ä¿å­˜åˆ°æ–‡ç« å¾®æœåŠ¡ä¸­ï¼Œä¿å­˜åˆ°articleåº“ï¼š

![](images/image-20231213111614286.png)

è€Œæ–‡ç« idæ ¼å¼æ˜¯bigintï¼Œä¸æ˜¯è‡ªå¢

#### åˆ†å¸ƒå¼id

éšç€ä¸šåŠ¡çš„å¢é•¿ï¼Œæ–‡ç« è¡¨å¯èƒ½è¦å ç”¨å¾ˆå¤§çš„ç‰©ç†å­˜å‚¨ç©ºé—´ï¼Œä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼ŒåæœŸä½¿ç”¨æ•°æ®åº“åˆ†ç‰‡æŠ€æœ¯ã€‚å°†ä¸€ä¸ªæ•°æ®åº“è¿›è¡Œæ‹†åˆ†ï¼Œé€šè¿‡æ•°æ®åº“ä¸­é—´ä»¶è¿æ¥ã€‚å¦‚æœæ•°æ®åº“ä¸­è¯¥è¡¨é€‰ç”¨IDè‡ªå¢ç­–ç•¥ï¼Œåˆ™å¯èƒ½äº§ç”Ÿé‡å¤çš„IDï¼Œæ­¤æ—¶åº”è¯¥ä½¿ç”¨åˆ†å¸ƒå¼IDç”Ÿæˆç­–ç•¥æ¥ç”ŸæˆIDã€‚

![](images/image-20231213111807488.png)

##### åˆ†å¸ƒå¼id-æŠ€æœ¯é€‰å‹

| **æ–¹æ¡ˆ** | **ä¼˜åŠ¿**                              | **åŠ£åŠ¿**                                                  |
| -------------- | ------------------------------------------- | --------------------------------------------------------------- |
| redis          | ï¼ˆINCRï¼‰ç”Ÿæˆä¸€ä¸ªå…¨å±€è¿ç»­é€’å¢ çš„æ•°å­—ç±»å‹ä¸»é”® | å¢åŠ äº†ä¸€ä¸ªå¤–éƒ¨ç»„ä»¶çš„ä¾èµ–ï¼ŒRedisä¸å¯ç”¨ï¼Œåˆ™æ•´ä¸ªæ•°æ®åº“å°†æ— æ³•åœ¨æ’å…¥ |
| UUID           | å…¨å±€å”¯ä¸€ï¼ŒMysqlä¹Ÿæœ‰UUIDå®ç°                 | 36ä¸ªå­—ç¬¦ç»„æˆï¼Œå ç”¨ç©ºé—´å¤§                                        |
| snowflakeç®—æ³•  | å…¨å±€å”¯ä¸€ ï¼Œæ•°å­—ç±»å‹ï¼Œå­˜å‚¨æˆæœ¬ä½             | æœºå™¨è§„æ¨¡å¤§äº1024å°æ— æ³•æ”¯æŒ                                      |

é›ªèŠ±ç®—æ³•ï¼ˆsnowflakeï¼‰æ˜¯Twitterå¼€æºçš„åˆ†å¸ƒå¼IDç”Ÿæˆç®—æ³•ï¼Œç»“æœæ˜¯ä¸€ä¸ªlongå‹çš„IDã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šä½¿ç”¨41bitä½œä¸ºæ¯«ç§’æ•°ï¼Œ10bitä½œä¸ºæœºå™¨çš„IDï¼ˆ5ä¸ªbitæ˜¯æ•°æ®ä¸­å¿ƒï¼Œ5ä¸ªbitçš„æœºå™¨IDï¼›å¯ä»¥ç†è§£ä¸º32ä¸ªæœºæˆ¿ï¼Œæ¯ä¸ªæœºæˆ¿æœ€å¤š32å°æœºå™¨ï¼‰ï¼Œ12bitä½œä¸ºæ¯«ç§’å†…çš„æµæ°´å·ï¼ˆæ„å‘³ç€æ¯ä¸ªèŠ‚ç‚¹åœ¨æ¯æ¯«ç§’å¯ä»¥äº§ç”Ÿ 4096 ä¸ª IDï¼‰ï¼Œæœ€åè¿˜æœ‰ä¸€ä¸ªç¬¦å·ä½ï¼ˆç¬¬ä¸€ä¸ªï¼‰ï¼Œæ°¸è¿œæ˜¯0ã€‚

![](images/image-20231213112110656.png)

æ–‡ç« ç«¯ç›¸å…³çš„è¡¨éƒ½ä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆid,åŒ…æ‹¬ap_articleã€ ap_article_configã€ ap_article_contentã€‚

mybatis-pluså·²ç»é›†æˆäº†é›ªèŠ±ç®—æ³•ï¼Œå®Œæˆä»¥ä¸‹ä¸¤æ­¥å³å¯åœ¨é¡¹ç›®ä¸­é›†æˆé›ªèŠ±ç®—æ³•

ç¬¬ä¸€ï¼šåœ¨å®ä½“ç±»ä¸­çš„idä¸ŠåŠ å…¥å¦‚ä¸‹é…ç½®ï¼ŒæŒ‡å®šç±»å‹ä¸ºid_worker

```java
@TableId(value = "id",type = IdType.ID_WORKER)
private Long id;
```

ç¬¬äºŒï¼šåœ¨application.ymlæ–‡ä»¶ä¸­é…ç½®æ•°æ®ä¸­å¿ƒidå’Œæœºå™¨id ã€åœ¨leadnews-articleçš„nacosä¸­é…ç½®ã€‘

```yaml
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: top.andyron.model.article.pojos
  global-config:
    datacenter-id: 1
    workerId: 1
```

datacenter-id:æ•°æ®ä¸­å¿ƒid(å–å€¼èŒƒå›´ï¼š0-31)

workerId:æœºå™¨id(å–å€¼èŒƒå›´ï¼š0-31)

#### ä¿å­˜appç«¯æ–‡ç« -æ€è·¯åˆ†æ

åœ¨æ–‡ç« å®¡æ ¸æˆåŠŸä»¥åéœ€è¦åœ¨appçš„articleåº“ä¸­æ–°å¢æ–‡ç« æ•°æ®ã€‚

> wm_newsçš„article_idå¯¹åº”ap_articleçš„idï¼Œwm_newsçš„article_idä¸ºç©ºè¡¨ç¤ºæ–°å¢æ–‡ç« ï¼Œä¸ä¸ºç©ºè¡¨ç¤ºä¿®æ”¹
>
> å½“è‡ªåª’ä½“ä¸­æ·»åŠ æ–‡ç« åï¼Œä½†æ²¡æœ‰å®¡æ ¸æˆåŠŸæ—¶article_idä¸ºç©ºï¼›
>
> å½“å®¡æ ¸æˆåŠŸåæ–‡ç« æ·»åŠ åˆ°appç«¯æ–‡ç« æ¨¡å—å¹¶äº§ç”Ÿæ–‡ç« idï¼Œå†æ·»åŠ åˆ°wm_newsçš„article_idã€‚

1.ä¿å­˜æ–‡ç« ä¿¡æ¯  ap_article
2.ä¿å­˜æ–‡ç« é…ç½®ä¿¡æ¯  ap_article_config
3.ä¿å­˜æ–‡ç« å†…å®¹ ap_article_content

![](images/image-20231213113733226.png)

#### ä¿å­˜appç«¯æ–‡ç« -feignæ¥å£

è‡ªåª’ä½“æ¨¡å—é€šè¿‡ è¿œç¨‹è°ƒç”¨å®ç° æ•°æ®ä¿å­˜åˆ°æ–‡ç« æ¨¡å—

![](images/image-20231213114649483.png)

`ApArticle`æ²¡æœ‰æ–‡ç« å†…å®¹å­—æ®µï¼Œéœ€è¦åœ¨ä¼ è¾“å¯¹è±¡ä¸­æ·»åŠ ã€‚

`ResponseResult`ç»“æœå¯èƒ½ä¸ºï¼š

![](images/image-20231213114727906.png)

#### å®ç°

1. åœ¨leadnews-feign-apiä¸­æ–°å¢æ¥å£

å¯¼å…¥feignçš„ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

å®šä¹‰æ–‡ç« ç«¯çš„è¿œç¨‹æ¥å£:

```java
package top.andyron.apis.article;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import top.andyron.model.article.dto.ArticleDto;
import top.andyron.model.common.dtos.ResponseResult;

/**
 * @author andyron
 **/
@FeignClient(value = "leadnews-article")
public interface IArticleClient {

    @PostMapping("/api/v1/article/save")
    public ResponseResult saveArticle(@RequestBody ArticleDto dto);
}
```

2. åœ¨leadnews-articleä¸­å®ç°feignæ¥å£

```java
@RestController
public class ArticleClient implements IArticleClient {
    @Autowired
    private ApArticleService apArticleService;
    @Override
    @PostMapping("/api/v1/article/save")
    public ResponseResult saveArticle(ArticleDto dto) {
        return apArticleService.saveArticle(dto);
    }
}
```

3. åœ¨æ–‡ç« å¾®æœåŠ¡ä¸­æ·»åŠ  `ApArticleConfigMapper`ã€‚

åœ¨ `ApArticleConfig`ä¸­æ·»åŠ æ„é€ å‡½æ•°ï¼Œè®¾ç½®ä¸€äº›APPå·²å‘å¸ƒæ–‡ç« é»˜è®¤é…ç½®ï¼š

```java
@Data
@NoArgsConstructor
@TableName("ap_article_config")
public class ApArticleConfig implements Serializable {

    public ApArticleConfig(Long articleId){
        this.articleId = articleId;
        this.isComment = true;
        this.isForward = true;
        this.isDelete = false;
        this.isDown = false;
    }
}
```

4. åœ¨ApArticleServiceä¸­æ–°å¢æ–¹æ³•saveArticleï¼Œå¹¶å®ç°
5. æµ‹è¯•

POST http://localhost:51802/user/api/v1/article/save

```json
{
    "title":"ARå¤´æ¡é¡¹ç›®èƒŒæ™¯",
    "authoId":1102,
    "layout":1,
    "labels":"ARå¤´æ¡é¡¹ç›®èƒŒæ™¯",
    "publishTime":"2028-03-14T11:35:49.000Z",
    "images": "http://192.168.0.102:9000/leadnews/2023/12/11/585e27f794e9403681ca5080fe710d0e.jpg",
    "content":"ARå¤´æ¡é¡¹ç›®èƒŒæ™¯,ARå¤´æ¡é¡¹ç›®èƒŒæ™¯,ARå¤´æ¡é¡¹ç›®èƒŒæ™¯,ARå¤´æ¡é¡¹ç›®èƒŒæ™¯"
}
```

ä¼šåœ¨ `ap_article`ã€`ap_article_config`ã€`ap_article_content`ä¿å­˜å„ä¸€æ¡æ•°æ®ã€‚

å¯ä»¥æ·»åŠ idå­—æ®µï¼Œä¿®æ”¹ã€‚

### 4.4 è‡ªåª’ä½“æ–‡ç« è‡ªåŠ¨å®¡æ ¸åŠŸèƒ½å®ç°

wm_news è‡ªåª’ä½“æ–‡ç« è¡¨

statuså­—æ®µï¼š0 è‰ç¨¿  1 å¾…å®¡æ ¸  2 å®¡æ ¸å¤±è´¥  3 äººå·¥å®¡æ ¸  4 äººå·¥å®¡æ ¸é€šè¿‡  8 å®¡æ ¸é€šè¿‡ï¼ˆå¾…å‘å¸ƒï¼‰ 9 å·²å‘å¸ƒ

#### å®ç°

åœ¨leadnews-wemediaä¸­çš„serviceæ–°å¢æ¥å£ `WmNewsAutoScanService`ï¼ŒåŠå…¶å®ç°

#### feignè¿œç¨‹æ¥å£è°ƒç”¨æ–¹å¼

![](images/image-20231213175037041.png)

leadnews-wemediaæœåŠ¡éœ€è¦ä¾èµ–äº†leadnews-feign-apiså·¥ç¨‹ï¼Œå¹¶ä¸”åœ¨è‡ªåª’ä½“çš„å¯åŠ¨ç±»WemediaApplicationä¸Šå¼€å¯feignçš„è¿œç¨‹è°ƒç”¨å³å¯ `@EnableFeignClients(basePackages = "top.andyron.apis")`ï¼š

```java
@EnableFeignClients(basePackages = "top.andyron.apis")
@SpringBootApplication
@EnableDiscoveryClient
@MapperScan("top.andyron.wemedia.mapper")
public class WemediaApplication {
    public static void main(String[] args) {
        SpringApplication.run(WemediaApplication.class, args);
    }
}

```

#### å•å…ƒæµ‹è¯•

åˆ›å»ºå•å…ƒæµ‹è¯•ç±»å’Œæ–¹æ³•ï¼Œæ‰“æ–­ç‚¹æµ‹è¯•

#### æœåŠ¡é™çº§å¤„ç†

![](images/image-20231213184825153.png)

- æœåŠ¡é™çº§æ˜¯æœåŠ¡è‡ªæˆ‘ä¿æŠ¤çš„ä¸€ç§æ–¹å¼ï¼Œæˆ–è€…ä¿æŠ¤ä¸‹æ¸¸æœåŠ¡çš„ä¸€ç§æ–¹å¼ï¼Œç”¨äºç¡®ä¿æœåŠ¡ä¸ä¼šå—è¯·æ±‚çªå¢å½±å“å˜å¾—ä¸å¯ç”¨ï¼Œç¡®ä¿æœåŠ¡ä¸ä¼šå´©æºƒ
- æœåŠ¡é™çº§è™½ç„¶ä¼šå¯¼è‡´è¯·æ±‚å¤±è´¥ï¼Œä½†æ˜¯ä¸ä¼šå¯¼è‡´é˜»å¡ã€‚

ä¿æŠ¤æ–‡ç« å¾®æœåŠ¡

å®ç°æ­¥éª¤ï¼š

1. åœ¨leadnews-feign-apiç¼–å†™é™çº§é€»è¾‘

```java
package top.andyron.apis.article.fallback;

import org.springframework.stereotype.Component;
import top.andyron.apis.article.IArticleClient;
import top.andyron.model.article.dto.ArticleDto;
import top.andyron.model.common.dtos.ResponseResult;
import top.andyron.model.common.enums.AppHttpCodeEnum;

/**
 * @author andyron
 **/
@Component
public class IArticleClientFallback implements IArticleClient {
    @Override
    public ResponseResult saveArticle(ArticleDto dto) {
        return ResponseResult.errorResult(AppHttpCodeEnum.SERVER_ERROR, "è·å–æ•°æ®å¤±è´¥");
    }
}
```

åœ¨è‡ªåª’ä½“å¾®æœåŠ¡ä¸­æ·»åŠ ç±»ï¼Œæ‰«æé™çº§ä»£ç ç±»çš„åŒ…

```java
package top.andyron.wemedia.config;

import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;

/**
 * @author andyron
 **/
@Configuration
@ComponentScan("top.andyron.apis.article.fallback")
public class InitConfig {
}
```

2. è¿œç¨‹æ¥å£ä¸­æŒ‡å‘é™çº§ä»£ç 

![](images/image-20231213185722271.png)

3. åœ¨è‡ªåª’ä½“æ¨¡å—leadnews-wemediaçš„å¼€å¯é™çº§

åœ¨leadnews-wemediaçš„nacosé…ç½®ä¸­å¿ƒé‡Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œå¼€å¯æœåŠ¡é™çº§ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šæœåŠ¡å“åº”çš„è¶…æ—¶çš„æ—¶é—´

```yaml
feign:
  # å¼€å¯feignå¯¹hystrixç†”æ–­é™çº§çš„æ”¯æŒ
  hystrix:
    enabled: true
  # ä¿®æ”¹è°ƒç”¨è¶…æ—¶æ—¶é—´
  client:
    config:
      default:
        connectTimeout: 2000
        readTimeout: 2000
```

4. æµ‹è¯•

åœ¨æ–‡ç« å¾®æœåŠ¡leadnews-articleä¸­ç±»ApArticleServiceImplçš„saveArticleä¸­æ·»åŠ ï¼šã€æ³¨æ„é‡å¯ã€‘

```java
        // ä¸ºäº†æµ‹è¯•æœåŠ¡é™çº§
        try {
            Thread.sleep(3000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
```

åœ¨è‡ªåª’ä½“ç«¯è¿›è¡Œå®¡æ ¸æµ‹è¯•ï¼Œä¼šå‡ºç°æœåŠ¡é™çº§çš„ç°è±¡ã€ä¼šè°ƒç”¨IArticleClientFallbackçš„saveArticleæ–¹æ³•ã€‘

### 4.5 å‘å¸ƒæ–‡ç« æäº¤å®¡æ ¸é›†æˆ

#### åŒæ­¥è°ƒç”¨ä¸å¼‚æ­¥è°ƒç”¨

åŒæ­¥ï¼šå°±æ˜¯åœ¨å‘å‡ºä¸€ä¸ªè°ƒç”¨æ—¶ï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œ è¯¥è°ƒç”¨å°±ä¸è¿”å›ï¼ˆå®æ—¶å¤„ç†ï¼‰

å¼‚æ­¥ï¼šè°ƒç”¨åœ¨å‘å‡ºä¹‹åï¼Œè¿™ä¸ªè°ƒç”¨å°±ç›´æ¥è¿”å›äº†ï¼Œæ²¡æœ‰è¿”å›ç»“æœï¼ˆåˆ†æ—¶å¤„ç†ï¼‰

![](images/image-20231213191322672.png)

#### Springbooté›†æˆå¼‚æ­¥çº¿ç¨‹è°ƒç”¨

1. åœ¨è‡ªåŠ¨å®¡æ ¸çš„æ–¹æ³•ä¸ŠåŠ ä¸Š@Asyncæ³¨è§£ï¼ˆæ ‡æ˜è¦å¼‚æ­¥è°ƒç”¨ï¼‰

```java
    @Override
    @Async  // æ ‡æ˜å½“å‰æ–¹æ³•æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•
    public void autoScanWmNews(Integer id) {
```

2. åœ¨æ–‡ç« å‘å¸ƒæˆåŠŸåè°ƒç”¨å®¡æ ¸çš„æ–¹æ³•

```java
   	@Autowired
    private WmNewsAutoScanService wmNewsAutoScanService;

    @Override
    public ResponseResult submitNews(WmNewsDto dto) {
        ...

        // 4 ä¸æ˜¯è‰ç¨¿ï¼Œä¿å­˜æ–‡ç« å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»ï¼Œå¦‚æœå½“å‰å¸ƒå±€æ˜¯è‡ªåŠ¨ï¼Œéœ€è¦åŒ¹é…å°é¢å›¾ç‰‡
        saveRelativeInfoForCover(dto, wmNews, materials);
      
        // å®¡æ ¸æ–‡ç« 
        wmNewsAutoScanService.autoScanWmNews(wmNews.getId());
      
        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }
```

3. åœ¨è‡ªåª’ä½“å¯åŠ¨ç±»ä¸Šæ·»åŠ @EnableAsyncæ³¨è§£å¼€å¯å¼‚æ­¥è°ƒç”¨

```java
@EnableAsync // å¼€å¯å¼‚æ­¥è°ƒç”¨
public class WemediaApplication {
```

### 4.6 æ–‡ç« å®¡æ ¸åŠŸèƒ½-ç»¼åˆæµ‹è¯•

#### æœåŠ¡å¯åŠ¨åˆ—è¡¨

1ï¼ŒnacosæœåŠ¡ç«¯

2ï¼Œarticleå¾®æœåŠ¡

3ï¼Œwemediaå¾®æœåŠ¡

4ï¼Œå¯åŠ¨wemediaç½‘å…³å¾®æœåŠ¡

5ï¼Œå¯åŠ¨wemediaå‰ç«¯ç³»ç»Ÿ

#### æµ‹è¯•æƒ…å†µåˆ—è¡¨

1ï¼Œè‡ªåª’ä½“å‰ç«¯å‘å¸ƒä¸€ç¯‡æ­£å¸¸çš„æ–‡ç« 

   å®¡æ ¸æˆåŠŸåï¼Œappç«¯çš„articleç›¸å…³æ•°æ®æ˜¯å¦å¯ä»¥æ­£å¸¸ä¿å­˜ï¼Œè‡ªåª’ä½“æ–‡ç« çŠ¶æ€å’Œappç«¯æ–‡ç« idæ˜¯å¦å›æ˜¾

2ï¼Œè‡ªåª’ä½“å‰ç«¯å‘å¸ƒä¸€ç¯‡åŒ…å«æ•æ„Ÿè¯çš„æ–‡ç«   ğŸ”–

   æ­£å¸¸æ˜¯å®¡æ ¸å¤±è´¥ï¼Œ wm_newsè¡¨ä¸­çš„çŠ¶æ€æ˜¯å¦æ”¹å˜ï¼ŒæˆåŠŸå’Œå¤±è´¥åŸå› æ­£å¸¸ä¿å­˜

3ï¼Œè‡ªåª’ä½“å‰ç«¯å‘å¸ƒä¸€ç¯‡åŒ…å«æ•æ„Ÿå›¾ç‰‡çš„æ–‡ç«  ğŸ”–

   æ­£å¸¸æ˜¯å®¡æ ¸å¤±è´¥ï¼Œ wm_newsè¡¨ä¸­çš„çŠ¶æ€æ˜¯å¦æ”¹å˜ï¼ŒæˆåŠŸå’Œå¤±è´¥åŸå› æ­£å¸¸ä¿å­˜

### 4.7 æ–°éœ€æ±‚-è‡ªç®¡ç†æ•æ„Ÿè¯

#### éœ€æ±‚åˆ†æ

æ–‡ç« å®¡æ ¸åŠŸèƒ½å·²ç»äº¤ä»˜äº†ï¼Œæ–‡ç« ä¹Ÿèƒ½æ­£å¸¸å‘å¸ƒå®¡æ ¸ã€‚çªç„¶ï¼Œäº§å“ç»ç†è¿‡æ¥è¯´è¦å¼€ä¼šã€‚

ä¼šè®®çš„å†…å®¹æ ¸å¿ƒæœ‰ä»¥ä¸‹å†…å®¹ï¼š

- æ–‡ç« å®¡æ ¸ä¸èƒ½è¿‡æ»¤ä¸€äº›æ•æ„Ÿè¯ï¼š

  ç§äººä¾¦æ¢ã€é’ˆå­”æ‘„è±¡ã€ä¿¡ç”¨å¡æç°ã€å¹¿å‘Šä»£ç†ã€ä»£å¼€å‘ç¥¨ã€åˆ»ç« åŠã€å‡ºå”®ç­”æ¡ˆã€å°é¢è´·æ¬¾â€¦

éœ€è¦å®Œæˆçš„åŠŸèƒ½ï¼š

éœ€è¦è‡ªå·±ç»´æŠ¤ä¸€å¥—æ•æ„Ÿè¯ï¼Œåœ¨æ–‡ç« å®¡æ ¸çš„æ—¶å€™ï¼Œéœ€è¦éªŒè¯æ–‡ç« æ˜¯å¦åŒ…å«è¿™äº›æ•æ„Ÿè¯

#### æ•æ„Ÿè¯-è¿‡æ»¤

æŠ€æœ¯é€‰å‹

| **æ–¹æ¡ˆ**         | **è¯´æ˜**                   |
| ---------------------- | -------------------------------- |
| æ•°æ®åº“æ¨¡ç³ŠæŸ¥è¯¢         | æ•ˆç‡å¤ªä½                         |
| String.indexOf("")æŸ¥æ‰¾ | æ•°æ®åº“é‡å¤§çš„è¯ä¹Ÿæ˜¯æ¯”è¾ƒæ…¢         |
| å…¨æ–‡æ£€ç´¢               | åˆ†è¯å†åŒ¹é…                       |
| DFAç®—æ³•                | ç¡®å®šæœ‰ç©·è‡ªåŠ¨æœº(ä¸€ç§==æ•°æ®ç»“æ„==) |

#### DFAå®ç°åŸç†

DFAå…¨ç§°ä¸ºï¼šDeterministic Finite Automaton,å³ç¡®å®šæœ‰ç©·è‡ªåŠ¨æœºã€‚

å­˜å‚¨ï¼šä¸€æ¬¡æ€§çš„æŠŠæ‰€æœ‰çš„æ•æ„Ÿè¯å­˜å‚¨åˆ°äº†å¤šä¸ªmapä¸­ï¼Œå°±æ˜¯ä¸‹å›¾è¡¨ç¤ºè¿™ç§ç»“æ„

æ•æ„Ÿè¯ï¼šå†°æ¯’ã€å¤§éº»ã€å¤§åè›‹

![](images/image-20231213210014870.png)

æ£€ç´¢çš„è¿‡ç¨‹:

![](images/image-20231213210149385.png)

#### è‡ªç®¡ç†æ•æ„Ÿè¯é›†æˆåˆ°æ–‡ç« å®¡æ ¸ä¸­

æ•æ„Ÿè¯ä¸€èˆ¬å­˜åˆ°ä¸€å¼ è¡¨ä¸­ã€‚

1. åˆ›å»ºæ•æ„Ÿè¯è¡¨wm_sensitiveåˆ°leadnews_wemediaåº“ä¸­

```mysql
CREATE TABLE `wm_sensitive` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `sensitives` varchar(10) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'æ•æ„Ÿè¯',
  `created_time` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=3201 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC COMMENT='æ•æ„Ÿè¯ä¿¡æ¯è¡¨';
```

2. æ·»åŠ WmSensitiveMapper
3. åœ¨æ–‡ç« å®¡æ ¸çš„ä»£ç ä¸­æ·»åŠ è‡ªç®¡ç†æ•æ„Ÿè¯å®¡æ ¸

```java
    private boolean handleSensitiveScan(String content, WmNews wmNews) {
        boolean flag = true;
        // è·å–æ‰€æœ‰æ•æ„Ÿè¯
        List<WmSensitive> wmSensitives = wmSensitiveMapper.selectList(Wrappers.<WmSensitive>lambdaQuery().select(WmSensitive::getSensitives));
        List<String> sensitiveList = wmSensitives.stream().map(WmSensitive::getSensitives).collect(Collectors.toList());

        SensitiveWordUtil.initMap(sensitiveList);
        Map<String, Integer> map = SensitiveWordUtil.matchWords(content);
        if (map.size() > 0) {
            updateWmNews(wmNews, (short) 2, "å½“å‰æ–‡ç« ä¸­å­˜å‚¨è¿è§„å†…å®¹ " + map);
            flag = false;
        }
        return flag;
    }
```

### 4.8 æ–°éœ€æ±‚-å›¾ç‰‡è¯†åˆ«æ–‡å­—å®¡æ ¸æ•æ„Ÿè¯

#### éœ€æ±‚åˆ†æ

äº§å“ç»ç†å¬é›†å¼€ä¼šï¼Œæ–‡ç« å®¡æ ¸åŠŸèƒ½å·²ç»äº¤ä»˜äº†ï¼Œæ–‡ç« ä¹Ÿèƒ½æ­£å¸¸å‘å¸ƒå®¡æ ¸ã€‚å¯¹äºä¸Šæ¬¡æå‡ºçš„è‡ªç®¡ç†æ•æ„Ÿè¯ä¹Ÿå¾ˆæ»¡æ„ï¼Œè¿™æ¬¡ä¼šè®®æ ¸å¿ƒçš„å†…å®¹å¦‚ä¸‹ï¼š

- æ–‡ç« ä¸­åŒ…å«çš„å›¾ç‰‡è¦è¯†åˆ«æ–‡å­—ï¼Œè¿‡æ»¤æ‰å›¾ç‰‡æ–‡å­—çš„æ•æ„Ÿè¯

#### å›¾ç‰‡æ–‡å­—è¯†åˆ«

ä»€ä¹ˆæ˜¯OCR?

OCR ï¼ˆOptical Character Recognitionï¼Œå…‰å­¦å­—ç¬¦è¯†åˆ«ï¼‰æ˜¯æŒ‡ç”µå­è®¾å¤‡ï¼ˆä¾‹å¦‚æ‰«æä»ªæˆ–æ•°ç ç›¸æœºï¼‰æ£€æŸ¥çº¸ä¸Šæ‰“å°çš„å­—ç¬¦ï¼Œé€šè¿‡æ£€æµ‹æš—ã€äº®çš„æ¨¡å¼ç¡®å®šå…¶å½¢çŠ¶ï¼Œç„¶åç”¨å­—ç¬¦è¯†åˆ«æ–¹æ³•å°†å½¢çŠ¶ç¿»è¯‘æˆè®¡ç®—æœºæ–‡å­—çš„è¿‡ç¨‹

| **æ–¹æ¡ˆ** | **è¯´æ˜**                                      |
| -------------- | --------------------------------------------------- |
| ç™¾åº¦OCR        | æ”¶è´¹                                                |
| Tesseract-OCR  | Googleç»´æŠ¤çš„å¼€æºOCRå¼•æ“ï¼Œæ”¯æŒJavaï¼ŒPythonç­‰è¯­è¨€è°ƒç”¨ |
| Tess4J         | å°è£…äº†Tesseract-OCR  ï¼Œæ”¯æŒJavaè°ƒç”¨                 |

Tesseract-OCR ç‰¹ç‚¹ï¼š

- Tesseractæ”¯æŒUTF-8ç¼–ç æ ¼å¼ï¼Œå¹¶ä¸”å¯ä»¥â€œå¼€ç®±å³ç”¨â€åœ°è¯†åˆ«100å¤šç§è¯­è¨€ã€‚
- Tesseractæ”¯æŒå¤šç§è¾“å‡ºæ ¼å¼ï¼šçº¯æ–‡æœ¬ï¼ŒhOCRï¼ˆHTMLï¼‰ï¼ŒPDFç­‰
- å®˜æ–¹å»ºè®®ï¼Œä¸ºäº†è·å¾—æ›´å¥½çš„OCRç»“æœï¼Œæœ€å¥½æä¾›ç»™é«˜è´¨é‡çš„å›¾åƒã€‚
- Tesseractè¿›è¡Œè¯†åˆ«å…¶ä»–è¯­è¨€çš„è®­ç»ƒ
  å…·ä½“çš„è®­ç»ƒæ–¹å¼ï¼Œè¯·å‚è€ƒå®˜æ–¹æä¾›çš„æ–‡æ¡£ï¼šhttps://tesseract-ocr.github.io/tessdoc/

#### Tess4jæ¡ˆä¾‹ ğŸ”–

1. åˆ›å»ºé¡¹ç›®å¯¼å…¥tess4jå¯¹åº”çš„ä¾èµ–

```xml
<dependency>
    <groupId>net.sourceforge.tess4j</groupId>
    <artifactId>tess4j</artifactId>
    <version>4.1.1</version>
</dependency>
```

2. å¯¼å…¥ä¸­æ–‡å­—ä½“åº“ï¼Œ æŠŠèµ„æ–™ä¸­çš„tessdataæ–‡ä»¶å¤¹æ‹·è´åˆ°è‡ªå·±çš„å·¥ä½œç©ºé—´ä¸‹ã€‚ç®€ä½“ä¸­æ–‡ `chi_sim.traineddata`
3. ç¼–å†™æµ‹è¯•ç±»è¿›è¡Œæµ‹è¯•

#### å›¾ç‰‡æ–‡å­—è¯†åˆ«é›†æˆåˆ°æ–‡ç« å®¡æ ¸ ğŸ”–

1. åœ¨leadnews-commonä¸­åˆ›å»ºå·¥å…·ç±»ï¼Œç®€å•å°è£…ä¸€ä¸‹tess4j

å…ˆå¯¼å…¥ä¾èµ–

åœ¨spring.factoriesé…ç½®ä¸­æ·»åŠ è¯¥ç±»

2. åœ¨leadnews-wemediaä¸­çš„é…ç½®ä¸­æ·»åŠ ä¸¤ä¸ªå±æ€§

```yaml
tess4j:
  data-path: D:\workspace\tessdata
  language: chi_sim
```

3. åœ¨WmNewsAutoScanServiceImplä¸­çš„handleImageScanæ–¹æ³•ä¸Šæ·»åŠ å¦‚ä¸‹ä»£ç 

### 4.9 æ–‡ç« è¯¦æƒ…-é™æ€æ–‡ä»¶ç”Ÿæˆ

#### æ€è·¯åˆ†æ

æ–‡ç« ç«¯åˆ›å»ºappç›¸å…³æ–‡ç« æ—¶ï¼Œç”Ÿæˆæ–‡ç« è¯¦æƒ…é™æ€é¡µä¸Šä¼ åˆ°MinIOä¸­

![](images/image-20210709110852966.png)

#### å®ç°æ­¥éª¤

### æ€è€ƒ

åˆ†å¸ƒå¼äº‹åŠ¡

![](images/image-20231213223344281.png)

ç›®å‰ï¼Œè‡ªåª’ä½“å¾®æœåŠ¡å’Œæ–‡ç« å¾®æœåŠ¡ï¼Œå¦‚æœå„è‡ªæŠ¥é”™ï¼Œå®ƒä»¬ç›¸äº’æ˜¯ä¸çŸ¥é“

> ä½œä¸šï¼šä½¿ç”¨seataæ¥è§£å†³å®¡æ ¸è¿‡ç¨‹ä¸­çš„åˆ†å¸ƒå¼äº‹ç‰©çš„é—®é¢˜

> æ–‡ç« å‘å¸ƒæ—¶é—´æ˜¯ä¸€ä¸ªæœªæ¥æ—¶é—´ï¼Œè¯¥å¦‚ä½•æŒ‰ç…§ç²¾ç¡®æ—¶é—´å‘å¸ƒï¼Ÿ
> ä¾‹å¦‚ï¼šå¦‚æœä»Šå¤©æ˜¯1æœˆ1æ—¥å†™äº†ä¸€ç¯‡æ–‡ç« ï¼Œè®¾å®šå‘å¸ƒæ—¶é—´æ˜¯1æœˆ5æ—¥ï¼Œé‚£è¿™ä¸ªæ–‡ç« ä»€ä¹ˆæ—¶å€™å®¡æ ¸

## 5 å»¶è¿Ÿä»»åŠ¡ç²¾å‡†å‘å¸ƒæ–‡ç« 

### 5.1 æ–‡ç« å®šæ—¶å‘å¸ƒ

å»¶è¿Ÿä»»åŠ¡

![](images/image-20231217125055708.png)

è½¦ç¥¨30minä¹‹å†…æ²¡æœ‰æ”¯ä»˜ï¼Œå½“å‰çš„å°±å–æ¶ˆäº†ï¼Œè¿™å°±æ˜¯é€šè¿‡å»¶è¿Ÿä»»åŠ¡å®Œæˆã€‚

![](images/image-20231217125316495.png)

æ–‡ç« å‘å¸ƒï¼Œä¸ç®¡æ˜¯å½“ä¸‹å‘å¸ƒè¿˜æ˜¯æœªæ¥æŸä¸ªæ—¶é—´å‘å¸ƒï¼Œéƒ½äº¤ç»™ã€å»¶è¿Ÿä»»åŠ¡æœåŠ¡ã€‘ï¼Œæœ‰å®ƒæ ¹æ®ä½ çš„å‘å¸ƒæ—¶é—´æ¥å†³å®šä»€ä¹ˆæ—¶å€™è¿›è¡Œå®¡æ ¸ã€‚

![](images/image-20231217125357326.png)

- ç”±äºå¯èƒ½æœ‰å¤šä¸ªéœ€æ±‚éƒ½éœ€è¦å»¶è¿Ÿä»»åŠ¡ï¼Œæ‰€ä»¥å°±æŠŠå»¶è¿Ÿä»»åŠ¡æœåŠ¡åŒ–ï¼›
- ä¸ºäº†æå‡æ€§èƒ½ï¼Œé‡‡ç”¨redisè¿›è¡Œä»»åŠ¡æ•°æ®çš„å­˜å‚¨ï¼›
- ä¸ºäº†ä¿è¯åœ¨å¯èƒ½çš„å¹¶å‘æƒ…å†µä¸‹ï¼Œæ•°æ®çš„å‡†ç¡®æ€§ï¼Œé‡‡ç”¨äº†æ•°æ®åº“é”æœºåˆ¶ï¼›ã€é›†æˆä¹è§‚é”ã€‘
- åœ¨åˆ†å¸ƒå¼ä¸‹ï¼Œä¸ºäº†è§£å†³ä¸€ä¸ªæœåŠ¡ä¸­çš„ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œä¸€ä¸ªæ–¹æ³•ï¼Œé‡‡ç”¨rediså®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆï¼›
- ä¸ºäº†æå‡redisçš„æ‰§è¡Œæ•ˆç‡ï¼Œé‡‡ç”¨redisç®¡é“ï¼Œä¹Ÿå°±æ˜¯æŠŠå¤šä¸ªredisæ“ä½œåˆå¹¶æˆä¸€ä¸ªï¼Œæœ€ç»ˆè¾¾æˆæå‡æ€§èƒ½çš„ç›®çš„

### 5.2 å»¶è¿Ÿä»»åŠ¡æ¦‚è¿°

#### ä»€ä¹ˆæ˜¯å»¶è¿Ÿä»»åŠ¡

- å®šæ—¶ä»»åŠ¡ï¼šæœ‰==å›ºå®šå‘¨æœŸ==çš„ï¼Œæœ‰æ˜ç¡®çš„è§¦å‘æ—¶é—´ã€‚
- å»¶è¿Ÿä»»åŠ¡ï¼š==æ²¡æœ‰å›ºå®š==çš„å¼€å§‹æ—¶é—´ï¼Œå®ƒå¸¸å¸¸æ˜¯ç”±ä¸€ä¸ªäº‹ä»¶è§¦å‘çš„ï¼Œè€Œåœ¨è¿™ä¸ªäº‹ä»¶è§¦å‘ä¹‹åçš„**ä¸€æ®µæ—¶é—´**å†…è§¦å‘å¦ä¸€ä¸ªäº‹ä»¶ï¼Œä»»åŠ¡å¯ä»¥ç«‹å³æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥å»¶è¿Ÿã€‚

![](images/image-20231217144017638.png)

åº”ç”¨åœºæ™¯ï¼š

åœºæ™¯ä¸€ï¼šè®¢å•ä¸‹å•ä¹‹å30åˆ†é’Ÿåï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ä»˜é’±ï¼Œåˆ™ç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆè®¢å•ï¼›å¦‚æœæœŸé—´ä¸‹å•æˆåŠŸï¼Œä»»åŠ¡å–æ¶ˆ

åœºæ™¯äºŒï¼šæ¥å£å¯¹æ¥å‡ºç°ç½‘ç»œé—®é¢˜ï¼Œ1åˆ†é’Ÿåé‡è¯•ï¼Œå¦‚æœå¤±è´¥ï¼Œ2åˆ†é’Ÿé‡è¯•ï¼Œç›´åˆ°å‡ºç°é˜ˆå€¼ç»ˆæ­¢

#### å»¶è¿Ÿä»»åŠ¡å®ç°æŠ€æœ¯å¯¹æ¯”

##### DelayQueue

JDKè‡ªå¸¦ `DelayQueue` æ˜¯ä¸€ä¸ªæ”¯æŒå»¶æ—¶è·å–å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œ å†…éƒ¨é‡‡ç”¨ä¼˜å…ˆé˜Ÿåˆ— `PriorityQueue` å­˜å‚¨å…ƒç´ ï¼ŒåŒæ—¶å…ƒç´ å¿…é¡»å®ç° `Delayed` æ¥å£ï¼›åœ¨åˆ›å»ºå…ƒç´ æ—¶å¯ä»¥æŒ‡å®šå¤šä¹…æ‰å¯ä»¥ä»é˜Ÿåˆ—ä¸­è·å–å½“å‰å…ƒç´ ï¼Œåªæœ‰åœ¨å»¶è¿ŸæœŸæ»¡æ—¶æ‰èƒ½ä»é˜Ÿåˆ—ä¸­æå–å…ƒç´ ã€‚

![](images/image-20231217144219854.png)

DelayQueueå±äºæ’åºé˜Ÿåˆ—ï¼Œå®ƒçš„ç‰¹æ®Šä¹‹å¤„åœ¨äºé˜Ÿåˆ—çš„å…ƒç´ å¿…é¡»å®ç°Delayedæ¥å£ï¼Œè¯¥æ¥å£éœ€è¦å®ç°compareToå’ŒgetDelayæ–¹æ³•

getDelayæ–¹æ³•ï¼šè·å–å…ƒç´ åœ¨é˜Ÿåˆ—ä¸­çš„å‰©ä½™æ—¶é—´ï¼Œåªæœ‰å½“å‰©ä½™æ—¶é—´ä¸º0æ—¶å…ƒç´ æ‰å¯ä»¥å‡ºé˜Ÿåˆ—ã€‚

compareToæ–¹æ³•ï¼šç”¨äºæ’åºï¼Œç¡®å®šå…ƒç´ å‡ºé˜Ÿåˆ—çš„é¡ºåºã€‚

**å®ç°ï¼š**

1ï¼šåœ¨æµ‹è¯•åŒ…jdkä¸‹åˆ›å»ºå»¶è¿Ÿä»»åŠ¡å…ƒç´ å¯¹è±¡DelayedTaskï¼Œå®ç°compareToå’ŒgetDelayæ–¹æ³•ï¼Œ

2ï¼šåœ¨mainæ–¹æ³•ä¸­åˆ›å»ºDelayQueueå¹¶å‘å»¶è¿Ÿé˜Ÿåˆ—ä¸­æ·»åŠ ä¸‰ä¸ªå»¶è¿Ÿä»»åŠ¡ï¼Œ

3ï¼šå¾ªç¯çš„ä»å»¶è¿Ÿé˜Ÿåˆ—ä¸­æ‹‰å–ä»»åŠ¡

> ä½¿ç”¨DelayQueueä½œä¸ºå»¶è¿Ÿä»»åŠ¡ï¼Œå¦‚æœç¨‹åºæŒ‚æ‰ä¹‹åï¼Œä»»åŠ¡éƒ½æ˜¯æ”¾åœ¨å†…å­˜ï¼Œæ¶ˆæ¯ä¼šä¸¢å¤±ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Ÿ

##### RabbitMQå®ç°å»¶è¿Ÿä»»åŠ¡ï¼ˆå¸¸ç”¨ï¼‰

- TTLï¼šTime To Live (æ¶ˆæ¯å­˜æ´»æ—¶é—´)
- ==æ­»ä¿¡é˜Ÿåˆ—==ï¼šDead Letter Exchange(æ­»ä¿¡äº¤æ¢æœº)ï¼Œå½“æ¶ˆæ¯æˆä¸ºDead messageåï¼Œå¯ä»¥é‡æ–°å‘é€å¦ä¸€ä¸ªäº¤æ¢æœºï¼ˆæ­»ä¿¡äº¤æ¢æœºï¼‰

![](images/image-20231217144506985.png)

##### rediså®ç°ï¼ˆå¸¸ç”¨ï¼Œæœ¬é¡¹ç›®ä½¿ç”¨ï¼‰

zsetæ•°æ®ç±»å‹çš„å»é‡æœ‰åºï¼ˆåˆ†æ•°æ’åºï¼‰ç‰¹ç‚¹è¿›è¡Œå»¶è¿Ÿã€‚ä¾‹å¦‚ï¼šæ—¶é—´æˆ³ä½œä¸ºscoreè¿›è¡Œæ’åº

![](images/image-20231217144637293.png)

ä¾‹å¦‚ï¼š

ç”Ÿäº§è€…æ·»åŠ 4ä¸ªä»»åŠ¡åˆ°å»¶è¿Ÿé˜Ÿåˆ—ä¸­ï¼Œæ—¶é—´æ¯«ç§’å€¼åˆ†åˆ«ä¸º97ã€98ã€99ã€100 ã€‚ å½“å‰æ—¶é—´çš„æ¯«ç§’å€¼ä¸º90ï¼Œæ¶ˆè´¹è€…ç«¯è¿›è¡Œç›‘å¬ï¼Œå¦‚æœå½“å‰æ—¶é—´çš„æ¯«ç§’å€¼åŒ¹é…åˆ°äº†å»¶è¿Ÿé˜Ÿåˆ—ä¸­çš„æ¯«ç§’å€¼å°±ç«‹å³æ¶ˆè´¹ã€‚

### 5.3 rediså®ç°å»¶è¿Ÿä»»åŠ¡

#### æµç¨‹è¯´æ˜

![](images/image-20231217150624431.png)

åªæ˜¯æŠŠæœªæ¥5minï¼ˆé¢„è®¾æ—¶é—´ï¼‰ä¸­çš„ä»»åŠ¡åŠ è½½åˆ°zsetä¸­ï¼ˆä¸ºäº†æé«˜æ•ˆç‡ï¼‰ï¼Œå®šæ—¶åŒæ­¥æ•°æ®åº“ä¸­æœªæ¥5minçš„ä»»åŠ¡åˆ°zsetï¼Œä¹Ÿè¦å®šæ—¶åˆ·æ–°zsetä¸­å½“æ—¶è¦æ‰§è¡Œçš„ä»»åŠ¡åˆ°listä¸­ã€‚

é—®é¢˜ï¼š

1. ä¸ºä»€ä¹ˆä»»åŠ¡éœ€è¦å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Ÿ

å»¶è¿Ÿä»»åŠ¡æ˜¯ä¸€ä¸ªé€šç”¨çš„æœåŠ¡ï¼Œä»»ä½•éœ€è¦å»¶è¿Ÿå¾—ä»»åŠ¡éƒ½å¯ä»¥è°ƒç”¨è¯¥æœåŠ¡ï¼Œå†…å­˜æ•°æ®åº“çš„å­˜å‚¨æ˜¯æœ‰é™çš„ï¼Œéœ€è¦è€ƒè™‘æ•°æ®æŒä¹…åŒ–çš„é—®é¢˜ï¼Œå­˜å‚¨æ•°æ®åº“ä¸­æ˜¯ä¸€ç§æ•°æ®å®‰å…¨çš„è€ƒè™‘ã€‚

2. ä¸ºä»€ä¹ˆredisä¸­ä½¿ç”¨ä¸¤ç§æ•°æ®ç±»å‹ï¼Œlistå’Œzsetï¼Ÿ

æ•ˆç‡é—®é¢˜ï¼Œç®—æ³•çš„æ—¶é—´å¤æ‚åº¦

åŸå› ä¸€ï¼šlistå­˜å‚¨ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡ï¼Œzsetå­˜å‚¨æœªæ¥çš„æ•°æ®

åŸå› äºŒï¼šä»»åŠ¡é‡è¿‡å¤§ä»¥åï¼Œzsetçš„æ€§èƒ½ä¼šä¸‹é™

æ—¶é—´å¤æ‚åº¦ï¼šæ‰§è¡Œæ—¶é—´ï¼ˆæ¬¡æ•°ï¼‰éšç€æ•°æ®è§„æ¨¡å¢é•¿çš„å˜åŒ–è¶‹åŠ¿

æ“ä½œredisä¸­çš„listå‘½ä»¤LPUSHï¼šæ—¶é—´å¤æ‚åº¦ï¼š`O(1)`

æ“ä½œredisä¸­çš„zsetå‘½ä»¤zaddï¼šæ—¶é—´å¤æ‚åº¦ï¼š`O(M*log((n))`

![](images/image-20231217150419390.png)

3. åœ¨æ·»åŠ zsetæ•°æ®çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆéœ€è¦é¢„åŠ è½½ï¼Ÿ

å¦‚æœä»»åŠ¡æ•°æ®ç‰¹åˆ«å¤§ï¼Œä¸ºäº†é˜²æ­¢é˜»å¡ï¼Œåªéœ€è¦æŠŠæœªæ¥å‡ åˆ†é’Ÿè¦æ‰§è¡Œçš„æ•°æ®å­˜å‚¨ç¼“å­˜å³å¯ï¼Œæ˜¯ä¸€ç§ä¼˜åŒ–çš„å½¢å¼

### 5.4 å»¶è¿Ÿä»»åŠ¡æœåŠ¡å®ç°

#### æ­å»ºleadnews-scheduleæ¨¡å—

leadnews-scheduleæ˜¯ä¸€ä¸ªé€šç”¨çš„æœåŠ¡ï¼Œå•ç‹¬åˆ›å»ºæ¨¡å—æ¥ç®¡ç†ä»»ä½•ç±»å‹çš„å»¶è¿Ÿä»»åŠ¡

![](images/image-20231217172522947.png)

1. åœ¨leadnews-serviceä¸‹åˆ›å»ºleadnews-scheduleæ¨¡å—
2. bootstrap.yml

```yaml
server:
  port: 51701
spring:
  application:
    name: leadnews-schedule
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.0.102:8848
      config:
        server-addr: 192.168.0.102:8848
        file-extension: yml
```

3. åœ¨nacosä¸­æ·»åŠ ç›¸åº”é…ç½®

```yaml
spring:
  datasource:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/leadnews_schedule?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&useSSL=false&allowPublicKeyRetrieval=true
      username: root
      password: 33824
# è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: top.andyron.model.schedule.pojos  
```

#### æ•°æ®åº“å‡†å¤‡

åˆ›å»ºleadnews_scheduleæ•°æ®åº“

```mysql
CREATE TABLE `taskinfo` (
  `task_id` bigint NOT NULL COMMENT 'ä»»åŠ¡id',
  `execute_time` datetime(3) NOT NULL COMMENT 'æ‰§è¡Œæ—¶é—´',
  `parameters` longblob COMMENT 'å‚æ•°',
  `priority` int NOT NULL COMMENT 'ä¼˜å…ˆçº§',
  `task_type` int NOT NULL COMMENT 'ä»»åŠ¡ç±»å‹',
  PRIMARY KEY (`task_id`),
  KEY `index_taskinfo_time` (`task_type`,`priority`,`execute_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;

CREATE TABLE `taskinfo_logs` (
  `task_id` bigint NOT NULL COMMENT 'ä»»åŠ¡id',
  `execute_time` datetime(3) NOT NULL COMMENT 'æ‰§è¡Œæ—¶é—´',
  `parameters` longblob COMMENT 'å‚æ•°',
  `priority` int NOT NULL COMMENT 'ä¼˜å…ˆçº§',
  `task_type` int NOT NULL COMMENT 'ä»»åŠ¡ç±»å‹',
  `version` int NOT NULL COMMENT 'ç‰ˆæœ¬å·,ç”¨ä¹è§‚é”',
  `status` int DEFAULT '0' COMMENT 'çŠ¶æ€ 0=åˆå§‹åŒ–çŠ¶æ€ 1=EXECUTED 2=CANCELLED',
  PRIMARY KEY (`task_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;
```

> mysqlä¸­ï¼Œblobæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶å¤§å‹å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªå¯ä»¥å­˜å‚¨å¤§é‡æ•°æ®çš„å®¹å™¨ï¼›longblobæœ€å¤§å­˜å‚¨4Gã€‚

##### æ•°æ®åº“è‡ªèº«è§£å†³å¹¶å‘çš„ä¸¤ç§ç­–ç•¥

- æ‚²è§‚é”ï¼ˆPessimistic Lockï¼‰

æ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ã€‚

- ä¹è§‚é”ï¼ˆOptimistic Lockï¼‰

æ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¸ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ï¼Œä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæœ‰æ²¡æœ‰å»æ›´æ–°è¿™ä¸ªæ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·ç­‰æœºåˆ¶ï¼ˆä¹Ÿå°±æ˜¯æ¯”å¯¹ä¿®æ”¹ä¹‹å‰çš„versionå’Œæäº¤ä¿®æ”¹ä¹‹å‰çš„versionï¼‰

##### mybatis-plusé›†æˆä¹è§‚é”çš„ä½¿ç”¨

1. åœ¨å®ä½“ç±»ä¸­ä½¿ç”¨ `@Version`æ ‡æ˜æ˜¯ä¸€ä¸ªç‰ˆæœ¬çš„å­—æ®µ

```java
		/**
     * ç‰ˆæœ¬å·,ç”¨ä¹è§‚é”
     */
    @Version
    private Integer version;
```

2. mybatis-pluså¯¹ä¹è§‚é”çš„æ”¯æŒï¼Œåœ¨å¯åŠ¨ç±»ä¸­å‘å®¹å™¨ä¸­æ”¾å…¥ä¹è§‚é”çš„æ‹¦æˆªå™¨

```java
		/**
     * mybatis-plusä¹è§‚é”æ”¯æŒ
     * @return
     */
    @Bean
    public MybatisPlusInterceptor optimisticLockerInterceptor(){
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
        return interceptor;
    }
```

#### rediså®ç°å»¶è¿Ÿä»»åŠ¡

> dockerå®‰è£…redis
>
> ```shell
> docker pull redis
>
> docker run -d --name redis --restart=always -p 6379:6379 redis --requirepass "leadnews"
> ```

- åœ¨leadnews-commonæ¨¡å—å¯¼å…¥redisç›¸å…³ä¾èµ–ï¼ˆæ”¾åœ¨commonä¸‹ï¼Œæ–¹ä¾¿å…¶ä»–æ¨¡å—ä½¿ç”¨ï¼‰

```xml
<!--spring data redis & cache-->
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<!-- redisä¾èµ–commons-pool è¿™ä¸ªä¾èµ–ä¸€å®šè¦æ·»åŠ  -->
<dependency>
  <groupId>org.apache.commons</groupId>
  <artifactId>commons-pool2</artifactId>
</dependency>
```

- åœ¨leadnews-scheduleä¸­é›†æˆredis,æ·»åŠ ä»¥ä¸‹nacosé…ç½®ï¼Œé“¾æ¥ä¸Šredis

```yaml
spring:
	redis:
		host: 192.168.0.102
		password: 123456
		port: 6379
```

- åœ¨leadnews-commonæ¨¡å—åˆ›å»ºCacheServiceï¼Œæ“ä½œredisçš„å·¥å…·ç±»

è¦è®©å…¶å®ƒå¾®æœåŠ¡ä½¿ç”¨ï¼Œéœ€è¦æ·»åŠ é…ç½®

```
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  top.andyron.common.exception.ExceptionCatch,\
  top.andyron.common.swagger.SwaggerConfiguration,\
  top.andyron.common.aliyun.GreenImageScan,\
  top.andyron.common.aliyun.GreenTextScan,\
  top.andyron.common.redis.CacheService
```

#### æ·»åŠ ä»»åŠ¡

1. åˆ›å»ºTaskinfoMapper å’ŒTaskinfoLogsMapper
2. åˆ›å»ºtaskç±»ï¼Œç”¨äºæ¥æ”¶æ·»åŠ ä»»åŠ¡çš„å‚æ•°

```java
package top.andyron.model.schedule.dtos;

import lombok.Data;
import java.io.Serializable;

@Data
public class Task implements Serializable {
    /**
     * ä»»åŠ¡id
     */
    private Long taskId;
    /**
     * ç±»å‹
     */
    private Integer taskType;
    /**
     * ä¼˜å…ˆçº§
     */
    private Integer priority;
    /**
     * æ‰§è¡Œid
     */
    private long executeTime;
    /**
     * taskå‚æ•°
     */
    private byte[] parameters;
}
```

3. åˆ›å»ºTaskService
   - æ·»åŠ ä»»åŠ¡åˆ°æ•°æ®åº“ä¸­
   - æ·»åŠ ä»»åŠ¡åˆ°redisä¸­
     - å¦‚æœä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å°äºç­‰äºå½“å‰æ—¶é—´å­˜å…¥list
     - å¦‚æœä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å¤§äºå½“å‰æ—¶é—´ï¼Œå°äºç­‰äºé¢„è®¾æ—¶é—´ï¼ˆæœªæ¥5åˆ†é’Ÿï¼‰å­˜å…¥zsetä¸­
4. æµ‹è¯•

#### å–æ¶ˆä»»åŠ¡

åœºæ™¯ï¼šç¬¬ä¸‰æ¥å£ç½‘ç»œä¸é€šï¼Œä½¿ç”¨å»¶è¿Ÿä»»åŠ¡è¿›è¡Œé‡è¯•ï¼Œå½“è¾¾åˆ°é˜ˆå€¼ä»¥åï¼Œå–æ¶ˆä»»åŠ¡ã€‚

![](images/image-20231228231324883.png)

1. æ ¹æ®taskidåˆ é™¤ä»»åŠ¡,ä¿®æ”¹ä»»åŠ¡æ—¥å¿—çŠ¶æ€ä¸º 2(å–æ¶ˆ)
2. åˆ é™¤redisä¸­å¯¹åº”çš„ä»»åŠ¡æ•°æ®ï¼ŒåŒ…æ‹¬listå’Œzset

#### æ¶ˆè´¹ä»»åŠ¡

![](images/image-20231228231409487.png)

#### æœªæ¥æ•°æ®å®šæ—¶åˆ·æ–°

![](images/image-20231231021017946.png)

å®ç°æ­¥éª¤ï¼š

![](images/image-20231228231521737.png)

##### é—®é¢˜

> å¦‚ä½•è·å–zsetä¸­æ‰€æœ‰çš„key?

æ–¹æ¡ˆ1ï¼škeys æ¨¡ç³ŠåŒ¹é…

![](images/image-20231231021113666.png)

keysçš„æ¨¡ç³ŠåŒ¹é…åŠŸèƒ½å¾ˆæ–¹ä¾¿ä¹Ÿå¾ˆå¼ºå¤§ï¼Œä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒéœ€è¦æ…ç”¨ï¼å¼€å‘ä¸­ä½¿ç”¨keysçš„æ¨¡ç³ŠåŒ¹é…å´å‘ç°redisçš„CPUä½¿ç”¨ç‡æé«˜ï¼Œæ‰€ä»¥å…¬å¸çš„redisç”Ÿäº§ç¯å¢ƒå°†keyså‘½ä»¤ç¦ç”¨äº†ï¼redisæ˜¯å•çº¿ç¨‹ï¼Œä¼šè¢«å µå¡ã€‚

æ–¹æ¡ˆ2ï¼šscan

![](images/image-20231231021131553.png)

SCAN å‘½ä»¤æ˜¯ä¸€ä¸ªåŸºäºæ¸¸æ ‡çš„è¿­ä»£å™¨ï¼ŒSCANå‘½ä»¤æ¯æ¬¡è¢«è°ƒç”¨ä¹‹åï¼Œ éƒ½ä¼šå‘ç”¨æˆ·è¿”å›ä¸€ä¸ªæ–°çš„æ¸¸æ ‡ï¼Œ ç”¨æˆ·åœ¨ä¸‹æ¬¡è¿­ä»£æ—¶éœ€è¦ä½¿ç”¨è¿™ä¸ªæ–°æ¸¸æ ‡ä½œä¸ºSCANå‘½ä»¤çš„æ¸¸æ ‡å‚æ•°ï¼Œ ä»¥æ­¤æ¥å»¶ç»­ä¹‹å‰çš„è¿­ä»£è¿‡ç¨‹ã€‚

> æ•°æ®å¦‚ä½•åŒæ­¥ï¼Ÿ
>
> ä¸¤ä»¶äº‹ï¼š
> ç¬¬ä¸€ï¼šä»zsetä¸­æŸ¥å‡ºæ•°æ®ï¼Œå¹¶åˆ é™¤
> ç¬¬äºŒï¼šæŠŠæ•°æ®å­˜å…¥åˆ°listä¸­

æ™®é€šrediså®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’æ¨¡å¼:

![](images/image-20231228232020265.png)

Pipelineè¯·æ±‚æ¨¡å‹ã€**==reidsç®¡é“==**ã€‘:

![](images/image-20231228232040024.png)

å¤šä¸ªå‘½ä»¤ä¸€èµ·è¯·æ±‚ï¼Œæé«˜æ•ˆç‡ã€‚

å®˜æ–¹æµ‹è¯•ç»“æœæ•°æ®å¯¹æ¯”:

![](images/image-20231228232109433.png)

##### å…·ä½“å®ç°

```java
   /**
     * æœªæ¥æ•°æ®å®šæ—¶åˆ·æ–°
     *
     * æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
     */
    @Scheduled(cron = "0 */1 * * * ?")
    public void refresh() {
        String token = cacheService.tryLock("FUTRUE_TASK_SYNC", 1000 * 30);

        if (StringUtils.isNotBlank(token)) {
            log.info("æœªæ¥æ•°æ®å®šæ—¶åˆ·æ–°---å®šæ—¶ä»»åŠ¡");

            // è·å–æ‰€æœ‰æœªæ¥æ•°æ®çš„é›†åˆkey
            Set<String> futureKeys = cacheService.scan(ScheduleConstants.FUTURE + "*");
            for (String futureKey : futureKeys) {
                // è·å–æ‰€æœ‰æœªæ¥æ•°æ®çš„é›†åˆkey   future_100_50
                String topicKey = ScheduleConstants.TOPIC + futureKey.split(ScheduleConstants.FUTURE)[1];

                // æŒ‰ç…§keyå’Œåˆ†å€¼æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„æ•°æ®
                Set<String> tasks = cacheService.zRangeByScore(futureKey, 0, System.currentTimeMillis());

                // åŒæ­¥æ•°æ®
                if (!tasks.isEmpty()) {
                    cacheService.refreshWithPipeline(futureKey, topicKey, tasks);
                    log.info("æˆåŠŸçš„å°†" + futureKey + "åˆ·æ–°åˆ°äº†" + topicKey);
                }
            }
        }
    }
```

å¼€å¯è°ƒåº¦ä»»åŠ¡

```java
@EnableScheduling  //å¼€å¯è°ƒåº¦ä»»åŠ¡
public class ScheduleApplication 
```

#### åˆ†å¸ƒå¼é”è§£å†³é›†ç¾¤ä¸‹çš„æ–¹æ³•æŠ¢å æ‰§è¡Œ

> é—®é¢˜æè¿°ï¼šå¦‚æœå¯åŠ¨ä¸¤å°leadnews-scheduleæœåŠ¡ï¼Œæ¯å°æœåŠ¡éƒ½ä¼šå»æ‰§è¡Œrefreshå®šæ—¶ä»»åŠ¡æ–¹æ³•ã€‚
>
> å±•ç¤ºé—®é¢˜p92 ğŸ”–

![](images/image-20231228232217510.png)

åˆ†å¸ƒå¼é”ï¼šæ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿæœ‰åºçš„å»å¯¹å…±äº«èµ„æºè¿›è¡Œæ“ä½œï¼Œé€šè¿‡äº’æ–¥æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚

åˆ†å¸ƒå¼é”çš„è§£å†³æ–¹æ¡ˆï¼š

| **æ–¹æ¡ˆ** | **è¯´æ˜**                    |
| -------------- | --------------------------------- |
| æ•°æ®åº“         | åŸºäºè¡¨çš„å”¯ä¸€ç´¢å¼•                  |
| zookeeper      | æ ¹æ®zookeeperä¸­çš„ä¸´æ—¶æœ‰åºèŠ‚ç‚¹æ’åº |
| redis          | ä½¿ç”¨SETNXå‘½ä»¤å®Œæˆ                 |

##### redisåˆ†å¸ƒå¼é”

sexnx ï¼ˆSET if Not eXistsï¼‰ å‘½ä»¤åœ¨æŒ‡å®šçš„ key ä¸å­˜åœ¨æ—¶ï¼Œä¸ºkeyè®¾ç½®æŒ‡å®šçš„å€¼ã€‚

åŠ é”çš„æ€è·¯ï¼š

![](images/image-20231231024219837.png)

é¦–å…ˆAè¯·æ±‚ååŠ é”ï¼ŒBå°±æ— æ³•è¯·æ±‚ï¼›

![](images/image-20231231024443534.png)

30ç§’åAé‡Šæ”¾é”ï¼ŒBå†è¯·æ±‚å°±æˆåŠŸï¼ŒåŒæ—¶å†åŠ é”ã€‚

åœ¨CacheServiceä¸­æ·»åŠ 

```java
    /**
     * åŠ é”
     * @param name é”åç§°
     * @param expire è¿‡æœŸæ—¶é—´ï¼Œæ¯«ç§’å€¼
     * @return
     */
    public String tryLock(String name, long expire) {
        name = name + "_lock";
        String token = UUID.randomUUID().toString();
        RedisConnectionFactory factory = stringRedisTemplate.getConnectionFactory();
        RedisConnection conn = factory.getConnection();
        try {
            // å‚è€ƒrediså‘½ä»¤ï¼š
            // set key value [EX seconds] [PX milliseconds] [NX|XX]
            Boolean result = conn.set(
                    name.getBytes(),
                    token.getBytes(),
                    Expiration.from(expire, TimeUnit.MILLISECONDS),
                    RedisStringCommands.SetOption.SET_IF_ABSENT
            );
            if (result != null && result) {
                return token;
            }

        } finally {
            RedisConnectionUtils.releaseConnection(conn, factory, false);
        }
        return null;
    }
```

ä¿®æ”¹ï¼š

```java
@Scheduled(cron = "0 */1 * * * ?")
public void refresh() {
  String token = cacheService.tryLock("FUTRUE_TASK_SYNC", 1000 * 30);

  if (StringUtils.isNotBlank(token)) {
    ...
  }
}
```

ğŸ”–æµ‹è¯•

#### æ•°æ®åº“ä»»åŠ¡å®šæ—¶åŒæ­¥åˆ°redis

1. æ¸…ç†ç¼“å­˜ä¸­çš„æ•°æ®

å› ä¸ºæ˜¯æŸ¥è¯¢å°äº5minä¸­çš„æ‰€æœ‰ä»»åŠ¡ï¼Œæ¸…ç†ç¼“å­˜æ˜¯ä¸ºäº†é˜²æ­¢ç¼“å­˜ä¸­æœ‰æ²¡æœ‰æ¶ˆè´¹çš„ä»»åŠ¡ï¼ˆé˜²æ­¢ä»»åŠ¡é‡å¤ï¼‰ã€‚

```java
Set<String> topicKeys = cacheService.scan(ScheduleConstants.TOPIC + "*");
Set<String> futureKeys = cacheService.scan(ScheduleConstants.FUTURE + "*");
cacheService.delete(topicKeys);
cacheService.delete(futureKeys);
```

2. æŸ¥è¯¢å°äºæœªæ¥5åˆ†é’Ÿçš„æ‰€æœ‰ä»»åŠ¡

```java
List<Taskinfo> taskinfoList = taskinfoMapper.selectList(Wrappers.<Taskinfo>lambdaQuery().lt(Taskinfo::getExecuteTime, calendar.getTime()));
```

3. æ–°å¢ä»»åŠ¡åˆ°redis

```java
for (Taskinfo taskinfo : taskinfoList) {
  Task task = new Task();
  BeanUtils.copyProperties(taskinfo,task);
  task.setExecuteTime(taskinfo.getExecuteTime().getTime());
  addTaskToCache(task);
}
```

4. æµ‹è¯•

æ¸…ç†æ‰ç¼“å­˜å’Œæ•°æ®åº“ä»»åŠ¡ï¼Œæ·»åŠ æ–°çš„å‡ æ¡ä»»åŠ¡ï¼Œç„¶ååœ¨åˆ æ‰ä¸€ä¸¤ä¸ªç¼“å­˜ä»»åŠ¡ï¼Œé‡å¯ScheduleApplicationå¾®æœåŠ¡çœ‹çœ‹æ˜¯å¦åŒæ­¥ã€‚

> 1. åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªæ–¹æ³•åœ¨åŒä¸€æ—¶é—´åªèƒ½è¢«ä¸€ä¸ªæœºå™¨çš„ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ
> 2. ä¸»è¦æ˜¯é€šè¿‡redisçš„sexnxç‰¹æ€§å®Œæˆåˆ†å¸ƒå¼é”çš„åŠŸèƒ½Aè·å–åˆ°é”ä»¥åå…¶ä»–å®¢æˆ·ç«¯ä¸èƒ½æ“ä½œï¼Œåªèƒ½ç­‰å¾…Aé‡Šæ”¾é”ä»¥åï¼Œå…¶ä»–å®¢æˆ·ç«¯æ‰èƒ½æ“ä½œ

### 5.5 å»¶è¿Ÿé˜Ÿåˆ—è§£å†³ç²¾å‡†æ—¶é—´å‘å¸ƒæ–‡ç« 

ä¸ºäº†è®©å…¶å®ƒå¾®æœåŠ¡ä¹Ÿèƒ½è°ƒç”¨leadnews-scheduleï¼Œéœ€è¦leadnews-scheduleæä¾›å¯¹å¤–çš„feignè¿œç¨‹æ¥å£ï¼š

![](images/image-20231231031908916.png)

#### å»¶è¿Ÿé˜Ÿåˆ—æœåŠ¡æä¾›å¯¹å¤–æ¥å£

- åœ¨leadnews-feign-apiæ¨¡å—ä¸­å®šä¹‰scheduleçš„feignè¿œç¨‹æ¥å£ï¼š

```java
@FeignClient("leadnews-schedule")
public interface IScheduleClient {
    /**
     * æ·»åŠ å»¶è¿Ÿä»»åŠ¡
     * @param task
     * @return
     */
    @PostMapping("/api/v1/task/add")
    public ResponseResult addTask(@RequestBody Task task);

    /**
     * å–æ¶ˆä»»åŠ¡
     * @param taskId
     * @return
     */
    @GetMapping("/api/v1/task/{taskId}")
    public ResponseResult cancelTask(@PathVariable("taskId") long taskId);

    /**
     * æŒ‰ç…§ç±»å‹å’Œä¼˜å…ˆçº§æ‹‰å–ä»»åŠ¡
     * @param type
     * @param priority
     * @return
     */
    @GetMapping("/api/v1/task/{type}/{priority}")
    public ResponseResult poll(@PathVariable("type") int type, @PathVariable("priority") int priority);
}
```

åœ¨leadnews-scheduleä¸­åˆ›å»ºä¸Šé¢è¿œç¨‹æ¥å£çš„å®ç°ï¼š

```

```

#### å‘å¸ƒæ–‡ç« é›†æˆæ·»åŠ å»¶è¿Ÿé˜Ÿåˆ—æ¥å£ï¼ˆæ·»åŠ ä»»åŠ¡ï¼‰

![](images/image-20231228233009467.png)

- åœ¨leadnews-wemediaæ¨¡å—ä¸­æ·»åŠ ä¸€ä¸ªserviceï¼š

```java
@Service
@Slf4j
public class WmNewsTaskServiceImpl implements WmNewsTaskService {

    @Autowired
    private IScheduleClient scheduleClient;

    /**
     * æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿Ÿé˜Ÿåˆ—ä¸­
     *
     * @param id          æ–‡ç« çš„id
     * @param publishTime å‘å¸ƒçš„æ—¶é—´ å¯ä»¥ä½œä¸ºä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´
     */
    @Override
    @Async
    public void addNewsToTask(Integer id, Date publishTime) {
        log.info("æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿Ÿé˜Ÿåˆ—ä¸­-----begin");

        Task task = new Task();
        task.setExecuteTime(publishTime.getTime());
        task.setTaskType(TaskTypeEnum.NEWS_SCAN_TIME.getTaskType());
        task.setPriority(TaskTypeEnum.NEWS_SCAN_TIME.getPriority());
        WmNews wmNews = new WmNews();
        wmNews.setId(id);
        task.setParameters(ProtostuffUtil.serialize(wmNews));

        scheduleClient.addTask(task);

        log.info("æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿Ÿé˜Ÿåˆ—ä¸­-----end");
    }
}
```

- ä¿®æ”¹WmNewsServiceImplä¸­çš„submitNews()æ–¹æ³•ï¼š

```java
    @Override
    public ResponseResult submitNews(WmNewsDto dto) {
      ....
        // å®¡æ ¸æ–‡ç« 
//        wmNewsAutoScanService.autoScanWmNews(wmNews.getId());
        wmNewsTaskService.addNewsToTask(wmNews.getId(), wmNews.getPublishTime());
    ...
```

- æµ‹è¯•

å¯åŠ¨leadnews-scheduleï¼Œleandnews-wemedia-gatewayï¼Œleadnews-wemedia

http://localhost:8802/#/login

##### åºåˆ—åŒ–å·¥å…·å¯¹æ¯”

`JdkSerialize`ï¼šjavaå†…ç½®çš„åºåˆ—åŒ–èƒ½å°†å®ç°äº†Serilazableæ¥å£çš„å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œ ObjectOutputStreamçš„writeObject()æ–¹æ³•å¯åºåˆ—åŒ–å¯¹è±¡ç”Ÿæˆå­—èŠ‚æ•°ç»„

`Protostuff`ï¼šgoogleå¼€æºçš„protostuffé‡‡ç”¨æ›´ä¸ºç´§å‡‘çš„äºŒè¿›åˆ¶æ•°ç»„ï¼Œè¡¨ç°æ›´åŠ ä¼˜å¼‚ï¼Œç„¶åä½¿ç”¨protostuffçš„ç¼–è¯‘å·¥å…·ç”Ÿæˆpojoç±»

```xml
<dependency>
  <groupId>io.protostuff</groupId>
  <artifactId>protostuff-core</artifactId>
  <version>1.6.0</version>
</dependency>

<dependency>
  <groupId>io.protostuff</groupId>
  <artifactId>protostuff-runtime</artifactId>
  <version>1.6.0</version>
</dependency>
```

#### æ¶ˆè´¹ä»»åŠ¡è¿›è¡Œå®¡æ ¸æ–‡ç« ï¼ˆæ‹‰å–ä»»åŠ¡ï¼‰

æŒ‰ç…§å›ºå®šé¢‘ç‡æ‹‰å»ä»»åŠ¡ï¼Œæ¯ç§’æ‹‰å–ä¸€æ¬¡ã€‚

- æ·»åŠ æ‹‰å–ä»»åŠ¡æ–¹æ³•

```java
    @Autowired
    private WmNewsAutoScanService wmNewsAutoScanService;

    /**
     * æ¶ˆè´¹ä»»åŠ¡ï¼Œå®¡æ ¸æ–‡ç« 
     * æ¯1ç§’æ‹‰å–ä»»åŠ¡
     */
    @Scheduled(fixedRate = 1000)
    @Override
    public void scanNewsByTask() {
        log.info("æ¶ˆè´¹ä»»åŠ¡ï¼Œå®¡æ ¸æ–‡ç« ");
        ResponseResult res = scheduleClient.poll(TaskTypeEnum.NEWS_SCAN_TIME.getTaskType(), TaskTypeEnum.NEWS_SCAN_TIME.getPriority());
        if (res.getCode().equals(200) && res.getData() != null) {
            Task task = JSON.parseObject(JSON.toJSONString(res.getData()), Task.class);
            WmNews wmNews = ProtostuffUtil.deserialize(task.getParameters(), WmNews.class);
            wmNewsAutoScanService.autoScanWmNews(wmNews.getId());
        }
    }
```

- å¼€å¯è°ƒåº¦ä»»åŠ¡

```java
@EnableScheduling
public class WemediaApplication 
```

- æµ‹è¯•

å¯åŠ¨leadnews-scheduleï¼Œleandnews-wemedia-gatewayä»¥åŠleadnews-articleï¼Œé‡å¯leadnews-wemedia

http://localhost:8802/#/login

ğŸ”–

## 6 kafkaåŠå¼‚æ­¥é€šçŸ¥æ–‡ç« ä¸Šä¸‹æ¶

### 6.1 è‡ªåª’ä½“æ–‡ç« ä¸Šä¸‹æ¶

#### éœ€æ±‚åˆ†æ

![](images/image-20231231042755824.png)

> æ€è€ƒï¼šè¿™é‡Œçš„æ–‡ç« ä¸Šä¸‹æ¶æŒ‡çš„è‡ªåª’ä½“æ–‡ç« è¿˜æ˜¯appç«¯æ–‡ç« ï¼Ÿ
>
> Appç«¯æ–‡ç« 

åœ¨è‡ªåª’ä½“å¾®æœåŠ¡ä¸Šä¸‹æ¶æ–‡ç« ï¼Œéœ€è¦é€šçŸ¥æ–‡ç« å¾®æœåŠ¡ï¼Œå¦‚æœé‡‡ç”¨feignè¿œç¨‹è°ƒç”¨å¯èƒ½ä¼šäº§ç”Ÿç³»ç»Ÿè€¦åˆğŸ”–ï¼›æ›´å¥½çš„æ–¹å¼æ˜¯MQï¼Œå®ƒçš„ä¼˜åŠ¿æ˜¯==ç³»ç»Ÿè§£è€¦==ã€‚

![](images/image-20231231043137993.png)

æ–‡ç« çš„ç‚¹èµä¸å–œæ¬¢æˆ–å…³æ³¨ï¼Œä¹Ÿå¯ä»¥ç”¨åˆ°MQï¼Œç”¨äº==æµé‡å‰Šå³°==ğŸ”–ï¼š

![](images/image-20240228113404756.png)

### 6.2 kafka

æ¶ˆæ¯ä¸­é—´ä»¶å¯¹æ¯”ï¼š

| ç‰¹æ€§       | ActiveMQ                               | RabbitMQ                   | RocketMQ                 | Kafka                                    |
| ---------- | -------------------------------------- | -------------------------- | ------------------------ | ---------------------------------------- |
| å¼€å‘è¯­è¨€   | java                                   | erlang                     | java                     | scala                                    |
| å•æœºååé‡ | ä¸‡çº§                                   | ä¸‡çº§                       | 10ä¸‡çº§                   | 100ä¸‡çº§                                  |
| æ—¶æ•ˆæ€§     | ms                                     | us                         | ms                       | msçº§ä»¥å†…                                 |
| å¯ç”¨æ€§     | é«˜ï¼ˆä¸»ä»ï¼‰                             | é«˜ï¼ˆä¸»ä»ï¼‰                 | éå¸¸é«˜ï¼ˆåˆ†å¸ƒå¼ï¼‰         | éå¸¸é«˜ï¼ˆåˆ†å¸ƒå¼ï¼‰                         |
| åŠŸèƒ½ç‰¹æ€§   | æˆç†Ÿçš„äº§å“ã€è¾ƒå…¨çš„æ–‡æ¡£ã€å„ç§åè®®æ”¯æŒå¥½ | å¹¶å‘èƒ½åŠ›å¼ºã€æ€§èƒ½å¥½ã€å»¶è¿Ÿä½ | MQåŠŸèƒ½æ¯”è¾ƒå®Œå–„ï¼Œæ‰©å±•æ€§ä½³ | åªæ”¯æŒä¸»è¦çš„MQåŠŸèƒ½ï¼Œä¸»è¦åº”ç”¨äºå¤§æ•°æ®é¢†åŸŸ |

æ¶ˆæ¯ä¸­é—´ä»¶å¯¹æ¯”-é€‰æ‹©å»ºè®®ï¼šã€ActiveMQå·²ä¸å†æ¨èã€‘

| **æ¶ˆæ¯ä¸­é—´ä»¶** | **å»ºè®®**                                                           |
| -------------------- | ------------------------------------------------------------------------ |
| Kafka                | è¿½æ±‚é«˜ååé‡ï¼Œé€‚åˆäº§ç”Ÿå¤§é‡æ•°æ®çš„äº’è”ç½‘æœåŠ¡çš„æ•°æ®æ”¶é›†ä¸šåŠ¡                 |
| RocketMQ             | å¯é æ€§è¦æ±‚å¾ˆé«˜çš„é‡‘èäº’è”ç½‘é¢†åŸŸï¼Œç¨³å®šæ€§é«˜ï¼Œç»å†äº†å¤šæ¬¡é˜¿é‡ŒåŒ11è€ƒéªŒ         |
| RabbitMQ             | æ€§èƒ½è¾ƒå¥½ï¼Œç¤¾åŒºæ´»è·ƒåº¦é«˜ï¼Œæ•°æ®é‡æ²¡æœ‰é‚£ä¹ˆå¤§ï¼Œä¼˜å…ˆé€‰æ‹©åŠŸèƒ½æ¯”è¾ƒå®Œå¤‡çš„RabbitMQ |

#### kafkaä»‹ç»

Kafkaæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æµåª’ä½“å¹³å°,ç±»ä¼¼äºæ¶ˆæ¯é˜Ÿåˆ—æˆ–ä¼ä¸šæ¶ˆæ¯ä¼ é€’ç³»ç»Ÿã€‚kafkaå®˜ç½‘ï¼šhttp://kafka.apache.org/

![](images/image-20231214135951026.png)

Producersï¼šæ¶ˆæ¯ç”Ÿäº§è€…

Consumersï¼šæ¶ˆæ¯æ¶ˆè´¹è€…

Kafka CLusterï¼škafkaé›†ç¾¤

Stream Processorsï¼šæ¶ˆæ¯æµå¼å¤„ç†

Connectorsï¼šè¿æ¥å™¨ï¼Œä¸æ•°æ®åº“æ•°æ®äº¤äº’



**kafkaåè¯è§£é‡Š**

![](images/image-20231214140006878.png)

- producerï¼šå‘å¸ƒæ¶ˆæ¯çš„å¯¹è±¡ç§°ä¹‹ä¸ºä¸»é¢˜ç”Ÿäº§è€…ï¼ˆKafka topic producerï¼‰
- topicï¼šKafkaå°†æ¶ˆæ¯åˆ†é—¨åˆ«ç±»ï¼Œæ¯ä¸€ç±»çš„æ¶ˆæ¯ç§°ä¹‹ä¸ºä¸€ä¸ª**ä¸»é¢˜ï¼ˆTopicï¼‰**
- consumerï¼šè®¢é˜…æ¶ˆæ¯å¹¶å¤„ç†å‘å¸ƒçš„æ¶ˆæ¯çš„å¯¹è±¡ç§°ä¹‹ä¸ºä¸»é¢˜æ¶ˆè´¹è€…ï¼ˆconsumersï¼‰
- brokerï¼šå·²å‘å¸ƒçš„æ¶ˆæ¯ä¿å­˜åœ¨ä¸€ç»„æœåŠ¡å™¨ä¸­ï¼Œç§°ä¹‹ä¸º**Kafkaé›†ç¾¤**ã€‚é›†ç¾¤ä¸­çš„æ¯ä¸€ä¸ªæœåŠ¡å™¨éƒ½æ˜¯ä¸€ä¸ªä»£ç†ï¼ˆBrokerï¼‰ã€‚ æ¶ˆè´¹è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªä¸»é¢˜ï¼ˆtopicï¼‰ï¼Œå¹¶ä»Brokeræ‹‰æ•°æ®ï¼Œä»è€Œæ¶ˆè´¹è¿™äº›å·²å‘å¸ƒçš„æ¶ˆæ¯ã€‚

#### kafkaå®‰è£…é…ç½®

Kafkaå¯¹äºzookeeperæ˜¯å¼ºä¾èµ–ï¼Œä¿å­˜kafkaç›¸å…³çš„èŠ‚ç‚¹æ•°æ®ï¼Œæ‰€ä»¥å®‰è£…Kafkaä¹‹å‰å¿…é¡»å…ˆå®‰è£…zookeeperã€‚

- Dockerå®‰è£…zookeeper

```shell
docker pull zookeeper:3.4.14

# mac m1 å¯èƒ½é‡åˆ°æ²¡æœ‰arm64çš„æƒ…å†µï¼Œæ·»åŠ --platform linux/x86_64
docker pull --platform linux/arm64 zookeeper:3.4.14

```

```shell
docker run -d --name zookeeper -p 2181:2181 zookeeper:3.4.14

docker run --platform linux/amd64 -d --name zookeeper -p 2181:2181 zookeeper:3.4.14
```

```
WARNING: The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested
```

- Dockerå®‰è£…kafka

æ³¨æ„kafkaå’Œzookeeperçš„ç‰ˆæœ¬å¯¹åº”

```shell
docker pull wurstmeister/kafka:2.12-2.3.1
```

```shell
docker run -d --name kafka \
--env KAFKA_ADVERTISED_HOST_NAME=10.211.55.5 \
--env KAFKA_ZOOKEEPER_CONNECT=10.211.55.5:2181 \
--env KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://10.211.55.5:9092 \
--env KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \
--env KAFKA_HEAP_OPTS="-Xmx256M -Xms256M" \
--net=host wurstmeister/kafka:2.12-2.3.1
```

> `10.211.55.5`æ˜¯æœåŠ¡å™¨åœ°å€
>
> `9092`æ˜¯kafkaå¯¹å¤–ç›‘å¬çš„ç«¯å£
>
> `--net=host`ï¼Œkafkaç›´æ¥ä½¿ç”¨å®¹å™¨å®¿ä¸»æœºçš„ç½‘ç»œå‘½åç©ºé—´ï¼Œ å³æ²¡æœ‰ç‹¬ç«‹çš„ç½‘ç»œç¯å¢ƒã€‚å®ƒä½¿ç”¨å®¿ä¸»æœºçš„ipå’Œç«¯å£ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨-pæ¥åšæ˜ å°„ï¼ˆäº‘ä¸»æœºå°±å¿…é¡»è¦ä½¿ç”¨-päº†ï¼‰ã€‚

> æœ€ç»ˆåœ¨é˜¿é‡Œäº‘æœåŠ¡ä¸­æ­å»º
>
> æˆ–è€…åœ¨macä¸Šç›´æ¥å®‰è£…ä½¿ç”¨:
>
> - ç›´æ¥ä¸‹è½½zookeeper 3.4.14çš„äºŒè¿›åˆ¶ç‰ˆæœ¬(apache-zookeeper-3.7.2-bin)
>
> ```shell
> âœ  bin sudo ./zkServer.sh start
> 
> âœ  bin sudo ./zkCli.sh 
> zk: localhost:2181(CONNECTED) 0] ls /
> [zookeeper]
> [zk: localhost:2181(CONNECTED) 1] 
> ```
>
> - ç›´æ¥ä¸‹è½½kafkaçš„äºŒè¿›åˆ¶ç‰ˆæœ¬ï¼ˆkafka_2.12-2.3.1ï¼‰
>
> ```shell
> ./kafka-topics.sh --version
> 2.3.1 (Commit:18a913733fb71c01)
> ```
>
> é…ç½®æ–‡ä»¶`config/server.properties`ä¸­å‚æ•°
>
> `broker.id`ï¼šæ¯ä¸ª Kafka æœåŠ¡éƒ½éœ€è¦æŒ‡å®šä¸€ä¸ªå”¯ä¸€çš„ broker.id
>
> `listeners`ï¼šKafka ç›‘å¬çš„åœ°å€å’Œç«¯å£å·ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ªï¼Œä»¥é€—å·åˆ†éš”ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒKafka ç›‘å¬çš„åœ°å€æ˜¯æœ¬æœº IP åœ°å€ã€‚
>
> `log.dirs`ï¼šKafka å­˜å‚¨æ¶ˆæ¯æ—¥å¿—çš„è·¯å¾„ã€‚
>
> `zookeeper.connect`ï¼šZooKeeper çš„è¿æ¥åœ°å€ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ªï¼Œä»¥é€—å·åˆ†éš”ã€‚å¦‚æœå®‰è£…äº†å¤šä¸ª ZooKeeperï¼Œå»ºè®®æŒ‡å®šå¤šä¸ªè¿æ¥åœ°å€ï¼Œä»¥æé«˜å¯ç”¨æ€§ã€‚
>
> 1ï¸âƒ£å¯åŠ¨ Kafka æœåŠ¡ï¼š
>
> ```shell
> ./kafka-server-start.sh config/server.properties
> ```
>
> 2ï¸âƒ£åˆ›å»ºä¸€ä¸ªtestä¸»é¢˜ï¼š
>
> ```
> ./kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic test
> ```
>
> å…¶ä¸­ï¼Œ--replication-factor å‚æ•°æŒ‡å®šå‰¯æœ¬æ•°ï¼Œ--partitions å‚æ•°æŒ‡å®šåˆ†åŒºæ•°ã€‚åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®å°†å‰¯æœ¬æ•°è®¾ç½®ä¸º 2 æˆ– 3ï¼Œä»¥æé«˜å¯ç”¨æ€§ã€‚
>
> 3ï¸âƒ£ç”Ÿäº§æ¶ˆæ¯ï¼š
>
> ```
> ./kafka-console-producer.sh --broker-list localhost:9092 --topic test
> ```
>
> åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥æ¶ˆæ¯ï¼Œç„¶åæŒ‰å›è½¦é”®å‘é€ã€‚
>
> 4ï¸âƒ£æ¥æ”¶æ¶ˆæ¯
>
> ```
> ./kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --from-beginning
> ```
>
> å…¶ä¸­ï¼Œ--from-beginning å‚æ•°è¡¨ç¤ºä»æœ€æ—©çš„æ¶ˆæ¯å¼€å§‹æ¥æ”¶ã€‚



> ç”±äºzookeeper 3.4.14æ²¡æœ‰armç‰ˆæœ¬ï¼Œé€‰æ‹©æ›´åŠ æ–°çš„ç‰ˆæœ¬ï¼š
>
> ```shell
> docker pull zookeeper:3.5.9
> 
> docker run -d --name zookeeper -p 2181:2181 zookeeper:3.5.9
> 
> docker run -d --name kafka \
> --env KAFKA_ADVERTISED_HOST_NAME=10.211.55.5 \
> --env KAFKA_ZOOKEEPER_CONNECT=10.211.55.5:2181 \
> --env KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://10.211.55.5:9092 \
> --env KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \
> --env KAFKA_HEAP_OPTS="-Xmx256M -Xms256M" \
> --net=host wurstmeister/kafka
> ```
>
> 

#### kafkaå…¥é—¨

##### å…¥é—¨æ¡ˆä¾‹



1. åˆ›å»ºkafka-demoé¡¹ç›®ï¼Œå¯¼å…¥ä¾èµ–

```xml
<dependency>
    <groupId>org.apache.kafka</groupId>
    <artifactId>kafka-clients</artifactId>
</dependency>
```

2. ç”Ÿäº§è€…å‘é€æ¶ˆæ¯

```java
public class ProducerQuickStart {

    public static void main(String[] args) {
        // 1 kafkaçš„é…ç½®ä¿¡æ¯
        Properties properties = new Properties();
        // kafkaçš„è¿æ¥åœ°å€
        properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        // å‘é€å¤±è´¥ï¼Œå¤±è´¥çš„é‡è¯•æ¬¡æ•°
        properties.put(ProducerConfig.RETRIES_CONFIG, 5);
        // æ¶ˆæ¯keyçš„åºåˆ—åŒ–å™¨
        properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, "org.apache.kafka.common.serialization.StringSerializer");
        // æ¶ˆæ¯valueçš„åºåˆ—åŒ–å™¨
        properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, "org.apache.kafka.common.serialization.StringSerializer");

        // 2 ç”Ÿäº§è€…å¯¹è±¡
        KafkaProducer<String,String> producer = new KafkaProducer<String, String>(properties);

        // å°è£…å‘é€çš„æ¶ˆæ¯:topicï¼Œkeyï¼Œvalue
        ProducerRecord<String,String> record = new ProducerRecord<String, String>("andyron-topic","100001","hello kafka-3");

        // 3 å‘é€æ¶ˆæ¯
        producer.send(record);

        // 4 å…³é—­æ¶ˆæ¯é€šé“ï¼Œå¿…é¡»å…³é—­ï¼Œå¦åˆ™æ¶ˆæ¯å‘é€ä¸æˆåŠŸ
        producer.close();
    }
}

```



3. æ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯

```java
public class ConsumerQuickStart {

    public static void main(String[] args) {
        // 1.æ·»åŠ kafkaçš„é…ç½®ä¿¡æ¯
        Properties properties = new Properties();
        // kafkaçš„è¿æ¥åœ°å€
        properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        // æ¶ˆè´¹è€…ç»„
        properties.put(ConsumerConfig.GROUP_ID_CONFIG, "group2");
        // keyã€valueçš„ååºåˆ—åŒ–å™¨
        properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, "org.apache.kafka.common.serialization.StringDeserializer");
        properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, "org.apache.kafka.common.serialization.StringDeserializer");

        // 2.æ¶ˆè´¹è€…å¯¹è±¡
        KafkaConsumer<String, String> consumer = new KafkaConsumer<String, String>(properties);

        // 3.è®¢é˜…ä¸»é¢˜
        consumer.subscribe(Collections.singletonList("andyron-topic"));

        // å½“å‰çº¿ç¨‹ä¸€ç›´å¤„äºç›‘å¬çŠ¶æ€
        while (true) {
            // 4.è·å–æ¶ˆæ¯
            ConsumerRecords<String, String> consumerRecords = consumer.poll(Duration.ofMillis(1000));
            for (ConsumerRecord<String, String> consumerRecord : consumerRecords) {
                System.out.println(consumerRecord.key());
                System.out.println(consumerRecord.value());
            }
        }
    }
}
```



å¤åˆ¶ä¸€ä»½æ¶ˆè´¹è€…

![](images/image-20240229114120981.png)

1ï¸âƒ£ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼Œå¤šä¸ªæ¶ˆè´¹è€…è®¢é˜…åŒä¸€ä¸ªä¸»é¢˜ï¼Œåªèƒ½æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯ï¼ˆä¸€å¯¹ä¸€ï¼‰

![](images/image-20240229112958842.png)

2ï¸âƒ£ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼Œå¤šä¸ªæ¶ˆè´¹è€…è®¢é˜…åŒä¸€ä¸ªä¸»é¢˜ï¼Œæ‰€æœ‰æ¶ˆè´¹è€…éƒ½èƒ½æ”¶åˆ°æ¶ˆæ¯ï¼ˆä¸€å¯¹å¤šï¼‰ã€ä¿®æ”¹å¤åˆ¶çš„æ¶ˆè´¹è€…çš„ç»„åä¸ºgroup2ã€‘

![](images/image-20240229113024296.png)

##### åˆ†åŒºæœºåˆ¶

![](images/image-20240229115145501.png)

Tè¡¨ç¤ºä¸»é¢˜ï¼ŒPè¡¨ç¤ºåˆ†åŒºï¼ˆå¯ä»¥ç†è§£ä¸ºä¸åŒçš„æ–‡ä»¶å¤¹ï¼‰

- Kafka ä¸­çš„åˆ†åŒºæœºåˆ¶æŒ‡çš„æ˜¯å°†æ¯ä¸ªä¸»é¢˜åˆ’åˆ†æˆå¤šä¸ªåˆ†åŒºï¼ˆPartitionï¼‰ã€ä¹Ÿå°±æ˜¯å¯ä»¥ç†è§£ä¸ºæŠŠtopicå­˜å‚¨åœ¨ä¸åŒçš„æœºå™¨é‡Œä¸åŒçš„æ–‡ä»¶å¤¹ä¸‹ã€‘
- å¯ä»¥å¤„ç†æ›´å¤šçš„æ¶ˆæ¯ï¼Œä¸å—å•å°æœåŠ¡å™¨çš„é™åˆ¶ï¼Œå¯ä»¥ä¸å—é™çš„å¤„ç†æ›´å¤šçš„æ•°æ®



##### topicå‰–æ

![](images/image-20240229115351849.png)

æ¯ä¸€ä¸ªåˆ†åŒºéƒ½æ˜¯ä¸€ä¸ªé¡ºåºçš„ã€ä¸å¯å˜çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œ å¹¶ä¸”å¯ä»¥æŒç»­çš„æ·»åŠ ã€‚åˆ†åŒºä¸­çš„æ¶ˆæ¯éƒ½è¢«åˆ†äº†ä¸€ä¸ªåºåˆ—å·ï¼Œç§°ä¹‹ä¸º==åç§»é‡(offset)==ï¼Œåœ¨æ¯ä¸ªåˆ†åŒºä¸­æ­¤åç§»é‡éƒ½æ˜¯å”¯ä¸€çš„ã€‚

##### åˆ†åŒºç­–ç•¥

| **åˆ†åŒºç­–ç•¥** | **è¯´æ˜**                                                                                     |
| ------------------ | -------------------------------------------------------------------------------------------------- |
| è½®è¯¢ç­–ç•¥           | æŒ‰é¡ºåºè½®æµå°†æ¯æ¡æ•°æ®åˆ†é…åˆ°æ¯ä¸ªåˆ†åŒºä¸­                                                               |
| éšæœºç­–ç•¥           | æ¯æ¬¡éƒ½éšæœºåœ°å°†æ¶ˆæ¯åˆ†é…åˆ°æ¯ä¸ªåˆ†åŒº                                                                   |
| æŒ‰é”®ä¿å­˜ç­–ç•¥       | ç”Ÿäº§è€…å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªkeyï¼Œè®¡ç®—è¿™ä¸ªkeyçš„hashCodeå€¼ï¼ŒæŒ‰ç…§hashCodeçš„å€¼å¯¹ä¸åŒæ¶ˆæ¯è¿›è¡Œå­˜å‚¨ |

ä¸æŒ‡å®škeyé»˜è®¤å°±æ˜¯è½®è¯¢ã€‚

#### kafkaé«˜å¯ç”¨è®¾è®¡ğŸ”–

##### æ–¹æ¡ˆä¸€ï¼šé›†ç¾¤

![](images/image-20240229120057326.png)

- Kafka çš„æœåŠ¡å™¨ç«¯ç”±è¢«ç§°ä¸ºBrokerçš„æœåŠ¡è¿›ç¨‹æ„æˆï¼Œå³ä¸€ä¸ªKafkaé›†ç¾¤ç”±å¤šä¸ªBrokerç»„æˆ
- è¿™æ ·å¦‚æœé›†ç¾¤ä¸­æŸä¸€å°æœºå™¨å®•æœºï¼Œå…¶ä»–æœºå™¨ä¸Šçš„ Broker ä¹Ÿä¾ç„¶èƒ½å¤Ÿå¯¹å¤–æä¾›æœåŠ¡ã€‚è¿™å…¶å®å°±æ˜¯ Kafka æä¾›é«˜å¯ç”¨çš„æ‰‹æ®µä¹‹ä¸€

##### æ–¹æ¡ˆäºŒï¼šå¤‡ä»½æœºåˆ¶(Replicationï¼‰

![](images/image-20231214140626267.png)

Kafka ä¸­æ¶ˆæ¯çš„å¤‡ä»½åˆå«åš å‰¯æœ¬ï¼ˆReplicaï¼‰

Kafka å®šä¹‰äº†ä¸¤ç±»å‰¯æœ¬ï¼š

- é¢†å¯¼è€…å‰¯æœ¬ï¼ˆLeader Replicaï¼‰
- è¿½éšè€…å‰¯æœ¬ï¼ˆFollower Replicaï¼‰

**åŒæ­¥æ–¹å¼**ï¼š

![](images/image-20231214140741381.png)

ISRï¼ˆin-sync replicaï¼‰éœ€è¦åŒæ­¥å¤åˆ¶ä¿å­˜çš„follower

å¦‚æœleaderå¤±æ•ˆåï¼Œéœ€è¦é€‰å‡ºæ–°çš„leaderï¼Œé€‰ä¸¾çš„åŸåˆ™å¦‚ä¸‹ï¼š

ç¬¬ä¸€ï¼šé€‰ä¸¾æ—¶ä¼˜å…ˆä»ISRä¸­é€‰å®šï¼Œå› ä¸ºè¿™ä¸ªåˆ—è¡¨ä¸­followerçš„æ•°æ®æ˜¯ä¸leaderåŒæ­¥çš„

ç¬¬äºŒï¼šå¦‚æœISRåˆ—è¡¨ä¸­çš„followeréƒ½ä¸è¡Œäº†ï¼Œå°±åªèƒ½ä»å…¶ä»–followerä¸­é€‰å–

æç«¯æƒ…å†µï¼Œå°±æ˜¯æ‰€æœ‰å‰¯æœ¬éƒ½å¤±æ•ˆäº†ï¼Œè¿™æ—¶æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

ç¬¬ä¸€ï¼šç­‰å¾…ISRä¸­çš„ä¸€ä¸ªæ´»è¿‡æ¥ï¼Œé€‰ä¸ºLeaderï¼Œæ•°æ®å¯é ï¼Œä½†æ´»è¿‡æ¥çš„æ—¶é—´ä¸ç¡®å®š

ç¬¬äºŒï¼šé€‰æ‹©ç¬¬ä¸€ä¸ªæ´»è¿‡æ¥çš„Replicationï¼Œä¸ä¸€å®šæ˜¯ISRä¸­çš„ï¼Œé€‰ä¸ºleaderï¼Œä»¥æœ€å¿«é€Ÿåº¦æ¢å¤å¯ç”¨æ€§ï¼Œä½†æ•°æ®ä¸ä¸€å®šå®Œæ•´

#### kafkaç”Ÿäº§è€…è¯¦è§£

##### å‘é€ç±»å‹

- åŒæ­¥å‘é€

  ä½¿ç”¨send()æ–¹æ³•å‘é€ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªFutureå¯¹è±¡ï¼Œè°ƒç”¨get()æ–¹æ³•è¿›è¡Œç­‰å¾…ï¼Œå°±å¯ä»¥çŸ¥é“æ¶ˆæ¯æ˜¯å¦å‘é€æˆåŠŸ

```java
//å‘é€æ¶ˆæ¯
try {
  RecordMetadata recordMetadata = producer.send(record).get();
  System.out.println(recordMetadata.offset());//è·å–åç§»é‡
} catch (Exception e){
  e.printStackTrace();
}
```

- å¼‚æ­¥å‘é€

  è°ƒç”¨send()æ–¹æ³•ï¼Œå¹¶æŒ‡å®šä¸€ä¸ªå›è°ƒå‡½æ•°ï¼ŒæœåŠ¡å™¨åœ¨è¿”å›å“åº”æ—¶è°ƒç”¨å‡½æ•°

```java
//å¼‚æ­¥æ¶ˆæ¯å‘é€
producer.send(kvProducerRecord, new Callback() {
    @Override
    public void onCompletion(RecordMetadata recordMetadata, Exception e) {
        if(e != null){
            System.out.println("è®°å½•å¼‚å¸¸ä¿¡æ¯åˆ°æ—¥å¿—è¡¨ä¸­");
        }
        System.out.println(recordMetadata.offset());
    }
});
```

##### å‚æ•°è¯¦è§£

[kafkaè¯¦ç»†é…ç½®](resource/kafkaé…ç½®.md)

- ack  æ¶ˆæ¯ç¡®è®¤æœºåˆ¶

| **ç¡®è®¤æœºåˆ¶**     | **è¯´æ˜**                                                     |
| ---------------- | ------------------------------------------------------------ |
| acks=0           | ç”Ÿäº§è€…åœ¨æˆåŠŸå†™å…¥æ¶ˆæ¯ä¹‹å‰**ä¸ä¼šç­‰å¾…**ä»»ä½•æ¥è‡ªæœåŠ¡å™¨çš„å“åº”,æ¶ˆæ¯æœ‰ä¸¢å¤±çš„é£é™©ï¼Œä½†æ˜¯é€Ÿåº¦æœ€å¿« |
| acks=1ï¼ˆé»˜è®¤å€¼ï¼‰ | åªè¦é›†ç¾¤é¦–é¢†èŠ‚ç‚¹æ”¶åˆ°æ¶ˆæ¯ï¼Œç”Ÿäº§è€…å°±ä¼šæ”¶åˆ°ä¸€ä¸ªæ¥è‡ªæœåŠ¡å™¨çš„**æˆåŠŸå“åº”** |
| acks=all         | åªæœ‰å½“æ‰€æœ‰å‚ä¸èµ‹å€¼çš„èŠ‚ç‚¹å…¨éƒ¨æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œç”Ÿäº§è€…æ‰ä¼šæ”¶åˆ°ä¸€ä¸ªæ¥è‡ªæœåŠ¡å™¨çš„æˆåŠŸå“åº” |

- retries  é‡è¯•æ¬¡æ•°

```java
//è®¾ç½®é‡è¯•æ¬¡æ•°
prop.put(ProducerConfig.RETRIES_CONFIG,10);
```

ç”Ÿäº§è€…ä»æœåŠ¡å™¨æ”¶åˆ°çš„é”™è¯¯æœ‰å¯èƒ½æ˜¯ä¸´æ—¶æ€§é”™è¯¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œretrieså‚æ•°çš„å€¼å†³å®šäº†ç”Ÿäº§è€…å¯ä»¥é‡å‘æ¶ˆæ¯çš„æ¬¡æ•°ï¼Œå¦‚æœè¾¾åˆ°è¿™ä¸ªæ¬¡æ•°ï¼Œç”Ÿäº§è€…ä¼šæ”¾å¼ƒé‡è¯•è¿”å›é”™è¯¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç”Ÿäº§è€…ä¼šåœ¨æ¯æ¬¡é‡è¯•ä¹‹é—´ç­‰å¾…100ms

- æ¶ˆæ¯å‹ç¼©

é»˜è®¤æƒ…å†µä¸‹ï¼Œ æ¶ˆæ¯å‘é€æ—¶ä¸ä¼šè¢«å‹ç¼©ã€‚

```java
//æ¶ˆæ¯å‹ç¼©
prop.put(ProducerConfig.COMPRESSION_TYPE_CONFIG,"gzip");
```

| **å‹ç¼©ç®—æ³•** | **è¯´æ˜**                                                     |
| ------------ | ------------------------------------------------------------ |
| snappy       | å ç”¨è¾ƒå°‘çš„ CPUï¼Œ å´èƒ½æä¾›è¾ƒå¥½çš„æ€§èƒ½å’Œç›¸å½“å¯è§‚çš„å‹ç¼©æ¯”ï¼Œ å¦‚æœçœ‹é‡æ€§èƒ½å’Œç½‘ç»œå¸¦å®½ï¼Œå»ºè®®é‡‡ç”¨ |
| lz4          | å ç”¨è¾ƒå°‘çš„ CPUï¼Œ å‹ç¼©å’Œè§£å‹ç¼©é€Ÿåº¦è¾ƒå¿«ï¼Œå‹ç¼©æ¯”ä¹Ÿå¾ˆå®¢è§‚        |
| gzip         | å ç”¨è¾ƒå¤šçš„ CPUï¼Œä½†ä¼šæä¾›æ›´é«˜çš„å‹ç¼©æ¯”ï¼Œç½‘ç»œå¸¦å®½æœ‰é™ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§ç®—æ³• |

ä½¿ç”¨å‹ç¼©å¯ä»¥é™ä½ç½‘ç»œä¼ è¾“å¼€é”€å’Œå­˜å‚¨å¼€é”€ï¼Œè€Œè¿™å¾€å¾€æ˜¯å‘ Kafka å‘é€æ¶ˆæ¯çš„ç“¶é¢ˆæ‰€åœ¨ã€‚



#### kafkaæ¶ˆè´¹è€…è¯¦è§£

##### æ¶ˆè´¹è€…ç»„

![](images/image-20240229141057990.png)

- æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰ ï¼šæŒ‡çš„å°±æ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆè´¹è€…ç»„æˆçš„ç¾¤ä½“
- ä¸€ä¸ªå‘å¸ƒåœ¨Topicä¸Šæ¶ˆæ¯è¢«åˆ†å‘ç»™æ­¤æ¶ˆè´¹è€…ç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹è€…

  - æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½åœ¨ä¸€ä¸ªç»„ä¸­ï¼Œé‚£ä¹ˆè¿™å°±å˜æˆäº†==queueæ¨¡å‹==
  - æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½åœ¨ä¸åŒçš„ç»„ä¸­ï¼Œé‚£ä¹ˆå°±å®Œå…¨å˜æˆäº†==å‘å¸ƒ-è®¢é˜…æ¨¡å‹==

##### æ¶ˆæ¯æœ‰åºæ€§

åº”ç”¨åœºæ™¯ï¼š

- å³æ—¶æ¶ˆæ¯ä¸­çš„å•å¯¹å•èŠå¤©å’Œç¾¤èŠï¼Œä¿è¯å‘é€æ–¹æ¶ˆæ¯å‘é€é¡ºåºä¸æ¥æ”¶æ–¹çš„é¡ºåºä¸€è‡´
- å……å€¼è½¬è´¦ä¸¤ä¸ªæ¸ é“åœ¨åŒä¸€ä¸ªæ—¶é—´è¿›è¡Œä½™é¢å˜æ›´ï¼ŒçŸ­ä¿¡é€šçŸ¥å¿…é¡»è¦æœ‰é¡ºåº
- ...

![](images/image-20240301111434538.png)

kafkaé›†ç¾¤æ‰˜ç®¡4ä¸ªåˆ†åŒºï¼ˆP0-P3ï¼‰ï¼Œ2ä¸ªæ¶ˆè´¹è€…ç»„ï¼Œæ¶ˆè´¹ç»„Aæœ‰2ä¸ªæ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹ç»„Bæœ‰4ä¸ªã€‚



topicåˆ†åŒºä¸­æ¶ˆæ¯åªèƒ½ç”±æ¶ˆè´¹è€…ç»„ä¸­çš„å”¯ä¸€ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†ï¼Œæ‰€ä»¥æ¶ˆæ¯è‚¯å®šæ˜¯æŒ‰ç…§å…ˆåé¡ºåºè¿›è¡Œå¤„ç†çš„ã€‚ä½†æ˜¯å®ƒä¹Ÿä»…ä»…æ˜¯ä¿è¯Topicçš„ä¸€ä¸ªåˆ†åŒºé¡ºåºå¤„ç†ï¼Œä¸èƒ½ä¿è¯è·¨åˆ†åŒºçš„æ¶ˆæ¯å…ˆåå¤„ç†é¡ºåºã€‚ æ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³è¦é¡ºåºçš„å¤„ç†Topicçš„æ‰€æœ‰æ¶ˆæ¯ï¼Œé‚£å°±åªæä¾›ä¸€ä¸ªåˆ†åŒºã€‚

##### æäº¤å’Œåç§»é‡

kafkaä¸ä¼šåƒå…¶ä»–JMSé˜Ÿåˆ—é‚£æ ·éœ€è¦å¾—åˆ°æ¶ˆè´¹è€…çš„ç¡®è®¤ï¼Œæ¶ˆè´¹è€…å¯ä»¥ä½¿ç”¨kafkaæ¥è¿½è¸ªæ¶ˆæ¯åœ¨åˆ†åŒºçš„ä½ç½®ï¼ˆåç§»é‡ï¼‰

æ¶ˆè´¹è€…ä¼šå¾€ä¸€ä¸ªå«åš`_consumer_offset`çš„ç‰¹æ®Šä¸»é¢˜å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯é‡ŒåŒ…å«äº†æ¯ä¸ªåˆ†åŒºçš„åç§»é‡ã€‚å¦‚æœæ¶ˆè´¹è€…å‘ç”Ÿå´©æºƒæˆ–æœ‰æ–°çš„æ¶ˆè´¹è€…åŠ å…¥ç¾¤ç»„ï¼Œå°±ä¼šè§¦å‘**å†å‡è¡¡**ã€‚

![](images/image-20240301111755975.png)

![](images/image-20240301111730050.png)

##### åç§»é‡

![](images/image-20240301112000503.png)

å¦‚æœæäº¤åç§»é‡å°äºå®¢æˆ·ç«¯å¤„ç†çš„æœ€åä¸€ä¸ªæ¶ˆæ¯çš„åç§»é‡ï¼Œé‚£ä¹ˆå¤„äºä¸¤ä¸ªåç§»é‡ä¹‹é—´çš„æ¶ˆæ¯å°±ä¼šè¢«é‡å¤å¤„ç†ã€‚

![](images/image-20240301112122524.png)

å¦‚æœæäº¤çš„åç§»é‡å¤§äºå®¢æˆ·ç«¯çš„æœ€åä¸€ä¸ªæ¶ˆæ¯çš„åç§»é‡ï¼Œé‚£ä¹ˆå¤„äºä¸¤ä¸ªåç§»é‡ä¹‹é—´çš„æ¶ˆæ¯å°†ä¼šä¸¢å¤±ã€‚

##### åç§»é‡æäº¤æ–¹å¼ğŸ”–

æäº¤åç§»é‡çš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯

- è‡ªåŠ¨æäº¤åç§»é‡ã€é»˜è®¤ã€‘

å½“enable.auto.commitè¢«è®¾ç½®ä¸ºtrueï¼Œæäº¤æ–¹å¼å°±æ˜¯è®©æ¶ˆè´¹è€…è‡ªåŠ¨æäº¤åç§»é‡ï¼Œæ¯éš”5ç§’æ¶ˆè´¹è€…ä¼šè‡ªåŠ¨æŠŠä»poll()æ–¹æ³•æ¥æ”¶çš„æœ€å¤§åç§»é‡æäº¤ä¸Šå»ã€‚

- æ‰‹åŠ¨æäº¤

  å½“enable.auto.commitè¢«è®¾ç½®ä¸ºfalseå¯ä»¥æœ‰ä»¥ä¸‹ä¸‰ç§æäº¤æ–¹å¼

  + æäº¤å½“å‰åç§»é‡ï¼ˆåŒæ­¥æäº¤ï¼‰

    ```java
    while (true) {  
      ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
      for (ConsumerRecord<String, String> record : records) {
        System.out.println(record.value());
        System.out.println(record.key());
        try {
          consumer.commitSync();//åŒæ­¥æäº¤å½“å‰æœ€æ–°çš„åç§»é‡
        } catch (CommitFailedException e){
          System.out.println("è®°å½•æäº¤å¤±è´¥çš„å¼‚å¸¸ï¼š"+e);
        }
      }
    }
    ```

    

  + å¼‚æ­¥æäº¤

    ```java
    while (true) {  
      ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
      for (ConsumerRecord<String, String> record : records) {
        System.out.println(record.value());
        System.out.println(record.key());
      }
      consumer.commitAsync(new OffsetCommitCallback() {
        @Override
        public void onComplete(Map<TopicPartition, OffsetAndMetadata> map, Exception e) {
          if(e!=null){
            System.out.println("è®°å½•é”™è¯¯çš„æäº¤åç§»é‡ï¼š"+ map+",å¼‚å¸¸ä¿¡æ¯"+e);
          }
        }
      });
    }
    ```

    

  + åŒæ­¥å’Œå¼‚æ­¥ç»„åˆæäº¤

    ```java
    try {
      while (true){
        ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
        for (ConsumerRecord<String, String> record : records) {
          System.out.println(record.value());
          System.out.println(record.key());
        }
        consumer.commitAsync();
      }
    } catch (Exception e){
      e.printStackTrace();
      System.out.println("è®°å½•é”™è¯¯ä¿¡æ¯ï¼š"+e);
    } finally {
      try { 
        consumer.commitSync();
      } finally {
        consumer.close();
      }
    }
    ```

    

â€‹		



### 6.3 springbooté›†æˆkafka

#### spring booté›†æˆkafkaæ”¶å‘æ¶ˆæ¯

1. å¯¼å…¥spring-kafkaä¾èµ–ä¿¡æ¯

```xml
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.apache.kafka</groupId>
            <artifactId>kafka-clients</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.kafka</groupId>
            <artifactId>spring-kafka</artifactId>
            <exclusions>
                <exclusion>
                    <groupId>org.apache.kafka</groupId>
                    <artifactId>kafka-clients</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-web</artifactId>
        </dependency>
    </dependencies>
```

2. åœ¨resourcesä¸‹åˆ›å»ºæ–‡ä»¶application.yml

```yaml
server:
  port: 9991
spring:
  application:
    name: kafka-demo
  kafka:
    bootstrap-servers: localhost:9092
    producer:
      retries: 10
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
    consumer:
      group-id: ${spring.application.name}-test
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
```

3. æ¶ˆæ¯ç”Ÿäº§è€…

```java
@RestController
public class HelloController {
    @Autowired
    private KafkaTemplate<String,String> kafkaTemplate;

    @GetMapping("/hello")
    public String hello() {
        // ç¬¬ä¸€ä¸ªå‚æ•°ï¼štopics
        // ç¬¬äºŒä¸ªå‚æ•°ï¼šæ¶ˆæ¯å†…å®¹
        kafkaTemplate.send("andy-kafka-hello","æˆä¸ºä¼˜ç§€çš„ç¨‹åºå‘˜");
        return "ok";
    }
}
```

4. æ¶ˆæ¯æ¶ˆè´¹è€…

```java
@Component
public class HelloListener {
    @KafkaListener(topics = {"andy-kafka-hello"})
    public void onMessage(String message){
        if(!StringUtils.isEmpty(message)){
            System.out.println(message);
        }
    }
}
```

5. ç¼–å†™å¯åŠ¨ç±»

```java
```

6. æµ‹è¯•ï¼šå¯åŠ¨ï¼Œè®¿é—® http://localhost:9991/hello

#### ä¼ é€’æ¶ˆæ¯ä¸ºå¯¹è±¡

ç›®å‰springbootæ•´åˆåçš„kafkaï¼Œå› ä¸ºåºåˆ—åŒ–å™¨æ˜¯`StringSerializer`ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœéœ€è¦ä¼ é€’å¯¹è±¡å¯ä»¥æœ‰ä¸¤ç§æ–¹å¼

- æ–¹å¼ä¸€ï¼šå¯ä»¥è‡ªå®šä¹‰åºåˆ—åŒ–å™¨ï¼Œå¯¹è±¡ç±»å‹ä¼—å¤šï¼Œè¿™ç§æ–¹å¼é€šç”¨æ€§ä¸å¼ºï¼Œæœ¬ç« èŠ‚ä¸ä»‹ç»
- æ–¹å¼äºŒï¼šå¯ä»¥æŠŠè¦ä¼ é€’çš„å¯¹è±¡è¿›è¡Œè½¬jsonå­—ç¬¦ä¸²ï¼Œæ¥æ”¶æ¶ˆæ¯åå†è½¬ä¸ºå¯¹è±¡å³å¯ï¼Œæœ¬é¡¹ç›®é‡‡ç”¨è¿™ç§æ–¹å¼

```java
    @GetMapping("/hello2")
    public String hello2() {
        User user = new User();
        user.setName("zhangsan");
        user.setAge(18);
        kafkaTemplate.send("andy-kafka-hello2", JSON.toJSONString(user));
        return "ok";
    }
```

```java
    @KafkaListener(topics = {"andy-kafka-hello2"})
    public void onMessage2(String message){
        if(!StringUtils.isEmpty(message)){
            User user = JSONObject.parseObject((String) message, User.class);
            System.out.println(user);
        }
    }
```





### 6.4 è‡ªåª’ä½“æ–‡ç« ä¸Šä¸‹æ¶åŠŸèƒ½å®Œæˆ

#### éœ€æ±‚åˆ†æ

![](images/image-20240301141722652.png)

**å·²å‘è¡¨ä¸”å·²ä¸Šæ¶**çš„æ–‡ç« å¯ä»¥ä¸‹æ¶

![](images/image-20240301142130702.png)

**å·²å‘è¡¨ä¸”å·²ä¸‹æ¶**çš„æ–‡ç« å¯ä»¥ä¸Šæ¶



#### æµç¨‹è¯´æ˜

![](images/image-20240229142728250.png)

`wm_news`

`ap_article_config`



#### æ¥å£å®šä¹‰

![](images/image-20240229142832662.png)

#### æ¶ˆæ¯ä¼ é€’articleç«¯æ–‡ç« ä¸Šä¸‹æ¶

ğŸ”–p111

```java
    @ApiOperation(value = "æ–‡ç« ä¸Šä¸‹æ¶")
    @PostMapping("/downOrUp")
    public ResponseResult DownOrUp(@RequestBody WmNewsDto dto) {
        return wmNewsService.DownOrUp(dto);
    }
```





1. å¯¼å…¥kafkaä¾èµ–ã€leadnews-commonæ¨¡å—ã€‘

```xml
<dependency>
  <groupId>org.springframework.kafka</groupId>
  <artifactId>spring-kafka</artifactId>
</dependency>
<dependency>
  <groupId>org.apache.kafka</groupId>
  <artifactId>kafka-clients</artifactId>
</dependency>
```



2. åœ¨è‡ªåª’ä½“ç«¯çš„nacosé…ç½®ä¸­å¿ƒã€leadnews-wemediaã€‘ï¼Œæ·»åŠ kafkaçš„ç”Ÿäº§è€…é…ç½®

```yaml
spring:
  kafka:
    bootstrap-servers: localhost:9092
    producer:
      retries: 10
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
```



3. åœ¨è‡ªåª’ä½“ç«¯æ–‡ç« ä¸Šä¸‹æ¶åï¼Œå‘é€æ¶ˆæ¯

`WmNewsServiceImpl::DownOrUp`

```java
            if(wmNews.getArticleId() != null){
                //å‘é€æ¶ˆæ¯ï¼Œé€šçŸ¥articleä¿®æ”¹æ–‡ç« çš„é…ç½®
                Map<String,Object> map = new HashMap<>();
                map.put("articleId",wmNews.getArticleId());
                map.put("enable",dto.getEnable());
                kafkaTemplate.send(WmNewsMessageConstants.WM_NEWS_UP_OR_DOWN_TOPIC, JSON.toJSONString(map));
            }
```

4. åœ¨articleç«¯çš„nacosé…ç½®ä¸­å¿ƒã€leadnews-articleã€‘ï¼Œæ·»åŠ kafkaçš„æ¶ˆè´¹è€…é…ç½®

```yaml
spring:
  kafka:
    bootstrap-servers: localhost:9092
    consumer:
      group-id: ${spring.application.name}
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
```



5. åœ¨articleç«¯ç¼–å†™ç›‘å¬ã€leadnews-articleã€‘ï¼Œæ¥æ”¶æ•°æ®

```java
@Component
@Slf4j
public class ArticleIsDownListener {

    @Autowired
    private ApArticleConfigService apArticleConfigService;

    @KafkaListener(topics = WmNewsMessageConstants.WM_NEWS_UP_OR_DOWN_TOPIC)
    public void onMessage(String message){
        if(StringUtils.isNotBlank(message)){
            Map map = JSON.parseObject(message, Map.class);
            apArticleConfigService.updateByMap(map);
        }
    }
}
```



6. ä¿®æ”¹ap_article_configè¡¨çš„æ•°æ®

```java
@Service
@Slf4j
@Transactional
public class ApArticleConfigServiceImpl extends ServiceImpl<ApArticleConfigMapper, ApArticleConfig> implements ApArticleConfigService {
    /**
     * ä¿®æ”¹æ–‡ç« 
     * @param map
     */
    @Override
    public void updateByMap(Map map) {
        // 0 ä¸‹æ¶  1 ä¸Šæ¶
        Object enable = map.get("enable");
        boolean isDown = true;
        if(enable.equals(1)){
           isDown = false;
        }
        //ä¿®æ”¹æ–‡ç« 
        update(Wrappers.<ApArticleConfig>lambdaUpdate().eq(ApArticleConfig::getArticleId,map.get("articleId"))
                .set(ApArticleConfig::getIsDown,isDown));
    }
}
```

7. æµ‹è¯• ğŸ”–





## 7 appç«¯æ–‡ç« æœç´¢

ä»Šæ—¥å†…å®¹é¢„è§ˆ

- æ–‡ç« æœç´¢

  - ElasticSearchç¯å¢ƒæ­å»º
  - ç´¢å¼•åº“åˆ›å»º
  - æ–‡ç« æœç´¢å¤šæ¡ä»¶å¤åˆæŸ¥è¯¢
  - ç´¢å¼•æ•°æ®åŒæ­¥
- æœç´¢å†å²è®°å½•

  - Mongodbç¯å¢ƒæ­å»º
  - å¼‚æ­¥ä¿å­˜æœç´¢å†å²
  - æŸ¥çœ‹æœç´¢å†å²åˆ—è¡¨
  - åˆ é™¤æœç´¢å†å²
- è”æƒ³è¯æŸ¥è¯¢

  - è”æƒ³è¯çš„æ¥æº
  - è”æƒ³è¯åŠŸèƒ½å®ç°

![](images/image-20240229144615889.png)

### 7.1 æ­å»ºElasticSearchç¯å¢ƒ

- æ‹‰å–ElasticSearché•œåƒ

```
docker pull elasticsearch:7.4.0
```

- åˆ›å»ºElasticSearchå®¹å™¨

```
docker run -id --name elasticsearch -p 9200:9200 -p 9300:9300 -v /usr/share/elasticsearch/plugins:/usr/share/elasticsearch/plugins -e "discovery.type=single-node" elasticsearch:7.4.0
```

- é…ç½®ä¸­æ–‡åˆ†è¯å™¨ ik  https://github.com/infinilabs/analysis-ik

  åœ¨/usr/share/elasticsearch/pluginsç›®å½•ä¸­æ–°å»ºanalysis-ikç›®å½•ï¼Œç„¶å`elasticsearch-analysis-ik-7.4.0.zip`ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Šå¹¶è§£å‹åˆ°analysis-ikç›®å½•

- åˆ†è¯æµ‹è¯•ã€‚é‡å¯elasticsearchå®¹å™¨

![](images/image-20240304100621828.png)

> ```
> # docker pull elasticsearch:7.4.0
> 7.4.0: Pulling from library/elasticsearch
> 7.4.0: Pulling from library/elasticsearch
> no matching manifest for linux/arm64/v8 in the manifest list entries
> ```
>
> åŸå› å¯èƒ½æ˜¯esä½ç‰ˆæœ¬æ²¡æœ‰arm64dockeré•œåƒã€‚

> å¦ä¸€ç§é€‰æ‹©æ˜¯  elasticsearch:7.14.2
>
> ```shell
> docker run -id --name elasticsearch -p 9200:9200 -p 9300:9300 -v /usr/share/elasticsearch/plugins:/usr/share/elasticsearch/plugins -e "discovery.type=single-node" elasticsearch:7.14.2
> ```
>
> post `localhost:9200/_analyze`  json



> å¦ä¸€ç§é€‰æ‹©ï¼Œåœ¨macosæœ¬åœ°å¯åŠ¨è¿è¡Œelasticsearchï¼Œæµ‹è¯•
> 
> post `10.211.55.5:9200/_analyze`  json
> 
> ```json
> {
> "analyzer": "ik_max_word",
>  "text": "æ¬¢è¿æ¥åˆ°é»‘é©¬ç¨‹åºå‘˜å­¦ä¹ "
>}
> ```
>
> ç»“æœï¼š
>
> ```json
> {
>     "tokens": [
>         {
>          "token": "æ¬¢è¿",
>          "start_offset": 0,
>         "end_offset": 2,
>          "type": "CN_WORD",
>         "position": 0
>      },
>      {
>             "token": "è¿æ¥",
>             "start_offset": 1,
>             "end_offset": 3,
>             "type": "CN_WORD",
>             "position": 1
>         },
>         {
>             "token": "æ¥åˆ°",
>             "start_offset": 2,
>             "end_offset": 4,
>             "type": "CN_WORD",
>             "position": 2
>         },
>         {
>             "token": "é»‘é©¬",
>             "start_offset": 4,
>             "end_offset": 6,
>             "type": "CN_WORD",
>             "position": 3
>         },
>         {
>             "token": "ç¨‹åºå‘˜",
>             "start_offset": 6,
>             "end_offset": 9,
>             "type": "CN_WORD",
>             "position": 4
>         },
>         {
>             "token": "ç¨‹åº",
>             "start_offset": 6,
>             "end_offset": 8,
>             "type": "CN_WORD",
>             "position": 5
>         },
>         {
>             "token": "å‘˜",
>             "start_offset": 8,
>             "end_offset": 9,
>             "type": "CN_CHAR",
>             "position": 6
>         },
>         {
>             "token": "å­¦ä¹ ",
>             "start_offset": 9,
>             "end_offset": 11,
>             "type": "CN_WORD",
>             "position": 7
>         }
>     ]
>    }
>    ```
>    
>    



### 7.2 appç«¯æ–‡ç« æœç´¢

#### éœ€æ±‚è¯´æ˜

- ç”¨æˆ·è¾“å…¥å…³é”®å¯æœç´¢æ–‡ç« åˆ—è¡¨
- å…³é”®è¯é«˜äº®æ˜¾ç¤º
- æ–‡ç« åˆ—è¡¨å±•ç¤ºä¸homeå±•ç¤ºä¸€æ ·ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æŸä¸€ç¯‡æ–‡ç« ï¼Œå¯æŸ¥çœ‹æ–‡ç« è¯¦æƒ…

#### æ€è·¯åˆ†æ

ä¸ºäº†åŠ å¿«æ£€ç´¢çš„æ•ˆç‡ï¼Œåœ¨æŸ¥è¯¢çš„æ—¶å€™ä¸ä¼šç›´æ¥ä»æ•°æ®åº“ä¸­æŸ¥è¯¢æ–‡ç« ï¼Œéœ€è¦åœ¨elasticsearchä¸­è¿›è¡Œé«˜é€Ÿæ£€ç´¢ã€‚

![](images/image-20240229150810447.png)

#### åˆ›å»ºç´¢å¼•å’Œæ˜ å°„

![](images/image-20240304111750822.png)

æœç´¢ç»“æœé¡µé¢å±•ç¤ºä»€ä¹ˆå†…å®¹?

- æ ‡é¢˜
- å¸ƒå±€
- å°é¢å›¾ç‰‡
- å‘å¸ƒæ—¶é—´
- ä½œè€…åç§°
- æ–‡ç« id
- ä½œè€…id
- é™æ€url

å“ªäº›éœ€è¦ç´¢å¼•å’Œåˆ†è¯ï¼Ÿ

- æ ‡é¢˜
- å†…å®¹

#### ä½¿ç”¨postman/apifoxæ·»åŠ æ˜ å°„å’ŒæŸ¥è¯¢

- put `localhost:9200/app_info_article`  

è¯·æ±‚bodyï¼Œjsonï¼šã€å¯¹åº”ä¸Šé¢æœç´¢ç»“æœé¡µé¢å±•ç¤ºçš„å†…å®¹ã€‘

```json
{
    "mappings":{
        "properties":{
            "id":{
                "type":"long"
            },
            "publishTime":{
                "type":"date"
            },
            "layout":{
                "type":"integer"
            },
            "images":{
                "type":"keyword",
                "index": false
            },
            "staticUrl":{
                "type":"keyword",
                "index": false
            },
            "authorId": {
                "type": "long"
            },
            "authorName": {
                "type": "text"
            },
            "title":{
                "type":"text",
                "analyzer":"ik_smart"
            },
            "content":{
                "type":"text",
                "analyzer":"ik_smart"
            }
        }
    }
}
```

ç»“æœï¼š

```json
{
    "acknowledged": true,
    "shards_acknowledged": true,
    "index": "app_info_article"
}
```



- GETè¯·æ±‚æŸ¥è¯¢æ˜ å°„ï¼šhttp://localhost:9200/app_info_article

- DELETEè¯·æ±‚ï¼Œåˆ é™¤ç´¢å¼•åŠæ˜ å°„ï¼šhttp://localhost:9200/app_info_article

- GETè¯·æ±‚ï¼ŒæŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£ï¼šhttp://localhost:9200/app_info_article/_search

```json
{
    "took": 115,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 0,
            "relation": "eq"
        },
        "max_score": null,
        "hits": []
    }
}
```

#### æ•°æ®åˆå§‹åŒ–åˆ°ç´¢å¼•åº“

é¡¹ç›®ä¸Šçº¿æ—¶ä¼šè¿›è¡Œä¸€æ¬¡æ‰¹é‡å¯¼å…¥æ•°æ®åˆ°ç´¢å¼•åº“

1. åœ¨æµ‹è¯•æ¨¡å—ä¸‹æ–°å»ºes-initæ¨¡å—



2. æŸ¥è¯¢æ‰€æœ‰çš„æ–‡ç« ä¿¡æ¯ï¼Œæ‰¹é‡å¯¼å…¥åˆ°esç´¢å¼•åº“ä¸­

```java
    @Autowired
    private ApArticleMapper apArticleMapper;
    @Autowired
    private RestHighLevelClient restHighLevelClient;
    /**
     * æ³¨æ„ï¼šæ•°æ®é‡çš„å¯¼å…¥ï¼Œå¦‚æœæ•°æ®é‡è¿‡å¤§ï¼Œéœ€è¦åˆ†é¡µå¯¼å…¥
     * @throws Exception
     */
    @Test
    public void init() throws Exception {
        // 1 æŸ¥è¯¢æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ç« 
        List<SearchArticleVo> searchArticleVos = apArticleMapper.loadArticleList();

        // 2 æ‰¹é‡å¯¼å…¥ç´¢å¼•åº“
        BulkRequest bulkRequest = new BulkRequest("app_info_article");
        for (SearchArticleVo searchArticleVo : searchArticleVos) {
            IndexRequest indexRequest = new IndexRequest().id(searchArticleVo.getId().toString())
                    .source(JSON.toJSONString(searchArticleVo), XContentType.JSON);
            bulkRequest.add(indexRequest);
        }

        BulkResponse response = restHighLevelClient.bulk(bulkRequest, RequestOptions.DEFAULT);
        System.out.println("æ’å…¥ç»“æœï¼š " + response.status());

    }
```

http://10.211.55.5:9200/app_info_article/_search  æŸ¥çœ‹å·²ç»å¯¼å…¥çš„ç´¢å¼•åº“

#### æœç´¢æ¥å£å®šä¹‰

![](images/image-20240229151152770.png)

UserSearchDto 

```java
@Data
public class UserSearchDto {

    /**
    * æœç´¢å…³é”®å­—
    */
    String searchWords;
    /**
    * å½“å‰é¡µ
    */
    int pageNum;
    /**
    * åˆ†é¡µæ¡æ•°
    */
    int pageSize;
    /**
    * æœ€å°æ—¶é—´
    */
    Date minBehotTime;

    public int getFromIndex(){
        if(this.pageNum<1)return 0;
        if(this.pageSize<1) this.pageSize = 10;
        return this.pageSize * (pageNum-1);
    }
}
```



æœ€å°æ—¶é—´æ¥åˆ¤æ–­åˆ†é¡µ

#### å®ç°

1. åœ¨leadnews-serviceæ¨¡å—ä¸‹åˆ›å»ºæ–°çš„å¾®æœåŠ¡æ¨¡å—leadnews-search

> IDEAä¸­æ‹·è´æ¨¡å—çš„æ­¥éª¤ï¼š
>
> 1. æŠŠæƒ³è¦æ‹·è´çš„ç›®å½•æ‹·è´ç›¸åº”çš„ç›®å½•ä¸‹
> 2. åœ¨å¯¹åº”çš„çˆ¶æ¨¡å—çš„pomç™»è®°
> 3. åœ¨Mavenå‡ºåˆ·æ–°

2. åœ¨nacosçš„æ–°å»ºé…ç½® leadnews-search

```yaml
spring:
  autoconfigure:
    exclude: org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration
elasticsearch:
  host: 10.211.55.5
  port: 9200
```



3. æœç´¢æ¥å£å®šä¹‰

```java
@RestController
@RequestMapping("/api/v1/article/search")
public class ArticleSearchController{
    @PostMapping("/search")
    public ResponseResult search(@RequestBody UserSearchDto userSearchDto) {
        return null;
    }
}
```



4. ä¸šåŠ¡å±‚

ArticleSearchServiceImpl





6. æµ‹è¯•

éœ€è¦åœ¨appçš„ç½‘å…³ä¸­æ·»åŠ æœç´¢å¾®æœåŠ¡çš„è·¯ç”±é…ç½®ã€åœ¨nacosé…ç½®leadnews-app-gatewayä¸­æ·»åŠ ã€‘ï¼š

```yaml
#æœç´¢å¾®æœåŠ¡
- id: leadnews-search
 uri: lb://leadnews-search
 predicates:
   - Path=/search/**
 filters:
   - StripPrefix= 1
```

å¯åŠ¨é¡¹ç›®è¿›è¡Œæµ‹è¯•ï¼Œè‡³å°‘è¦å¯åŠ¨æ–‡ç« å¾®æœåŠ¡ï¼Œç”¨æˆ·å¾®æœåŠ¡ï¼Œæœç´¢å¾®æœåŠ¡ï¼Œappç½‘å…³å¾®æœåŠ¡ï¼Œappå‰ç«¯å·¥ç¨‹

![](images/image-20240314161953117.png)

### 7.3 æ–°å¢æ–‡ç« åˆ›å»ºç´¢å¼•

å‰é¢çš„ï¼Œé¡¹ç›®ä¸Šçº¿æ—¶ï¼Œä¼šåˆå§‹åŒ–ä¸€æ¬¡ç´¢å¼•åº“ï¼Œä¹‹åæ¯ä¸€æ¬¡æ–°å¢æ–‡ç« æ—¶ä¹Ÿéœ€è¦åˆ›å»ºç´¢å¼•ã€‚

#### æ€è·¯åˆ†æ

![](images/image-20240229151519511.png)

#### å®ç°æ­¥éª¤

1. æ–‡ç« å®¡æ ¸æˆåŠŸä½¿ç”¨kafkaå‘é€æ¶ˆæ¯

åœ¨æ–‡ç« å¾®æœåŠ¡`ArticleFreemarkerServiceImpl#buildArticleToMinIO` ä¸­æ·»åŠ 

```java
// å‘é€æ¶ˆæ¯ï¼Œåˆ›å»ºesç´¢å¼•
createArticleEsIndex(apArticle, content, path);
```

```java
    @Autowired
    private KafkaTemplate<String,String> kafkaTemplate;
    /**
     * å‘é€æ¶ˆæ¯ï¼Œåˆ›å»ºesç´¢å¼•
     * @param apArticle
     * @param content
     * @param path
     */
    private void createArticleEsIndex(ApArticle apArticle, String content, String path) {
        SearchArticleVo vo = new SearchArticleVo();
        BeanUtils.copyProperties(apArticle,vo);
        vo.setContent(content);
        vo.setStaticUrl(path);

        kafkaTemplate.send(ArticleConstants.ARTICLE_ES_SYNC_TOPIC, JSON.toJSONString(vo));
    }
```



2. æ–‡ç« å¾®æœåŠ¡é›†æˆkafkaå‘é€æ¶ˆæ¯

åœ¨æ–‡ç« å¾®æœåŠ¡çš„nacosçš„é…ç½®ä¸­å¿ƒæ·»åŠ kafkaæ¶ˆæ¯ç”Ÿäº§è€…çš„é…ç½®ï¼š

```yaml
kafka:
    bootstrap-servers: localhost:9092
    producer:
      retries: 10
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
```



3. åœ¨æœç´¢å¾®æœåŠ¡ä¸­åˆ›å»ºç›‘å¬ï¼Œç”¨äºæ¥æ”¶æ¶ˆæ¯ï¼Œæ·»åŠ æ•°æ®åˆ°ç´¢å¼•åº“

```java
@Component
@Slf4j
public class SyncArticleListener {
    @Autowired
    private RestHighLevelClient restHighLevelClient;

    @KafkaListener(topics = ArticleConstants.ARTICLE_ES_SYNC_TOPIC)
    public void onMessage(String message) {
        if(StringUtils.isNotBlank(message)){

            log.info("SyncArticleListener,message={}", message);

            SearchArticleVo searchArticleVo = JSON.parseObject(message, SearchArticleVo.class);
            IndexRequest indexRequest = new IndexRequest("app_info_article");
            indexRequest.id(searchArticleVo.getId().toString());
            indexRequest.source(message, XContentType.JSON);
            try {
                restHighLevelClient.index(indexRequest, RequestOptions.DEFAULT);
            } catch (IOException e) {
                e.printStackTrace();
                log.error("sync es error={}",e);
            }
        }
    }
}
```



4. åœ¨nacosä¸­çš„æœç´¢å¾®æœåŠ¡ä¸­æ·»åŠ ï¼Œkafkaæ¶ˆè´¹è€…é…ç½®

```yaml
spring:
  kafka:
    bootstrap-servers: localhost:9092
    consumer:
      group-id: ${spring.application.name}
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
```



5. æµ‹è¯•

ğŸ”–



### 7.4 appç«¯æœç´¢-æœç´¢è®°å½•

#### éœ€æ±‚è¯´æ˜

- å±•ç¤ºç”¨æˆ·çš„æœç´¢è®°å½•10æ¡ï¼ŒæŒ‰ç…§æœç´¢å…³é”®è¯çš„æ—¶é—´å€’åº
- å¯ä»¥åˆ é™¤æœç´¢è®°å½•
- ä¿å­˜å†å²è®°å½•ï¼Œä¿å­˜10æ¡ï¼Œå¤šä½™çš„åˆ™åˆ é™¤æœ€ä¹…çš„å†å²è®°å½•

![](images/image-20240229151659579.png)

#### æ•°æ®å­˜å‚¨è¯´æ˜

ç”¨æˆ·çš„æœç´¢è®°å½•ï¼Œéœ€è¦ç»™**æ¯ä¸€ä¸ªç”¨æˆ·éƒ½ä¿å­˜ä¸€ä»½**ï¼Œæ•°æ®é‡è¾ƒå¤§ï¼Œè¦æ±‚åŠ è½½é€Ÿåº¦å¿«ï¼Œé€šå¸¸è¿™æ ·çš„æ•°æ®å­˜å‚¨åˆ°mongodbæ›´åˆé€‚ï¼Œä¸å»ºè®®ç›´æ¥å­˜å‚¨åˆ°å…³ç³»å‹æ•°æ®åº“ä¸­ã€‚

![](images/image-20240314182714920.png)



#### MongoDBå®‰è£…åŠé›†æˆ

- æ‹‰å–é•œåƒ

```
docker pull mongo
```

- åˆ›å»ºå®¹å™¨

```
docker run -di --name mongo-service --restart=always -p 27017:27017 -v ~/data/mongodata:/data mongo
```

- ä½¿ç”¨navicaté“¾æ¥MongoDBæµ‹è¯•



- åœ¨leadnews-testæ¨¡å—ä¸­æ–°å»ºmongo-demoæ¨¡å—ç”¨äºmongoå­¦ä¹ 

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-data-mongodb</artifactId>
</dependency>
```

```yaml
server:
  port: 9998
spring:
  data:
    mongodb:
      host: 10.211.55.5
      port: 27017
      database: leadnews-history
```





æ ¸å¿ƒæ–¹æ³•ï¼š

```java
		@Autowired
    private MongoTemplate mongoTemplate;

    //ä¿å­˜
    @Test
    public void saveTest(){
        for (int i = 0; i < 10; i++) {
            ApAssociateWords apAssociateWords = new ApAssociateWords();
            apAssociateWords.setAssociateWords("ARå¤´æ¡" + i);
            apAssociateWords.setCreatedTime(new Date());
            mongoTemplate.save(apAssociateWords);
        }

    }

    //æŸ¥è¯¢ä¸€ä¸ª
    @Test
    public void saveFindOne(){
        ApAssociateWords apAssociateWords = mongoTemplate.findById("65f2eb852fd072556df0c1a6", ApAssociateWords.class);
        System.out.println(apAssociateWords);
    }

    //æ¡ä»¶æŸ¥è¯¢
    @Test
    public void testQuery(){
        Query query = Query.query(Criteria.where("associateWords").is("ARå¤´æ¡"))
                .with(Sort.by(Sort.Direction.DESC,"createdTime"));
        List<ApAssociateWords> apAssociateWordsList = mongoTemplate.find(query, ApAssociateWords.class);
        System.out.println(apAssociateWordsList);
    }

    @Test
    public void testDel(){
        mongoTemplate.remove(Query.query(Criteria.where("associateWords").is("é»‘é©¬å¤´æ¡")),ApAssociateWords.class);
    }
```





#### ä¿å­˜æœç´¢è®°å½•-å®ç°æ€è·¯

![](images/image-20240229152130494.png)

ç”¨æˆ·è¾“å…¥å…³é”®å­—è¿›è¡Œæœç´¢çš„å¼‚æ­¥è®°å½•å…³é”®å­—



ç”¨æˆ·æœç´¢è®°å½•å¯¹åº”çš„é›†åˆï¼Œå¯¹åº”å®ä½“ç±»ï¼š`ApUserSearch` 

![](images/image-20240229152304375.png)

#### ä¿å­˜æœç´¢è®°å½•-å®ç°æ­¥éª¤

1. åœ¨æœç´¢å¾®æœåŠ¡é›†æˆmongodb

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-data-mongodb</artifactId>
</dependency>
```

åœ¨nacosä¸­çš„æœç´¢å¾®æœåŠ¡é…ç½®ä¸­æ·»åŠ ï¼š

```yaml
spring:
  data:
    mongodb:
      host: 10.211.55.5
      port: 27017
      database: leadnews-history
```

å¯¼å…¥MongoDBæ•°æ®sqlï¼Œleadnews-history.sqlï¼›

åœ¨æœç´¢å¾®æœåŠ¡ä¸‹åˆ›å»ºå¯¹åº”çš„ä¸¤ä¸ªå®ä½“ç±»ï¼š`ApUserSearch`ï¼ˆæœç´¢çš„å†å²è¡¨ï¼‰ã€`ApAssociateWords`ï¼ˆè”æƒ³è¯è¡¨ï¼‰



2. åˆ›å»º`ApUserSearchService`æ–°å¢insertæ–¹æ³•

```java
@Override
public void insert(String keyword, Integer userId) {
  // 1 æŸ¥è¯¢å½“å‰ç”¨æˆ·æœç´¢çš„å…³é”®è¯
  Query query = Query.query(Criteria.where("userId").is(userId).and("keyword").is(keyword));
  ApUserSearch apUserSearch = mongoTemplate.findOne(query, ApUserSearch.class);

  // 2 å­˜åœ¨åˆ™æ›´æ–°æœ€æ–°æ—¶é—´
  if (apUserSearch != null) {
    apUserSearch.setCreatedTime(new Date());
    mongoTemplate.save(apUserSearch);
    return;
  }

  // 3 ä¸å­˜åœ¨åˆ™æ–°å¢, åˆ¤æ–­å½“å‰å†å²è®°å½•æ˜¯å¦è¶…è¿‡10æ¡è®°å½•
  apUserSearch = new ApUserSearch();
  apUserSearch.setUserId(userId);
  apUserSearch.setKeyword(keyword);
  apUserSearch.setCreatedTime(new Date());

  Query q = Query.query(Criteria.where("userId").is(userId));
  q.with(Sort.by(Sort.Direction.DESC, "createdTime"));
  List<ApUserSearch> apUserSearchList = mongoTemplate.find(q, ApUserSearch.class);
  if (apUserSearchList == null || apUserSearchList.size() < 10) {
    mongoTemplate.save(apUserSearch);
  } else {
    ApUserSearch lastUserSearch = apUserSearchList.get(apUserSearchList.size() - 1);
    mongoTemplate.findAndReplace(Query.query(Criteria.where("id").is(lastUserSearch.getId())), apUserSearch);
  }

}
```



3. åœ¨appçš„ç½‘å…³çš„è¿‡æ»¤å™¨`AuthorizeFilter`ä¸­æ·»åŠ ï¼š

```java
            // è·å–ç”¨æˆ·
            Object userId = claimsBody.get("id");
            // å­˜å‚¨headerä¸­
            ServerHttpRequest serverHttpRequest = request.mutate().headers(httpHeaders -> {
                httpHeaders.add("userId", userId + "");
            }).build();
            // é‡ç½®è¯·æ±‚
            exchange.mutate().request(serverHttpRequest);
```



4. å‚è€ƒè‡ªåª’ä½“å¾®æœåŠ¡ï¼Œåœ¨æœç´¢å¾®æœåŠ¡ä¸­æ·»åŠ æ‹¦æˆªå™¨   è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·

```java
public class AppTokenInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        String userId = request.getHeader("userId");
        if (userId != null) {
            // å­˜å…¥åˆ°å½“å‰çº¿ç¨‹ä¸­
            ApUser apUser = new ApUser();
            apUser.setId(Integer.valueOf(userId));
            AppThreadLocalUtil.setUser(apUser);
        }
        return true;
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        AppThreadLocalUtil.clear();
    }
}
```

ğŸ”–p126 `AppThreadLocalUtil`



æƒ³è®©ä¸Šé¢çš„æ‹¦æˆªå™¨ç”Ÿæ•ˆï¼Œè¿˜éœ€è¦æ·»åŠ é…ç½®:

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // æ·»åŠ è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨ï¼Œæ‹¦æˆªæ‰€æœ‰è¯·æ±‚
        registry.addInterceptor(new AppTokenInterceptor()).addPathPatterns("/**");
    }
}
```



5. åœ¨`ArticleSearchService`çš„searchæ–¹æ³•ä¸­æ·»åŠ è°ƒç”¨ä¿å­˜å†å²è®°å½•

```java
        // å¼‚æ­¥è°ƒç”¨ï¼Œä¿å­˜æœç´¢è®°å½•
        ApUser user = AppThreadLocalUtil.getUser();
        if (user != null && dto.getFromIndex() == 0) {
            apUserSearchService.insert(dto.getSearchWords(), user.getId());
        }
```

æ³¨æ„è¦åœ¨insertæ–¹æ³•ä¸Šæ·»åŠ `@Async`ï¼Œå·²ç»searchå¯åŠ¨ç±»å¼€å¯å¼‚æ­¥è°ƒç”¨`@EnableAsync`



6. æµ‹è¯•ï¼Œå¼€å¯appç½‘å…³ã€ç”¨æˆ·å¾®æœåŠ¡ã€æ–‡ç« å¾®æœåŠ¡ã€æœç´¢å¾®æœåŠ¡ï¼Œæœç´¢åæŸ¥çœ‹mongodbæ‰¾é‚£ä¸ªçš„ç»“æœ



#### åŠ è½½æœç´¢å†å²

æŒ‰ç…§å½“å‰ç”¨æˆ·ï¼ŒæŒ‰ç…§æ—¶é—´å€’åºæŸ¥è¯¢ã€‚  `/api/v1/history/load`  POST

```java
List<ApUserSearch> userSearchList = mongoTemplate.find(Query.query(Criteria.where("userId").is(userId))               .with(Sort.by(Sort.Direction.DESC, "createdTime")), ApUserSearch.class);
```



#### åˆ é™¤æœç´¢å†å²

æŒ‰ç…§æœç´¢å†å²idåˆ é™¤ã€‚`/api/v1/history/del` POST `HistorySearchDto`

```java
// åˆ é™¤
Query query = Query.query(Criteria.where("userId").is(user.getId()).and("id").is(historySearchDto.getId()));
mongoTemplate.remove(query, ApUserSearch.class);

```



### 7.5 appç«¯æœç´¢-å…³é”®å­—è”æƒ³è¯

#### éœ€æ±‚åˆ†æ

æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å…³é”®å­—å±•ç¤ºè”æƒ³è¯

![](images/image-20240229152834382.png)

`ApAssociateWords`

```java
@Data
@Document("ap_associate_words")
public class ApAssociateWords implements Serializable {

    private static final long serialVersionUID = 1L;
    private String id;

    /**
     * è”æƒ³è¯
     */
    private String associateWords;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createdTime;
}
```

 

#### æœç´¢è¯-è”æƒ³è¯çš„æ•°æ®æ¥æº

é€šå¸¸æ˜¯ç½‘ä¸Šæœç´¢é¢‘ç‡æ¯”è¾ƒé«˜çš„ä¸€äº›è¯ï¼Œé€šå¸¸åœ¨ä¼ä¸šä¸­æœ‰ä¸¤éƒ¨åˆ†æ¥æºï¼š

- ç¬¬ä¸€ï¼šè‡ªå·±ç»´æŠ¤æœç´¢è¯
  é€šè¿‡åˆ†æç”¨æˆ·æœç´¢é¢‘ç‡è¾ƒé«˜çš„è¯ï¼ŒæŒ‰ç…§æ’åä½œä¸ºæœç´¢è¯

- ç¬¬äºŒï¼šç¬¬ä¸‰æ–¹è·å–
  å…³é”®è¯è§„åˆ’å¸ˆï¼ˆç™¾åº¦ï¼‰ã€[5118](https://www.5118.com/ciku/index)ã€çˆ±ç«™ç½‘



å¯ä»¥æ ¹æ®éœ€æ±‚å¯¼å…¥è”æƒ³è¯åˆ°mongoä¸­

#### æ¥å£å®šä¹‰

`/api/v1/associate/search`  POST  `UserSearchDto`

```java
//3 æ‰§è¡ŒæŸ¥è¯¢ æ¨¡ç³ŠæŸ¥è¯¢
Query query = Query.query(Criteria.where("associateWords").regex(".*?\\" + userSearchDto.getSearchWords() + ".*"));
query.limit(userSearchDto.getPageSize());
List<ApAssociateWords> wordsList = mongoTemplate.find(query, ApAssociateWords.class);
```

æ­£åˆ™è¡¨è¾¾å¼è¯´æ˜

|      | **è¯´æ˜**                                    |
| ---- | ------------------------------------------- |
| `.`  | è¡¨ç¤ºåŒ¹é…ä»»æ„å­—ç¬¦                            |
| `*`  | è¡¨ç¤ºåŒ¹é…0æ¬¡ä»¥ä¸Š                             |
| `*?` | åˆ™æ˜¯è¡¨ç¤ºéè´ªå©ªåŒ¹é…,ç¢°åˆ°ç¬¦åˆæ¡ä»¶çš„ç«‹é©¬å°±åŒ¹é… |

2

## 8 å¹³å°ç®¡ç†





## 9 ç”¨æˆ·è¡Œä¸º

### 1 ä»€ä¹ˆæ˜¯è¡Œä¸º

ç”¨æˆ·è¡Œä¸ºæ•°æ®çš„è®°å½•åŒ…æ‹¬äº†å…³æ³¨ã€ç‚¹èµã€ä¸å–œæ¬¢ã€æ”¶è—ã€é˜…è¯»ç­‰è¡Œä¸º

é»‘é©¬å¤´æ¡é¡¹ç›®æ•´ä¸ªé¡¹ç›®å¼€å‘æ¶‰åŠwebå±•ç¤ºå’Œå¤§æ•°æ®åˆ†ææ¥ç»™ç”¨æˆ·æ¨èæ–‡ç« ï¼Œå¦‚ä½•æ‰¾å‡ºå“ªäº›æ–‡ç« æ˜¯çƒ­ç‚¹æ–‡ç« è¿›è¡Œé’ˆå¯¹æ€§çš„æ¨èå‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™éœ€è¦è¿›è¡Œå¤§æ•°æ®åˆ†æçš„å‡†å¤‡å·¥ä½œï¼ŒåŸ‹ç‚¹ã€‚

æ‰€è°“â€œ==åŸ‹ç‚¹==â€ï¼Œæ˜¯æ•°æ®é‡‡é›†é¢†åŸŸï¼ˆå°¤å…¶æ˜¯ç”¨æˆ·è¡Œä¸ºæ•°æ®é‡‡é›†é¢†åŸŸï¼‰çš„æœ¯è¯­ï¼ŒæŒ‡çš„æ˜¯é’ˆå¯¹ç‰¹å®šç”¨æˆ·è¡Œä¸ºæˆ–äº‹ä»¶è¿›è¡Œæ•è·ã€å¤„ç†å’Œå‘é€çš„ç›¸å…³æŠ€æœ¯åŠå…¶å®æ–½è¿‡ç¨‹ã€‚æ¯”å¦‚ç”¨æˆ·æŸä¸ªiconç‚¹å‡»æ¬¡æ•°ã€é˜…è¯»æ–‡ç« çš„æ—¶é•¿ï¼Œè§‚çœ‹è§†é¢‘çš„æ—¶é•¿ç­‰ç­‰ã€‚

### 2 å…³æ³¨

![image-20210727162600274](../../../../../Volumes/FX-SSD-PS2000/myfield/å¼€å‘èµ„æ–™/02é¡¹ç›®èµ„æ–™/é»‘é©¬å¤´æ¡/day09-ç”¨æˆ·/éœ€æ±‚è¯´æ˜/ç”¨æˆ·è¡Œä¸º-éœ€æ±‚.assets\image-20210727162600274.png)

å¦‚ä¸Šæ•ˆæœï¼š

å½“å‰ç™»å½•åçš„ç”¨æˆ·å¯ä»¥å…³æ³¨ä½œè€…ï¼Œä¹Ÿå¯ä»¥å–æ¶ˆå…³æ³¨ä½œè€…

ä¸€ä¸ªç”¨æˆ·å…³æ³¨äº†ä½œè€…ï¼Œä½œè€…æ˜¯ç”±ç”¨æˆ·å®åè®¤è¯ä»¥åå¼€é€šçš„ä½œè€…æƒé™ï¼Œæ‰æœ‰äº†ä½œè€…ä¿¡æ¯ï¼Œä½œè€…è‚¯å®šæ˜¯appä¸­çš„ä¸€ä¸ªç”¨æˆ·ã€‚

ä»ç”¨æˆ·çš„è§’åº¦å‡ºå‘ï¼šä¸€ä¸ªç”¨æˆ·å¯ä»¥å…³æ³¨å…¶ä»–å¤šä¸ªä½œè€… â€”â€” æˆ‘çš„å…³æ³¨

ä»ä½œè€…çš„è§’åº¦å‡ºå‘ï¼šä¸€ä¸ªç”¨æˆ·ï¼ˆåŒæ˜¯ä½œè€…ï¼‰ä¹Ÿå¯ä»¥æ‹¥æœ‰å¾ˆå¤šä¸ªç²‰ä¸ â€”â€” æˆ‘çš„ç²‰ä¸

![image-20210727163038634](../../../../../Volumes/FX-SSD-PS2000/myfield/å¼€å‘èµ„æ–™/02é¡¹ç›®èµ„æ–™/é»‘é©¬å¤´æ¡/day09-ç”¨æˆ·/éœ€æ±‚è¯´æ˜/ç”¨æˆ·è¡Œä¸º-éœ€æ±‚.assets\image-20210727163038634.png)

### 3 ç‚¹èµæˆ–å–æ¶ˆç‚¹èµ

### 4 é˜…è¯»

å½“ç”¨æˆ·æŸ¥çœ‹äº†æŸä¸€ç¯‡æ–‡ç« ï¼Œéœ€è¦è®°å½•å½“å‰ç”¨æˆ·æŸ¥çœ‹çš„æ¬¡æ•°ï¼Œé˜…è¯»æ—¶é•¿ï¼ˆéå¿…è¦ï¼‰ï¼Œé˜…è¯»æ–‡ç« çš„æ¯”ä¾‹ï¼ˆéå¿…è¦ï¼‰ï¼ŒåŠ è½½çš„æ—¶é•¿ï¼ˆéå¿…è¦ï¼‰

### 5 ä¸å–œæ¬¢

ä¸ºä»€ä¹ˆä¼šæœ‰ä¸å–œæ¬¢ï¼Ÿ

ä¸€æ—¦ç”¨æˆ·ç‚¹å‡»äº†ä¸å–œæ¬¢ï¼Œä¸å†ç»™å½“å‰ç”¨æˆ·æ¨èè¿™ä¸€ç±»å‹çš„æ–‡ç« ä¿¡æ¯

### 6 æ”¶è—

è®°å½•å½“å‰ç™»å½•äººæ”¶è—çš„æ–‡ç« 

### 7 æ–‡ç« è¯¦æƒ…-è¡Œä¸ºæ•°æ®å›æ˜¾

ä¸»è¦æ˜¯ç”¨æ¥å±•ç¤ºæ–‡ç« çš„å…³ç³»ï¼Œappç«¯ç”¨æˆ·å¿…é¡»ç™»å½•ï¼Œåˆ¤æ–­å½“å‰ç”¨æˆ·**æ˜¯å¦å·²ç»å…³æ³¨è¯¥æ–‡ç« çš„ä½œè€…ã€æ˜¯å¦æ”¶è—äº†æ­¤æ–‡ç« ã€æ˜¯å¦ç‚¹èµäº†æ–‡ç« ã€æ˜¯å¦ä¸å–œæ¬¢è¯¥æ–‡ç« ç­‰**

ä¾‹ï¼šå¦‚æœå½“å‰ç”¨æˆ·ç‚¹èµäº†è¯¥æ–‡ç« ï¼Œç‚¹èµæŒ‰é’®è¿›è¡Œé«˜äº®ï¼Œå…¶ä»–åŠŸèƒ½ç±»ä¼¼ã€‚

### 8 æ³¨æ„ï¼š

- æ‰€æœ‰çš„è¡Œä¸ºæ•°æ®ï¼Œéƒ½å­˜å‚¨åˆ°redisä¸­
- ç‚¹èµã€é˜…è¯»ã€ä¸å–œæ¬¢éœ€è¦ä¸“é—¨åˆ›å»ºä¸€ä¸ªå¾®æœåŠ¡æ¥å¤„ç†æ•°æ®ï¼Œæ–°å»ºæ¨¡å—ï¼šheima-leadnews-behavior
- å…³æ³¨éœ€è¦åœ¨heima-leadnews-userå¾®æœåŠ¡ä¸­å®ç°
- æ”¶è—ä¸æ–‡ç« è¯¦æƒ…æ•°æ®å›æ˜¾åœ¨heima-leadnews-articleå¾®æœåŠ¡ä¸­å®ç°

## 10 çƒ­ç‚¹æ–‡ç« -å®šæ—¶è®¡ç®—

### ä»Šæ—¥å†…å®¹

#### éœ€æ±‚åˆ†æ

ç›®å‰å®ç°çš„æ€è·¯ï¼šä»æ•°æ®åº“ç›´æ¥æŒ‰ç…§å‘å¸ƒæ—¶é—´å€’åºæŸ¥è¯¢

- é—®é¢˜1ï¼š

  å¦‚ä½•è®¿é—®é‡è¾ƒå¤§ï¼Œç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œå‹åŠ›è¾ƒå¤§
- é—®é¢˜2ï¼š

  æ–°å‘å¸ƒçš„æ–‡ç« ä¼šå±•ç¤ºåœ¨å‰é¢ï¼Œå¹¶ä¸æ˜¯çƒ­ç‚¹æ–‡ç« 

#### å®ç°æ€è·¯

æŠŠçƒ­ç‚¹æ•°æ®å­˜å…¥redisè¿›è¡Œå±•ç¤º

åˆ¤æ–­æ–‡ç« æ˜¯å¦æ˜¯çƒ­ç‚¹ï¼Œæœ‰å‡ é¡¹æ ‡å‡†ï¼š **ç‚¹èµæ•°é‡ï¼Œè¯„è®ºæ•°é‡ï¼Œé˜…è¯»æ•°é‡ï¼Œæ”¶è—æ•°é‡**

è®¡ç®—æ–‡ç« çƒ­åº¦ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

- å®šæ—¶è®¡ç®—æ–‡ç« çƒ­åº¦
- å®æ—¶è®¡ç®—æ–‡ç« çƒ­åº¦

#### å®šæ—¶è®¡ç®—

![](images/image-20210729225206299.png)

- æ ¹æ®æ–‡ç« çš„è¡Œä¸ºï¼ˆç‚¹èµã€è¯„è®ºã€é˜…è¯»ã€æ”¶è—ï¼‰è®¡ç®—æ–‡ç« çš„åˆ†å€¼ï¼Œåˆ©ç”¨å®šæ—¶ä»»åŠ¡æ¯å¤©å®Œæˆä¸€æ¬¡è®¡ç®—
- æŠŠåˆ†å€¼è¾ƒå¤§çš„æ–‡ç« æ•°æ®å­˜å…¥åˆ°redisä¸­
- Appç«¯ç”¨æˆ·æŸ¥è¯¢æ–‡ç« åˆ—è¡¨çš„æ—¶å€™ï¼Œä¼˜å…ˆä»redisä¸­æŸ¥è¯¢çƒ­åº¦è¾ƒé«˜çš„æ–‡ç« æ•°æ®

#### å®šæ—¶ä»»åŠ¡æ¡†æ¶-xxljob

springä¼ ç»Ÿçš„å®šæ—¶ä»»åŠ¡@Scheduledï¼Œä½†æ˜¯è¿™æ ·å­˜åœ¨è¿™ä¸€äº›é—®é¢˜ ï¼š

- åšé›†ç¾¤ä»»åŠ¡çš„é‡å¤æ‰§è¡Œé—®é¢˜
- cronè¡¨è¾¾å¼å®šä¹‰åœ¨ä»£ç ä¹‹ä¸­ï¼Œä¿®æ”¹ä¸æ–¹ä¾¿
- å®šæ—¶ä»»åŠ¡å¤±è´¥äº†ï¼Œæ— æ³•é‡è¯•ä¹Ÿæ²¡æœ‰ç»Ÿè®¡
- å¦‚æœä»»åŠ¡é‡è¿‡å¤§ï¼Œä¸èƒ½æœ‰æ•ˆçš„åˆ†ç‰‡æ‰§è¡Œ

è§£å†³è¿™äº›é—®é¢˜çš„æ–¹æ¡ˆä¸ºï¼š

**xxl-jobåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æ¡†æ¶**

### åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ğŸ”–

#### ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦

å½“å‰è½¯ä»¶çš„æ¶æ„å·²ç»å¼€å§‹å‘åˆ†å¸ƒå¼æ¶æ„è½¬å˜ï¼Œå°†å•ä½“ç»“æ„æ‹†åˆ†ä¸ºè‹¥å¹²æœåŠ¡ï¼ŒæœåŠ¡ä¹‹é—´é€šè¿‡ç½‘ç»œäº¤äº’æ¥å®Œæˆä¸šåŠ¡å¤„ç†ã€‚åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸‹ï¼Œä¸€ä¸ªæœåŠ¡å¾€å¾€ä¼šéƒ¨ç½²å¤šä¸ªå®ä¾‹æ¥è¿è¡Œæˆ‘ä»¬çš„ä¸šåŠ¡ï¼Œå¦‚æœåœ¨è¿™ç§åˆ†å¸ƒå¼ç³»ç»Ÿç¯å¢ƒä¸‹è¿è¡Œä»»åŠ¡è°ƒåº¦ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º**åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦**ã€‚

![](images/image-20210729230059884.png)

å°†ä»»åŠ¡è°ƒåº¦ç¨‹åºåˆ†å¸ƒå¼æ„å»ºï¼Œè¿™æ ·å°±å¯ä»¥å…·æœ‰åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç‰¹ç‚¹ï¼Œå¹¶ä¸”æé«˜ä»»åŠ¡çš„è°ƒåº¦å¤„ç†èƒ½åŠ›ï¼š

1ã€å¹¶è¡Œä»»åŠ¡è°ƒåº¦

å¹¶è¡Œä»»åŠ¡è°ƒåº¦å®ç°é å¤šçº¿ç¨‹ï¼Œå¦‚æœæœ‰å¤§é‡ä»»åŠ¡éœ€è¦è°ƒåº¦ï¼Œæ­¤æ—¶å…‰é å¤šçº¿ç¨‹å°±ä¼šæœ‰ç“¶é¢ˆäº†ï¼Œå› ä¸ºä¸€å°è®¡ç®—æœºCPUçš„å¤„ç†èƒ½åŠ›æ˜¯æœ‰é™çš„ã€‚

å¦‚æœå°†ä»»åŠ¡è°ƒåº¦ç¨‹åºåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œæ¯ä¸ªç»“ç‚¹è¿˜å¯ä»¥éƒ¨ç½²ä¸ºé›†ç¾¤ï¼Œè¿™æ ·å°±å¯ä»¥è®©å¤šå°è®¡ç®—æœºå…±åŒå»å®Œæˆä»»åŠ¡è°ƒåº¦ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»åŠ¡åˆ†å‰²ä¸ºè‹¥å¹²ä¸ªåˆ†ç‰‡ï¼Œç”±ä¸åŒçš„å®ä¾‹å¹¶è¡Œæ‰§è¡Œï¼Œæ¥æé«˜ä»»åŠ¡è°ƒåº¦çš„å¤„ç†æ•ˆç‡ã€‚

2ã€é«˜å¯ç”¨

è‹¥æŸä¸€ä¸ªå®ä¾‹å®•æœºï¼Œä¸å½±å“å…¶ä»–å®ä¾‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚

3ã€å¼¹æ€§æ‰©å®¹

å½“é›†ç¾¤ä¸­å¢åŠ å®ä¾‹å°±å¯ä»¥æé«˜å¹¶æ‰§è¡Œä»»åŠ¡çš„å¤„ç†æ•ˆç‡ã€‚

4ã€ä»»åŠ¡ç®¡ç†ä¸ç›‘æµ‹

å¯¹ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰å®šæ—¶ä»»åŠ¡è¿›è¡Œç»Ÿä¸€çš„ç®¡ç†åŠç›‘æµ‹ã€‚è®©å¼€å‘äººå‘˜åŠè¿ç»´äººå‘˜èƒ½å¤Ÿæ—¶åˆ»äº†è§£ä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼Œä»è€Œåšå‡ºå¿«é€Ÿçš„åº”æ€¥å¤„ç†å“åº”ã€‚

**åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦é¢ä¸´çš„é—®é¢˜ï¼š**

å½“ä»»åŠ¡è°ƒåº¦ä»¥é›†ç¾¤æ–¹å¼éƒ¨ç½²ï¼ŒåŒä¸€ä¸ªä»»åŠ¡è°ƒåº¦å¯èƒ½ä¼šæ‰§è¡Œå¤šæ¬¡ï¼Œä¾‹å¦‚ï¼šç”µå•†ç³»ç»Ÿå®šæœŸå‘æ”¾ä¼˜æƒ åˆ¸ï¼Œå°±å¯èƒ½é‡å¤å‘æ”¾ä¼˜æƒ åˆ¸ï¼Œå¯¹å…¬å¸é€ æˆæŸå¤±ï¼Œä¿¡ç”¨å¡è¿˜æ¬¾æé†’å°±ä¼šé‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œç»™ç”¨æˆ·é€ æˆçƒ¦æ¼ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ§åˆ¶ç›¸åŒçš„ä»»åŠ¡åœ¨å¤šä¸ªè¿è¡Œå®ä¾‹ä¸Šåªæ‰§è¡Œä¸€æ¬¡ã€‚å¸¸è§è§£å†³æ–¹æ¡ˆï¼š

- åˆ†å¸ƒå¼é”ï¼Œå¤šä¸ªå®ä¾‹åœ¨ä»»åŠ¡æ‰§è¡Œå‰é¦–å…ˆéœ€è¦è·å–é”ï¼Œå¦‚æœè·å–å¤±è´¥é‚£ä¹ˆå°±è¯æ˜æœ‰å…¶ä»–æœåŠ¡å·²ç»åœ¨è¿è¡Œï¼Œå¦‚æœè·å–æˆåŠŸé‚£ä¹ˆè¯æ˜æ²¡æœ‰æœåŠ¡åœ¨è¿è¡Œå®šæ—¶ä»»åŠ¡ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‰§è¡Œã€‚
- ZooKeeperé€‰ä¸¾ï¼Œåˆ©ç”¨ZooKeeperå¯¹Leaderå®ä¾‹æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œæ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„æ—¶å€™åˆ¤æ–­è‡ªå·±æ˜¯å¦æ˜¯Leaderï¼Œå¦‚æœä¸æ˜¯åˆ™ä¸æ‰§è¡Œï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œè¿™æ ·ä¹Ÿèƒ½è¾¾åˆ°ç›®çš„ã€‚

#### xxl-Jobç®€ä»‹

é’ˆå¯¹åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦çš„éœ€æ±‚ï¼Œå¸‚åœºä¸Šå‡ºç°äº†å¾ˆå¤šçš„äº§å“ï¼š

1ï¼‰ TBScheduleï¼šæ·˜å®æ¨å‡ºçš„ä¸€æ¬¾éå¸¸ä¼˜ç§€çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼è°ƒåº¦æ¡†æ¶ï¼Œç›®å‰è¢«åº”ç”¨äºé˜¿é‡Œã€äº¬ä¸œã€æ”¯ä»˜å®ã€å›½ç¾ç­‰å¾ˆå¤šäº’è”ç½‘ä¼ä¸šçš„æµç¨‹è°ƒåº¦ç³»ç»Ÿä¸­ã€‚ä½†æ˜¯å·²ç»å¤šå¹´æœªæ›´æ–°ï¼Œæ–‡æ¡£ç¼ºå¤±ä¸¥é‡ï¼Œç¼ºå°‘ç»´æŠ¤ã€‚

2ï¼‰ XXL-Jobï¼šå¤§ä¼—ç‚¹è¯„çš„åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œæ˜¯ä¸€ä¸ªè½»é‡çº§åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°, å…¶æ ¸å¿ƒè®¾è®¡ç›®æ ‡æ˜¯å¼€å‘è¿…é€Ÿã€å­¦ä¹ ç®€å•ã€è½»é‡çº§ã€æ˜“æ‰©å±•ã€‚ç°å·²å¼€æ”¾æºä»£ç å¹¶æ¥å…¥å¤šå®¶å…¬å¸çº¿ä¸Šäº§å“çº¿ï¼Œå¼€ç®±å³ç”¨ã€‚

3ï¼‰Elastic-jobï¼šå½“å½“ç½‘å€Ÿé‰´TBScheduleå¹¶åŸºäºquartz äºŒæ¬¡å¼€å‘çš„å¼¹æ€§åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿï¼ŒåŠŸèƒ½ä¸°å¯Œå¼ºå¤§ï¼Œé‡‡ç”¨zookeeperå®ç°åˆ†å¸ƒå¼åè°ƒï¼Œå…·æœ‰ä»»åŠ¡é«˜å¯ç”¨ä»¥åŠåˆ†ç‰‡åŠŸèƒ½ã€‚

4ï¼‰Saturnï¼š å”¯å“ä¼šå¼€æºçš„ä¸€ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼ŒåŸºäºElastic-jobï¼Œå¯ä»¥å…¨åŸŸç»Ÿä¸€é…ç½®ï¼Œç»Ÿä¸€ç›‘æ§ï¼Œå…·æœ‰ä»»åŠ¡é«˜å¯ç”¨ä»¥åŠåˆ†ç‰‡åŠŸèƒ½ã€‚

XXL-JOBæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç›®æ ‡æ˜¯å¼€å‘è¿…é€Ÿã€å­¦ä¹ ç®€å•ã€è½»é‡çº§ã€æ˜“æ‰©å±•ã€‚ç°å·²å¼€æ”¾æºä»£ç å¹¶æ¥å…¥å¤šå®¶å…¬å¸çº¿ä¸Šäº§å“çº¿ï¼Œå¼€ç®±å³ç”¨ã€‚

æºç åœ°å€ï¼šhttps://gitee.com/xuxueli0323/xxl-job

æ–‡æ¡£åœ°å€ï¼šhttps://www.xuxueli.com/xxl-job/

**ç‰¹æ€§**

- **ç®€å•çµæ´»**
  æä¾›Webé¡µé¢å¯¹ä»»åŠ¡è¿›è¡Œç®¡ç†ï¼Œç®¡ç†ç³»ç»Ÿæ”¯æŒç”¨æˆ·ç®¡ç†ã€æƒé™æ§åˆ¶ï¼›
  æ”¯æŒå®¹å™¨éƒ¨ç½²ï¼›
  æ”¯æŒé€šè¿‡é€šç”¨HTTPæä¾›è·¨å¹³å°ä»»åŠ¡è°ƒåº¦ï¼›
- **ä¸°å¯Œçš„ä»»åŠ¡ç®¡ç†åŠŸèƒ½**
  æ”¯æŒé¡µé¢å¯¹ä»»åŠ¡CRUDæ“ä½œï¼›
  æ”¯æŒåœ¨é¡µé¢ç¼–å†™è„šæœ¬ä»»åŠ¡ã€å‘½ä»¤è¡Œä»»åŠ¡ã€Javaä»£ç ä»»åŠ¡å¹¶æ‰§è¡Œï¼›
  æ”¯æŒä»»åŠ¡çº§è”ç¼–æ’ï¼Œçˆ¶ä»»åŠ¡æ‰§è¡Œç»“æŸåè§¦å‘å­ä»»åŠ¡æ‰§è¡Œï¼›
  æ”¯æŒè®¾ç½®æŒ‡å®šä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹è·¯ç”±ç­–ç•¥ï¼ŒåŒ…æ‹¬è½®è¯¢ã€éšæœºã€å¹¿æ’­ã€æ•…éšœè½¬ç§»ã€å¿™ç¢Œè½¬ç§»ç­‰ï¼›
  æ”¯æŒCronæ–¹å¼ã€ä»»åŠ¡ä¾èµ–ã€è°ƒåº¦ä¸­å¿ƒAPIæ¥å£æ–¹å¼è§¦å‘ä»»åŠ¡æ‰§è¡Œ
- **é«˜æ€§èƒ½**
  ä»»åŠ¡è°ƒåº¦æµç¨‹å…¨å¼‚æ­¥åŒ–è®¾è®¡å®ç°ï¼Œå¦‚å¼‚æ­¥è°ƒåº¦ã€å¼‚æ­¥è¿è¡Œã€å¼‚æ­¥å›è°ƒç­‰ï¼Œæœ‰æ•ˆå¯¹å¯†é›†è°ƒåº¦è¿›è¡Œæµé‡å‰Šå³°ï¼›
- **é«˜å¯ç”¨**
  ä»»åŠ¡è°ƒåº¦ä¸­å¿ƒã€ä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹å‡ é›†ç¾¤éƒ¨ç½²ï¼Œæ”¯æŒåŠ¨æ€æ‰©å±•ã€æ•…éšœè½¬ç§»
  æ”¯æŒä»»åŠ¡é…ç½®è·¯ç”±æ•…éšœè½¬ç§»ç­–ç•¥ï¼Œæ‰§è¡Œå™¨èŠ‚ç‚¹ä¸å¯ç”¨æ˜¯è‡ªåŠ¨è½¬ç§»åˆ°å…¶ä»–èŠ‚ç‚¹æ‰§è¡Œ
  æ”¯æŒä»»åŠ¡è¶…æ—¶æ§åˆ¶ã€å¤±è´¥é‡è¯•é…ç½®
  æ”¯æŒä»»åŠ¡å¤„ç†é˜»å¡ç­–ç•¥ï¼šè°ƒåº¦å½“ä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹å¿™ç¢Œæ—¶æ¥ä¸åŠæ‰§è¡Œä»»åŠ¡çš„å¤„ç†ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼šä¸²è¡Œã€æŠ›å¼ƒã€è¦†ç›–ç­–ç•¥
- **æ˜“äºç›‘æ§è¿ç»´**
  æ”¯æŒè®¾ç½®ä»»åŠ¡å¤±è´¥é‚®ä»¶å‘Šè­¦ï¼Œé¢„ç•™æ¥å£æ”¯æŒçŸ­ä¿¡ã€é’‰é’‰å‘Šè­¦ï¼›
  æ”¯æŒå®æ—¶æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œè¿è¡Œæ•°æ®ç»Ÿè®¡å›¾è¡¨ã€ä»»åŠ¡è¿›åº¦ç›‘æ§æ•°æ®ã€ä»»åŠ¡å®Œæ•´æ‰§è¡Œæ—¥å¿—ï¼›

#### XXL-Job-ç¯å¢ƒæ­å»º

##### è°ƒåº¦ä¸­å¿ƒç¯å¢ƒè¦æ±‚

- Maven3+
- Jdk1.8+
- Mysql5.7+

##### æºç ä»“åº“åœ°å€

| æºç ä»“åº“åœ°å€                         | Release Download                                       |
| :----------------------------------- | :----------------------------------------------------- |
| https://github.com/xuxueli/xxl-job   | [Download](https://github.com/xuxueli/xxl-job/releases)   |
| http://gitee.com/xuxueli0323/xxl-job | [Download](http://gitee.com/xuxueli0323/xxl-job/releases) |

ä¹Ÿå¯ä»¥ä½¿ç”¨èµ„æ–™æ–‡ä»¶å¤¹ä¸­çš„æºç 



#### XXL-Jobæºç è¯´æ˜

![](images/image-20240229154629784.png)

#### é…ç½®éƒ¨ç½²è°ƒåº¦ä¸­å¿ƒ





##### 2.3.3 åˆå§‹åŒ–â€œè°ƒåº¦æ•°æ®åº“â€

è¯·ä¸‹è½½é¡¹ç›®æºç å¹¶è§£å‹ï¼Œè·å– â€œè°ƒåº¦æ•°æ®åº“åˆå§‹åŒ–SQLè„šæœ¬â€ å¹¶æ‰§è¡Œå³å¯ã€‚

ä½ç½®ï¼š`/xxl-job/doc/db/tables_xxl_job.sql`  å…±8å¼ è¡¨

- xxl_job_lockï¼šä»»åŠ¡è°ƒåº¦é”è¡¨ï¼›
- xxl_job_groupï¼šæ‰§è¡Œå™¨ä¿¡æ¯è¡¨ï¼Œç»´æŠ¤ä»»åŠ¡æ‰§è¡Œå™¨ä¿¡æ¯ï¼›
- xxl_job_infoï¼šè°ƒåº¦æ‰©å±•ä¿¡æ¯è¡¨ï¼š ç”¨äºä¿å­˜XXL-JOBè°ƒåº¦ä»»åŠ¡çš„æ‰©å±•ä¿¡æ¯ï¼Œå¦‚ä»»åŠ¡åˆ†ç»„ã€ä»»åŠ¡åã€æœºå™¨åœ°å€ã€æ‰§è¡Œå™¨ã€æ‰§è¡Œå…¥å‚å’ŒæŠ¥è­¦é‚®ä»¶ç­‰ç­‰ï¼›
- xxl_job_logï¼šè°ƒåº¦æ—¥å¿—è¡¨ï¼š ç”¨äºä¿å­˜XXL-JOBä»»åŠ¡è°ƒåº¦çš„å†å²ä¿¡æ¯ï¼Œå¦‚è°ƒåº¦ç»“æœã€æ‰§è¡Œç»“æœã€è°ƒåº¦å…¥å‚ã€è°ƒåº¦æœºå™¨å’Œæ‰§è¡Œå™¨ç­‰ç­‰ï¼›
- xxl_job_logglueï¼šä»»åŠ¡GLUEæ—¥å¿—ï¼šç”¨äºä¿å­˜GLUEæ›´æ–°å†å²ï¼Œç”¨äºæ”¯æŒGLUEçš„ç‰ˆæœ¬å›æº¯åŠŸèƒ½ï¼›
- xxl_job_registryï¼šæ‰§è¡Œå™¨æ³¨å†Œè¡¨ï¼Œç»´æŠ¤åœ¨çº¿çš„æ‰§è¡Œå™¨å’Œè°ƒåº¦ä¸­å¿ƒæœºå™¨åœ°å€ä¿¡æ¯ï¼›
- xxl_job_userï¼šç³»ç»Ÿç”¨æˆ·è¡¨ï¼›

è°ƒåº¦ä¸­å¿ƒæ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œé›†ç¾¤æƒ…å†µä¸‹å„èŠ‚ç‚¹åŠ¡å¿…è¿æ¥åŒä¸€ä¸ªmysqlå®ä¾‹;

å¦‚æœmysqlåšä¸»ä»,è°ƒåº¦ä¸­å¿ƒé›†ç¾¤èŠ‚ç‚¹åŠ¡å¿…å¼ºåˆ¶èµ°ä¸»åº“;

##### 2.3.4 ç¼–è¯‘æºç 

è§£å‹æºç ,æŒ‰ç…§mavenæ ¼å¼å°†æºç å¯¼å…¥IDE, ä½¿ç”¨mavenè¿›è¡Œç¼–è¯‘å³å¯ï¼Œæºç ç»“æ„å¦‚ä¸‹ï¼š

![](images/image-20210729230502703.png)

##### 2.3.5 é…ç½®éƒ¨ç½²â€œè°ƒåº¦ä¸­å¿ƒâ€

è°ƒåº¦ä¸­å¿ƒé¡¹ç›®ï¼šxxl-job-admin

ä½œç”¨ï¼šç»Ÿä¸€ç®¡ç†ä»»åŠ¡è°ƒåº¦å¹³å°ä¸Šè°ƒåº¦ä»»åŠ¡ï¼Œè´Ÿè´£è§¦å‘è°ƒåº¦æ‰§è¡Œï¼Œå¹¶ä¸”æä¾›ä»»åŠ¡ç®¡ç†å¹³å°ã€‚

æ­¥éª¤ä¸€ï¼šè°ƒåº¦ä¸­å¿ƒé…ç½®

è°ƒåº¦ä¸­å¿ƒé…ç½®æ–‡ä»¶åœ°å€ï¼š`/xxl-job/xxl-job-admin/src/main/resources/application.properties`

æ•°æ®åº“çš„è¿æ¥ä¿¡æ¯ä¿®æ”¹ä¸ºè‡ªå·±çš„æ•°æ®åº“

```properties
### web
server.port=8888
server.servlet.context-path=/xxl-job-admin

### actuator
management.server.servlet.context-path=/actuator
management.health.mail.enabled=false

### resources
spring.mvc.servlet.load-on-startup=0
spring.mvc.static-path-pattern=/static/**
spring.resources.static-locations=classpath:/static/

### freemarker
spring.freemarker.templateLoaderPath=classpath:/templates/
spring.freemarker.suffix=.ftl
spring.freemarker.charset=UTF-8
spring.freemarker.request-context-attribute=request
spring.freemarker.settings.number_format=0.##########

### mybatis
mybatis.mapper-locations=classpath:/mybatis-mapper/*Mapper.xml
#mybatis.type-aliases-package=com.xxl.job.admin.core.model

### xxl-job, datasource
spring.datasource.url=jdbc:mysql://127.0.0.1:3306/xxl_job?Unicode=true&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8
spring.datasource.username=root
spring.datasource.password=root
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

### datasource-pool
spring.datasource.type=com.zaxxer.hikari.HikariDataSource
spring.datasource.hikari.minimum-idle=10
spring.datasource.hikari.maximum-pool-size=30
spring.datasource.hikari.auto-commit=true
spring.datasource.hikari.idle-timeout=30000
spring.datasource.hikari.pool-name=HikariCP
spring.datasource.hikari.max-lifetime=900000
spring.datasource.hikari.connection-timeout=10000
spring.datasource.hikari.connection-test-query=SELECT 1

### xxl-job, email
spring.mail.host=smtp.qq.com
spring.mail.port=25
spring.mail.username=xxx@qq.com
spring.mail.password=xxx
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
spring.mail.properties.mail.smtp.starttls.required=true
spring.mail.properties.mail.smtp.socketFactory.class=javax.net.ssl.SSLSocketFactory

### xxl-job, access token
xxl.job.accessToken=

### xxl-job, i18n (default is zh_CN, and you can choose "zh_CN", "zh_TC" and "en")
xxl.job.i18n=zh_CN

## xxl-job, triggerpool max size
xxl.job.triggerpool.fast.max=200
xxl.job.triggerpool.slow.max=100

### xxl-job, log retention days
xxl.job.logretentiondays=30
```

å¯åŠ¨è°ƒåº¦ä¸­å¿ƒï¼Œé»˜è®¤ç™»å½•è´¦å· â€œadmin/123456â€, ç™»å½•åè¿è¡Œç•Œé¢å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

#### é…ç½®éƒ¨ç½²è°ƒåº¦ä¸­å¿ƒ-dockerå®‰è£…

//....ğŸ”–

### çƒ­ç‚¹æ–‡ç« -å®šæ—¶è®¡ç®—

#### éœ€æ±‚åˆ†æ

éœ€æ±‚ï¼šä¸ºæ¯ä¸ªé¢‘é“ç¼“å­˜çƒ­åº¦è¾ƒé«˜çš„30æ¡æ–‡ç« ä¼˜å…ˆå±•ç¤º

åˆ¤æ–­æ–‡ç« çƒ­åº¦è¾ƒé«˜çš„æ ‡å‡†æ˜¯ä»€ä¹ˆï¼Ÿ

æ–‡ç« ï¼šé˜…è¯»ï¼Œç‚¹èµï¼Œè¯„è®ºï¼Œæ”¶è—

ap_articleæ–‡ç« è¡¨

![](images/image-20240229154912638.png)

#### å®ç°

1.æŸ¥è¯¢å‰5å¤©çš„æ–‡ç« 



2.è®¡ç®—æ–‡ç« åˆ†å€¼



3.ä¸ºæ¯ä¸ªé¢‘é“ç¼“å­˜30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« 



4.å®šæ—¶ä»»åŠ¡







### æŸ¥è¯¢æ–‡ç« æ¥å£æ”¹é€ 

#### æ€è·¯åˆ†æ

![](images/image-20240229155143398.png)

#### å®ç°









## 11 çƒ­ç‚¹æ–‡ç« -å®æ—¶è®¡ç®—

kafkaStream

- ä»€ä¹ˆæ˜¯æµå¼è®¡ç®—
- kafkaStreamæ¦‚è¿°
- kafkaStreamå…¥é—¨æ¡ˆä¾‹
- Springbooté›†æˆkafkaStream

å®æ—¶è®¡ç®—

- ç”¨æˆ·è¡Œä¸ºå‘é€æ¶ˆæ¯
- kafkaStreamèšåˆå¤„ç†æ¶ˆæ¯
- æ›´æ–°æ–‡ç« è¡Œä¸ºæ•°é‡
- æ›¿æ¢çƒ­ç‚¹æ–‡ç« æ•°æ®

å®šæ—¶è®¡ç®—ä¸å®æ—¶è®¡ç®—

![](images/image-20240229163932210.png)





### å®æ—¶æµå¼è®¡ç®—



#### æ¦‚å¿µ

ä¸€èˆ¬æµå¼è®¡ç®—ä¼šä¸æ‰¹é‡è®¡ç®—ç›¸æ¯”è¾ƒã€‚åœ¨æµå¼è®¡ç®—æ¨¡å‹ä¸­ï¼Œè¾“å…¥æ˜¯æŒç»­çš„ï¼Œå¯ä»¥è®¤ä¸ºåœ¨æ—¶é—´ä¸Šæ˜¯æ— ç•Œçš„ï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œæ°¸è¿œæ‹¿ä¸åˆ°å…¨é‡æ•°æ®å»åšè®¡ç®—ã€‚åŒæ—¶ï¼Œè®¡ç®—ç»“æœæ˜¯æŒç»­è¾“å‡ºçš„ï¼Œä¹Ÿå³è®¡ç®—ç»“æœåœ¨æ—¶é—´ä¸Šä¹Ÿæ˜¯æ— ç•Œçš„ã€‚æµå¼è®¡ç®—ä¸€èˆ¬å¯¹å®æ—¶æ€§è¦æ±‚è¾ƒé«˜ï¼ŒåŒæ—¶ä¸€èˆ¬æ˜¯å…ˆå®šä¹‰ç›®æ ‡è®¡ç®—ï¼Œç„¶åæ•°æ®åˆ°æ¥ä¹‹åå°†è®¡ç®—é€»è¾‘åº”ç”¨äºæ•°æ®ã€‚åŒæ—¶ä¸ºäº†æé«˜è®¡ç®—æ•ˆç‡ï¼Œå¾€å¾€å°½å¯èƒ½é‡‡ç”¨å¢é‡è®¡ç®—ä»£æ›¿å…¨é‡è®¡ç®—ã€‚

![](images/image-20240206095446101.png)

æµå¼è®¡ç®—å°±ç›¸å½“äºä¸Šå›¾çš„å³ä¾§æ‰¶æ¢¯ï¼Œæ˜¯å¯ä»¥æºæºä¸æ–­çš„äº§ç”Ÿæ•°æ®ï¼Œæºæºä¸æ–­çš„æ¥æ”¶æ•°æ®ï¼Œæ²¡æœ‰è¾¹ç•Œã€‚

#### åº”ç”¨åœºæ™¯

- æ—¥å¿—åˆ†æ

  ç½‘ç«™çš„ç”¨æˆ·è®¿é—®æ—¥å¿—è¿›è¡Œå®æ—¶çš„åˆ†æï¼Œè®¡ç®—è®¿é—®é‡ï¼Œç”¨æˆ·ç”»åƒï¼Œç•™å­˜ç‡ç­‰ç­‰ï¼Œå®æ—¶çš„è¿›è¡Œæ•°æ®åˆ†æï¼Œå¸®åŠ©ä¼ä¸šè¿›è¡Œå†³ç­–
- å¤§å±çœ‹æ¿ç»Ÿè®¡

  å¯ä»¥å®æ—¶çš„æŸ¥çœ‹ç½‘ç«™æ³¨å†Œæ•°é‡ï¼Œè®¢å•æ•°é‡ï¼Œè´­ä¹°æ•°é‡ï¼Œé‡‘é¢ç­‰ã€‚
- å…¬äº¤å®æ—¶æ•°æ®

  å¯ä»¥éšæ—¶æ›´æ–°å…¬äº¤è½¦æ–¹ä½ï¼Œè®¡ç®—å¤šä¹…åˆ°è¾¾ç«™ç‰Œç­‰
- å®æ—¶æ–‡ç« åˆ†å€¼è®¡ç®—

  å¤´æ¡ç±»æ–‡ç« çš„åˆ†å€¼è®¡ç®—ï¼Œé€šè¿‡ç”¨æˆ·çš„è¡Œä¸ºå®æ—¶æ–‡ç« çš„åˆ†å€¼ï¼Œåˆ†å€¼è¶Šé«˜å°±è¶Šè¢«æ¨èã€‚

#### æŠ€æœ¯æ–¹æ¡ˆé€‰å‹

- Hadoop
- Apche Storm

  Storm æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å®æ—¶å¤§æ•°æ®å¤„ç†ç³»ç»Ÿï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ–¹ä¾¿åœ°å¤„ç†æµ·é‡æ•°æ®ï¼Œå…·æœ‰é«˜å¯é ã€é«˜å®¹é”™ã€é«˜æ‰©å±•çš„ç‰¹ç‚¹ã€‚æ˜¯æµå¼æ¡†æ¶ï¼Œæœ‰å¾ˆé«˜çš„æ•°æ®ååèƒ½åŠ›ã€‚
- Kafka Stream

  å¯ä»¥è½»æ¾åœ°å°†å…¶åµŒå…¥ä»»ä½•Javaåº”ç”¨ç¨‹åºä¸­ï¼Œå¹¶ä¸ç”¨æˆ·ä¸ºå…¶æµåº”ç”¨ç¨‹åºæ‰€æ‹¥æœ‰çš„ä»»ä½•ç°æœ‰æ‰“åŒ…ï¼Œéƒ¨ç½²å’Œæ“ä½œå·¥å…·é›†æˆã€‚

### Kafka Stream

#### æ¦‚è¿°

Kafka Streamæ˜¯Apache Kafkaä»0.10ç‰ˆæœ¬å¼•å…¥çš„ä¸€ä¸ªæ–°Featureã€‚å®ƒæ˜¯æä¾›äº†å¯¹å­˜å‚¨äºKafkaå†…çš„æ•°æ®è¿›è¡Œæµå¼å¤„ç†å’Œåˆ†æçš„åŠŸèƒ½ã€‚

Kafka Streamçš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š

- Kafka Streamæä¾›äº†ä¸€ä¸ªéå¸¸ç®€å•è€Œè½»é‡çš„Libraryï¼Œå®ƒå¯ä»¥éå¸¸æ–¹ä¾¿åœ°åµŒå…¥ä»»æ„Javaåº”ç”¨ä¸­ï¼Œä¹Ÿå¯ä»¥ä»»æ„æ–¹å¼æ‰“åŒ…å’Œéƒ¨ç½²
- é™¤äº†Kafkaå¤–ï¼Œæ— ä»»ä½•å¤–éƒ¨ä¾èµ–
- å……åˆ†åˆ©ç”¨Kafkaåˆ†åŒºæœºåˆ¶å®ç°æ°´å¹³æ‰©å±•å’Œé¡ºåºæ€§ä¿è¯
- é€šè¿‡å¯å®¹é”™çš„state storeå®ç°é«˜æ•ˆçš„çŠ¶æ€æ“ä½œï¼ˆå¦‚windowed joinå’Œaggregationï¼‰
- æ”¯æŒæ­£å¥½ä¸€æ¬¡å¤„ç†è¯­ä¹‰
- æä¾›è®°å½•çº§çš„å¤„ç†èƒ½åŠ›ï¼Œä»è€Œå®ç°æ¯«ç§’çº§çš„ä½å»¶è¿Ÿ
- æ”¯æŒåŸºäºäº‹ä»¶æ—¶é—´çš„çª—å£æ“ä½œï¼Œå¹¶ä¸”å¯å¤„ç†æ™šåˆ°çš„æ•°æ®ï¼ˆlate arrival of recordsï¼‰
- åŒæ—¶æä¾›åº•å±‚çš„å¤„ç†åŸè¯­Processorï¼ˆç±»ä¼¼äºStormçš„spoutå’Œboltï¼‰ï¼Œä»¥åŠé«˜å±‚æŠ½è±¡çš„DSLï¼ˆç±»ä¼¼äºSparkçš„map/group/reduceï¼‰

#### Kafka Streamsçš„å…³é”®æ¦‚å¿µ

- æºå¤„ç†å™¨ï¼ˆSource Processorï¼‰ï¼šæºå¤„ç†å™¨æ˜¯ä¸€ä¸ªæ²¡æœ‰ä»»ä½•ä¸Šæ¸¸å¤„ç†å™¨çš„ç‰¹æ®Šç±»å‹çš„æµå¤„ç†å™¨ã€‚å®ƒä»ä¸€ä¸ªæˆ–å¤šä¸ªkafkaä¸»é¢˜ç”Ÿæˆè¾“å…¥æµã€‚é€šè¿‡æ¶ˆè´¹è¿™äº›ä¸»é¢˜çš„æ¶ˆæ¯å¹¶å°†å®ƒä»¬è½¬å‘åˆ°ä¸‹æ¸¸å¤„ç†å™¨ã€‚
- Sinkå¤„ç†å™¨ï¼šsinkå¤„ç†å™¨æ˜¯ä¸€ä¸ªæ²¡æœ‰ä¸‹æ¸¸æµå¤„ç†å™¨çš„ç‰¹æ®Šç±»å‹çš„æµå¤„ç†å™¨ã€‚å®ƒæ¥æ”¶ä¸Šæ¸¸æµå¤„ç†å™¨çš„æ¶ˆæ¯å‘é€åˆ°ä¸€ä¸ªæŒ‡å®šçš„Kafkaä¸»é¢˜ã€‚

#### KStream

- æ•°æ®ç»“æ„ç±»ä¼¼äºmap
- KStreamæ•°æ®æµï¼ˆdata streamï¼‰ï¼Œå³æ˜¯ä¸€æ®µé¡ºåºçš„ï¼Œå¯ä»¥æ— é™é•¿ï¼Œä¸æ–­æ›´æ–°çš„æ•°æ®é›†ã€‚



#### Kafka Streamå…¥é—¨æ¡ˆä¾‹





ç»“æœï¼šé€šè¿‡æµå¼è®¡ç®—ï¼Œä¼šæŠŠç”Ÿäº§è€…çš„å¤šæ¡æ¶ˆæ¯æ±‡æ€»æˆä¸€æ¡å‘é€åˆ°æ¶ˆè´¹è€…ä¸­è¾“å‡º



#### SpringBooté›†æˆKafka Stream





### çƒ­ç‚¹æ–‡ç« -å®æ—¶è®¡ç®—

#### æ€è·¯è¯´æ˜

![](images/image-20210621235620854.png)

#### å®ç°

1.ä¿®æ”¹ApLikesBehaviorServiceImplå’ŒApReadBehaviorServiceImplæ–°å¢å‘é€æ¶ˆæ¯



2.åœ¨leadnews-articleå¾®æœåŠ¡ä¸­é›†æˆkafkaStreamï¼ˆå‚è€ƒkafka-demoï¼‰



3.åœ¨leadnews-articleå¾®æœåŠ¡ä¸­å®æ—¶æ¥æ”¶æ¶ˆæ¯ï¼Œèšåˆå†…å®¹



4.é‡æ–°è®¡ç®—æ–‡ç« çš„åˆ†å€¼ï¼Œæ›´æ–°åˆ°æ•°æ®åº“å’Œç¼“å­˜ä¸­



5.å®šä¹‰ç›‘å¬ï¼Œæ¥æ”¶èšåˆä¹‹åçš„æ•°æ®ï¼Œæ–‡ç« çš„åˆ†å€¼é‡æ–°è¿›è¡Œè®¡ç®—







## 12 é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ

### ä»€ä¹ˆæ˜¯æŒç»­é›†æˆ

æŒç»­é›†æˆï¼ˆ Continuous integration ï¼Œ ç®€ç§° CI ï¼‰æŒ‡çš„æ˜¯ï¼Œé¢‘ç¹åœ°ï¼ˆä¸€å¤©å¤šæ¬¡ï¼‰å°†ä»£ç é›†æˆåˆ°ä¸»å¹²

![image-20210802000658790](images/image-20210802000658790.png)

**æŒç»­é›†æˆçš„ç»„æˆè¦ç´ **

ä¸€ä¸ªè‡ªåŠ¨æ„å»ºè¿‡ç¨‹ï¼Œ ä»æ£€å‡ºä»£ç ã€ ç¼–è¯‘æ„å»ºã€ è¿è¡Œæµ‹è¯•ã€ ç»“æœè®°å½•ã€ æµ‹è¯•ç»Ÿè®¡ç­‰éƒ½æ˜¯è‡ªåŠ¨å®Œæˆçš„ï¼Œ æ— éœ€äººå·¥å¹²é¢„ã€‚

ä¸€ä¸ªä»£ç å­˜å‚¨åº“ï¼Œå³éœ€è¦ç‰ˆæœ¬æ§åˆ¶è½¯ä»¶æ¥ä¿éšœä»£ç çš„å¯ç»´æŠ¤æ€§ï¼ŒåŒæ—¶ä½œä¸ºæ„å»ºè¿‡ç¨‹çš„ç´ æåº“ï¼Œä¸€èˆ¬ä½¿ç”¨SVNæˆ–Gitã€‚

ä¸€ä¸ªæŒç»­é›†æˆæœåŠ¡å™¨ï¼Œ Jenkins å°±æ˜¯ä¸€ä¸ªé…ç½®ç®€å•å’Œä½¿ç”¨æ–¹ä¾¿çš„æŒç»­é›†æˆæœåŠ¡å™¨ã€‚

æŒç»­é›†æˆçš„å¥½å¤„

1ã€é™ä½é£é™©ï¼Œç”±äºæŒç»­é›†æˆä¸æ–­å»æ„å»ºï¼Œç¼–è¯‘å’Œæµ‹è¯•ï¼Œå¯ä»¥å¾ˆæ—©æœŸå‘ç°é—®é¢˜ï¼Œæ‰€ä»¥ä¿®å¤çš„ä»£ä»·å°±å°‘ï¼›
2ã€å¯¹ç³»ç»Ÿå¥åº·æŒç»­æ£€æŸ¥ï¼Œå‡å°‘å‘å¸ƒé£é™©å¸¦æ¥çš„é—®é¢˜ï¼›
3ã€å‡å°‘é‡å¤æ€§å·¥ä½œï¼›
4ã€æŒç»­éƒ¨ç½²ï¼Œæä¾›å¯éƒ¨ç½²å•å…ƒåŒ…ï¼›
5ã€æŒç»­äº¤ä»˜å¯ä¾›ä½¿ç”¨çš„ç‰ˆæœ¬ï¼›
6ã€å¢å¼ºå›¢é˜Ÿä¿¡å¿ƒï¼›

### è½¯ä»¶å¼€å‘æ¨¡å¼

#### è½¯ä»¶å¼€å‘ç”Ÿå‘½å‘¨æœŸ

è½¯ä»¶å¼€å‘ç”Ÿå‘½å‘¨æœŸåˆå«åšSDLCï¼ˆSoftware Development Life Cycleï¼‰ï¼Œå®ƒæ˜¯é›†åˆäº†è®¡åˆ’ã€å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²è¿‡ç¨‹çš„é›†åˆã€‚å¦‚ä¸‹å›¾æ‰€ç¤º ï¼š

![](images/image-20210802011508487.png)

- éœ€æ±‚åˆ†æ

  è¿™æ˜¯ç”Ÿå‘½å‘¨æœŸçš„ç¬¬ä¸€é˜¶æ®µï¼Œæ ¹æ®é¡¹ç›®éœ€æ±‚ï¼Œå›¢é˜Ÿæ‰§è¡Œä¸€ä¸ªå¯è¡Œæ€§è®¡åˆ’çš„åˆ†æã€‚é¡¹ç›®éœ€æ±‚å¯èƒ½æ˜¯å…¬å¸å†…éƒ¨æˆ–è€…å®¢æˆ·æå‡ºçš„ã€‚è¿™é˜¶æ®µä¸»è¦æ˜¯å¯¹ä¿¡æ¯çš„æ”¶é›†ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å¯¹ç°æœ‰é¡¹ç›®çš„æ”¹å–„å’Œé‡æ–°åšä¸€ä¸ªæ–°çš„é¡¹ç›®ã€‚è¿˜è¦åˆ†æé¡¹ç›®çš„é¢„ç®—å¤šé•¿ï¼Œå¯ä»¥ä»å“ªæ–¹é¢å—ç›ŠåŠå¸ƒå±€ï¼Œè¿™ä¹Ÿæ˜¯é¡¹ç›®åˆ›å»ºçš„ç›®æ ‡ã€‚
- è®¾è®¡

  ç¬¬äºŒé˜¶æ®µå°±æ˜¯è®¾è®¡é˜¶æ®µï¼Œç³»ç»Ÿæ¶æ„å’Œæ»¡æ„çŠ¶æ€ï¼ˆå°±æ˜¯è¦åšæˆä»€ä¹ˆæ ·å­ï¼Œæœ‰ä»€ä¹ˆåŠŸèƒ½ï¼‰ï¼Œå’Œåˆ›å»ºä¸€ä¸ªé¡¹ç›®è®¡åˆ’ã€‚è®¡åˆ’å¯ä»¥ä½¿ç”¨å›¾è¡¨ï¼Œå¸ƒå±€è®¾è®¡æˆ–è€…æ–‡å­—çš„æ–¹å¼å‘ˆç°ã€‚
- å®ç°

  ç¬¬ä¸‰é˜¶æ®µå°±æ˜¯å®ç°é˜¶æ®µï¼Œé¡¹ç›®ç»ç†åˆ›å»ºå’Œåˆ†é…å·¥ä½œç»™å¼€è€…ï¼Œå¼€å‘è€…æ ¹æ®ä»»åŠ¡å’Œåœ¨è®¾è®¡é˜¶æ®µå®šä¹‰çš„ç›®æ ‡è¿›è¡Œå¼€å‘ä»£ç ã€‚ä¾æ®é¡¹ç›®çš„å¤§å°å’Œå¤æ‚ç¨‹åº¦ï¼Œå¯ä»¥éœ€è¦æ•°æœˆæˆ–æ›´é•¿æ—¶é—´æ‰èƒ½å®Œæˆã€‚
- æµ‹è¯•

  æµ‹è¯•äººå‘˜è¿›è¡Œä»£ç æµ‹è¯• ï¼ŒåŒ…æ‹¬åŠŸèƒ½æµ‹è¯•ã€ä»£ç æµ‹è¯•ã€å‹åŠ›æµ‹è¯•ç­‰ã€‚
- è¿›åŒ–

  æœ€åè¿›é˜¶æ®µå°±æ˜¯å¯¹äº§å“ä¸æ–­çš„è¿›åŒ–æ”¹è¿›å’Œç»´æŠ¤é˜¶æ®µï¼Œæ ¹æ®ç”¨æˆ·çš„ä½¿ç”¨æƒ…å†µï¼Œå¯èƒ½éœ€è¦å¯¹æŸåŠŸèƒ½è¿›è¡Œä¿®æ”¹ï¼Œbugä¿®å¤ï¼ŒåŠŸèƒ½å¢åŠ ç­‰ã€‚

#### è½¯ä»¶å¼€å‘ç€‘å¸ƒæ¨¡å‹

ç€‘å¸ƒæ¨¡å‹æ˜¯æœ€è‘—åå’Œæœ€å¸¸ä½¿ç”¨çš„è½¯ä»¶å¼€å‘æ¨¡å‹ã€‚ç€‘å¸ƒæ¨¡å‹å°±æ˜¯ä¸€ç³»åˆ—çš„è½¯ä»¶å¼€å‘è¿‡ç¨‹ã€‚å®ƒæ˜¯ç”±åˆ¶é€ ä¸šç¹è¡å‡ºæ¥çš„ã€‚ä¸€ä¸ªé«˜åº¦åŒ–çš„ç»“æ„æµç¨‹åœ¨ä¸€ä¸ªæ–¹å‘ä¸ŠæµåŠ¨ï¼Œæœ‰ç‚¹åƒç”Ÿäº§çº¿ä¸€æ ·ã€‚åœ¨ç€‘å¸ƒæ¨¡å‹åˆ›å»ºä¹‹åˆï¼Œæ²¡æœ‰å…¶å®ƒå¼€å‘çš„æ¨¡å‹ï¼Œæœ‰å¾ˆå¤šä¸œè¥¿å…¨é å¼€å‘äººå‘˜å»çŒœæµ‹ï¼Œå»å¼€å‘ã€‚è¿™æ ·çš„æ¨¡å‹ä»…é€‚ç”¨äºé‚£äº›ç®€å•çš„è½¯ä»¶å¼€å‘ï¼Œ ä½†æ˜¯å·²ç»ä¸é€‚åˆç°åœ¨çš„å¼€å‘äº†ã€‚

ä¸‹å›¾å¯¹è½¯ä»¶å¼€å‘æ¨¡å‹çš„ä¸€ä¸ªé˜è¿°ã€‚

![image-20210802011525024](images/image-20210802011525024.png)

| ä¼˜åŠ¿                                       | åŠ£åŠ¿                                                                                   |
| ------------------------------------------ | -------------------------------------------------------------------------------------- |
| ç®€å•æ˜“ç”¨å’Œç†è§£                             | å„ä¸ªé˜¶æ®µçš„åˆ’åˆ†å®Œå…¨å›ºå®šï¼Œé˜¶æ®µä¹‹é—´äº§ç”Ÿå¤§é‡çš„æ–‡æ¡£ï¼Œæå¤§åœ°å¢åŠ äº†å·¥ä½œé‡ã€‚                   |
| å½“å‰ä¸€é˜¶æ®µå®Œæˆåï¼Œæ‚¨åªéœ€è¦å»å…³æ³¨åç»­é˜¶æ®µã€‚ | ç”±äºå¼€å‘æ¨¡å‹æ˜¯çº¿æ€§çš„ï¼Œç”¨æˆ·åªæœ‰ç­‰åˆ°æ•´ä¸ªè¿‡ç¨‹çš„æœ«æœŸæ‰èƒ½è§åˆ°å¼€å‘æˆæœï¼Œä»è€Œå¢åŠ äº†å¼€å‘é£é™©ã€‚ |
| ä¸ºé¡¹ç›®æä¾›äº†æŒ‰é˜¶æ®µåˆ’åˆ†çš„æ£€æŸ¥èŠ‚ç‚¹           | ç€‘å¸ƒæ¨¡å‹çš„çªå‡ºç¼ºç‚¹æ˜¯ä¸é€‚åº”ç”¨æˆ·éœ€æ±‚çš„å˜åŒ–ã€‚                                             |

#### è½¯ä»¶çš„æ•æ·å¼€å‘

- ä»€ä¹ˆæ˜¯æ•æ·å¼€å‘ï¼Ÿ

  æ•æ·å¼€å‘ï¼ˆAgile Developmentï¼‰ çš„æ ¸å¿ƒæ˜¯è¿­ä»£å¼€å‘ï¼ˆIterative Developmentï¼‰ ä¸ å¢é‡å¼€å‘ï¼ˆIncremental Developmentï¼‰ã€‚
- ä½•ä¸ºè¿­ä»£å¼€å‘ï¼Ÿ

  å¯¹äºå¤§å‹è½¯ä»¶é¡¹ç›®ï¼Œä¼ ç»Ÿçš„å¼€å‘æ–¹å¼æ˜¯é‡‡ç”¨ä¸€ä¸ªå¤§å‘¨æœŸï¼ˆæ¯”å¦‚ä¸€å¹´ï¼‰è¿›è¡Œå¼€å‘ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡"å¤§å¼€å‘"ï¼›è¿­ä»£å¼€å‘çš„æ–¹å¼åˆ™ä¸ä¸€æ ·ï¼Œå®ƒå°†å¼€å‘è¿‡ç¨‹æ‹†åˆ†æˆå¤šä¸ªå°å‘¨æœŸï¼Œå³ä¸€æ¬¡"å¤§å¼€å‘"å˜æˆå¤šæ¬¡"å°å¼€å‘"ï¼Œæ¯æ¬¡å°å¼€å‘éƒ½æ˜¯åŒæ ·çš„æµç¨‹ï¼Œæ‰€ä»¥çœ‹ä¸Šå»å°±å¥½åƒé‡å¤åœ¨åšåŒæ ·çš„æ­¥éª¤ã€‚

  ä¸¾ä¾‹æ¥è¯´ï¼ŒSpaceX å…¬å¸æƒ³é€ ä¸€ä¸ªå¤§æ¨åŠ›ç«ç®­ï¼Œå°†äººç±»é€åˆ°ç«æ˜Ÿã€‚ä½†æ˜¯ï¼Œå®ƒä¸æ˜¯ä¸€å¼€å§‹å°±é€ å¤§ç«ç®­ï¼Œè€Œæ˜¯å…ˆé€ ä¸€ä¸ªæœ€ç®€é™‹çš„å°ç«ç®­ Falcon 1ã€‚ç»“æœï¼Œç¬¬ä¸€æ¬¡å‘å°„å°±çˆ†ç‚¸äº†ï¼Œç›´åˆ°ç¬¬å››æ¬¡å‘å°„ï¼Œæ‰æˆåŠŸè¿›å…¥è½¨é“ã€‚ç„¶åï¼Œå¼€å‘äº†ä¸­å‹ç«ç®­ Falcon 9ï¼Œä¹å¹´ä¸­å‘å°„äº†70æ¬¡ã€‚æœ€åï¼Œæ‰å¼€å‘ Falcon é‡å‹ç«ç®­ã€‚å¦‚æœSpaceX ä¸é‡‡ç”¨è¿­ä»£å¼€å‘ï¼Œå®ƒå¯èƒ½ç›´åˆ°ç°åœ¨è¿˜æ— æ³•ä¸Šå¤©ã€‚
- ä½•ä¸ºå¢é‡å¼€å‘ï¼Ÿ

  è½¯ä»¶çš„æ¯ä¸ªç‰ˆæœ¬ï¼Œéƒ½ä¼šæ–°å¢ä¸€ä¸ªç”¨æˆ·å¯ä»¥æ„ŸçŸ¥çš„å®Œæ•´åŠŸèƒ½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒæŒ‰ç…§æ–°å¢åŠŸèƒ½æ¥åˆ’åˆ†è¿­ä»£ã€‚

  ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ¿äº§å…¬å¸å¼€å‘ä¸€ä¸ª10æ ‹æ¥¼çš„å°åŒºã€‚å¦‚æœé‡‡ç”¨å¢é‡å¼€å‘çš„æ¨¡å¼ï¼Œè¯¥å…¬å¸ç¬¬ä¸€ä¸ªè¿­ä»£å°±æ˜¯äº¤ä»˜ä¸€å·æ¥¼ï¼Œç¬¬äºŒä¸ªè¿­ä»£äº¤ä»˜äºŒå·æ¥¼......æ¯ä¸ªè¿­ä»£éƒ½æ˜¯å®Œæˆä¸€æ ‹å®Œæ•´çš„æ¥¼ã€‚è€Œä¸æ˜¯ç¬¬ä¸€ä¸ªè¿­ä»£æŒ–å¥½10æ ‹æ¥¼çš„åœ°åŸºï¼Œç¬¬äºŒä¸ªè¿­ä»£å»ºå¥½æ¯æ ‹æ¥¼çš„éª¨æ¶ï¼Œç¬¬ä¸‰ä¸ªè¿­ä»£æ¶è®¾å±‹é¡¶......
- æ•æ·å¼€å‘å¦‚ä½•è¿­ä»£ï¼Ÿ

  è™½ç„¶æ•æ·å¼€å‘å°†è½¯ä»¶å¼€å‘åˆ†æˆå¤šä¸ªè¿­ä»£ï¼Œä½†æ˜¯ä¹Ÿè¦æ±‚ï¼Œæ¯æ¬¡è¿­ä»£éƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„è½¯ä»¶å¼€å‘å‘¨æœŸï¼Œå¿…é¡»æŒ‰ç…§è½¯ä»¶å·¥ç¨‹çš„æ–¹æ³•è®ºï¼Œè¿›è¡Œæ­£è§„çš„æµç¨‹ç®¡ç†ã€‚

![image-20210802011540379](images/image-20210802011540379.png)

- æ•æ·å¼€å‘æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

  - æ—©æœŸäº¤ä»˜

    æ•æ·å¼€å‘çš„ç¬¬ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯æ—©æœŸäº¤ä»˜ï¼Œä»è€Œå¤§å¤§é™ä½æˆæœ¬ã€‚ è¿˜æ˜¯ä»¥ä¸Šä¸€èŠ‚çš„æˆ¿äº§å…¬å¸ä¸ºä¾‹ï¼Œå¦‚æœæŒ‰ç…§ä¼ ç»Ÿçš„"ç€‘å¸ƒå¼€å‘æ¨¡å¼"ï¼Œå…ˆæŒ–10æ ‹æ¥¼çš„åœ°åŸºã€å†ç›–éª¨æ¶ã€ç„¶åæ¶è®¾å±‹é¡¶ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½ç­‰åˆ°å‰ä¸€ä¸ªé˜¶æ®µå®Œæˆåå¼€å§‹ï¼Œå¯èƒ½éœ€è¦ä¸¤å¹´æ‰èƒ½ä¸€æ¬¡æ€§äº¤ä»˜10æ ‹æ¥¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸è€ƒè™‘é¢„å”®ï¼Œè¯¥é¡¹ç›®å¿…é¡»ç­‰åˆ°ä¸¤å¹´åæ‰èƒ½å›æ¬¾ã€‚ æ•æ·å¼€å‘æ˜¯å…­ä¸ªæœˆåäº¤ä»˜ä¸€å·æ¥¼ï¼Œåé¢æ¯ä¸¤ä¸ªæœˆäº¤ä»˜ä¸€æ ‹æ¥¼ã€‚å› æ­¤ï¼ŒåŠå¹´å°±èƒ½å›æ¬¾10%ï¼Œåé¢æ¯ä¸ªæœˆéƒ½ä¼šæœ‰ç°é‡‘æµï¼Œèµ„é‡‘å‹åŠ›å°±å¤§å¤§å‡è½»äº†ã€‚
  - é™ä½é£é™©

    æ•æ·å¼€å‘çš„ç¬¬äºŒä¸ªå¥½å¤„æ˜¯ï¼ŒåŠæ—¶äº†è§£å¸‚åœºéœ€æ±‚ï¼Œé™ä½äº§å“ä¸é€‚ç”¨çš„é£é™©ã€‚ è¯·æƒ³ä¸€æƒ³ï¼Œå“ªä¸€ç§æƒ…å†µæŸå¤±æ¯”è¾ƒå°ï¼š10æ ‹æ¥¼éƒ½é€ å¥½ä»¥åï¼Œæ‰å‘ç°å–ä¸å‡ºå»ï¼Œè¿˜æ˜¯é€ å¥½ç¬¬ä¸€æ ‹æ¥¼ï¼Œå°±å‘ç°å–ä¸å‡ºå»ï¼Œä»è€Œæ”¹è¿›æˆ–åœå»ºåé¢9æ ‹æ¥¼ï¼Ÿ

### Jenkinså®‰è£…é…ç½®

#### Jenkinsä»‹ç»

Jenkins  æ˜¯ä¸€æ¬¾æµè¡Œçš„å¼€æºæŒç»­é›†æˆï¼ˆContinuous Integrationï¼‰å·¥å…·ï¼Œå¹¿æ³›ç”¨äºé¡¹ç›®å¼€å‘ï¼Œå…·æœ‰è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²ç­‰åŠŸèƒ½ã€‚å®˜ç½‘ï¼š  http://jenkins-ci.org/ã€‚

![](images/image-20240229165420810.png)

Jenkinsçš„ç‰¹å¾ï¼š

- å¼€æºçš„ Javaè¯­è¨€å¼€å‘æŒç»­é›†æˆå·¥å…·ï¼Œæ”¯æŒæŒç»­é›†æˆï¼ŒæŒç»­éƒ¨ç½²ã€‚
- æ˜“äºå®‰è£…éƒ¨ç½²é…ç½®ï¼šå¯é€šè¿‡ yumå®‰è£…,æˆ–ä¸‹è½½waråŒ…ä»¥åŠé€šè¿‡dockerå®¹å™¨ç­‰å¿«é€Ÿå®ç°å®‰è£…éƒ¨ç½²ï¼Œå¯æ–¹ä¾¿webç•Œé¢é…ç½®ç®¡ç†ã€‚
- æ¶ˆæ¯é€šçŸ¥åŠæµ‹è¯•æŠ¥å‘Šï¼šé›†æˆ RSS/E-mailé€šè¿‡RSSå‘å¸ƒæ„å»ºç»“æœæˆ–å½“æ„å»ºå®Œæˆæ—¶é€šè¿‡e-mailé€šçŸ¥ï¼Œç”ŸæˆJUnit/TestNGæµ‹è¯•æŠ¥å‘Šã€‚
- åˆ†å¸ƒå¼æ„å»ºï¼šæ”¯æŒ Jenkinsèƒ½å¤Ÿè®©å¤šå°è®¡ç®—æœºä¸€èµ·æ„å»º/æµ‹è¯•ã€‚
- æ–‡ä»¶è¯†åˆ«ï¼š Jenkinsèƒ½å¤Ÿè·Ÿè¸ªå“ªæ¬¡æ„å»ºç”Ÿæˆå“ªäº›jarï¼Œå“ªæ¬¡æ„å»ºä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„jarç­‰ã€‚
- ä¸°å¯Œçš„æ’ä»¶æ”¯æŒï¼šæ”¯æŒæ‰©å±•æ’ä»¶ï¼Œä½ å¯ä»¥å¼€å‘é€‚åˆè‡ªå·±å›¢é˜Ÿä½¿ç”¨çš„å·¥å…·ï¼Œå¦‚ gitï¼Œsvnï¼Œmavenï¼Œdockerç­‰ã€‚

#### Jenkinså®‰è£…



##### æ’ä»¶å®‰è£…

å¦‚æœæƒ³è®©Jenkinsæ¥å®ç°æ›´å¤šçš„åŠŸèƒ½ï¼Œéœ€è¦å®‰è£…æ’ä»¶å®Œæˆ

Maven Integration pluginï¼š Maven é›†æˆç®¡ç†æ’ä»¶ã€‚
Docker pluginï¼š Dockeré›†æˆæ’ä»¶ã€‚
GitLab Pluginï¼š GitLabé›†æˆæ’ä»¶ã€‚
Publish Over SSHï¼šè¿œç¨‹æ–‡ä»¶å‘å¸ƒæ’ä»¶ã€‚
SSH: è¿œç¨‹è„šæœ¬æ‰§è¡Œæ’ä»¶ã€‚



å¯ä»¥åœ¨jenkinsçš„ç®¡ç†ç•Œé¢ä¸­æŸ¥çœ‹å®‰è£…æ’ä»¶ï¼šManage Jenkins-->Manage Plugins



#### æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡



#### Jenkinså·¥å…·é…ç½®

åœ¨jenkinsç®¡ç†é¡µé¢ä¸­é›†æˆç¯å¢ƒï¼Œ Manage Jenkins-->Tool Configuration ï¼Œéœ€è¦æŒ‡å®šç¯å¢ƒçš„ç›®å½•ã€‚







### åç«¯é¡¹ç›®éƒ¨ç½²

#### å¤šç¯å¢ƒåˆ‡æ¢

åœ¨é¡¹ç›®å¼€å‘éƒ¨ç½²çš„è¿‡ç¨‹ä¸­ï¼Œä¸€èˆ¬éƒ½ä¼šæœ‰ä¸‰å¥—é¡¹ç›®ç¯å¢ƒ

- Development ï¼šå¼€å‘ç¯å¢ƒ
- Production ï¼šç”Ÿäº§ç¯å¢ƒ
- Test ï¼šæµ‹è¯•ç¯å¢ƒ

ä¾‹å¦‚ï¼šå¼€å‘ç¯å¢ƒçš„mysqlè¿æ¥çš„æ˜¯æœ¬åœ°ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦è¿æ¥çº¿ä¸Šçš„mysqlç¯å¢ƒ

##### å¾®æœåŠ¡ä¸­å¤šç¯å¢ƒé…ç½®

1.åœ¨å¾®æœåŠ¡ä¸­çš„bootstrap.ymlä¸­æ–°å¢é…ç½®



2.åœ¨nacosçš„é…ç½®ä¸­å¿ƒä¸­æ–°å¢å„ä¸ªç¯å¢ƒçš„é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚userå¾®æœåŠ¡ä¸­æ–°å¢



#### æ•´ä½“æ€è·¯

ç›®æ ‡ï¼šæŠŠARå¤´æ¡çš„appç«¯ç›¸å…³çš„å¾®æœåŠ¡éƒ¨ç½²åˆ°192.168.200.100è¿™å°æœåŠ¡å™¨ä¸Š



> æ³¨æ„ï¼š192.168.200.100ä¸192.168.200.130å¿…é¡»ä½¿ç”¨NATè¿™ä¸ªç½‘å¡ï¼Œå¿…é¡»åœ¨åŒä¸€ä¸ªç½‘æ®µï¼Œæ˜¯å¯ä»¥äº’ç›¸é€šä¿¡çš„ï¼Œå¯ä»¥ä½¿ç”¨pingå‘½ä»¤æ¥æ£€æŸ¥



#### æœåŠ¡é›†æˆDockeré…ç½®

ç›®æ ‡ï¼šéƒ¨ç½²çš„æ¯ä¸€ä¸ªå¾®æœåŠ¡éƒ½æ˜¯å…ˆåˆ›å»ºdockeré•œåƒååˆ›å»ºå¯¹åº”å®¹å™¨å¯åŠ¨

æ–¹å¼ä¸€ï¼šæœ¬åœ°å¾®æœåŠ¡æ‰“åŒ…ä»¥åä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œç¼–å†™Dockerfileæ–‡ä»¶å®Œæˆã€‚
æ–¹å¼äºŒï¼šä½¿ç”¨dockerfile-maven-pluginæ’ä»¶ï¼Œå¯ä»¥ç›´æ¥æŠŠå¾®æœåŠ¡åˆ›å»ºä¸ºé•œåƒä½¿ç”¨ï¼ˆæ›´çœäº‹ï¼‰

ğŸ”–



#### åŸºç¡€ä¾èµ–æ‰“åŒ…é…ç½®

åœ¨å¾®æœåŠ¡è¿è¡Œä¹‹å‰éœ€è¦åœ¨æœ¬åœ°ä»“åº“ä¸­å…ˆå»installæ‰€ä¾èµ–çš„jaråŒ…ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥åº”è¯¥æ˜¯ä»gitä¸­æ‹‰å–ä»£ç ï¼Œå¹¶ä¸”æŠŠåŸºç¡€çš„ä¾èµ–éƒ¨åˆ†å®‰è£…åˆ°ä»“åº“ä¸­





#### å¾®æœåŠ¡æ‰“åŒ…é…ç½®

æ‰€æœ‰å¾®æœåŠ¡æ‰“åŒ…çš„æ–¹å¼ç±»ä¼¼ï¼Œä»¥leadnews-userå¾®æœåŠ¡ä¸ºä¾‹



#### éƒ¨ç½²æœåŠ¡åˆ°è¿œç¨‹æœåŠ¡å™¨ä¸Š

ç›®æ ‡ï¼šä½¿ç”¨jenkinsï¼ˆ192.168.200.100ï¼‰æŠŠå¾®æœåŠ¡æ‰“åŒ…éƒ¨ç½²åˆ°192.168.200.130æœåŠ¡å™¨ä¸Š

1ï¼Œå®‰è£…ç§æœ‰ä»“åº“



2ï¼Œjenkinsä¸­å®‰è£…æ’ä»¶



3ï¼Œjenkinsç³»ç»Ÿé…ç½®è¿œç¨‹æœåŠ¡å™¨é“¾æ¥



4ï¼Œjenkinsé¡¹ç›®åˆ›å»ºä¸å…¶ä»–å¾®æœåŠ¡ç›¸åŒ



5ï¼Œè®¾ç½®å‚æ•°



6ï¼Œæ„å»ºæ‰§è¡ŒExecute shell



7ï¼Œåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œè„šæœ¬



8.æ„å»ºå®Œæˆä»¥åï¼Œå¯ä»¥ç™»å½•130æœåŠ¡å™¨ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ç›¸å…³çš„é•œåƒå’Œå®¹å™¨



#### è”è°ƒæµ‹è¯•

1.å‚è€ƒjenkinsä¸­leadnews-userå¾®æœåŠ¡æŠŠappç«¯ç½‘å…³éƒ¨ç½²èµ·æ¥
2.ä¿®æ”¹æœ¬åœ°nginxä¸­çš„é…ç½®åå‘ä»£ç†åœ°å€ä¸º100è¿™å°æœåŠ¡å™¨ï¼šleadnews-app.conf

```nginx
upstream  heima-app-gateway{
  server 192.168.200.100:51601;
}
```

3.å¯åŠ¨nginxï¼Œæ‰“å¼€é¡µé¢è¿›è¡Œæµ‹è¯•



### jenkinsè§¦å‘å™¨é…ç½®

#### URLè§¦å‘è¿œç¨‹æ„å»º





#### å…¶ä»–å·¥ç¨‹æ„å»ºåè§¦å‘



#### å®šæ—¶æ„å»º



##### å®šæ—¶æ„å»º-å®šæ—¶è¡¨è¾¾å¼

å®šæ—¶å­—ç¬¦ä¸²ä»å·¦å¾€å³åˆ†åˆ«ä¸ºï¼š åˆ† æ—¶ æ—¥ æœˆ å‘¨

| ç»„æˆéƒ¨åˆ† | å«ä¹‰        | å–å€¼èŒƒå›´                   |
| -------- | ----------- | -------------------------- |
| ç¬¬ä¸€éƒ¨åˆ† | minute (åˆ†) | 0~59                       |
| ç¬¬äºŒéƒ¨åˆ† | hour(å°æ—¶)  | 0~23                       |
| ç¬¬ä¸‰éƒ¨åˆ† | day(å¤©)     | 1~31                       |
| ç¬¬å››éƒ¨åˆ† | month(æœˆ)   | 1~12                       |
| ç¬¬äº”éƒ¨åˆ† | week(å‘¨)    | 0~7ï¼Œ0 å’Œ 7 éƒ½æ˜¯è¡¨ç¤ºæ˜ŸæœŸå¤© |

- æ¯30åˆ†é’Ÿæ„å»ºä¸€æ¬¡ï¼šH/30 * * * * 10:02 10:32
- æ¯2ä¸ªå°æ—¶æ„å»ºä¸€æ¬¡: H H/2 * * *
- æ¯å¤©çš„8ç‚¹ï¼Œ12ç‚¹ï¼Œ22ç‚¹ï¼Œä¸€å¤©æ„å»º3æ¬¡ï¼š (å¤šä¸ªæ—¶é—´ç‚¹ä¸­é—´ç”¨é€—å·éš”å¼€) 0 8,12,22 * * *
- æ¯å¤©ä¸­åˆ12ç‚¹å®šæ—¶æ„å»ºä¸€æ¬¡ H 12 * * *
- æ¯å¤©ä¸‹åˆ18ç‚¹å®šæ—¶æ„å»ºä¸€æ¬¡ H 18 * * *

> ç¬¦å·`H`è¡¨ç¤ºä¸€ä¸ªéšæœºæ•°
> ç¬¦å·`*`å–å€¼èŒƒå›´çš„ä»»æ„å€¼



#### è½®è¯¢

è½®è¯¢SCMï¼ˆPoll SCMï¼‰ï¼Œæ˜¯æŒ‡å®šæ—¶æ‰«ææœ¬åœ°ä»£ç ä»“åº“çš„ä»£ç æ˜¯å¦æœ‰å˜æ›´ï¼Œå¦‚æœä»£ç æœ‰å˜æ›´å°±è§¦å‘é¡¹ç›®æ„å»ºã€‚



Jenkinsä¼šå®šæ—¶æ‰«ææœ¬åœ°æ•´ä¸ªé¡¹ç›®çš„ä»£ç ï¼Œå¢å¤§ç³»ç»Ÿçš„å¼€é”€ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚



> æ€»ç»“ï¼š
>
> æ„å»ºé¡¹ç›®çš„æ–¹å¼
>
> 1. æ‰‹åŠ¨æ„å»ºï¼ˆå¸¸ç”¨ï¼‰
> 2. URLè§¦å‘è¿œç¨‹æ„å»º
> 3. å…¶ä»–å·¥ç¨‹æ„å»ºåè§¦å‘ï¼ˆå¸¸ç”¨ï¼‰
> 4. å®šæ—¶æ„å»º
> 5. è½®è¯¢ï¼Œæ‰«æä»£ç ä»“åº“æŸ¥çœ‹æ˜¯å¦å˜æ›´

## 13 æ›´å¤šåŠŸèƒ½

- 01-æ–‡ç« è¯„è®º[å®æˆ˜]-->ä½¿ç”¨mongodbè¿›è¡Œå­˜å‚¨
- 02-è‡ªåª’ä½“è¯„è®ºç®¡ç†[å®æˆ˜]-->ä½¿ç”¨mongodbè¿›è¡Œå­˜å‚¨
- 03-è‡ªåª’ä½“å›¾æ–‡ç»Ÿè®¡[å®æˆ˜]
